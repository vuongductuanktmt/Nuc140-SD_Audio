; generated by Component: ARM Compiler 5.06 update 5 (build 528) Tool: ArmCC [4d3621]
; commandline ArmCC [--list --split_sections --debug -c --asm --interleave -o.\obj\ff.o --asm_dir=.\lst\ --list_dir=.\lst\ --depend=.\obj\ff.d --cpu=Cortex-M0 --apcs=interwork -O0 --diag_suppress=9931 -I..\ -I..\ff8\src\ -I..\..\..\..\Library\CMSIS\Include -I..\..\..\..\Library\Device\Nuvoton\NUC1xx\Include -I..\..\..\..\Library\Device\Nuvoton\NUC1xx\Source -I..\..\..\..\Library\ -I..\..\..\..\Library\NUC1xx\Include -I..\..\..\..\Library\NUC1xx-LB_002\Include -IF:\Keil\ARM\RV31\INC -IF:\Keil\ARM\CMSIS\Include -IF:\Keil\ARM\INC\Nuvoton\NUC1xx -D__UVISION_VERSION=524 --omf_browse=.\obj\ff.crf ..\ff8\src\ff.c]
                          THUMB

                          AREA ||i.check_fs||, CODE, READONLY, ALIGN=2

                  check_fs PROC
;;;1628   static
;;;1629   BYTE check_fs (	/* 0:The FAT BR, 1:Valid BR but not an FAT, 2:Not a BR, 3:Disk error */
000000  b570              PUSH     {r4-r6,lr}
;;;1630   	FATFS *fs,	/* File system object */
;;;1631   	DWORD sect	/* Sector# (lba) to check if it is an FAT boot record or not */
;;;1632   )
;;;1633   {
000002  4604              MOV      r4,r0
000004  460d              MOV      r5,r1
;;;1634   	if (disk_read(fs->drv, fs->win, sect, 1) != RES_OK)	/* Load boot record */
000006  7860              LDRB     r0,[r4,#1]
000008  2301              MOVS     r3,#1
00000a  462a              MOV      r2,r5
00000c  4621              MOV      r1,r4
00000e  3134              ADDS     r1,r1,#0x34
000010  f7fffffe          BL       disk_read
000014  2800              CMP      r0,#0
000016  d001              BEQ      |L1.28|
;;;1635   		return 3;
000018  2003              MOVS     r0,#3
                  |L1.26|
;;;1636   	if (LD_WORD(&fs->win[BS_55AA]) != 0xAA55)		/* Check record signature (always placed at offset 510 even if the sector size is >512) */
;;;1637   		return 2;
;;;1638   
;;;1639   	if ((LD_DWORD(&fs->win[BS_FilSysType]) & 0xFFFFFF) == 0x544146)	/* Check "FAT" string */
;;;1640   		return 0;
;;;1641   	if ((LD_DWORD(&fs->win[BS_FilSysType32]) & 0xFFFFFF) == 0x544146)
;;;1642   		return 0;
;;;1643   
;;;1644   	return 1;
;;;1645   }
00001a  bd70              POP      {r4-r6,pc}
                  |L1.28|
00001c  4620              MOV      r0,r4                 ;1636
00001e  3034              ADDS     r0,r0,#0x34           ;1636
000020  30ff              ADDS     r0,r0,#0xff           ;1636
000022  30ff              ADDS     r0,r0,#0xff           ;1636
000024  7840              LDRB     r0,[r0,#1]            ;1636
000026  0201              LSLS     r1,r0,#8              ;1636
000028  4620              MOV      r0,r4                 ;1636
00002a  3034              ADDS     r0,r0,#0x34           ;1636
00002c  30ff              ADDS     r0,r0,#0xff           ;1636
00002e  30e1              ADDS     r0,r0,#0xe1           ;1636
000030  7f80              LDRB     r0,[r0,#0x1e]         ;1636
000032  4301              ORRS     r1,r1,r0              ;1636
000034  4818              LDR      r0,|L1.152|
000036  4281              CMP      r1,r0                 ;1636
000038  d001              BEQ      |L1.62|
00003a  2002              MOVS     r0,#2                 ;1637
00003c  e7ed              B        |L1.26|
                  |L1.62|
00003e  206d              MOVS     r0,#0x6d              ;1639
000040  5d00              LDRB     r0,[r0,r4]            ;1639
000042  0601              LSLS     r1,r0,#24             ;1639
000044  206c              MOVS     r0,#0x6c              ;1639
000046  5d00              LDRB     r0,[r0,r4]            ;1639
000048  0400              LSLS     r0,r0,#16             ;1639
00004a  4308              ORRS     r0,r0,r1              ;1639
00004c  216b              MOVS     r1,#0x6b              ;1639
00004e  5d09              LDRB     r1,[r1,r4]            ;1639
000050  0209              LSLS     r1,r1,#8              ;1639
000052  4308              ORRS     r0,r0,r1              ;1639
000054  216a              MOVS     r1,#0x6a              ;1639
000056  5d09              LDRB     r1,[r1,r4]            ;1639
000058  4308              ORRS     r0,r0,r1              ;1639
00005a  0200              LSLS     r0,r0,#8              ;1639
00005c  0a00              LSRS     r0,r0,#8              ;1639
00005e  490f              LDR      r1,|L1.156|
000060  4288              CMP      r0,r1                 ;1639
000062  d101              BNE      |L1.104|
000064  2000              MOVS     r0,#0                 ;1640
000066  e7d8              B        |L1.26|
                  |L1.104|
000068  2089              MOVS     r0,#0x89              ;1641
00006a  5d00              LDRB     r0,[r0,r4]            ;1641
00006c  0601              LSLS     r1,r0,#24             ;1641
00006e  2088              MOVS     r0,#0x88              ;1641
000070  5d00              LDRB     r0,[r0,r4]            ;1641
000072  0400              LSLS     r0,r0,#16             ;1641
000074  4308              ORRS     r0,r0,r1              ;1641
000076  2187              MOVS     r1,#0x87              ;1641
000078  5d09              LDRB     r1,[r1,r4]            ;1641
00007a  0209              LSLS     r1,r1,#8              ;1641
00007c  4308              ORRS     r0,r0,r1              ;1641
00007e  2186              MOVS     r1,#0x86              ;1641
000080  5d09              LDRB     r1,[r1,r4]            ;1641
000082  4308              ORRS     r0,r0,r1              ;1641
000084  0200              LSLS     r0,r0,#8              ;1641
000086  0a00              LSRS     r0,r0,#8              ;1641
000088  4904              LDR      r1,|L1.156|
00008a  4288              CMP      r0,r1                 ;1641
00008c  d101              BNE      |L1.146|
00008e  2000              MOVS     r0,#0                 ;1642
000090  e7c3              B        |L1.26|
                  |L1.146|
000092  2001              MOVS     r0,#1                 ;1644
000094  e7c1              B        |L1.26|
;;;1646   
                          ENDP

000096  0000              DCW      0x0000
                  |L1.152|
                          DCD      0x0000aa55
                  |L1.156|
                          DCD      0x00544146

                          AREA ||i.chk_chr||, CODE, READONLY, ALIGN=1

                  chk_chr PROC
;;;267    static
;;;268    int chk_chr (const char* str, int chr) {
000000  4602              MOV      r2,r0
;;;269    	while (*str && *str != chr) str++;
000002  e000              B        |L2.6|
                  |L2.4|
000004  1c52              ADDS     r2,r2,#1
                  |L2.6|
000006  7810              LDRB     r0,[r2,#0]
000008  2800              CMP      r0,#0
00000a  d002              BEQ      |L2.18|
00000c  7810              LDRB     r0,[r2,#0]
00000e  4288              CMP      r0,r1
000010  d1f8              BNE      |L2.4|
                  |L2.18|
;;;270    	return *str;
000012  7810              LDRB     r0,[r2,#0]
;;;271    }
000014  4770              BX       lr
;;;272    
                          ENDP


                          AREA ||i.chk_mounted||, CODE, READONLY, ALIGN=2

                  chk_mounted PROC
;;;1654   static
;;;1655   FRESULT chk_mounted (	/* FR_OK(0): successful, !=0: any error occurred */
000000  b5f7              PUSH     {r0-r2,r4-r7,lr}
;;;1656   	const TCHAR **path,	/* Pointer to pointer to the path name (drive number) */
;;;1657   	FATFS **rfs,		/* Pointer to pointer to the found file system object */
;;;1658   	BYTE chk_wp			/* !=0: Check media write protection for write access */
;;;1659   )
;;;1660   {
000002  b08c              SUB      sp,sp,#0x30
;;;1661   	BYTE fmt, b, *tbl;
;;;1662   	UINT vol;
;;;1663   	DSTATUS stat;
;;;1664   	DWORD bsect, fasize, tsect, sysect, nclst, szbfat;
;;;1665   	WORD nrsv;
;;;1666   	const TCHAR *p = *path;
000004  980c              LDR      r0,[sp,#0x30]
000006  6800              LDR      r0,[r0,#0]
000008  9002              STR      r0,[sp,#8]
;;;1667   	FATFS *fs;
;;;1668   
;;;1669   	/* Get logical drive number from the path name */
;;;1670   	vol = p[0] - '0';				/* Is there a drive number? */
00000a  9802              LDR      r0,[sp,#8]
00000c  7800              LDRB     r0,[r0,#0]
00000e  3830              SUBS     r0,r0,#0x30
000010  900b              STR      r0,[sp,#0x2c]
;;;1671   	if (vol <= 9 && p[1] == ':') {	/* Found a drive number, get and strip it */
000012  980b              LDR      r0,[sp,#0x2c]
000014  2809              CMP      r0,#9
000016  d80a              BHI      |L3.46|
000018  9802              LDR      r0,[sp,#8]
00001a  7840              LDRB     r0,[r0,#1]
00001c  283a              CMP      r0,#0x3a
00001e  d106              BNE      |L3.46|
;;;1672   		p += 2; *path = p;			/* Return pointer to the path name */
000020  9802              LDR      r0,[sp,#8]
000022  1c80              ADDS     r0,r0,#2
000024  9002              STR      r0,[sp,#8]
000026  990c              LDR      r1,[sp,#0x30]
000028  9802              LDR      r0,[sp,#8]
00002a  6008              STR      r0,[r1,#0]
00002c  e002              B        |L3.52|
                  |L3.46|
;;;1673   	} else {						/* No drive number is given */
;;;1674   #if _FS_RPATH
;;;1675   		vol = Drive;				/* Use current drive */
00002e  48f2              LDR      r0,|L3.1016|
000030  7800              LDRB     r0,[r0,#0]  ; Drive
000032  900b              STR      r0,[sp,#0x2c]
                  |L3.52|
;;;1676   #else
;;;1677   		vol = 0;					/* Use drive 0 */
;;;1678   #endif
;;;1679   	}
;;;1680   
;;;1681   	/* Check if the logical drive is valid or not */
;;;1682   	if (vol >= _DRIVES) 			/* Is the drive number valid? */
000034  980b              LDR      r0,[sp,#0x2c]
000036  2800              CMP      r0,#0
000038  d002              BEQ      |L3.64|
;;;1683   		return FR_INVALID_DRIVE;
00003a  200b              MOVS     r0,#0xb
                  |L3.60|
;;;1684   	*rfs = fs = FatFs[vol];			/* Return pointer to the corresponding file system object */
;;;1685   	if (!fs) return FR_NOT_ENABLED;	/* Is the file system object available? */
;;;1686   
;;;1687   	ENTER_FF(fs);					/* Lock file system */
;;;1688   
;;;1689   	if (fs->fs_type) {				/* If the logical drive has been mounted */
;;;1690   		stat = disk_status(fs->drv);
;;;1691   		if (!(stat & STA_NOINIT)) {	/* and the physical drive is kept initialized (has not been changed), */
;;;1692   #if !_FS_READONLY
;;;1693   			if (chk_wp && (stat & STA_PROTECT))	/* Check write protection if needed */
;;;1694   				return FR_WRITE_PROTECTED;
;;;1695   #endif
;;;1696   			return FR_OK;			/* The file system object is valid */
;;;1697   		}
;;;1698   	}
;;;1699   
;;;1700   	/* The logical drive must be mounted. Following code attempts to mount the volume (initialize the file system object) */
;;;1701   
;;;1702   	fs->fs_type = 0;					/* Clear the file system object */
;;;1703   	fs->drv = (BYTE)LD2PD(vol);			/* Bind the logical drive and a physical drive */
;;;1704   	stat = disk_initialize(fs->drv);	/* Initialize low level disk I/O layer */
;;;1705   	if (stat & STA_NOINIT)				/* Check if the drive is ready */
;;;1706   		return FR_NOT_READY;
;;;1707   #if _MAX_SS != 512						/* Get disk sector size if needed */
;;;1708   	if (disk_ioctl(fs->drv, GET_SECTOR_SIZE, &SS(fs)) != RES_OK || SS(fs) > _MAX_SS)
;;;1709   		return FR_NO_FILESYSTEM;
;;;1710   #endif
;;;1711   #if !_FS_READONLY
;;;1712   	if (chk_wp && (stat & STA_PROTECT))	/* Check disk write protection if needed */
;;;1713   		return FR_WRITE_PROTECTED;
;;;1714   #endif
;;;1715   	/* Search FAT partition on the drive (Supports only generic partitionings, FDISK and SFD) */
;;;1716   	fmt = check_fs(fs, bsect = 0);		/* Check sector 0 if it is a VBR */
;;;1717   	if (fmt == 1) {						/* Not an FAT-VBR, the disk may be partitioned */
;;;1718   		/* Check the partition listed in top of the partition table */
;;;1719   		tbl = &fs->win[MBR_Table + LD2PT(vol) * 16];	/* Partition table */
;;;1720   		if (tbl[4]) {									/* Is the partition existing? */
;;;1721   			bsect = LD_DWORD(&tbl[8]);					/* Partition offset in LBA */
;;;1722   			fmt = check_fs(fs, bsect);					/* Check the partition */
;;;1723   		}
;;;1724   	}
;;;1725   	if (fmt == 3) return FR_DISK_ERR;
;;;1726   	if (fmt) return FR_NO_FILESYSTEM;					/* No FAT volume is found */
;;;1727   
;;;1728   	/* Following code initializes the file system object */
;;;1729   
;;;1730   	if (LD_WORD(fs->win+BPB_BytsPerSec) != SS(fs))		/* (BPB_BytsPerSec must be equal to the physical sector size) */
;;;1731   		return FR_NO_FILESYSTEM;
;;;1732   
;;;1733   	fasize = LD_WORD(fs->win+BPB_FATSz16);				/* Number of sectors per FAT */
;;;1734   	if (!fasize) fasize = LD_DWORD(fs->win+BPB_FATSz32);
;;;1735   	fs->fsize = fasize;
;;;1736   
;;;1737   	fs->n_fats = b = fs->win[BPB_NumFATs];				/* Number of FAT copies */
;;;1738   	if (b != 1 && b != 2) return FR_NO_FILESYSTEM;		/* (Must be 1 or 2) */
;;;1739   	fasize *= b;										/* Number of sectors for FAT area */
;;;1740   
;;;1741   	fs->csize = b = fs->win[BPB_SecPerClus];			/* Number of sectors per cluster */
;;;1742   	if (!b || (b & (b - 1))) return FR_NO_FILESYSTEM;	/* (Must be 1,2,4...128) */
;;;1743   
;;;1744   	fs->n_rootdir = LD_WORD(fs->win+BPB_RootEntCnt);	/* Number of root directory entries */
;;;1745   	if (fs->n_rootdir % (SS(fs) / 32)) return FR_NO_FILESYSTEM;	/* (BPB_RootEntCnt must be sector aligned) */
;;;1746   
;;;1747   	tsect = LD_WORD(fs->win+BPB_TotSec16);				/* Number of sectors on the volume */
;;;1748   	if (!tsect) tsect = LD_DWORD(fs->win+BPB_TotSec32);
;;;1749   
;;;1750   	nrsv = LD_WORD(fs->win+BPB_RsvdSecCnt);				/* Number of reserved sectors */
;;;1751   	if (!nrsv) return FR_NO_FILESYSTEM;					/* (BPB_RsvdSecCnt must not be 0) */
;;;1752   
;;;1753   	/* Determine the FAT sub type */
;;;1754   	sysect = nrsv + fasize + fs->n_rootdir / (SS(fs) / 32);	/* RSV+FAT+DIR */
;;;1755   	if (tsect < sysect) return FR_NO_FILESYSTEM;		/* (Invalid volume size) */
;;;1756   	nclst = (tsect - sysect) / fs->csize;				/* Number of clusters */
;;;1757   	if (!nclst) return FR_NO_FILESYSTEM;				/* (Invalid volume size) */
;;;1758   	fmt = FS_FAT12;
;;;1759   	if (nclst >= MIN_FAT16) fmt = FS_FAT16;
;;;1760   	if (nclst >= MIN_FAT32) fmt = FS_FAT32;
;;;1761   
;;;1762   	/* Boundaries and Limits */
;;;1763   	fs->n_fatent = nclst + 2;							/* Number of FAT entries */
;;;1764   	fs->database = bsect + sysect;						/* Data start sector */
;;;1765   	fs->fatbase = bsect + nrsv; 						/* FAT start sector */
;;;1766   	if (fmt == FS_FAT32) {
;;;1767   		if (fs->n_rootdir) return FR_NO_FILESYSTEM;		/* (BPB_RootEntCnt must be 0) */
;;;1768   		fs->dirbase = LD_DWORD(fs->win+BPB_RootClus);	/* Root directory start cluster */
;;;1769   		szbfat = fs->n_fatent * 4;						/* (Required FAT size) */
;;;1770   	} else {
;;;1771   		if (!fs->n_rootdir)	return FR_NO_FILESYSTEM;	/* (BPB_RootEntCnt must not be 0) */
;;;1772   		fs->dirbase = fs->fatbase + fasize;				/* Root directory start sector */
;;;1773   		szbfat = (fmt == FS_FAT16) ?					/* (Required FAT size) */
;;;1774   			fs->n_fatent * 2 : fs->n_fatent * 3 / 2 + (fs->n_fatent & 1);
;;;1775   	}
;;;1776   	if (fs->fsize < (szbfat + (SS(fs) - 1)) / SS(fs))	/* (FAT size must not be less than FAT sectors */
;;;1777   		return FR_NO_FILESYSTEM;
;;;1778   
;;;1779   #if !_FS_READONLY
;;;1780   	/* Initialize cluster allocation information */
;;;1781   	fs->free_clust = 0xFFFFFFFF;
;;;1782   	fs->last_clust = 0;
;;;1783   
;;;1784   	/* Get fsinfo if available */
;;;1785   	if (fmt == FS_FAT32) {
;;;1786   	 	fs->fsi_flag = 0;
;;;1787   		fs->fsi_sector = bsect + LD_WORD(fs->win+BPB_FSInfo);
;;;1788   		if (disk_read(fs->drv, fs->win, fs->fsi_sector, 1) == RES_OK &&
;;;1789   			LD_WORD(fs->win+BS_55AA) == 0xAA55 &&
;;;1790   			LD_DWORD(fs->win+FSI_LeadSig) == 0x41615252 &&
;;;1791   			LD_DWORD(fs->win+FSI_StrucSig) == 0x61417272) {
;;;1792   				fs->last_clust = LD_DWORD(fs->win+FSI_Nxt_Free);
;;;1793   				fs->free_clust = LD_DWORD(fs->win+FSI_Free_Count);
;;;1794   		}
;;;1795   	}
;;;1796   #endif
;;;1797   	fs->fs_type = fmt;		/* FAT sub-type */
;;;1798   	fs->id = ++Fsid;		/* File system mount ID */
;;;1799   	fs->winsect = 0;		/* Invalidate sector cache */
;;;1800   	fs->wflag = 0;
;;;1801   #if _FS_RPATH
;;;1802   	fs->cdir = 0;			/* Current directory (root dir) */
;;;1803   #endif
;;;1804   #if _FS_SHARE				/* Clear file lock semaphores */
;;;1805   	for (vol = 0; vol < _FS_SHARE; vol++)
;;;1806   		fs->flsem[vol].ctr = 0;
;;;1807   #endif
;;;1808   
;;;1809   	return FR_OK;
;;;1810   }
00003c  b00f              ADD      sp,sp,#0x3c
00003e  bdf0              POP      {r4-r7,pc}
                  |L3.64|
000040  980b              LDR      r0,[sp,#0x2c]         ;1684
000042  0080              LSLS     r0,r0,#2              ;1684
000044  49ed              LDR      r1,|L3.1020|
000046  580c              LDR      r4,[r1,r0]            ;1684
000048  980d              LDR      r0,[sp,#0x34]         ;1684
00004a  6004              STR      r4,[r0,#0]            ;1684
00004c  2c00              CMP      r4,#0                 ;1685
00004e  d101              BNE      |L3.84|
000050  200c              MOVS     r0,#0xc               ;1685
000052  e7f3              B        |L3.60|
                  |L3.84|
000054  7820              LDRB     r0,[r4,#0]            ;1689
000056  2800              CMP      r0,#0                 ;1689
000058  d014              BEQ      |L3.132|
00005a  7860              LDRB     r0,[r4,#1]            ;1690
00005c  f7fffffe          BL       disk_status
000060  900a              STR      r0,[sp,#0x28]         ;1690
000062  980a              LDR      r0,[sp,#0x28]         ;1691
000064  07c0              LSLS     r0,r0,#31             ;1691
000066  0fc0              LSRS     r0,r0,#31             ;1691
000068  2800              CMP      r0,#0                 ;1691
00006a  d10b              BNE      |L3.132|
00006c  980e              LDR      r0,[sp,#0x38]         ;1693
00006e  2800              CMP      r0,#0                 ;1693
000070  d006              BEQ      |L3.128|
000072  2104              MOVS     r1,#4                 ;1693
000074  980a              LDR      r0,[sp,#0x28]         ;1693
000076  4008              ANDS     r0,r0,r1              ;1693
000078  2800              CMP      r0,#0                 ;1693
00007a  d001              BEQ      |L3.128|
00007c  200a              MOVS     r0,#0xa               ;1694
00007e  e7dd              B        |L3.60|
                  |L3.128|
000080  2000              MOVS     r0,#0                 ;1696
000082  e7db              B        |L3.60|
                  |L3.132|
000084  2000              MOVS     r0,#0                 ;1702
000086  7020              STRB     r0,[r4,#0]            ;1702
000088  980b              LDR      r0,[sp,#0x2c]         ;1703
00008a  7060              STRB     r0,[r4,#1]            ;1703
00008c  7860              LDRB     r0,[r4,#1]            ;1704
00008e  f7fffffe          BL       disk_initialize
000092  900a              STR      r0,[sp,#0x28]         ;1704
000094  980a              LDR      r0,[sp,#0x28]         ;1705
000096  07c0              LSLS     r0,r0,#31             ;1705
000098  0fc0              LSRS     r0,r0,#31             ;1705
00009a  2800              CMP      r0,#0                 ;1705
00009c  d001              BEQ      |L3.162|
00009e  2003              MOVS     r0,#3                 ;1706
0000a0  e7cc              B        |L3.60|
                  |L3.162|
0000a2  980e              LDR      r0,[sp,#0x38]         ;1712
0000a4  2800              CMP      r0,#0                 ;1712
0000a6  d006              BEQ      |L3.182|
0000a8  2104              MOVS     r1,#4                 ;1712
0000aa  980a              LDR      r0,[sp,#0x28]         ;1712
0000ac  4008              ANDS     r0,r0,r1              ;1712
0000ae  2800              CMP      r0,#0                 ;1712
0000b0  d001              BEQ      |L3.182|
0000b2  200a              MOVS     r0,#0xa               ;1713
0000b4  e7c2              B        |L3.60|
                  |L3.182|
0000b6  2000              MOVS     r0,#0                 ;1716
0000b8  4601              MOV      r1,r0                 ;1716
0000ba  9009              STR      r0,[sp,#0x24]         ;1716
0000bc  4620              MOV      r0,r4                 ;1716
0000be  f7fffffe          BL       check_fs
0000c2  4605              MOV      r5,r0                 ;1716
0000c4  2d01              CMP      r5,#1                 ;1717
0000c6  d115              BNE      |L3.244|
0000c8  4627              MOV      r7,r4                 ;1719
0000ca  37ff              ADDS     r7,r7,#0xff           ;1719
0000cc  37f3              ADDS     r7,r7,#0xf3           ;1719
0000ce  7938              LDRB     r0,[r7,#4]            ;1720
0000d0  2800              CMP      r0,#0                 ;1720
0000d2  d00f              BEQ      |L3.244|
0000d4  7af8              LDRB     r0,[r7,#0xb]          ;1721
0000d6  0600              LSLS     r0,r0,#24             ;1721
0000d8  7ab9              LDRB     r1,[r7,#0xa]          ;1721
0000da  0409              LSLS     r1,r1,#16             ;1721
0000dc  4308              ORRS     r0,r0,r1              ;1721
0000de  7a79              LDRB     r1,[r7,#9]            ;1721
0000e0  0209              LSLS     r1,r1,#8              ;1721
0000e2  4308              ORRS     r0,r0,r1              ;1721
0000e4  7a39              LDRB     r1,[r7,#8]            ;1721
0000e6  4308              ORRS     r0,r0,r1              ;1721
0000e8  9009              STR      r0,[sp,#0x24]         ;1721
0000ea  4620              MOV      r0,r4                 ;1722
0000ec  9909              LDR      r1,[sp,#0x24]         ;1722
0000ee  f7fffffe          BL       check_fs
0000f2  4605              MOV      r5,r0                 ;1722
                  |L3.244|
0000f4  2d03              CMP      r5,#3                 ;1725
0000f6  d101              BNE      |L3.252|
0000f8  2001              MOVS     r0,#1                 ;1725
0000fa  e79f              B        |L3.60|
                  |L3.252|
0000fc  2d00              CMP      r5,#0                 ;1726
0000fe  d001              BEQ      |L3.260|
000100  200d              MOVS     r0,#0xd               ;1726
000102  e79b              B        |L3.60|
                  |L3.260|
000104  2040              MOVS     r0,#0x40              ;1730
000106  5d00              LDRB     r0,[r0,r4]            ;1730
000108  0200              LSLS     r0,r0,#8              ;1730
00010a  213f              MOVS     r1,#0x3f              ;1730
00010c  5d09              LDRB     r1,[r1,r4]            ;1730
00010e  4308              ORRS     r0,r0,r1              ;1730
000110  2101              MOVS     r1,#1                 ;1730
000112  0249              LSLS     r1,r1,#9              ;1730
000114  4288              CMP      r0,r1                 ;1730
000116  d001              BEQ      |L3.284|
000118  200d              MOVS     r0,#0xd               ;1731
00011a  e78f              B        |L3.60|
                  |L3.284|
00011c  204b              MOVS     r0,#0x4b              ;1733
00011e  5d00              LDRB     r0,[r0,r4]            ;1733
000120  0200              LSLS     r0,r0,#8              ;1733
000122  214a              MOVS     r1,#0x4a              ;1733
000124  5d09              LDRB     r1,[r1,r4]            ;1733
000126  4308              ORRS     r0,r0,r1              ;1733
000128  9008              STR      r0,[sp,#0x20]         ;1733
00012a  9808              LDR      r0,[sp,#0x20]         ;1734
00012c  2800              CMP      r0,#0                 ;1734
00012e  d10e              BNE      |L3.334|
000130  205b              MOVS     r0,#0x5b              ;1734
000132  5d00              LDRB     r0,[r0,r4]            ;1734
000134  0601              LSLS     r1,r0,#24             ;1734
000136  205a              MOVS     r0,#0x5a              ;1734
000138  5d00              LDRB     r0,[r0,r4]            ;1734
00013a  0400              LSLS     r0,r0,#16             ;1734
00013c  4308              ORRS     r0,r0,r1              ;1734
00013e  2159              MOVS     r1,#0x59              ;1734
000140  5d09              LDRB     r1,[r1,r4]            ;1734
000142  0209              LSLS     r1,r1,#8              ;1734
000144  4308              ORRS     r0,r0,r1              ;1734
000146  2158              MOVS     r1,#0x58              ;1734
000148  5d09              LDRB     r1,[r1,r4]            ;1734
00014a  4308              ORRS     r0,r0,r1              ;1734
00014c  9008              STR      r0,[sp,#0x20]         ;1734
                  |L3.334|
00014e  9808              LDR      r0,[sp,#0x20]         ;1735
000150  6220              STR      r0,[r4,#0x20]         ;1735
000152  2044              MOVS     r0,#0x44              ;1737
000154  5d06              LDRB     r6,[r0,r4]            ;1737
000156  70e6              STRB     r6,[r4,#3]            ;1737
000158  2e01              CMP      r6,#1                 ;1738
00015a  d003              BEQ      |L3.356|
00015c  2e02              CMP      r6,#2                 ;1738
00015e  d001              BEQ      |L3.356|
000160  200d              MOVS     r0,#0xd               ;1738
000162  e76b              B        |L3.60|
                  |L3.356|
000164  9808              LDR      r0,[sp,#0x20]         ;1739
000166  4370              MULS     r0,r6,r0              ;1739
000168  9008              STR      r0,[sp,#0x20]         ;1739
00016a  2041              MOVS     r0,#0x41              ;1741
00016c  5d00              LDRB     r0,[r0,r4]            ;1741
00016e  4606              MOV      r6,r0                 ;1741
000170  70a0              STRB     r0,[r4,#2]            ;1741
000172  2e00              CMP      r6,#0                 ;1742
000174  d003              BEQ      |L3.382|
000176  1e70              SUBS     r0,r6,#1              ;1742
000178  4030              ANDS     r0,r0,r6              ;1742
00017a  2800              CMP      r0,#0                 ;1742
00017c  d001              BEQ      |L3.386|
                  |L3.382|
00017e  200d              MOVS     r0,#0xd               ;1742
000180  e75c              B        |L3.60|
                  |L3.386|
000182  2046              MOVS     r0,#0x46              ;1744
000184  5d00              LDRB     r0,[r0,r4]            ;1744
000186  0200              LSLS     r0,r0,#8              ;1744
000188  2145              MOVS     r1,#0x45              ;1744
00018a  5d09              LDRB     r1,[r1,r4]            ;1744
00018c  4308              ORRS     r0,r0,r1              ;1744
00018e  8120              STRH     r0,[r4,#8]            ;1744
000190  7a20              LDRB     r0,[r4,#8]            ;1745
000192  0700              LSLS     r0,r0,#28             ;1745
000194  0f00              LSRS     r0,r0,#28             ;1745
000196  2800              CMP      r0,#0                 ;1745
000198  d001              BEQ      |L3.414|
00019a  200d              MOVS     r0,#0xd               ;1745
00019c  e74e              B        |L3.60|
                  |L3.414|
00019e  2048              MOVS     r0,#0x48              ;1747
0001a0  5d00              LDRB     r0,[r0,r4]            ;1747
0001a2  0200              LSLS     r0,r0,#8              ;1747
0001a4  2147              MOVS     r1,#0x47              ;1747
0001a6  5d09              LDRB     r1,[r1,r4]            ;1747
0001a8  4308              ORRS     r0,r0,r1              ;1747
0001aa  9007              STR      r0,[sp,#0x1c]         ;1747
0001ac  9807              LDR      r0,[sp,#0x1c]         ;1748
0001ae  2800              CMP      r0,#0                 ;1748
0001b0  d10e              BNE      |L3.464|
0001b2  2057              MOVS     r0,#0x57              ;1748
0001b4  5d00              LDRB     r0,[r0,r4]            ;1748
0001b6  0601              LSLS     r1,r0,#24             ;1748
0001b8  2056              MOVS     r0,#0x56              ;1748
0001ba  5d00              LDRB     r0,[r0,r4]            ;1748
0001bc  0400              LSLS     r0,r0,#16             ;1748
0001be  4308              ORRS     r0,r0,r1              ;1748
0001c0  2155              MOVS     r1,#0x55              ;1748
0001c2  5d09              LDRB     r1,[r1,r4]            ;1748
0001c4  0209              LSLS     r1,r1,#8              ;1748
0001c6  4308              ORRS     r0,r0,r1              ;1748
0001c8  2154              MOVS     r1,#0x54              ;1748
0001ca  5d09              LDRB     r1,[r1,r4]            ;1748
0001cc  4308              ORRS     r0,r0,r1              ;1748
0001ce  9007              STR      r0,[sp,#0x1c]         ;1748
                  |L3.464|
0001d0  2043              MOVS     r0,#0x43              ;1750
0001d2  5d00              LDRB     r0,[r0,r4]            ;1750
0001d4  0200              LSLS     r0,r0,#8              ;1750
0001d6  2142              MOVS     r1,#0x42              ;1750
0001d8  5d09              LDRB     r1,[r1,r4]            ;1750
0001da  4308              ORRS     r0,r0,r1              ;1750
0001dc  9003              STR      r0,[sp,#0xc]          ;1750
0001de  9803              LDR      r0,[sp,#0xc]          ;1751
0001e0  2800              CMP      r0,#0                 ;1751
0001e2  d101              BNE      |L3.488|
0001e4  200d              MOVS     r0,#0xd               ;1751
0001e6  e729              B        |L3.60|
                  |L3.488|
0001e8  9908              LDR      r1,[sp,#0x20]         ;1754
0001ea  9803              LDR      r0,[sp,#0xc]          ;1754
0001ec  1840              ADDS     r0,r0,r1              ;1754
0001ee  8921              LDRH     r1,[r4,#8]            ;1754
0001f0  0909              LSRS     r1,r1,#4              ;1754
0001f2  1840              ADDS     r0,r0,r1              ;1754
0001f4  9006              STR      r0,[sp,#0x18]         ;1754
0001f6  9907              LDR      r1,[sp,#0x1c]         ;1755
0001f8  9806              LDR      r0,[sp,#0x18]         ;1755
0001fa  4281              CMP      r1,r0                 ;1755
0001fc  d201              BCS      |L3.514|
0001fe  200d              MOVS     r0,#0xd               ;1755
000200  e71c              B        |L3.60|
                  |L3.514|
000202  78a1              LDRB     r1,[r4,#2]            ;1756
000204  9b06              LDR      r3,[sp,#0x18]         ;1756
000206  9a07              LDR      r2,[sp,#0x1c]         ;1756
000208  1ad0              SUBS     r0,r2,r3              ;1756
00020a  f7fffffe          BL       __aeabi_uidivmod
00020e  9005              STR      r0,[sp,#0x14]         ;1756
000210  9805              LDR      r0,[sp,#0x14]         ;1757
000212  2800              CMP      r0,#0                 ;1757
000214  d101              BNE      |L3.538|
000216  200d              MOVS     r0,#0xd               ;1757
000218  e710              B        |L3.60|
                  |L3.538|
00021a  2501              MOVS     r5,#1                 ;1758
00021c  4978              LDR      r1,|L3.1024|
00021e  9805              LDR      r0,[sp,#0x14]         ;1759
000220  4288              CMP      r0,r1                 ;1759
000222  d300              BCC      |L3.550|
000224  2502              MOVS     r5,#2                 ;1759
                  |L3.550|
000226  4977              LDR      r1,|L3.1028|
000228  9805              LDR      r0,[sp,#0x14]         ;1760
00022a  4288              CMP      r0,r1                 ;1760
00022c  d300              BCC      |L3.560|
00022e  2503              MOVS     r5,#3                 ;1760
                  |L3.560|
000230  9805              LDR      r0,[sp,#0x14]         ;1763
000232  1c80              ADDS     r0,r0,#2              ;1763
000234  61e0              STR      r0,[r4,#0x1c]         ;1763
000236  9906              LDR      r1,[sp,#0x18]         ;1764
000238  9809              LDR      r0,[sp,#0x24]         ;1764
00023a  1840              ADDS     r0,r0,r1              ;1764
00023c  62e0              STR      r0,[r4,#0x2c]         ;1764
00023e  9903              LDR      r1,[sp,#0xc]          ;1765
000240  9809              LDR      r0,[sp,#0x24]         ;1765
000242  1840              ADDS     r0,r0,r1              ;1765
000244  6260              STR      r0,[r4,#0x24]         ;1765
000246  2d03              CMP      r5,#3                 ;1766
000248  d117              BNE      |L3.634|
00024a  8920              LDRH     r0,[r4,#8]            ;1767
00024c  2800              CMP      r0,#0                 ;1767
00024e  d001              BEQ      |L3.596|
000250  200d              MOVS     r0,#0xd               ;1767
000252  e6f3              B        |L3.60|
                  |L3.596|
000254  2063              MOVS     r0,#0x63              ;1768
000256  5d00              LDRB     r0,[r0,r4]            ;1768
000258  0601              LSLS     r1,r0,#24             ;1768
00025a  2062              MOVS     r0,#0x62              ;1768
00025c  5d00              LDRB     r0,[r0,r4]            ;1768
00025e  0400              LSLS     r0,r0,#16             ;1768
000260  4308              ORRS     r0,r0,r1              ;1768
000262  2161              MOVS     r1,#0x61              ;1768
000264  5d09              LDRB     r1,[r1,r4]            ;1768
000266  0209              LSLS     r1,r1,#8              ;1768
000268  4308              ORRS     r0,r0,r1              ;1768
00026a  2160              MOVS     r1,#0x60              ;1768
00026c  5d09              LDRB     r1,[r1,r4]            ;1768
00026e  4308              ORRS     r0,r0,r1              ;1768
000270  62a0              STR      r0,[r4,#0x28]         ;1768
000272  69e0              LDR      r0,[r4,#0x1c]         ;1769
000274  0080              LSLS     r0,r0,#2              ;1769
000276  9004              STR      r0,[sp,#0x10]         ;1769
000278  e016              B        |L3.680|
                  |L3.634|
00027a  8920              LDRH     r0,[r4,#8]            ;1771
00027c  2800              CMP      r0,#0                 ;1771
00027e  d101              BNE      |L3.644|
000280  200d              MOVS     r0,#0xd               ;1771
000282  e6db              B        |L3.60|
                  |L3.644|
000284  6a61              LDR      r1,[r4,#0x24]         ;1772
000286  9808              LDR      r0,[sp,#0x20]         ;1772
000288  1808              ADDS     r0,r1,r0              ;1772
00028a  62a0              STR      r0,[r4,#0x28]         ;1772
00028c  2d02              CMP      r5,#2                 ;1773
00028e  d102              BNE      |L3.662|
000290  69e0              LDR      r0,[r4,#0x1c]         ;1774
000292  0040              LSLS     r0,r0,#1              ;1774
000294  e007              B        |L3.678|
                  |L3.662|
000296  69e0              LDR      r0,[r4,#0x1c]         ;1774
000298  0041              LSLS     r1,r0,#1              ;1774
00029a  1840              ADDS     r0,r0,r1              ;1774
00029c  0840              LSRS     r0,r0,#1              ;1774
00029e  7f21              LDRB     r1,[r4,#0x1c]         ;1774
0002a0  07c9              LSLS     r1,r1,#31             ;1774
0002a2  0fc9              LSRS     r1,r1,#31             ;1774
0002a4  1840              ADDS     r0,r0,r1              ;1774
                  |L3.678|
0002a6  9004              STR      r0,[sp,#0x10]         ;1774
                  |L3.680|
0002a8  6a21              LDR      r1,[r4,#0x20]         ;1776
0002aa  9804              LDR      r0,[sp,#0x10]         ;1776
0002ac  30ff              ADDS     r0,r0,#0xff           ;1776
0002ae  30ff              ADDS     r0,r0,#0xff           ;1776
0002b0  3001              ADDS     r0,#1                 ;1776
0002b2  0a40              LSRS     r0,r0,#9              ;1776
0002b4  4281              CMP      r1,r0                 ;1776
0002b6  d201              BCS      |L3.700|
0002b8  200d              MOVS     r0,#0xd               ;1777
0002ba  e6bf              B        |L3.60|
                  |L3.700|
0002bc  2000              MOVS     r0,#0                 ;1781
0002be  43c0              MVNS     r0,r0                 ;1781
0002c0  6120              STR      r0,[r4,#0x10]         ;1781
0002c2  2000              MOVS     r0,#0                 ;1782
0002c4  60e0              STR      r0,[r4,#0xc]          ;1782
0002c6  2d03              CMP      r5,#3                 ;1785
0002c8  d17e              BNE      |L3.968|
0002ca  7160              STRB     r0,[r4,#5]            ;1786
0002cc  2065              MOVS     r0,#0x65              ;1787
0002ce  5d00              LDRB     r0,[r0,r4]            ;1787
0002d0  0201              LSLS     r1,r0,#8              ;1787
0002d2  2064              MOVS     r0,#0x64              ;1787
0002d4  5d00              LDRB     r0,[r0,r4]            ;1787
0002d6  4301              ORRS     r1,r1,r0              ;1787
0002d8  9809              LDR      r0,[sp,#0x24]         ;1787
0002da  1808              ADDS     r0,r1,r0              ;1787
0002dc  6160              STR      r0,[r4,#0x14]         ;1787
0002de  7860              LDRB     r0,[r4,#1]            ;1788
0002e0  6962              LDR      r2,[r4,#0x14]         ;1788
0002e2  2301              MOVS     r3,#1                 ;1788
0002e4  4621              MOV      r1,r4                 ;1788
0002e6  3134              ADDS     r1,r1,#0x34           ;1788
0002e8  9001              STR      r0,[sp,#4]            ;1788
0002ea  f7fffffe          BL       disk_read
0002ee  2800              CMP      r0,#0                 ;1788
0002f0  d174              BNE      |L3.988|
0002f2  4620              MOV      r0,r4                 ;1789
0002f4  3034              ADDS     r0,r0,#0x34           ;1789
0002f6  30ff              ADDS     r0,r0,#0xff           ;1789
0002f8  30ff              ADDS     r0,r0,#0xff           ;1789
0002fa  7840              LDRB     r0,[r0,#1]            ;1789
0002fc  0201              LSLS     r1,r0,#8              ;1789
0002fe  4620              MOV      r0,r4                 ;1789
000300  3034              ADDS     r0,r0,#0x34           ;1789
000302  30ff              ADDS     r0,r0,#0xff           ;1789
000304  30e1              ADDS     r0,r0,#0xe1           ;1789
000306  7f80              LDRB     r0,[r0,#0x1e]         ;1789
000308  4301              ORRS     r1,r1,r0              ;1789
00030a  483f              LDR      r0,|L3.1032|
00030c  4281              CMP      r1,r0                 ;1789
00030e  d165              BNE      |L3.988|
000310  2037              MOVS     r0,#0x37              ;1790
000312  5d00              LDRB     r0,[r0,r4]            ;1790
000314  0600              LSLS     r0,r0,#24             ;1790
000316  2136              MOVS     r1,#0x36              ;1790
000318  5d09              LDRB     r1,[r1,r4]            ;1790
00031a  0409              LSLS     r1,r1,#16             ;1790
00031c  4308              ORRS     r0,r0,r1              ;1790
00031e  2135              MOVS     r1,#0x35              ;1790
000320  5d09              LDRB     r1,[r1,r4]            ;1790
000322  0209              LSLS     r1,r1,#8              ;1790
000324  4308              ORRS     r0,r0,r1              ;1790
000326  2134              MOVS     r1,#0x34              ;1790
000328  5d09              LDRB     r1,[r1,r4]            ;1790
00032a  4308              ORRS     r0,r0,r1              ;1790
00032c  4937              LDR      r1,|L3.1036|
00032e  4288              CMP      r0,r1                 ;1790
000330  d154              BNE      |L3.988|
000332  4620              MOV      r0,r4                 ;1791
000334  3034              ADDS     r0,r0,#0x34           ;1791
000336  30ff              ADDS     r0,r0,#0xff           ;1791
000338  30e5              ADDS     r0,r0,#0xe5           ;1791
00033a  78c0              LDRB     r0,[r0,#3]            ;1791
00033c  0601              LSLS     r1,r0,#24             ;1791
00033e  4620              MOV      r0,r4                 ;1791
000340  3034              ADDS     r0,r0,#0x34           ;1791
000342  30ff              ADDS     r0,r0,#0xff           ;1791
000344  30e5              ADDS     r0,r0,#0xe5           ;1791
000346  7880              LDRB     r0,[r0,#2]            ;1791
000348  0400              LSLS     r0,r0,#16             ;1791
00034a  4308              ORRS     r0,r0,r1              ;1791
00034c  4621              MOV      r1,r4                 ;1791
00034e  3134              ADDS     r1,r1,#0x34           ;1791
000350  31ff              ADDS     r1,r1,#0xff           ;1791
000352  31e5              ADDS     r1,r1,#0xe5           ;1791
000354  7849              LDRB     r1,[r1,#1]            ;1791
000356  0209              LSLS     r1,r1,#8              ;1791
000358  4308              ORRS     r0,r0,r1              ;1791
00035a  4621              MOV      r1,r4                 ;1791
00035c  3134              ADDS     r1,r1,#0x34           ;1791
00035e  31ff              ADDS     r1,r1,#0xff           ;1791
000360  31e1              ADDS     r1,r1,#0xe1           ;1791
000362  7909              LDRB     r1,[r1,#4]            ;1791
000364  4308              ORRS     r0,r0,r1              ;1791
000366  492a              LDR      r1,|L3.1040|
000368  4288              CMP      r0,r1                 ;1791
00036a  d137              BNE      |L3.988|
00036c  4620              MOV      r0,r4                 ;1792
00036e  3034              ADDS     r0,r0,#0x34           ;1792
000370  30ff              ADDS     r0,r0,#0xff           ;1792
000372  30ed              ADDS     r0,r0,#0xed           ;1792
000374  78c0              LDRB     r0,[r0,#3]            ;1792
000376  0601              LSLS     r1,r0,#24             ;1792
000378  4620              MOV      r0,r4                 ;1792
00037a  3034              ADDS     r0,r0,#0x34           ;1792
00037c  30ff              ADDS     r0,r0,#0xff           ;1792
00037e  30ed              ADDS     r0,r0,#0xed           ;1792
000380  7880              LDRB     r0,[r0,#2]            ;1792
000382  0400              LSLS     r0,r0,#16             ;1792
000384  4308              ORRS     r0,r0,r1              ;1792
000386  4621              MOV      r1,r4                 ;1792
000388  3134              ADDS     r1,r1,#0x34           ;1792
00038a  31ff              ADDS     r1,r1,#0xff           ;1792
00038c  31ed              ADDS     r1,r1,#0xed           ;1792
00038e  7849              LDRB     r1,[r1,#1]            ;1792
000390  0209              LSLS     r1,r1,#8              ;1792
000392  4308              ORRS     r0,r0,r1              ;1792
000394  4621              MOV      r1,r4                 ;1792
000396  3134              ADDS     r1,r1,#0x34           ;1792
000398  31ff              ADDS     r1,r1,#0xff           ;1792
00039a  31e1              ADDS     r1,r1,#0xe1           ;1792
00039c  7b09              LDRB     r1,[r1,#0xc]          ;1792
00039e  4308              ORRS     r0,r0,r1              ;1792
0003a0  60e0              STR      r0,[r4,#0xc]          ;1792
0003a2  4620              MOV      r0,r4                 ;1793
0003a4  3034              ADDS     r0,r0,#0x34           ;1793
0003a6  30ff              ADDS     r0,r0,#0xff           ;1793
0003a8  30e9              ADDS     r0,r0,#0xe9           ;1793
0003aa  78c0              LDRB     r0,[r0,#3]            ;1793
0003ac  0601              LSLS     r1,r0,#24             ;1793
0003ae  4620              MOV      r0,r4                 ;1793
0003b0  3034              ADDS     r0,r0,#0x34           ;1793
0003b2  30ff              ADDS     r0,r0,#0xff           ;1793
0003b4  30e9              ADDS     r0,r0,#0xe9           ;1793
0003b6  7880              LDRB     r0,[r0,#2]            ;1793
0003b8  0400              LSLS     r0,r0,#16             ;1793
0003ba  4308              ORRS     r0,r0,r1              ;1793
0003bc  4621              MOV      r1,r4                 ;1793
0003be  3134              ADDS     r1,r1,#0x34           ;1793
0003c0  31ff              ADDS     r1,r1,#0xff           ;1793
0003c2  31e9              ADDS     r1,r1,#0xe9           ;1793
0003c4  7849              LDRB     r1,[r1,#1]            ;1793
0003c6  e000              B        |L3.970|
                  |L3.968|
0003c8  e008              B        |L3.988|
                  |L3.970|
0003ca  0209              LSLS     r1,r1,#8              ;1793
0003cc  4308              ORRS     r0,r0,r1              ;1793
0003ce  4621              MOV      r1,r4                 ;1793
0003d0  3134              ADDS     r1,r1,#0x34           ;1793
0003d2  31ff              ADDS     r1,r1,#0xff           ;1793
0003d4  31e1              ADDS     r1,r1,#0xe1           ;1793
0003d6  7a09              LDRB     r1,[r1,#8]            ;1793
0003d8  4308              ORRS     r0,r0,r1              ;1793
0003da  6120              STR      r0,[r4,#0x10]         ;1793
                  |L3.988|
0003dc  7025              STRB     r5,[r4,#0]            ;1797
0003de  480d              LDR      r0,|L3.1044|
0003e0  8800              LDRH     r0,[r0,#0]            ;1798  ; Fsid
0003e2  1c40              ADDS     r0,r0,#1              ;1798
0003e4  b280              UXTH     r0,r0                 ;1798
0003e6  490b              LDR      r1,|L3.1044|
0003e8  8008              STRH     r0,[r1,#0]            ;1798
0003ea  80e0              STRH     r0,[r4,#6]            ;1798
0003ec  2000              MOVS     r0,#0                 ;1799
0003ee  6320              STR      r0,[r4,#0x30]         ;1799
0003f0  7120              STRB     r0,[r4,#4]            ;1800
0003f2  61a0              STR      r0,[r4,#0x18]         ;1802
0003f4  bf00              NOP                            ;1809
0003f6  e621              B        |L3.60|
;;;1811   
                          ENDP

                  |L3.1016|
                          DCD      Drive
                  |L3.1020|
                          DCD      FatFs
                  |L3.1024|
                          DCD      0x00000ff6
                  |L3.1028|
                          DCD      0x0000fff6
                  |L3.1032|
                          DCD      0x0000aa55
                  |L3.1036|
                          DCD      0x41615252
                  |L3.1040|
                          DCD      0x61417272
                  |L3.1044|
                          DCD      Fsid

                          AREA ||i.clust2sect||, CODE, READONLY, ALIGN=1

                  clust2sect PROC
;;;693    
;;;694    DWORD clust2sect (	/* !=0: Sector number, 0: Failed - invalid cluster# */
000000  4602              MOV      r2,r0
;;;695    	FATFS *fs,		/* File system object */
;;;696    	DWORD clst		/* Cluster# to be converted */
;;;697    )
;;;698    {
;;;699    	clst -= 2;
000002  1e89              SUBS     r1,r1,#2
;;;700    	if (clst >= (fs->n_fatent - 2)) return 0;		/* Invalid cluster# */
000004  69d0              LDR      r0,[r2,#0x1c]
000006  1e80              SUBS     r0,r0,#2
000008  4288              CMP      r0,r1
00000a  d801              BHI      |L4.16|
00000c  2000              MOVS     r0,#0
                  |L4.14|
;;;701    	return clst * fs->csize + fs->database;
;;;702    }
00000e  4770              BX       lr
                  |L4.16|
000010  7890              LDRB     r0,[r2,#2]            ;701
000012  4348              MULS     r0,r1,r0              ;701
000014  6ad3              LDR      r3,[r2,#0x2c]         ;701
000016  18c0              ADDS     r0,r0,r3              ;701
000018  e7f9              B        |L4.14|
;;;703    
                          ENDP


                          AREA ||i.cmp_lfn||, CODE, READONLY, ALIGN=2

                  cmp_lfn PROC
;;;830    static
;;;831    int cmp_lfn (			/* 1:Matched, 0:Not matched */
000000  b5fe              PUSH     {r1-r7,lr}
;;;832    	WCHAR *lfnbuf,		/* Pointer to the LFN to be compared */
;;;833    	BYTE *dir			/* Pointer to the directory entry containing a part of LFN */
;;;834    )
;;;835    {
000002  4605              MOV      r5,r0
000004  460c              MOV      r4,r1
;;;836    	int i, s;
;;;837    	WCHAR wc, uc;
;;;838    
;;;839    
;;;840    	i = ((dir[LDIR_Ord] & 0xBF) - 1) * 13;	/* Get offset in the LFN buffer */
000006  7820              LDRB     r0,[r4,#0]
000008  21bf              MOVS     r1,#0xbf
00000a  4008              ANDS     r0,r0,r1
00000c  1e40              SUBS     r0,r0,#1
00000e  210d              MOVS     r1,#0xd
000010  4348              MULS     r0,r1,r0
000012  4606              MOV      r6,r0
;;;841    	s = 0; wc = 1;
000014  2700              MOVS     r7,#0
000016  2001              MOVS     r0,#1
000018  9001              STR      r0,[sp,#4]
;;;842    	do {
00001a  bf00              NOP      
                  |L5.28|
;;;843    		uc = LD_WORD(dir+LfnOfs[s]);	/* Pick an LFN character from the entry */
00001c  481b              LDR      r0,|L5.140|
00001e  5dc0              LDRB     r0,[r0,r7]
000020  1900              ADDS     r0,r0,r4
000022  7840              LDRB     r0,[r0,#1]
000024  0200              LSLS     r0,r0,#8
000026  4919              LDR      r1,|L5.140|
000028  5dc9              LDRB     r1,[r1,r7]
00002a  5c61              LDRB     r1,[r4,r1]
00002c  4308              ORRS     r0,r0,r1
00002e  9000              STR      r0,[sp,#0]
;;;844    		if (wc) {	/* Last char has not been processed */
000030  9801              LDR      r0,[sp,#4]
000032  2800              CMP      r0,#0
000034  d010              BEQ      |L5.88|
;;;845    			wc = ff_wtoupper(uc);		/* Convert it to upper case */
000036  9800              LDR      r0,[sp,#0]
000038  f7fffffe          BL       ff_wtoupper
00003c  9001              STR      r0,[sp,#4]
;;;846    			if (i >= _MAX_LFN || wc != ff_wtoupper(lfnbuf[i++]))	/* Compare it */
00003e  2e7f              CMP      r6,#0x7f
000040  da08              BGE      |L5.84|
000042  4631              MOV      r1,r6
000044  1c76              ADDS     r6,r6,#1
000046  0049              LSLS     r1,r1,#1
000048  5a68              LDRH     r0,[r5,r1]
00004a  f7fffffe          BL       ff_wtoupper
00004e  9901              LDR      r1,[sp,#4]
000050  4288              CMP      r0,r1
000052  d007              BEQ      |L5.100|
                  |L5.84|
;;;847    				return 0;				/* Not matched */
000054  2000              MOVS     r0,#0
                  |L5.86|
;;;848    		} else {
;;;849    			if (uc != 0xFFFF) return 0;	/* Check filler */
;;;850    		}
;;;851    	} while (++s < 13);				/* Repeat until all chars in the entry are checked */
;;;852    
;;;853    	if ((dir[LDIR_Ord] & 0x40) && wc && lfnbuf[i])	/* Last segment matched but different length */
;;;854    		return 0;
;;;855    
;;;856    	return 1;						/* The part of LFN matched */
;;;857    }
000056  bdfe              POP      {r1-r7,pc}
                  |L5.88|
000058  490d              LDR      r1,|L5.144|
00005a  9800              LDR      r0,[sp,#0]            ;849
00005c  4288              CMP      r0,r1                 ;849
00005e  d001              BEQ      |L5.100|
000060  2000              MOVS     r0,#0                 ;849
000062  e7f8              B        |L5.86|
                  |L5.100|
000064  1c78              ADDS     r0,r7,#1              ;851
000066  4607              MOV      r7,r0                 ;851
000068  280d              CMP      r0,#0xd               ;851
00006a  dbd7              BLT      |L5.28|
00006c  7820              LDRB     r0,[r4,#0]            ;853
00006e  2140              MOVS     r1,#0x40              ;853
000070  4008              ANDS     r0,r0,r1              ;853
000072  2800              CMP      r0,#0                 ;853
000074  d008              BEQ      |L5.136|
000076  9801              LDR      r0,[sp,#4]            ;853
000078  2800              CMP      r0,#0                 ;853
00007a  d005              BEQ      |L5.136|
00007c  0070              LSLS     r0,r6,#1              ;853
00007e  5a28              LDRH     r0,[r5,r0]            ;853
000080  2800              CMP      r0,#0                 ;853
000082  d001              BEQ      |L5.136|
000084  2000              MOVS     r0,#0                 ;854
000086  e7e6              B        |L5.86|
                  |L5.136|
000088  2001              MOVS     r0,#1                 ;856
00008a  e7e4              B        |L5.86|
;;;858    
                          ENDP

                  |L5.140|
                          DCD      LfnOfs
                  |L5.144|
                          DCD      0x0000ffff

                          AREA ||i.create_chain||, CODE, READONLY, ALIGN=2

                  create_chain PROC
;;;635    static
;;;636    DWORD create_chain (	/* 0:No free cluster, 1:Internal error, 0xFFFFFFFF:Disk error, >=2:New cluster# */
000000  b5f3              PUSH     {r0,r1,r4-r7,lr}
;;;637    	FATFS *fs,			/* File system object */
;;;638    	DWORD clst			/* Cluster# to stretch. 0 means create a new chain. */
;;;639    )
;;;640    {
000002  b081              SUB      sp,sp,#4
000004  4604              MOV      r4,r0
;;;641    	DWORD cs, ncl, scl;
;;;642    
;;;643    
;;;644    	if (clst == 0) {		/* Create a new chain */
000006  9802              LDR      r0,[sp,#8]
000008  2800              CMP      r0,#0
00000a  d107              BNE      |L6.28|
;;;645    		scl = fs->last_clust;			/* Get suggested start point */
00000c  68e7              LDR      r7,[r4,#0xc]
;;;646    		if (!scl || scl >= fs->n_fatent) scl = 1;
00000e  2f00              CMP      r7,#0
000010  d002              BEQ      |L6.24|
000012  69e0              LDR      r0,[r4,#0x1c]
000014  42b8              CMP      r0,r7
000016  d810              BHI      |L6.58|
                  |L6.24|
000018  2701              MOVS     r7,#1
00001a  e00e              B        |L6.58|
                  |L6.28|
;;;647    	}
;;;648    	else {					/* Stretch the current chain */
;;;649    		cs = get_fat(fs, clst);			/* Check the cluster status */
00001c  4620              MOV      r0,r4
00001e  9902              LDR      r1,[sp,#8]
000020  f7fffffe          BL       get_fat
000024  4606              MOV      r6,r0
;;;650    		if (cs < 2) return 1;			/* It is an invalid cluster */
000026  2e02              CMP      r6,#2
000028  d201              BCS      |L6.46|
00002a  2001              MOVS     r0,#1
                  |L6.44|
;;;651    		if (cs < fs->n_fatent) return cs;	/* It is already followed by next cluster */
;;;652    		scl = clst;
;;;653    	}
;;;654    
;;;655    	ncl = scl;				/* Start cluster */
;;;656    	for (;;) {
;;;657    		ncl++;							/* Next cluster */
;;;658    		if (ncl >= fs->n_fatent) {		/* Wrap around */
;;;659    			ncl = 2;
;;;660    			if (ncl > scl) return 0;	/* No free cluster */
;;;661    		}
;;;662    		cs = get_fat(fs, ncl);			/* Get the cluster status */
;;;663    		if (cs == 0) break;				/* Found a free cluster */
;;;664    		if (cs == 0xFFFFFFFF || cs == 1)/* An error occurred */
;;;665    			return cs;
;;;666    		if (ncl == scl) return 0;		/* No free cluster */
;;;667    	}
;;;668    
;;;669    	if (put_fat(fs, ncl, 0x0FFFFFFF))	/* Mark the new cluster "last link" */
;;;670    		return 0xFFFFFFFF;
;;;671    	if (clst != 0) {					/* Link it to the previous one if needed */
;;;672    		if (put_fat(fs, clst, ncl))
;;;673    			return 0xFFFFFFFF;
;;;674    	}
;;;675    
;;;676    	fs->last_clust = ncl;				/* Update FSINFO */
;;;677    	if (fs->free_clust != 0xFFFFFFFF) {
;;;678    		fs->free_clust--;
;;;679    		fs->fsi_flag = 1;
;;;680    	}
;;;681    
;;;682    	return ncl;		/* Return new cluster number */
;;;683    }
00002c  bdfe              POP      {r1-r7,pc}
                  |L6.46|
00002e  69e0              LDR      r0,[r4,#0x1c]         ;651
000030  42b0              CMP      r0,r6                 ;651
000032  d901              BLS      |L6.56|
000034  4630              MOV      r0,r6                 ;651
000036  e7f9              B        |L6.44|
                  |L6.56|
000038  9f02              LDR      r7,[sp,#8]            ;652
                  |L6.58|
00003a  463d              MOV      r5,r7                 ;655
00003c  bf00              NOP                            ;656
                  |L6.62|
00003e  1c6d              ADDS     r5,r5,#1              ;657
000040  69e0              LDR      r0,[r4,#0x1c]         ;658
000042  42a8              CMP      r0,r5                 ;658
000044  d804              BHI      |L6.80|
000046  2502              MOVS     r5,#2                 ;659
000048  42bd              CMP      r5,r7                 ;660
00004a  d901              BLS      |L6.80|
00004c  2000              MOVS     r0,#0                 ;660
00004e  e7ed              B        |L6.44|
                  |L6.80|
000050  4629              MOV      r1,r5                 ;662
000052  4620              MOV      r0,r4                 ;662
000054  f7fffffe          BL       get_fat
000058  4606              MOV      r6,r0                 ;662
00005a  2e00              CMP      r6,#0                 ;663
00005c  d100              BNE      |L6.96|
00005e  e00a              B        |L6.118|
                  |L6.96|
000060  1c70              ADDS     r0,r6,#1              ;664
000062  2800              CMP      r0,#0                 ;664
000064  d001              BEQ      |L6.106|
000066  2e01              CMP      r6,#1                 ;664
000068  d101              BNE      |L6.110|
                  |L6.106|
00006a  4630              MOV      r0,r6                 ;665
00006c  e7de              B        |L6.44|
                  |L6.110|
00006e  42bd              CMP      r5,r7                 ;666
000070  d1e5              BNE      |L6.62|
000072  2000              MOVS     r0,#0                 ;666
000074  e7da              B        |L6.44|
                  |L6.118|
000076  bf00              NOP                            ;663
000078  4a11              LDR      r2,|L6.192|
00007a  4629              MOV      r1,r5                 ;669
00007c  4620              MOV      r0,r4                 ;669
00007e  f7fffffe          BL       put_fat
000082  2800              CMP      r0,#0                 ;669
000084  d002              BEQ      |L6.140|
000086  2000              MOVS     r0,#0                 ;670
000088  43c0              MVNS     r0,r0                 ;670
00008a  e7cf              B        |L6.44|
                  |L6.140|
00008c  9802              LDR      r0,[sp,#8]            ;671
00008e  2800              CMP      r0,#0                 ;671
000090  d009              BEQ      |L6.166|
000092  462a              MOV      r2,r5                 ;672
000094  4620              MOV      r0,r4                 ;672
000096  9902              LDR      r1,[sp,#8]            ;672
000098  f7fffffe          BL       put_fat
00009c  2800              CMP      r0,#0                 ;672
00009e  d002              BEQ      |L6.166|
0000a0  2000              MOVS     r0,#0                 ;673
0000a2  43c0              MVNS     r0,r0                 ;673
0000a4  e7c2              B        |L6.44|
                  |L6.166|
0000a6  60e5              STR      r5,[r4,#0xc]          ;676
0000a8  6920              LDR      r0,[r4,#0x10]         ;677
0000aa  1c40              ADDS     r0,r0,#1              ;677
0000ac  2800              CMP      r0,#0                 ;677
0000ae  d004              BEQ      |L6.186|
0000b0  6920              LDR      r0,[r4,#0x10]         ;678
0000b2  1e40              SUBS     r0,r0,#1              ;678
0000b4  6120              STR      r0,[r4,#0x10]         ;678
0000b6  2001              MOVS     r0,#1                 ;679
0000b8  7160              STRB     r0,[r4,#5]            ;679
                  |L6.186|
0000ba  4628              MOV      r0,r5                 ;682
0000bc  e7b6              B        |L6.44|
;;;684    #endif /* !_FS_READONLY */
                          ENDP

0000be  0000              DCW      0x0000
                  |L6.192|
                          DCD      0x0fffffff

                          AREA ||i.create_name||, CODE, READONLY, ALIGN=2

                  create_name PROC
;;;1267   static
;;;1268   FRESULT create_name (
000000  b5f3              PUSH     {r0,r1,r4-r7,lr}
;;;1269   	DIR *dj,			/* Pointer to the directory object */
;;;1270   	const TCHAR **path	/* Pointer to pointer to the segment in the path string */
;;;1271   )
;;;1272   {
000002  b085              SUB      sp,sp,#0x14
;;;1273   #ifdef _EXCVT
;;;1274   	static const BYTE excvt[] = _EXCVT;	/* Upper conversion table for extended chars */
;;;1275   #endif
;;;1276   
;;;1277   #if _USE_LFN	/* LFN configuration */
;;;1278   	BYTE b, cf;
;;;1279   	WCHAR w, *lfn;
;;;1280   	int i, ni, si, di;
;;;1281   	const TCHAR *p;
;;;1282   
;;;1283   	/* Create LFN in Unicode */
;;;1284   	si = di = 0;
000004  2000              MOVS     r0,#0
000006  4605              MOV      r5,r0
000008  9001              STR      r0,[sp,#4]
;;;1285   	p = *path;
00000a  9806              LDR      r0,[sp,#0x18]
00000c  6800              LDR      r0,[r0,#0]
00000e  9000              STR      r0,[sp,#0]
;;;1286   	lfn = dj->lfn;
000010  9805              LDR      r0,[sp,#0x14]
000012  69c7              LDR      r7,[r0,#0x1c]
;;;1287   	for (;;) {
000014  bf00              NOP      
                  |L7.22|
;;;1288   		w = p[si++];					/* Get a character */
000016  9801              LDR      r0,[sp,#4]
000018  1c41              ADDS     r1,r0,#1
00001a  9101              STR      r1,[sp,#4]
00001c  9900              LDR      r1,[sp,#0]
00001e  5c0c              LDRB     r4,[r1,r0]
;;;1289   		if (w < ' ' || w == '/' || w == '\\') break;	/* Break on end of segment */
000020  2c20              CMP      r4,#0x20
000022  db03              BLT      |L7.44|
000024  2c2f              CMP      r4,#0x2f
000026  d001              BEQ      |L7.44|
000028  2c5c              CMP      r4,#0x5c
00002a  d100              BNE      |L7.46|
                  |L7.44|
00002c  e01d              B        |L7.106|
                  |L7.46|
;;;1290   		if (di >= _MAX_LFN)				/* Reject too long name */
00002e  2d7f              CMP      r5,#0x7f
000030  db02              BLT      |L7.56|
;;;1291   			return FR_INVALID_NAME;
000032  2006              MOVS     r0,#6
                  |L7.52|
;;;1292   #if !_LFN_UNICODE
;;;1293   		w &= 0xFF;
;;;1294   		if (IsDBCS1(w)) {				/* If it is a DBC 1st byte */
;;;1295   			b = p[si++];				/* Get 2nd byte */
;;;1296   			if (!IsDBCS2(b))			/* Reject invalid code for DBC */
;;;1297   				return FR_INVALID_NAME;
;;;1298   #if(IsDBCS2(b))
;;;1299   			w = (w << 8) + b;
;;;1300   #endif
;;;1301   		}
;;;1302   		w = ff_convert(w, 1);			/* Convert OEM to Unicode */
;;;1303   		if (!w) return FR_INVALID_NAME;	/* Reject invalid code */
;;;1304   #endif
;;;1305   		if (w < 0x80 && chk_chr("\"*:<>\?|\x7F", w)) /* Reject illegal chars for LFN */
;;;1306   			return FR_INVALID_NAME;
;;;1307   		lfn[di++] = w;					/* Store the Unicode char */
;;;1308   	}
;;;1309   	*path = &p[si];						/* Return pointer to the next segment */
;;;1310   	cf = (w < ' ') ? NS_LAST : 0;		/* Set last segment flag if end of path */
;;;1311   #if _FS_RPATH
;;;1312   	if ((di == 1 && lfn[di - 1] == '.') || /* Is this a dot entry? */
;;;1313   		(di == 2 && lfn[di - 1] == '.' && lfn[di - 2] == '.')) {
;;;1314   		lfn[di] = 0;
;;;1315   		for (i = 0; i < 11; i++)
;;;1316   			dj->fn[i] = (i < di) ? '.' : ' ';
;;;1317   		dj->fn[i] = cf | NS_DOT;		/* This is a dot entry */
;;;1318   		return FR_OK;
;;;1319   	}
;;;1320   #endif
;;;1321   	while (di) {						/* Strip trailing spaces and dots */
;;;1322   		w = lfn[di - 1];
;;;1323   		if (w != ' ' && w != '.') break;
;;;1324   		di--;
;;;1325   	}
;;;1326   	if (!di) return FR_INVALID_NAME;	/* Reject nul string */
;;;1327   
;;;1328   	lfn[di] = 0;						/* LFN is created */
;;;1329   
;;;1330   	/* Create SFN in directory form */
;;;1331   	mem_set(dj->fn, ' ', 11);
;;;1332   	for (si = 0; lfn[si] == ' ' || lfn[si] == '.'; si++) ;	/* Strip leading spaces and dots */
;;;1333   	if (si) cf |= NS_LOSS | NS_LFN;
;;;1334   	while (di && lfn[di - 1] != '.') di--;	/* Find extension (di<=si: no extension) */
;;;1335   
;;;1336   	b = i = 0; ni = 8;
;;;1337   	for (;;) {
;;;1338   		w = lfn[si++];					/* Get an LFN char */
;;;1339   		if (!w) break;					/* Break on end of the LFN */
;;;1340   		if (w == ' ' || (w == '.' && si != di)) {	/* Remove spaces and dots */
;;;1341   			cf |= NS_LOSS | NS_LFN; continue;
;;;1342   		}
;;;1343   
;;;1344   		if (i >= ni || si == di) {		/* Extension or end of SFN */
;;;1345   			if (ni == 11) {				/* Long extension */
;;;1346   				cf |= NS_LOSS | NS_LFN; break;
;;;1347   			}
;;;1348   			if (si != di) cf |= NS_LOSS | NS_LFN;	/* Out of 8.3 format */
;;;1349   			if (si > di) break;			/* No extension */
;;;1350   			si = di; i = 8; ni = 11;	/* Enter extension section */
;;;1351   			b <<= 2; continue;
;;;1352   		}
;;;1353   
;;;1354   		if (w >= 0x80) {				/* Non ASCII char */
;;;1355   #ifdef _EXCVT
;;;1356   			w = ff_convert(w, 0);		/* Unicode -> OEM code */
;;;1357   			if (w) w = excvt[w - 0x80];	/* Convert extended char to upper (SBCS) */
;;;1358   #else
;;;1359   			w = ff_convert(ff_wtoupper(w), 0);	/* Upper converted Unicode -> OEM code */
;;;1360   #endif
;;;1361   			cf |= NS_LFN;				/* Force create LFN entry */
;;;1362   		}
;;;1363   
;;;1364   		if (_DF1S && w >= 0x100) {		/* Double byte char */
;;;1365   			if (i >= ni - 1) {
;;;1366   				cf |= NS_LOSS | NS_LFN; i = ni; continue;
;;;1367   			}
;;;1368   			dj->fn[i++] = (BYTE)(w >> 8);
;;;1369   		} else {						/* Single byte char */
;;;1370   			if (!w || chk_chr("+,;=[]", w)) {		/* Replace illegal chars for SFN */
;;;1371   				w = '_'; cf |= NS_LOSS | NS_LFN;	/* Lossy conversion */
;;;1372   			} else {
;;;1373   				if (IsUpper(w)) {		/* ASCII large capital */
;;;1374   					b |= 2;
;;;1375   				} else {
;;;1376   					if (IsLower(w)) {	/* ASCII small capital */
;;;1377   						b |= 1; w -= 0x20;
;;;1378   					}
;;;1379   				}
;;;1380   			}
;;;1381   		}
;;;1382   		dj->fn[i++] = (BYTE)w;
;;;1383   	}
;;;1384   
;;;1385   	if (dj->fn[0] == 0xE5) dj->fn[0] = 0x05;	/* If the first char collides with deleted mark, replace it with 0x05 */
;;;1386   
;;;1387   	if (ni == 8) b <<= 2;
;;;1388   	if ((b & 0x0C) == 0x0C || (b & 0x03) == 0x03)	/* Create LFN entry when there are composite capitals */
;;;1389   		cf |= NS_LFN;
;;;1390   	if (!(cf & NS_LFN)) {						/* When LFN is in 8.3 format without extended char, NT flags are created */
;;;1391   		if ((b & 0x03) == 0x01) cf |= NS_EXT;	/* NT flag (Extension has only small capital) */
;;;1392   		if ((b & 0x0C) == 0x04) cf |= NS_BODY;	/* NT flag (Filename has only small capital) */
;;;1393   	}
;;;1394   
;;;1395   	dj->fn[NS] = cf;	/* SFN is created */
;;;1396   
;;;1397   	return FR_OK;
;;;1398   
;;;1399   
;;;1400   #else	/* Non-LFN configuration */
;;;1401   	BYTE b, c, d, *sfn;
;;;1402   	int ni, si, i;
;;;1403   	const char *p;
;;;1404   
;;;1405   	/* Create file name in directory form */
;;;1406   	sfn = dj->fn;
;;;1407   	mem_set(sfn, ' ', 11);
;;;1408   	si = i = b = 0; ni = 8;
;;;1409   	p = *path;
;;;1410   #if _FS_RPATH
;;;1411   	if (p[si] == '.') { /* Is this a dot entry? */
;;;1412   		for (;;) {
;;;1413   			c = (BYTE)p[si++];
;;;1414   			if (c != '.' || si >= 3) break;
;;;1415   			sfn[i++] = c;
;;;1416   		}
;;;1417   		if (c != '/' && c != '\\' && c > ' ') return FR_INVALID_NAME;
;;;1418   		*path = &p[si];									/* Return pointer to the next segment */
;;;1419   		sfn[NS] = (c <= ' ') ? NS_LAST | NS_DOT : NS_DOT;	/* Set last segment flag if end of path */
;;;1420   		return FR_OK;
;;;1421   	}
;;;1422   #endif
;;;1423   	for (;;) {
;;;1424   		c = (BYTE)p[si++];
;;;1425   		if (c <= ' ' || c == '/' || c == '\\') break;	/* Break on end of segment */
;;;1426   		if (c == '.' || i >= ni) {
;;;1427   			if (ni != 8 || c != '.') return FR_INVALID_NAME;
;;;1428   			i = 8; ni = 11;
;;;1429   			b <<= 2; continue;
;;;1430   		}
;;;1431   		if (c >= 0x80) {				/* Extended char */
;;;1432   #ifdef _EXCVT
;;;1433   			c = excvt[c - 0x80];		/* Convert extend char (SBCS) */
;;;1434   #else
;;;1435   			b |= 3;						/* Eliminate NT flag if extended char is exist */
;;;1436   #if !_DF1S	/* ASCII only cfg */
;;;1437   			return FR_INVALID_NAME;
;;;1438   #endif
;;;1439   #endif
;;;1440   		}
;;;1441   		if (IsDBCS1(c)) {				/* DBC 1st byte? */
;;;1442   			d = (BYTE)p[si++];			/* Get 2nd byte */
;;;1443   			if (!IsDBCS2(d) || i >= ni - 1)	/* Reject invalid DBC */
;;;1444   				return FR_INVALID_NAME;
;;;1445   			sfn[i++] = c;
;;;1446   			sfn[i++] = d;
;;;1447   		} else {						/* Single byte code */
;;;1448   			if (chk_chr("\"*+,:<=>\?[]|\x7F", c))	/* Reject illegal chrs for SFN */
;;;1449   				return FR_INVALID_NAME;
;;;1450   			if (IsUpper(c)) {			/* ASCII large capital? */
;;;1451   				b |= 2;
;;;1452   			} else {
;;;1453   				if (IsLower(c)) {		/* ASCII small capital? */
;;;1454   					b |= 1; c -= 0x20;
;;;1455   				}
;;;1456   			}
;;;1457   			sfn[i++] = c;
;;;1458   		}
;;;1459   	}
;;;1460   	*path = &p[si];						/* Return pointer to the next segment */
;;;1461   	c = (c <= ' ') ? NS_LAST : 0;		/* Set last segment flag if end of path */
;;;1462   
;;;1463   	if (!i) return FR_INVALID_NAME;		/* Reject nul string */
;;;1464   	if (sfn[0] == 0xE5) sfn[0] = 0x05;	/* When first char collides with 0xE5, replace it with 0x05 */
;;;1465   
;;;1466   	if (ni == 8) b <<= 2;
;;;1467   	if ((b & 0x03) == 0x01) c |= NS_EXT;	/* NT flag (Name extension has only small capital) */
;;;1468   	if ((b & 0x0C) == 0x04) c |= NS_BODY;	/* NT flag (Name body has only small capital) */
;;;1469   
;;;1470   	sfn[NS] = c;		/* Store NT flag, File name is created */
;;;1471   
;;;1472   	return FR_OK;
;;;1473   #endif
;;;1474   }
000034  b007              ADD      sp,sp,#0x1c
000036  bdf0              POP      {r4-r7,pc}
                  |L7.56|
000038  b2e4              UXTB     r4,r4                 ;1293
00003a  2101              MOVS     r1,#1                 ;1302
00003c  4620              MOV      r0,r4                 ;1302
00003e  f7fffffe          BL       ff_convert
000042  4604              MOV      r4,r0                 ;1302
000044  2c00              CMP      r4,#0                 ;1303
000046  d101              BNE      |L7.76|
000048  2006              MOVS     r0,#6                 ;1303
00004a  e7f3              B        |L7.52|
                  |L7.76|
00004c  2c80              CMP      r4,#0x80              ;1305
00004e  da07              BGE      |L7.96|
000050  4621              MOV      r1,r4                 ;1305
000052  a091              ADR      r0,|L7.664|
000054  f7fffffe          BL       chk_chr
000058  2800              CMP      r0,#0                 ;1305
00005a  d001              BEQ      |L7.96|
00005c  2006              MOVS     r0,#6                 ;1306
00005e  e7e9              B        |L7.52|
                  |L7.96|
000060  4628              MOV      r0,r5                 ;1307
000062  1c6d              ADDS     r5,r5,#1              ;1307
000064  0040              LSLS     r0,r0,#1              ;1307
000066  523c              STRH     r4,[r7,r0]            ;1307
000068  e7d5              B        |L7.22|
                  |L7.106|
00006a  bf00              NOP                            ;1289
00006c  9901              LDR      r1,[sp,#4]            ;1309
00006e  9800              LDR      r0,[sp,#0]            ;1309
000070  1841              ADDS     r1,r0,r1              ;1309
000072  9806              LDR      r0,[sp,#0x18]         ;1309
000074  6001              STR      r1,[r0,#0]            ;1309
000076  2c20              CMP      r4,#0x20              ;1310
000078  da01              BGE      |L7.126|
00007a  2004              MOVS     r0,#4                 ;1310
00007c  e000              B        |L7.128|
                  |L7.126|
00007e  2000              MOVS     r0,#0                 ;1310
                  |L7.128|
000080  4606              MOV      r6,r0                 ;1310
000082  2d01              CMP      r5,#1                 ;1312
000084  d104              BNE      |L7.144|
000086  1e68              SUBS     r0,r5,#1              ;1312
000088  0040              LSLS     r0,r0,#1              ;1312
00008a  5a38              LDRH     r0,[r7,r0]            ;1312
00008c  282e              CMP      r0,#0x2e              ;1312
00008e  d00b              BEQ      |L7.168|
                  |L7.144|
000090  2d02              CMP      r5,#2                 ;1313
000092  d126              BNE      |L7.226|
000094  1e68              SUBS     r0,r5,#1              ;1313
000096  0040              LSLS     r0,r0,#1              ;1313
000098  5a38              LDRH     r0,[r7,r0]            ;1313
00009a  282e              CMP      r0,#0x2e              ;1313
00009c  d121              BNE      |L7.226|
00009e  1ea8              SUBS     r0,r5,#2              ;1313
0000a0  0040              LSLS     r0,r0,#1              ;1313
0000a2  5a38              LDRH     r0,[r7,r0]            ;1313
0000a4  282e              CMP      r0,#0x2e              ;1313
0000a6  d11c              BNE      |L7.226|
                  |L7.168|
0000a8  2000              MOVS     r0,#0                 ;1314
0000aa  0069              LSLS     r1,r5,#1              ;1314
0000ac  5278              STRH     r0,[r7,r1]            ;1314
0000ae  9003              STR      r0,[sp,#0xc]          ;1315
0000b0  e00c              B        |L7.204|
                  |L7.178|
0000b2  9803              LDR      r0,[sp,#0xc]          ;1316
0000b4  42a8              CMP      r0,r5                 ;1316
0000b6  da01              BGE      |L7.188|
0000b8  212e              MOVS     r1,#0x2e              ;1316
0000ba  e000              B        |L7.190|
                  |L7.188|
0000bc  2120              MOVS     r1,#0x20              ;1316
                  |L7.190|
0000be  9805              LDR      r0,[sp,#0x14]         ;1316
0000c0  6982              LDR      r2,[r0,#0x18]         ;1316
0000c2  9803              LDR      r0,[sp,#0xc]          ;1316
0000c4  5411              STRB     r1,[r2,r0]            ;1316
0000c6  9803              LDR      r0,[sp,#0xc]          ;1315
0000c8  1c40              ADDS     r0,r0,#1              ;1315
0000ca  9003              STR      r0,[sp,#0xc]          ;1315
                  |L7.204|
0000cc  9803              LDR      r0,[sp,#0xc]          ;1315
0000ce  280b              CMP      r0,#0xb               ;1315
0000d0  dbef              BLT      |L7.178|
0000d2  2020              MOVS     r0,#0x20              ;1317
0000d4  4330              ORRS     r0,r0,r6              ;1317
0000d6  9905              LDR      r1,[sp,#0x14]         ;1317
0000d8  698a              LDR      r2,[r1,#0x18]         ;1317
0000da  9903              LDR      r1,[sp,#0xc]          ;1317
0000dc  5450              STRB     r0,[r2,r1]            ;1317
0000de  2000              MOVS     r0,#0                 ;1318
0000e0  e7a8              B        |L7.52|
                  |L7.226|
0000e2  e008              B        |L7.246|
                  |L7.228|
0000e4  1e68              SUBS     r0,r5,#1              ;1322
0000e6  0040              LSLS     r0,r0,#1              ;1322
0000e8  5a3c              LDRH     r4,[r7,r0]            ;1322
0000ea  2c20              CMP      r4,#0x20              ;1323
0000ec  d002              BEQ      |L7.244|
0000ee  2c2e              CMP      r4,#0x2e              ;1323
0000f0  d000              BEQ      |L7.244|
0000f2  e002              B        |L7.250|
                  |L7.244|
0000f4  1e6d              SUBS     r5,r5,#1              ;1324
                  |L7.246|
0000f6  2d00              CMP      r5,#0                 ;1321
0000f8  d1f4              BNE      |L7.228|
                  |L7.250|
0000fa  bf00              NOP                            ;1323
0000fc  2d00              CMP      r5,#0                 ;1326
0000fe  d101              BNE      |L7.260|
000100  2006              MOVS     r0,#6                 ;1326
000102  e797              B        |L7.52|
                  |L7.260|
000104  2000              MOVS     r0,#0                 ;1328
000106  0069              LSLS     r1,r5,#1              ;1328
000108  5278              STRH     r0,[r7,r1]            ;1328
00010a  9905              LDR      r1,[sp,#0x14]         ;1331
00010c  220b              MOVS     r2,#0xb               ;1331
00010e  6988              LDR      r0,[r1,#0x18]         ;1331
000110  2120              MOVS     r1,#0x20              ;1331
000112  f7fffffe          BL       mem_set
000116  2000              MOVS     r0,#0                 ;1332
000118  9001              STR      r0,[sp,#4]            ;1332
00011a  e002              B        |L7.290|
                  |L7.284|
00011c  9801              LDR      r0,[sp,#4]            ;1332
00011e  1c40              ADDS     r0,r0,#1              ;1332
000120  9001              STR      r0,[sp,#4]            ;1332
                  |L7.290|
000122  9801              LDR      r0,[sp,#4]            ;1332
000124  0040              LSLS     r0,r0,#1              ;1332
000126  5a38              LDRH     r0,[r7,r0]            ;1332
000128  2820              CMP      r0,#0x20              ;1332
00012a  d0f7              BEQ      |L7.284|
00012c  9801              LDR      r0,[sp,#4]            ;1332
00012e  0040              LSLS     r0,r0,#1              ;1332
000130  5a38              LDRH     r0,[r7,r0]            ;1332
000132  282e              CMP      r0,#0x2e              ;1332
000134  d0f2              BEQ      |L7.284|
000136  9801              LDR      r0,[sp,#4]            ;1333
000138  2800              CMP      r0,#0                 ;1333
00013a  d001              BEQ      |L7.320|
00013c  2003              MOVS     r0,#3                 ;1333
00013e  4306              ORRS     r6,r6,r0              ;1333
                  |L7.320|
000140  e000              B        |L7.324|
                  |L7.322|
000142  1e6d              SUBS     r5,r5,#1              ;1334
                  |L7.324|
000144  2d00              CMP      r5,#0                 ;1334
000146  d004              BEQ      |L7.338|
000148  1e68              SUBS     r0,r5,#1              ;1334
00014a  0040              LSLS     r0,r0,#1              ;1334
00014c  5a38              LDRH     r0,[r7,r0]            ;1334
00014e  282e              CMP      r0,#0x2e              ;1334
000150  d1f7              BNE      |L7.322|
                  |L7.338|
000152  2000              MOVS     r0,#0                 ;1336
000154  9003              STR      r0,[sp,#0xc]          ;1336
000156  9004              STR      r0,[sp,#0x10]         ;1336
000158  2008              MOVS     r0,#8                 ;1336
00015a  9002              STR      r0,[sp,#8]            ;1336
00015c  bf00              NOP                            ;1337
                  |L7.350|
00015e  9801              LDR      r0,[sp,#4]            ;1338
000160  1c41              ADDS     r1,r0,#1              ;1338
000162  0040              LSLS     r0,r0,#1              ;1338
000164  9101              STR      r1,[sp,#4]            ;1338
000166  5a3c              LDRH     r4,[r7,r0]            ;1338
000168  2c00              CMP      r4,#0                 ;1339
00016a  d100              BNE      |L7.366|
00016c  e060              B        |L7.560|
                  |L7.366|
00016e  2c20              CMP      r4,#0x20              ;1340
000170  d004              BEQ      |L7.380|
000172  2c2e              CMP      r4,#0x2e              ;1340
000174  d105              BNE      |L7.386|
000176  9801              LDR      r0,[sp,#4]            ;1340
000178  42a8              CMP      r0,r5                 ;1340
00017a  d002              BEQ      |L7.386|
                  |L7.380|
00017c  2003              MOVS     r0,#3                 ;1341
00017e  4306              ORRS     r6,r6,r0              ;1341
000180  e7ed              B        |L7.350|
                  |L7.386|
000182  9902              LDR      r1,[sp,#8]            ;1344
000184  9803              LDR      r0,[sp,#0xc]          ;1344
000186  4288              CMP      r0,r1                 ;1344
000188  da02              BGE      |L7.400|
00018a  9801              LDR      r0,[sp,#4]            ;1344
00018c  42a8              CMP      r0,r5                 ;1344
00018e  d118              BNE      |L7.450|
                  |L7.400|
000190  9802              LDR      r0,[sp,#8]            ;1345
000192  280b              CMP      r0,#0xb               ;1345
000194  d102              BNE      |L7.412|
000196  2003              MOVS     r0,#3                 ;1346
000198  4306              ORRS     r6,r6,r0              ;1346
00019a  e049              B        |L7.560|
                  |L7.412|
00019c  9801              LDR      r0,[sp,#4]            ;1348
00019e  42a8              CMP      r0,r5                 ;1348
0001a0  d001              BEQ      |L7.422|
0001a2  2003              MOVS     r0,#3                 ;1348
0001a4  4306              ORRS     r6,r6,r0              ;1348
                  |L7.422|
0001a6  9801              LDR      r0,[sp,#4]            ;1349
0001a8  42a8              CMP      r0,r5                 ;1349
0001aa  dd00              BLE      |L7.430|
0001ac  e040              B        |L7.560|
                  |L7.430|
0001ae  9501              STR      r5,[sp,#4]            ;1350
0001b0  2008              MOVS     r0,#8                 ;1350
0001b2  9003              STR      r0,[sp,#0xc]          ;1350
0001b4  200b              MOVS     r0,#0xb               ;1350
0001b6  9002              STR      r0,[sp,#8]            ;1350
0001b8  9804              LDR      r0,[sp,#0x10]         ;1351
0001ba  0680              LSLS     r0,r0,#26             ;1351
0001bc  0e00              LSRS     r0,r0,#24             ;1351
0001be  9004              STR      r0,[sp,#0x10]         ;1351
0001c0  e7cd              B        |L7.350|
                  |L7.450|
0001c2  2c80              CMP      r4,#0x80              ;1354
0001c4  db0c              BLT      |L7.480|
0001c6  2100              MOVS     r1,#0                 ;1356
0001c8  4620              MOV      r0,r4                 ;1356
0001ca  f7fffffe          BL       ff_convert
0001ce  4604              MOV      r4,r0                 ;1356
0001d0  2c00              CMP      r4,#0                 ;1357
0001d2  d003              BEQ      |L7.476|
0001d4  4620              MOV      r0,r4                 ;1357
0001d6  3880              SUBS     r0,r0,#0x80           ;1357
0001d8  4932              LDR      r1,|L7.676|
0001da  5c0c              LDRB     r4,[r1,r0]            ;1357
                  |L7.476|
0001dc  2002              MOVS     r0,#2                 ;1361
0001de  4306              ORRS     r6,r6,r0              ;1361
                  |L7.480|
0001e0  bf00              NOP                            ;1364
0001e2  2c00              CMP      r4,#0                 ;1370
0001e4  d005              BEQ      |L7.498|
0001e6  4621              MOV      r1,r4                 ;1370
0001e8  a02f              ADR      r0,|L7.680|
0001ea  f7fffffe          BL       chk_chr
0001ee  2800              CMP      r0,#0                 ;1370
0001f0  d003              BEQ      |L7.506|
                  |L7.498|
0001f2  245f              MOVS     r4,#0x5f              ;1371
0001f4  2003              MOVS     r0,#3                 ;1371
0001f6  4306              ORRS     r6,r6,r0              ;1371
0001f8  e013              B        |L7.546|
                  |L7.506|
0001fa  2c41              CMP      r4,#0x41              ;1373
0001fc  db06              BLT      |L7.524|
0001fe  2c5a              CMP      r4,#0x5a              ;1373
000200  dc04              BGT      |L7.524|
000202  2102              MOVS     r1,#2                 ;1374
000204  9804              LDR      r0,[sp,#0x10]         ;1374
000206  4308              ORRS     r0,r0,r1              ;1374
000208  9004              STR      r0,[sp,#0x10]         ;1374
00020a  e00a              B        |L7.546|
                  |L7.524|
00020c  2c61              CMP      r4,#0x61              ;1376
00020e  db08              BLT      |L7.546|
000210  2c7a              CMP      r4,#0x7a              ;1376
000212  dc06              BGT      |L7.546|
000214  2101              MOVS     r1,#1                 ;1377
000216  9804              LDR      r0,[sp,#0x10]         ;1377
000218  4308              ORRS     r0,r0,r1              ;1377
00021a  9004              STR      r0,[sp,#0x10]         ;1377
00021c  4620              MOV      r0,r4                 ;1377
00021e  3820              SUBS     r0,r0,#0x20           ;1377
000220  b284              UXTH     r4,r0                 ;1377
                  |L7.546|
000222  9805              LDR      r0,[sp,#0x14]         ;1382
000224  6982              LDR      r2,[r0,#0x18]         ;1382
000226  9803              LDR      r0,[sp,#0xc]          ;1382
000228  1c43              ADDS     r3,r0,#1              ;1382
00022a  9303              STR      r3,[sp,#0xc]          ;1382
00022c  5414              STRB     r4,[r2,r0]            ;1382
00022e  e796              B        |L7.350|
                  |L7.560|
000230  bf00              NOP                            ;1339
000232  9805              LDR      r0,[sp,#0x14]         ;1385
000234  6980              LDR      r0,[r0,#0x18]         ;1385
000236  7800              LDRB     r0,[r0,#0]            ;1385
000238  28e5              CMP      r0,#0xe5              ;1385
00023a  d103              BNE      |L7.580|
00023c  2105              MOVS     r1,#5                 ;1385
00023e  9805              LDR      r0,[sp,#0x14]         ;1385
000240  6980              LDR      r0,[r0,#0x18]         ;1385
000242  7001              STRB     r1,[r0,#0]            ;1385
                  |L7.580|
000244  9802              LDR      r0,[sp,#8]            ;1387
000246  2808              CMP      r0,#8                 ;1387
000248  d103              BNE      |L7.594|
00024a  9804              LDR      r0,[sp,#0x10]         ;1387
00024c  0680              LSLS     r0,r0,#26             ;1387
00024e  0e00              LSRS     r0,r0,#24             ;1387
000250  9004              STR      r0,[sp,#0x10]         ;1387
                  |L7.594|
000252  210c              MOVS     r1,#0xc               ;1388
000254  9804              LDR      r0,[sp,#0x10]         ;1388
000256  4008              ANDS     r0,r0,r1              ;1388
000258  280c              CMP      r0,#0xc               ;1388
00025a  d004              BEQ      |L7.614|
00025c  9804              LDR      r0,[sp,#0x10]         ;1388
00025e  0780              LSLS     r0,r0,#30             ;1388
000260  0f80              LSRS     r0,r0,#30             ;1388
000262  2803              CMP      r0,#3                 ;1388
000264  d101              BNE      |L7.618|
                  |L7.614|
000266  2002              MOVS     r0,#2                 ;1389
000268  4306              ORRS     r6,r6,r0              ;1389
                  |L7.618|
00026a  2002              MOVS     r0,#2                 ;1390
00026c  4030              ANDS     r0,r0,r6              ;1390
00026e  2800              CMP      r0,#0                 ;1390
000270  d10d              BNE      |L7.654|
000272  9804              LDR      r0,[sp,#0x10]         ;1391
000274  0780              LSLS     r0,r0,#30             ;1391
000276  0f80              LSRS     r0,r0,#30             ;1391
000278  2801              CMP      r0,#1                 ;1391
00027a  d101              BNE      |L7.640|
00027c  2010              MOVS     r0,#0x10              ;1391
00027e  4306              ORRS     r6,r6,r0              ;1391
                  |L7.640|
000280  210c              MOVS     r1,#0xc               ;1392
000282  9804              LDR      r0,[sp,#0x10]         ;1392
000284  4008              ANDS     r0,r0,r1              ;1392
000286  2804              CMP      r0,#4                 ;1392
000288  d101              BNE      |L7.654|
00028a  2008              MOVS     r0,#8                 ;1392
00028c  4306              ORRS     r6,r6,r0              ;1392
                  |L7.654|
00028e  9805              LDR      r0,[sp,#0x14]         ;1395
000290  6980              LDR      r0,[r0,#0x18]         ;1395
000292  72c6              STRB     r6,[r0,#0xb]          ;1395
000294  2000              MOVS     r0,#0                 ;1397
000296  e6cd              B        |L7.52|
;;;1475   
                          ENDP

                  |L7.664|
000298  222a3a3c          DCB      """*:<>?|",127,0
00029c  3e3f7c7f
0002a0  00      
0002a1  00                DCB      0
0002a2  00                DCB      0
0002a3  00                DCB      0
                  |L7.676|
                          DCD      excvt
                  |L7.680|
0002a8  2b2c3b3d          DCB      "+,;=[]",0
0002ac  5b5d00  
0002af  00                DCB      0

                          AREA ||i.dir_find||, CODE, READONLY, ALIGN=1

                  dir_find PROC
;;;998    static
;;;999    FRESULT dir_find (
000000  b5fe              PUSH     {r1-r7,lr}
;;;1000   	DIR *dj			/* Pointer to the directory object linked to the file name */
;;;1001   )
;;;1002   {
000002  4604              MOV      r4,r0
;;;1003   	FRESULT res;
;;;1004   	BYTE c, *dir;
;;;1005   #if _USE_LFN
;;;1006   	BYTE a, ord, sum;
;;;1007   #endif
;;;1008   
;;;1009   	res = dir_sdi(dj, 0);			/* Rewind directory object */
000004  2100              MOVS     r1,#0
000006  4620              MOV      r0,r4
000008  f7fffffe          BL       dir_sdi
00000c  4607              MOV      r7,r0
;;;1010   	if (res != FR_OK) return res;
00000e  2f00              CMP      r7,#0
000010  d001              BEQ      |L8.22|
000012  4638              MOV      r0,r7
                  |L8.20|
;;;1011   
;;;1012   #if _USE_LFN
;;;1013   	ord = sum = 0xFF;
;;;1014   #endif
;;;1015   	do {
;;;1016   		res = move_window(dj->fs, dj->sect);
;;;1017   		if (res != FR_OK) break;
;;;1018   		dir = dj->dir;					/* Ptr to the directory entry of current index */
;;;1019   		c = dir[DIR_Name];
;;;1020   		if (c == 0) { res = FR_NO_FILE; break; }	/* Reached to end of table */
;;;1021   #if _USE_LFN	/* LFN configuration */
;;;1022   		a = dir[DIR_Attr] & AM_MASK;
;;;1023   		if (c == 0xE5 || ((a & AM_VOL) && a != AM_LFN)) {	/* An entry without valid data */
;;;1024   			ord = 0xFF;
;;;1025   		} else {
;;;1026   			if (a == AM_LFN) {			/* An LFN entry is found */
;;;1027   				if (dj->lfn) {
;;;1028   					if (c & 0x40) {		/* Is it start of LFN sequence? */
;;;1029   						sum = dir[LDIR_Chksum];
;;;1030   						c &= 0xBF; ord = c;	/* LFN start order */
;;;1031   						dj->lfn_idx = dj->index;
;;;1032   					}
;;;1033   					/* Check validity of the LFN entry and compare it with given name */
;;;1034   					ord = (c == ord && sum == dir[LDIR_Chksum] && cmp_lfn(dj->lfn, dir)) ? ord - 1 : 0xFF;
;;;1035   				}
;;;1036   			} else {					/* An SFN entry is found */
;;;1037   				if (!ord && sum == sum_sfn(dir)) break;	/* LFN matched? */
;;;1038   				ord = 0xFF; dj->lfn_idx = 0xFFFF;	/* Reset LFN sequence */
;;;1039   				if (!(dj->fn[NS] & NS_LOSS) && !mem_cmp(dir, dj->fn, 11)) break;	/* SFN matched? */
;;;1040   			}
;;;1041   		}
;;;1042   #else		/* Non LFN configuration */
;;;1043   		if (!(dir[DIR_Attr] & AM_VOL) && !mem_cmp(dir, dj->fn, 11)) /* Is it a valid entry? */
;;;1044   			break;
;;;1045   #endif
;;;1046   		res = dir_next(dj, 0);		/* Next entry */
;;;1047   	} while (res == FR_OK);
;;;1048   
;;;1049   	return res;
;;;1050   }
000014  bdfe              POP      {r1-r7,pc}
                  |L8.22|
000016  20ff              MOVS     r0,#0xff              ;1013
000018  9000              STR      r0,[sp,#0]            ;1013
00001a  9001              STR      r0,[sp,#4]            ;1013
00001c  bf00              NOP                            ;1015
                  |L8.30|
00001e  6921              LDR      r1,[r4,#0x10]         ;1016
000020  6820              LDR      r0,[r4,#0]            ;1016
000022  f7fffffe          BL       move_window
000026  4607              MOV      r7,r0                 ;1016
000028  2f00              CMP      r7,#0                 ;1017
00002a  d000              BEQ      |L8.46|
00002c  e05f              B        |L8.238|
                  |L8.46|
00002e  6965              LDR      r5,[r4,#0x14]         ;1018
000030  782e              LDRB     r6,[r5,#0]            ;1019
000032  2e00              CMP      r6,#0                 ;1020
000034  d101              BNE      |L8.58|
000036  2704              MOVS     r7,#4                 ;1020
000038  e059              B        |L8.238|
                  |L8.58|
00003a  7ae8              LDRB     r0,[r5,#0xb]          ;1022
00003c  0680              LSLS     r0,r0,#26             ;1022
00003e  0e80              LSRS     r0,r0,#26             ;1022
000040  9002              STR      r0,[sp,#8]            ;1022
000042  2ee5              CMP      r6,#0xe5              ;1023
000044  d007              BEQ      |L8.86|
000046  2108              MOVS     r1,#8                 ;1023
000048  9802              LDR      r0,[sp,#8]            ;1023
00004a  4008              ANDS     r0,r0,r1              ;1023
00004c  2800              CMP      r0,#0                 ;1023
00004e  d005              BEQ      |L8.92|
000050  9802              LDR      r0,[sp,#8]            ;1023
000052  280f              CMP      r0,#0xf               ;1023
000054  d002              BEQ      |L8.92|
                  |L8.86|
000056  20ff              MOVS     r0,#0xff              ;1024
000058  9001              STR      r0,[sp,#4]            ;1024
00005a  e041              B        |L8.224|
                  |L8.92|
00005c  9802              LDR      r0,[sp,#8]            ;1026
00005e  280f              CMP      r0,#0xf               ;1026
000060  d121              BNE      |L8.166|
000062  69e0              LDR      r0,[r4,#0x1c]         ;1027
000064  2800              CMP      r0,#0                 ;1027
000066  d03b              BEQ      |L8.224|
000068  2040              MOVS     r0,#0x40              ;1028
00006a  4030              ANDS     r0,r0,r6              ;1028
00006c  2800              CMP      r0,#0                 ;1028
00006e  d006              BEQ      |L8.126|
000070  7b68              LDRB     r0,[r5,#0xd]          ;1029
000072  9000              STR      r0,[sp,#0]            ;1029
000074  20bf              MOVS     r0,#0xbf              ;1030
000076  4006              ANDS     r6,r6,r0              ;1030
000078  9601              STR      r6,[sp,#4]            ;1030
00007a  88e0              LDRH     r0,[r4,#6]            ;1031
00007c  8420              STRH     r0,[r4,#0x20]         ;1031
                  |L8.126|
00007e  9801              LDR      r0,[sp,#4]            ;1034
000080  4286              CMP      r6,r0                 ;1034
000082  d10c              BNE      |L8.158|
000084  7b69              LDRB     r1,[r5,#0xd]          ;1034
000086  9800              LDR      r0,[sp,#0]            ;1034
000088  4281              CMP      r1,r0                 ;1034
00008a  d108              BNE      |L8.158|
00008c  4629              MOV      r1,r5                 ;1034
00008e  69e0              LDR      r0,[r4,#0x1c]         ;1034
000090  f7fffffe          BL       cmp_lfn
000094  2800              CMP      r0,#0                 ;1034
000096  d002              BEQ      |L8.158|
000098  9801              LDR      r0,[sp,#4]            ;1034
00009a  1e40              SUBS     r0,r0,#1              ;1034
00009c  e000              B        |L8.160|
                  |L8.158|
00009e  20ff              MOVS     r0,#0xff              ;1034
                  |L8.160|
0000a0  b2c0              UXTB     r0,r0                 ;1034
0000a2  9001              STR      r0,[sp,#4]            ;1034
0000a4  e01c              B        |L8.224|
                  |L8.166|
0000a6  9801              LDR      r0,[sp,#4]            ;1037
0000a8  2800              CMP      r0,#0                 ;1037
0000aa  d106              BNE      |L8.186|
0000ac  4628              MOV      r0,r5                 ;1037
0000ae  f7fffffe          BL       sum_sfn
0000b2  9900              LDR      r1,[sp,#0]            ;1037
0000b4  4288              CMP      r0,r1                 ;1037
0000b6  d100              BNE      |L8.186|
0000b8  e019              B        |L8.238|
                  |L8.186|
0000ba  20ff              MOVS     r0,#0xff              ;1038
0000bc  9001              STR      r0,[sp,#4]            ;1038
0000be  2000              MOVS     r0,#0                 ;1038
0000c0  43c0              MVNS     r0,r0                 ;1038
0000c2  8420              STRH     r0,[r4,#0x20]         ;1038
0000c4  69a0              LDR      r0,[r4,#0x18]         ;1039
0000c6  7ac0              LDRB     r0,[r0,#0xb]          ;1039
0000c8  07c0              LSLS     r0,r0,#31             ;1039
0000ca  0fc0              LSRS     r0,r0,#31             ;1039
0000cc  2800              CMP      r0,#0                 ;1039
0000ce  d107              BNE      |L8.224|
0000d0  220b              MOVS     r2,#0xb               ;1039
0000d2  4628              MOV      r0,r5                 ;1039
0000d4  69a1              LDR      r1,[r4,#0x18]         ;1039
0000d6  f7fffffe          BL       mem_cmp
0000da  2800              CMP      r0,#0                 ;1039
0000dc  d100              BNE      |L8.224|
0000de  e006              B        |L8.238|
                  |L8.224|
0000e0  2100              MOVS     r1,#0                 ;1046
0000e2  4620              MOV      r0,r4                 ;1046
0000e4  f7fffffe          BL       dir_next
0000e8  4607              MOV      r7,r0                 ;1046
0000ea  2f00              CMP      r7,#0                 ;1047
0000ec  d097              BEQ      |L8.30|
                  |L8.238|
0000ee  bf00              NOP                            ;1017
0000f0  4638              MOV      r0,r7                 ;1049
0000f2  e78f              B        |L8.20|
;;;1051   
                          ENDP


                          AREA ||i.dir_next||, CODE, READONLY, ALIGN=1

                  dir_next PROC
;;;759    static
;;;760    FRESULT dir_next (	/* FR_OK:Succeeded, FR_NO_FILE:End of table, FR_DENIED:EOT and could not stretch */
000000  b5f3              PUSH     {r0,r1,r4-r7,lr}
;;;761    	DIR *dj,		/* Pointer to directory object */
;;;762    	int stretch		/* 0: Do not stretch table, 1: Stretch table if needed */
;;;763    )
;;;764    {
000002  b081              SUB      sp,sp,#4
000004  4604              MOV      r4,r0
;;;765    	DWORD clst;
;;;766    	WORD i;
;;;767    
;;;768    
;;;769    	i = dj->index + 1;
000006  88e0              LDRH     r0,[r4,#6]
000008  1c40              ADDS     r0,r0,#1
00000a  b286              UXTH     r6,r0
;;;770    	if (!i || !dj->sect)	/* Report EOT when index has reached 65535 */
00000c  2e00              CMP      r6,#0
00000e  d002              BEQ      |L9.22|
000010  6920              LDR      r0,[r4,#0x10]
000012  2800              CMP      r0,#0
000014  d101              BNE      |L9.26|
                  |L9.22|
;;;771    		return FR_NO_FILE;
000016  2004              MOVS     r0,#4
                  |L9.24|
;;;772    
;;;773    	if (!(i % (SS(dj->fs) / 32))) {	/* Sector changed? */
;;;774    		dj->sect++;					/* Next sector */
;;;775    
;;;776    		if (dj->clust == 0) {	/* Static table */
;;;777    			if (i >= dj->fs->n_rootdir)	/* Report EOT when end of table */
;;;778    				return FR_NO_FILE;
;;;779    		}
;;;780    		else {					/* Dynamic table */
;;;781    			if (((i / (SS(dj->fs) / 32)) & (dj->fs->csize - 1)) == 0) {	/* Cluster changed? */
;;;782    				clst = get_fat(dj->fs, dj->clust);				/* Get next cluster */
;;;783    				if (clst <= 1) return FR_INT_ERR;
;;;784    				if (clst == 0xFFFFFFFF) return FR_DISK_ERR;
;;;785    				if (clst >= dj->fs->n_fatent) {					/* When it reached end of dynamic table */
;;;786    #if !_FS_READONLY
;;;787    					BYTE c;
;;;788    					if (!stretch) return FR_NO_FILE;			/* When do not stretch, report EOT */
;;;789    					clst = create_chain(dj->fs, dj->clust);		/* Stretch cluster chain */
;;;790    					if (clst == 0) return FR_DENIED;			/* No free cluster */
;;;791    					if (clst == 1) return FR_INT_ERR;
;;;792    					if (clst == 0xFFFFFFFF) return FR_DISK_ERR;
;;;793    					/* Clean-up stretched table */
;;;794    					if (move_window(dj->fs, 0)) return FR_DISK_ERR;	/* Flush active window */
;;;795    					mem_set(dj->fs->win, 0, SS(dj->fs));			/* Clear window buffer */
;;;796    					dj->fs->winsect = clust2sect(dj->fs, clst);	/* Cluster start sector */
;;;797    					for (c = 0; c < dj->fs->csize; c++) {		/* Fill the new cluster with 0 */
;;;798    						dj->fs->wflag = 1;
;;;799    						if (move_window(dj->fs, 0)) return FR_DISK_ERR;
;;;800    						dj->fs->winsect++;
;;;801    					}
;;;802    					dj->fs->winsect -= c;						/* Rewind window address */
;;;803    #else
;;;804    					return FR_NO_FILE;			/* Report EOT */
;;;805    #endif
;;;806    				}
;;;807    				dj->clust = clst;				/* Initialize data for new cluster */
;;;808    				dj->sect = clust2sect(dj->fs, clst);
;;;809    			}
;;;810    		}
;;;811    	}
;;;812    
;;;813    	dj->index = i;
;;;814    	dj->dir = dj->fs->win + (i % (SS(dj->fs) / 32)) * 32;
;;;815    
;;;816    	return FR_OK;
;;;817    }
000018  bdfe              POP      {r1-r7,pc}
                  |L9.26|
00001a  0730              LSLS     r0,r6,#28             ;773
00001c  0f00              LSRS     r0,r0,#28             ;773
00001e  2800              CMP      r0,#0                 ;773
000020  d175              BNE      |L9.270|
000022  6920              LDR      r0,[r4,#0x10]         ;774
000024  1c40              ADDS     r0,r0,#1              ;774
000026  6120              STR      r0,[r4,#0x10]         ;774
000028  68e0              LDR      r0,[r4,#0xc]          ;776
00002a  2800              CMP      r0,#0                 ;776
00002c  d105              BNE      |L9.58|
00002e  6820              LDR      r0,[r4,#0]            ;777
000030  8900              LDRH     r0,[r0,#8]            ;777
000032  42b0              CMP      r0,r6                 ;777
000034  dc6b              BGT      |L9.270|
000036  2004              MOVS     r0,#4                 ;778
000038  e7ee              B        |L9.24|
                  |L9.58|
00003a  0930              LSRS     r0,r6,#4              ;781
00003c  6821              LDR      r1,[r4,#0]            ;781
00003e  7889              LDRB     r1,[r1,#2]            ;781
000040  1e49              SUBS     r1,r1,#1              ;781
000042  4008              ANDS     r0,r0,r1              ;781
000044  2800              CMP      r0,#0                 ;781
000046  d162              BNE      |L9.270|
000048  68e1              LDR      r1,[r4,#0xc]          ;782
00004a  6820              LDR      r0,[r4,#0]            ;782
00004c  f7fffffe          BL       get_fat
000050  4605              MOV      r5,r0                 ;782
000052  2d01              CMP      r5,#1                 ;783
000054  d801              BHI      |L9.90|
000056  2002              MOVS     r0,#2                 ;783
000058  e7de              B        |L9.24|
                  |L9.90|
00005a  1c68              ADDS     r0,r5,#1              ;784
00005c  2800              CMP      r0,#0                 ;784
00005e  d101              BNE      |L9.100|
000060  2001              MOVS     r0,#1                 ;784
000062  e7d9              B        |L9.24|
                  |L9.100|
000064  6820              LDR      r0,[r4,#0]            ;785
000066  69c0              LDR      r0,[r0,#0x1c]         ;785
000068  42a8              CMP      r0,r5                 ;785
00006a  d84a              BHI      |L9.258|
00006c  9802              LDR      r0,[sp,#8]            ;788
00006e  2800              CMP      r0,#0                 ;788
000070  d101              BNE      |L9.118|
000072  2004              MOVS     r0,#4                 ;788
000074  e7d0              B        |L9.24|
                  |L9.118|
000076  68e1              LDR      r1,[r4,#0xc]          ;789
000078  6820              LDR      r0,[r4,#0]            ;789
00007a  f7fffffe          BL       create_chain
00007e  4605              MOV      r5,r0                 ;789
000080  2d00              CMP      r5,#0                 ;790
000082  d101              BNE      |L9.136|
000084  2007              MOVS     r0,#7                 ;790
000086  e7c7              B        |L9.24|
                  |L9.136|
000088  2d01              CMP      r5,#1                 ;791
00008a  d101              BNE      |L9.144|
00008c  2002              MOVS     r0,#2                 ;791
00008e  e7c3              B        |L9.24|
                  |L9.144|
000090  1c68              ADDS     r0,r5,#1              ;792
000092  2800              CMP      r0,#0                 ;792
000094  d101              BNE      |L9.154|
000096  2001              MOVS     r0,#1                 ;792
000098  e7be              B        |L9.24|
                  |L9.154|
00009a  2100              MOVS     r1,#0                 ;794
00009c  6820              LDR      r0,[r4,#0]            ;794
00009e  f7fffffe          BL       move_window
0000a2  2800              CMP      r0,#0                 ;794
0000a4  d001              BEQ      |L9.170|
0000a6  2001              MOVS     r0,#1                 ;794
0000a8  e7b6              B        |L9.24|
                  |L9.170|
0000aa  6821              LDR      r1,[r4,#0]            ;795
0000ac  4608              MOV      r0,r1                 ;795
0000ae  3034              ADDS     r0,r0,#0x34           ;795
0000b0  2201              MOVS     r2,#1                 ;795
0000b2  0252              LSLS     r2,r2,#9              ;795
0000b4  2100              MOVS     r1,#0                 ;795
0000b6  f7fffffe          BL       mem_set
0000ba  4629              MOV      r1,r5                 ;796
0000bc  6820              LDR      r0,[r4,#0]            ;796
0000be  f7fffffe          BL       clust2sect
0000c2  6821              LDR      r1,[r4,#0]            ;796
0000c4  6308              STR      r0,[r1,#0x30]         ;796
0000c6  2700              MOVS     r7,#0                 ;797
0000c8  e011              B        |L9.238|
                  |L9.202|
0000ca  2001              MOVS     r0,#1                 ;798
0000cc  6821              LDR      r1,[r4,#0]            ;798
0000ce  7108              STRB     r0,[r1,#4]            ;798
0000d0  2100              MOVS     r1,#0                 ;799
0000d2  6820              LDR      r0,[r4,#0]            ;799
0000d4  f7fffffe          BL       move_window
0000d8  2800              CMP      r0,#0                 ;799
0000da  d001              BEQ      |L9.224|
0000dc  2001              MOVS     r0,#1                 ;799
0000de  e79b              B        |L9.24|
                  |L9.224|
0000e0  6820              LDR      r0,[r4,#0]            ;800
0000e2  6b00              LDR      r0,[r0,#0x30]         ;800
0000e4  1c40              ADDS     r0,r0,#1              ;800
0000e6  6821              LDR      r1,[r4,#0]            ;800
0000e8  6308              STR      r0,[r1,#0x30]         ;800
0000ea  1c78              ADDS     r0,r7,#1              ;797
0000ec  b2c7              UXTB     r7,r0                 ;797
                  |L9.238|
0000ee  6820              LDR      r0,[r4,#0]            ;797
0000f0  7880              LDRB     r0,[r0,#2]            ;797
0000f2  42b8              CMP      r0,r7                 ;797
0000f4  dce9              BGT      |L9.202|
0000f6  6820              LDR      r0,[r4,#0]            ;802
0000f8  6b00              LDR      r0,[r0,#0x30]         ;802
0000fa  1bc0              SUBS     r0,r0,r7              ;802
0000fc  6821              LDR      r1,[r4,#0]            ;802
0000fe  6308              STR      r0,[r1,#0x30]         ;802
000100  bf00              NOP                            ;806
                  |L9.258|
000102  60e5              STR      r5,[r4,#0xc]          ;807
000104  4629              MOV      r1,r5                 ;808
000106  6820              LDR      r0,[r4,#0]            ;808
000108  f7fffffe          BL       clust2sect
00010c  6120              STR      r0,[r4,#0x10]         ;808
                  |L9.270|
00010e  80e6              STRH     r6,[r4,#6]            ;813
000110  6820              LDR      r0,[r4,#0]            ;814
000112  3034              ADDS     r0,r0,#0x34           ;814
000114  0731              LSLS     r1,r6,#28             ;814
000116  0dc9              LSRS     r1,r1,#23             ;814
000118  1840              ADDS     r0,r0,r1              ;814
00011a  6160              STR      r0,[r4,#0x14]         ;814
00011c  2000              MOVS     r0,#0                 ;816
00011e  e77b              B        |L9.24|
;;;818    
                          ENDP


                          AREA ||i.dir_read||, CODE, READONLY, ALIGN=1

                  dir_read PROC
;;;1059   static
;;;1060   FRESULT dir_read (
000000  b5fe              PUSH     {r1-r7,lr}
;;;1061   	DIR *dj			/* Pointer to the directory object that pointing the entry to be read */
;;;1062   )
;;;1063   {
000002  4604              MOV      r4,r0
;;;1064   	FRESULT res;
;;;1065   	BYTE c, *dir;
;;;1066   #if _USE_LFN
;;;1067   	BYTE a, ord = 0xFF, sum = 0xFF;
000004  20ff              MOVS     r0,#0xff
000006  9001              STR      r0,[sp,#4]
000008  9000              STR      r0,[sp,#0]
;;;1068   #endif
;;;1069   
;;;1070   	res = FR_NO_FILE;
00000a  2704              MOVS     r7,#4
;;;1071   	while (dj->sect) {
00000c  e056              B        |L10.188|
                  |L10.14|
;;;1072   		res = move_window(dj->fs, dj->sect);
00000e  6921              LDR      r1,[r4,#0x10]
000010  6820              LDR      r0,[r4,#0]
000012  f7fffffe          BL       move_window
000016  4607              MOV      r7,r0
;;;1073   		if (res != FR_OK) break;
000018  2f00              CMP      r7,#0
00001a  d000              BEQ      |L10.30|
00001c  e051              B        |L10.194|
                  |L10.30|
;;;1074   		dir = dj->dir;					/* Ptr to the directory entry of current index */
00001e  6965              LDR      r5,[r4,#0x14]
;;;1075   		c = dir[DIR_Name];
000020  782e              LDRB     r6,[r5,#0]
;;;1076   		if (c == 0) { res = FR_NO_FILE; break; }	/* Reached to end of table */
000022  2e00              CMP      r6,#0
000024  d101              BNE      |L10.42|
000026  2704              MOVS     r7,#4
000028  e04b              B        |L10.194|
                  |L10.42|
;;;1077   #if _USE_LFN	/* LFN configuration */
;;;1078   		a = dir[DIR_Attr] & AM_MASK;
00002a  7ae8              LDRB     r0,[r5,#0xb]
00002c  0680              LSLS     r0,r0,#26
00002e  0e80              LSRS     r0,r0,#26
000030  9002              STR      r0,[sp,#8]
;;;1079   		if (c == 0xE5 || (!_FS_RPATH && c == '.') || ((a & AM_VOL) && a != AM_LFN)) {	/* An entry without valid data */
000032  2ee5              CMP      r6,#0xe5
000034  d008              BEQ      |L10.72|
000036  bf00              NOP      
000038  2108              MOVS     r1,#8
00003a  9802              LDR      r0,[sp,#8]
00003c  4008              ANDS     r0,r0,r1
00003e  2800              CMP      r0,#0
000040  d005              BEQ      |L10.78|
000042  9802              LDR      r0,[sp,#8]
000044  280f              CMP      r0,#0xf
000046  d002              BEQ      |L10.78|
                  |L10.72|
;;;1080   			ord = 0xFF;
000048  20ff              MOVS     r0,#0xff
00004a  9001              STR      r0,[sp,#4]
00004c  e02e              B        |L10.172|
                  |L10.78|
;;;1081   		} else {
;;;1082   			if (a == AM_LFN) {			/* An LFN entry is found */
00004e  9802              LDR      r0,[sp,#8]
000050  280f              CMP      r0,#0xf
000052  d11e              BNE      |L10.146|
;;;1083   				if (c & 0x40) {			/* Is it start of LFN sequence? */
000054  2040              MOVS     r0,#0x40
000056  4030              ANDS     r0,r0,r6
000058  2800              CMP      r0,#0
00005a  d006              BEQ      |L10.106|
;;;1084   					sum = dir[LDIR_Chksum];
00005c  7b68              LDRB     r0,[r5,#0xd]
00005e  9000              STR      r0,[sp,#0]
;;;1085   					c &= 0xBF; ord = c;
000060  20bf              MOVS     r0,#0xbf
000062  4006              ANDS     r6,r6,r0
000064  9601              STR      r6,[sp,#4]
;;;1086   					dj->lfn_idx = dj->index;
000066  88e0              LDRH     r0,[r4,#6]
000068  8420              STRH     r0,[r4,#0x20]
                  |L10.106|
;;;1087   				}
;;;1088   				/* Check LFN validity and capture it */
;;;1089   				ord = (c == ord && sum == dir[LDIR_Chksum] && pick_lfn(dj->lfn, dir)) ? ord - 1 : 0xFF;
00006a  9801              LDR      r0,[sp,#4]
00006c  4286              CMP      r6,r0
00006e  d10c              BNE      |L10.138|
000070  7b69              LDRB     r1,[r5,#0xd]
000072  9800              LDR      r0,[sp,#0]
000074  4281              CMP      r1,r0
000076  d108              BNE      |L10.138|
000078  4629              MOV      r1,r5
00007a  69e0              LDR      r0,[r4,#0x1c]
00007c  f7fffffe          BL       pick_lfn
000080  2800              CMP      r0,#0
000082  d002              BEQ      |L10.138|
000084  9801              LDR      r0,[sp,#4]
000086  1e40              SUBS     r0,r0,#1
000088  e000              B        |L10.140|
                  |L10.138|
00008a  20ff              MOVS     r0,#0xff
                  |L10.140|
00008c  b2c0              UXTB     r0,r0
00008e  9001              STR      r0,[sp,#4]
000090  e00c              B        |L10.172|
                  |L10.146|
;;;1090   			} else {					/* An SFN entry is found */
;;;1091   				if (ord || sum != sum_sfn(dir))	/* Is there a valid LFN? */
000092  9801              LDR      r0,[sp,#4]
000094  2800              CMP      r0,#0
000096  d105              BNE      |L10.164|
000098  4628              MOV      r0,r5
00009a  f7fffffe          BL       sum_sfn
00009e  9900              LDR      r1,[sp,#0]
0000a0  4288              CMP      r0,r1
0000a2  d002              BEQ      |L10.170|
                  |L10.164|
;;;1092   					dj->lfn_idx = 0xFFFF;		/* It has no LFN. */
0000a4  2000              MOVS     r0,#0
0000a6  43c0              MVNS     r0,r0
0000a8  8420              STRH     r0,[r4,#0x20]
                  |L10.170|
;;;1093   				break;
0000aa  e00a              B        |L10.194|
                  |L10.172|
;;;1094   			}
;;;1095   		}
;;;1096   #else		/* Non LFN configuration */
;;;1097   		if (c != 0xE5 && (_FS_RPATH || c != '.') && !(dir[DIR_Attr] & AM_VOL))	/* Is it a valid entry? */
;;;1098   			break;
;;;1099   #endif
;;;1100   		res = dir_next(dj, 0);				/* Next entry */
0000ac  2100              MOVS     r1,#0
0000ae  4620              MOV      r0,r4
0000b0  f7fffffe          BL       dir_next
0000b4  4607              MOV      r7,r0
;;;1101   		if (res != FR_OK) break;
0000b6  2f00              CMP      r7,#0
0000b8  d000              BEQ      |L10.188|
0000ba  e002              B        |L10.194|
                  |L10.188|
0000bc  6920              LDR      r0,[r4,#0x10]         ;1071
0000be  2800              CMP      r0,#0                 ;1071
0000c0  d1a5              BNE      |L10.14|
                  |L10.194|
0000c2  bf00              NOP                            ;1073
;;;1102   	}
;;;1103   
;;;1104   	if (res != FR_OK) dj->sect = 0;
0000c4  2f00              CMP      r7,#0
0000c6  d001              BEQ      |L10.204|
0000c8  2000              MOVS     r0,#0
0000ca  6120              STR      r0,[r4,#0x10]
                  |L10.204|
;;;1105   
;;;1106   	return res;
0000cc  4638              MOV      r0,r7
;;;1107   }
0000ce  bdfe              POP      {r1-r7,pc}
;;;1108   #endif
                          ENDP


                          AREA ||i.dir_register||, CODE, READONLY, ALIGN=1

                  dir_register PROC
;;;1116   static
;;;1117   FRESULT dir_register (	/* FR_OK:Successful, FR_DENIED:No free entry or too many SFN collision, FR_DISK_ERR:Disk error */
000000  b5f0              PUSH     {r4-r7,lr}
;;;1118   	DIR *dj				/* Target directory with object name to be created */
;;;1119   )
;;;1120   {
000002  b08b              SUB      sp,sp,#0x2c
000004  4604              MOV      r4,r0
;;;1121   	FRESULT res;
;;;1122   	BYTE c, *dir;
;;;1123   #if _USE_LFN	/* LFN configuration */
;;;1124   	WORD n, ne, is;
;;;1125   	BYTE sn[12], *fn, sum;
;;;1126   	WCHAR *lfn;
;;;1127   
;;;1128   
;;;1129   	fn = dj->fn; lfn = dj->lfn;
000006  69a0              LDR      r0,[r4,#0x18]
000008  9004              STR      r0,[sp,#0x10]
00000a  69e0              LDR      r0,[r4,#0x1c]
00000c  9002              STR      r0,[sp,#8]
;;;1130   	mem_cpy(sn, fn, 12);
00000e  220c              MOVS     r2,#0xc
000010  a805              ADD      r0,sp,#0x14
000012  9904              LDR      r1,[sp,#0x10]
000014  f7fffffe          BL       mem_cpy
;;;1131   
;;;1132   	if (_FS_RPATH && (sn[NS] & NS_DOT)) return FR_INVALID_NAME;	/* Cannot create dot entry */
000018  4668              MOV      r0,sp
00001a  7fc0              LDRB     r0,[r0,#0x1f]
00001c  2120              MOVS     r1,#0x20
00001e  4008              ANDS     r0,r0,r1
000020  2800              CMP      r0,#0
000022  d002              BEQ      |L11.42|
000024  2006              MOVS     r0,#6
                  |L11.38|
;;;1133   
;;;1134   	if (sn[NS] & NS_LOSS) {			/* When LFN is out of 8.3 format, generate a numbered name */
;;;1135   		fn[NS] = 0; dj->lfn = 0;			/* Find only SFN */
;;;1136   		for (n = 1; n < 100; n++) {
;;;1137   			gen_numname(fn, sn, lfn, n);	/* Generate a numbered name */
;;;1138   			res = dir_find(dj);				/* Check if the name collides with existing SFN */
;;;1139   			if (res != FR_OK) break;
;;;1140   		}
;;;1141   		if (n == 100) return FR_DENIED;		/* Abort if too many collisions */
;;;1142   		if (res != FR_NO_FILE) return res;	/* Abort if the result is other than 'not collided' */
;;;1143   		fn[NS] = sn[NS]; dj->lfn = lfn;
;;;1144   	}
;;;1145   
;;;1146   	if (sn[NS] & NS_LFN) {			/* When LFN is to be created, reserve an SFN + LFN entries. */
;;;1147   		for (ne = 0; lfn[ne]; ne++) ;
;;;1148   		ne = (ne + 25) / 13;
;;;1149   	} else {						/* Otherwise reserve only an SFN entry. */
;;;1150   		ne = 1;
;;;1151   	}
;;;1152   
;;;1153   	/* Reserve contiguous entries */
;;;1154   	res = dir_sdi(dj, 0);
;;;1155   	if (res != FR_OK) return res;
;;;1156   	n = is = 0;
;;;1157   	do {
;;;1158   		res = move_window(dj->fs, dj->sect);
;;;1159   		if (res != FR_OK) break;
;;;1160   		c = *dj->dir;				/* Check the entry status */
;;;1161   		if (c == 0xE5 || c == 0) {	/* Is it a blank entry? */
;;;1162   			if (n == 0) is = dj->index;	/* First index of the contiguous entry */
;;;1163   			if (++n == ne) break;	/* A contiguous entry that required count is found */
;;;1164   		} else {
;;;1165   			n = 0;					/* Not a blank entry. Restart to search */
;;;1166   		}
;;;1167   		res = dir_next(dj, 1);		/* Next entry with table stretch */
;;;1168   	} while (res == FR_OK);
;;;1169   
;;;1170   	if (res == FR_OK && ne > 1) {	/* Initialize LFN entry if needed */
;;;1171   		res = dir_sdi(dj, is);
;;;1172   		if (res == FR_OK) {
;;;1173   			sum = sum_sfn(dj->fn);	/* Sum of the SFN tied to the LFN */
;;;1174   			ne--;
;;;1175   			do {					/* Store LFN entries in bottom first */
;;;1176   				res = move_window(dj->fs, dj->sect);
;;;1177   				if (res != FR_OK) break;
;;;1178   				fit_lfn(dj->lfn, dj->dir, (BYTE)ne, sum);
;;;1179   				dj->fs->wflag = 1;
;;;1180   				res = dir_next(dj, 0);	/* Next entry */
;;;1181   			} while (res == FR_OK && --ne);
;;;1182   		}
;;;1183   	}
;;;1184   
;;;1185   #else	/* Non LFN configuration */
;;;1186   	res = dir_sdi(dj, 0);
;;;1187   	if (res == FR_OK) {
;;;1188   		do {	/* Find a blank entry for the SFN */
;;;1189   			res = move_window(dj->fs, dj->sect);
;;;1190   			if (res != FR_OK) break;
;;;1191   			c = *dj->dir;
;;;1192   			if (c == 0xE5 || c == 0) break;	/* Is it a blank entry? */
;;;1193   			res = dir_next(dj, 1);			/* Next entry with table stretch */
;;;1194   		} while (res == FR_OK);
;;;1195   	}
;;;1196   #endif
;;;1197   
;;;1198   	if (res == FR_OK) {		/* Initialize the SFN entry */
;;;1199   		res = move_window(dj->fs, dj->sect);
;;;1200   		if (res == FR_OK) {
;;;1201   			dir = dj->dir;
;;;1202   			mem_set(dir, 0, 32);		/* Clean the entry */
;;;1203   			mem_cpy(dir, dj->fn, 11);	/* Put SFN */
;;;1204   #if _USE_LFN
;;;1205   			dir[DIR_NTres] = *(dj->fn+NS) & (NS_BODY | NS_EXT);	/* Put NT flag */
;;;1206   #endif
;;;1207   			dj->fs->wflag = 1;
;;;1208   		}
;;;1209   	}
;;;1210   
;;;1211   	return res;
;;;1212   }
000026  b00b              ADD      sp,sp,#0x2c
000028  bdf0              POP      {r4-r7,pc}
                  |L11.42|
00002a  4668              MOV      r0,sp                 ;1134
00002c  7fc0              LDRB     r0,[r0,#0x1f]         ;1134
00002e  07c0              LSLS     r0,r0,#31             ;1134
000030  0fc0              LSRS     r0,r0,#31             ;1134
000032  2800              CMP      r0,#0                 ;1134
000034  d026              BEQ      |L11.132|
000036  2100              MOVS     r1,#0                 ;1135
000038  9804              LDR      r0,[sp,#0x10]         ;1135
00003a  72c1              STRB     r1,[r0,#0xb]          ;1135
00003c  2000              MOVS     r0,#0                 ;1135
00003e  61e0              STR      r0,[r4,#0x1c]         ;1135
000040  2701              MOVS     r7,#1                 ;1136
000042  e00e              B        |L11.98|
                  |L11.68|
000044  463b              MOV      r3,r7                 ;1137
000046  a905              ADD      r1,sp,#0x14           ;1137
000048  9a02              LDR      r2,[sp,#8]            ;1137
00004a  9804              LDR      r0,[sp,#0x10]         ;1137
00004c  f7fffffe          BL       gen_numname
000050  4620              MOV      r0,r4                 ;1138
000052  f7fffffe          BL       dir_find
000056  4605              MOV      r5,r0                 ;1138
000058  2d00              CMP      r5,#0                 ;1139
00005a  d000              BEQ      |L11.94|
00005c  e003              B        |L11.102|
                  |L11.94|
00005e  1c78              ADDS     r0,r7,#1              ;1136
000060  b287              UXTH     r7,r0                 ;1136
                  |L11.98|
000062  2f64              CMP      r7,#0x64              ;1136
000064  dbee              BLT      |L11.68|
                  |L11.102|
000066  bf00              NOP                            ;1139
000068  2f64              CMP      r7,#0x64              ;1141
00006a  d101              BNE      |L11.112|
00006c  2007              MOVS     r0,#7                 ;1141
00006e  e7da              B        |L11.38|
                  |L11.112|
000070  2d04              CMP      r5,#4                 ;1142
000072  d001              BEQ      |L11.120|
000074  4628              MOV      r0,r5                 ;1142
000076  e7d6              B        |L11.38|
                  |L11.120|
000078  4668              MOV      r0,sp                 ;1143
00007a  7fc1              LDRB     r1,[r0,#0x1f]         ;1143
00007c  9804              LDR      r0,[sp,#0x10]         ;1143
00007e  72c1              STRB     r1,[r0,#0xb]          ;1143
000080  9802              LDR      r0,[sp,#8]            ;1143
000082  61e0              STR      r0,[r4,#0x1c]         ;1143
                  |L11.132|
000084  4668              MOV      r0,sp                 ;1146
000086  7fc0              LDRB     r0,[r0,#0x1f]         ;1146
000088  2102              MOVS     r1,#2                 ;1146
00008a  4008              ANDS     r0,r0,r1              ;1146
00008c  2800              CMP      r0,#0                 ;1146
00008e  d00f              BEQ      |L11.176|
000090  2600              MOVS     r6,#0                 ;1147
000092  e001              B        |L11.152|
                  |L11.148|
000094  1c70              ADDS     r0,r6,#1              ;1147
000096  b286              UXTH     r6,r0                 ;1147
                  |L11.152|
000098  0071              LSLS     r1,r6,#1              ;1147
00009a  9802              LDR      r0,[sp,#8]            ;1147
00009c  5a40              LDRH     r0,[r0,r1]            ;1147
00009e  2800              CMP      r0,#0                 ;1147
0000a0  d1f8              BNE      |L11.148|
0000a2  210d              MOVS     r1,#0xd               ;1148
0000a4  4630              MOV      r0,r6                 ;1148
0000a6  3019              ADDS     r0,r0,#0x19           ;1148
0000a8  f7fffffe          BL       __aeabi_idivmod
0000ac  b286              UXTH     r6,r0                 ;1148
0000ae  e000              B        |L11.178|
                  |L11.176|
0000b0  2601              MOVS     r6,#1                 ;1150
                  |L11.178|
0000b2  2100              MOVS     r1,#0                 ;1154
0000b4  4620              MOV      r0,r4                 ;1154
0000b6  f7fffffe          BL       dir_sdi
0000ba  4605              MOV      r5,r0                 ;1154
0000bc  2d00              CMP      r5,#0                 ;1155
0000be  d001              BEQ      |L11.196|
0000c0  4628              MOV      r0,r5                 ;1155
0000c2  e7b0              B        |L11.38|
                  |L11.196|
0000c4  2000              MOVS     r0,#0                 ;1156
0000c6  4607              MOV      r7,r0                 ;1156
0000c8  9008              STR      r0,[sp,#0x20]         ;1156
0000ca  bf00              NOP                            ;1157
                  |L11.204|
0000cc  6921              LDR      r1,[r4,#0x10]         ;1158
0000ce  6820              LDR      r0,[r4,#0]            ;1158
0000d0  f7fffffe          BL       move_window
0000d4  4605              MOV      r5,r0                 ;1158
0000d6  2d00              CMP      r5,#0                 ;1159
0000d8  d000              BEQ      |L11.220|
0000da  e01a              B        |L11.274|
                  |L11.220|
0000dc  6960              LDR      r0,[r4,#0x14]         ;1160
0000de  7800              LDRB     r0,[r0,#0]            ;1160
0000e0  900a              STR      r0,[sp,#0x28]         ;1160
0000e2  980a              LDR      r0,[sp,#0x28]         ;1161
0000e4  28e5              CMP      r0,#0xe5              ;1161
0000e6  d002              BEQ      |L11.238|
0000e8  980a              LDR      r0,[sp,#0x28]         ;1161
0000ea  2800              CMP      r0,#0                 ;1161
0000ec  d109              BNE      |L11.258|
                  |L11.238|
0000ee  2f00              CMP      r7,#0                 ;1162
0000f0  d101              BNE      |L11.246|
0000f2  88e0              LDRH     r0,[r4,#6]            ;1162
0000f4  9008              STR      r0,[sp,#0x20]         ;1162
                  |L11.246|
0000f6  1c78              ADDS     r0,r7,#1              ;1163
0000f8  b280              UXTH     r0,r0                 ;1163
0000fa  4607              MOV      r7,r0                 ;1163
0000fc  42b0              CMP      r0,r6                 ;1163
0000fe  d101              BNE      |L11.260|
000100  e007              B        |L11.274|
                  |L11.258|
000102  2700              MOVS     r7,#0                 ;1165
                  |L11.260|
000104  2101              MOVS     r1,#1                 ;1167
000106  4620              MOV      r0,r4                 ;1167
000108  f7fffffe          BL       dir_next
00010c  4605              MOV      r5,r0                 ;1167
00010e  2d00              CMP      r5,#0                 ;1168
000110  d0dc              BEQ      |L11.204|
                  |L11.274|
000112  bf00              NOP                            ;1159
000114  2d00              CMP      r5,#0                 ;1170
000116  d12d              BNE      |L11.372|
000118  2e01              CMP      r6,#1                 ;1170
00011a  dd2b              BLE      |L11.372|
00011c  4620              MOV      r0,r4                 ;1171
00011e  9908              LDR      r1,[sp,#0x20]         ;1171
000120  f7fffffe          BL       dir_sdi
000124  4605              MOV      r5,r0                 ;1171
000126  2d00              CMP      r5,#0                 ;1172
000128  d124              BNE      |L11.372|
00012a  69a0              LDR      r0,[r4,#0x18]         ;1173
00012c  f7fffffe          BL       sum_sfn
000130  9003              STR      r0,[sp,#0xc]          ;1173
000132  1e70              SUBS     r0,r6,#1              ;1174
000134  b286              UXTH     r6,r0                 ;1174
000136  bf00              NOP                            ;1175
                  |L11.312|
000138  6921              LDR      r1,[r4,#0x10]         ;1176
00013a  6820              LDR      r0,[r4,#0]            ;1176
00013c  f7fffffe          BL       move_window
000140  4605              MOV      r5,r0                 ;1176
000142  2d00              CMP      r5,#0                 ;1177
000144  d000              BEQ      |L11.328|
000146  e014              B        |L11.370|
                  |L11.328|
000148  b2f2              UXTB     r2,r6                 ;1178
00014a  6961              LDR      r1,[r4,#0x14]         ;1178
00014c  69e0              LDR      r0,[r4,#0x1c]         ;1178
00014e  9001              STR      r0,[sp,#4]            ;1178
000150  9b03              LDR      r3,[sp,#0xc]          ;1178
000152  f7fffffe          BL       fit_lfn
000156  2001              MOVS     r0,#1                 ;1179
000158  6821              LDR      r1,[r4,#0]            ;1179
00015a  7108              STRB     r0,[r1,#4]            ;1179
00015c  2100              MOVS     r1,#0                 ;1180
00015e  4620              MOV      r0,r4                 ;1180
000160  f7fffffe          BL       dir_next
000164  4605              MOV      r5,r0                 ;1180
000166  2d00              CMP      r5,#0                 ;1181
000168  d103              BNE      |L11.370|
00016a  1e70              SUBS     r0,r6,#1              ;1181
00016c  b280              UXTH     r0,r0                 ;1181
00016e  1e06              SUBS     r6,r0,#0              ;1181
000170  d1e2              BNE      |L11.312|
                  |L11.370|
000172  bf00              NOP                            ;1177
                  |L11.372|
000174  2d00              CMP      r5,#0                 ;1198
000176  d11b              BNE      |L11.432|
000178  6921              LDR      r1,[r4,#0x10]         ;1199
00017a  6820              LDR      r0,[r4,#0]            ;1199
00017c  f7fffffe          BL       move_window
000180  4605              MOV      r5,r0                 ;1199
000182  2d00              CMP      r5,#0                 ;1200
000184  d114              BNE      |L11.432|
000186  6960              LDR      r0,[r4,#0x14]         ;1201
000188  9009              STR      r0,[sp,#0x24]         ;1201
00018a  2220              MOVS     r2,#0x20              ;1202
00018c  2100              MOVS     r1,#0                 ;1202
00018e  9809              LDR      r0,[sp,#0x24]         ;1202
000190  f7fffffe          BL       mem_set
000194  220b              MOVS     r2,#0xb               ;1203
000196  69a1              LDR      r1,[r4,#0x18]         ;1203
000198  9809              LDR      r0,[sp,#0x24]         ;1203
00019a  f7fffffe          BL       mem_cpy
00019e  69a0              LDR      r0,[r4,#0x18]         ;1205
0001a0  7ac1              LDRB     r1,[r0,#0xb]          ;1205
0001a2  2018              MOVS     r0,#0x18              ;1205
0001a4  4001              ANDS     r1,r1,r0              ;1205
0001a6  9809              LDR      r0,[sp,#0x24]         ;1205
0001a8  7301              STRB     r1,[r0,#0xc]          ;1205
0001aa  2001              MOVS     r0,#1                 ;1207
0001ac  6821              LDR      r1,[r4,#0]            ;1207
0001ae  7108              STRB     r0,[r1,#4]            ;1207
                  |L11.432|
0001b0  4628              MOV      r0,r5                 ;1211
0001b2  e738              B        |L11.38|
;;;1213   #endif /* !_FS_READONLY */
                          ENDP


                          AREA ||i.dir_remove||, CODE, READONLY, ALIGN=2

                  dir_remove PROC
;;;1222   static
;;;1223   FRESULT dir_remove (	/* FR_OK: Successful, FR_DISK_ERR: A disk error */
000000  b570              PUSH     {r4-r6,lr}
;;;1224   	DIR *dj				/* Directory object pointing the entry to be removed */
;;;1225   )
;;;1226   {
000002  4604              MOV      r4,r0
;;;1227   	FRESULT res;
;;;1228   #if _USE_LFN	/* LFN configuration */
;;;1229   	WORD i;
;;;1230   
;;;1231   	i = dj->index;	/* SFN index */
000004  88e6              LDRH     r6,[r4,#6]
;;;1232   	res = dir_sdi(dj, (WORD)((dj->lfn_idx == 0xFFFF) ? i : dj->lfn_idx));	/* Goto the SFN or top of the LFN entries */
000006  8c20              LDRH     r0,[r4,#0x20]
000008  4a16              LDR      r2,|L12.100|
00000a  4290              CMP      r0,r2
00000c  d101              BNE      |L12.18|
00000e  4630              MOV      r0,r6
000010  e000              B        |L12.20|
                  |L12.18|
000012  8c20              LDRH     r0,[r4,#0x20]
                  |L12.20|
000014  4601              MOV      r1,r0
000016  4620              MOV      r0,r4
000018  f7fffffe          BL       dir_sdi
00001c  4605              MOV      r5,r0
;;;1233   	if (res == FR_OK) {
00001e  2d00              CMP      r5,#0
000020  d11d              BNE      |L12.94|
;;;1234   		do {
000022  bf00              NOP      
                  |L12.36|
;;;1235   			res = move_window(dj->fs, dj->sect);
000024  6921              LDR      r1,[r4,#0x10]
000026  6820              LDR      r0,[r4,#0]
000028  f7fffffe          BL       move_window
00002c  4605              MOV      r5,r0
;;;1236   			if (res != FR_OK) break;
00002e  2d00              CMP      r5,#0
000030  d000              BEQ      |L12.52|
000032  e010              B        |L12.86|
                  |L12.52|
;;;1237   			*dj->dir = 0xE5;			/* Mark the entry "deleted" */
000034  20e5              MOVS     r0,#0xe5
000036  6961              LDR      r1,[r4,#0x14]
000038  7008              STRB     r0,[r1,#0]
;;;1238   			dj->fs->wflag = 1;
00003a  2001              MOVS     r0,#1
00003c  6821              LDR      r1,[r4,#0]
00003e  7108              STRB     r0,[r1,#4]
;;;1239   			if (dj->index >= i) break;	/* When reached SFN, all entries of the object has been deleted. */
000040  88e0              LDRH     r0,[r4,#6]
000042  42b0              CMP      r0,r6
000044  db00              BLT      |L12.72|
000046  e006              B        |L12.86|
                  |L12.72|
;;;1240   			res = dir_next(dj, 0);		/* Next entry */
000048  2100              MOVS     r1,#0
00004a  4620              MOV      r0,r4
00004c  f7fffffe          BL       dir_next
000050  4605              MOV      r5,r0
;;;1241   		} while (res == FR_OK);
000052  2d00              CMP      r5,#0
000054  d0e6              BEQ      |L12.36|
                  |L12.86|
000056  bf00              NOP                            ;1236
;;;1242   		if (res == FR_NO_FILE) res = FR_INT_ERR;
000058  2d04              CMP      r5,#4
00005a  d100              BNE      |L12.94|
00005c  2502              MOVS     r5,#2
                  |L12.94|
;;;1243   	}
;;;1244   
;;;1245   #else			/* Non LFN configuration */
;;;1246   	res = dir_sdi(dj, dj->index);
;;;1247   	if (res == FR_OK) {
;;;1248   		res = move_window(dj->fs, dj->sect);
;;;1249   		if (res == FR_OK) {
;;;1250   			*dj->dir = 0xE5;			/* Mark the entry "deleted" */
;;;1251   			dj->fs->wflag = 1;
;;;1252   		}
;;;1253   	}
;;;1254   #endif
;;;1255   
;;;1256   	return res;
00005e  4628              MOV      r0,r5
;;;1257   }
000060  bd70              POP      {r4-r6,pc}
;;;1258   #endif /* !_FS_READONLY */
                          ENDP

000062  0000              DCW      0x0000
                  |L12.100|
                          DCD      0x0000ffff

                          AREA ||i.dir_sdi||, CODE, READONLY, ALIGN=1

                  dir_sdi PROC
;;;711    static
;;;712    FRESULT dir_sdi (
000000  b5f8              PUSH     {r3-r7,lr}
;;;713    	DIR *dj,		/* Pointer to directory object */
;;;714    	WORD idx		/* Directory index number */
;;;715    )
;;;716    {
000002  4604              MOV      r4,r0
000004  460e              MOV      r6,r1
;;;717    	DWORD clst;
;;;718    	WORD ic;
;;;719    
;;;720    
;;;721    	dj->index = idx;
000006  80e6              STRH     r6,[r4,#6]
;;;722    	clst = dj->sclust;
000008  68a5              LDR      r5,[r4,#8]
;;;723    	if (clst == 1 || clst >= dj->fs->n_fatent)	/* Check start cluster range */
00000a  2d01              CMP      r5,#1
00000c  d003              BEQ      |L13.22|
00000e  6820              LDR      r0,[r4,#0]
000010  69c0              LDR      r0,[r0,#0x1c]
000012  42a8              CMP      r0,r5
000014  d801              BHI      |L13.26|
                  |L13.22|
;;;724    		return FR_INT_ERR;
000016  2002              MOVS     r0,#2
                  |L13.24|
;;;725    	if (!clst && dj->fs->fs_type == FS_FAT32)	/* Replace cluster# 0 with root cluster# if in FAT32 */
;;;726    		clst = dj->fs->dirbase;
;;;727    
;;;728    	if (clst == 0) {	/* Static table */
;;;729    		dj->clust = clst;
;;;730    		if (idx >= dj->fs->n_rootdir)		/* Index is out of range */
;;;731    			return FR_INT_ERR;
;;;732    		dj->sect = dj->fs->dirbase + idx / (SS(dj->fs) / 32);	/* Sector# */
;;;733    	}
;;;734    	else {				/* Dynamic table */
;;;735    		ic = SS(dj->fs) / 32 * dj->fs->csize;	/* Entries per cluster */
;;;736    		while (idx >= ic) {	/* Follow cluster chain */
;;;737    			clst = get_fat(dj->fs, clst);				/* Get next cluster */
;;;738    			if (clst == 0xFFFFFFFF) return FR_DISK_ERR;	/* Disk error */
;;;739    			if (clst < 2 || clst >= dj->fs->n_fatent)	/* Reached to end of table or int error */
;;;740    				return FR_INT_ERR;
;;;741    			idx -= ic;
;;;742    		}
;;;743    		dj->clust = clst;
;;;744    		dj->sect = clust2sect(dj->fs, clst) + idx / (SS(dj->fs) / 32);	/* Sector# */
;;;745    	}
;;;746    
;;;747    	dj->dir = dj->fs->win + (idx % (SS(dj->fs) / 32)) * 32;	/* Ptr to the entry in the sector */
;;;748    
;;;749    	return FR_OK;	/* Seek succeeded */
;;;750    }
000018  bdf8              POP      {r3-r7,pc}
                  |L13.26|
00001a  2d00              CMP      r5,#0                 ;725
00001c  d105              BNE      |L13.42|
00001e  6820              LDR      r0,[r4,#0]            ;725
000020  7800              LDRB     r0,[r0,#0]            ;725
000022  2803              CMP      r0,#3                 ;725
000024  d101              BNE      |L13.42|
000026  6820              LDR      r0,[r4,#0]            ;726
000028  6a85              LDR      r5,[r0,#0x28]         ;726
                  |L13.42|
00002a  2d00              CMP      r5,#0                 ;728
00002c  d10c              BNE      |L13.72|
00002e  60e5              STR      r5,[r4,#0xc]          ;729
000030  6820              LDR      r0,[r4,#0]            ;730
000032  8900              LDRH     r0,[r0,#8]            ;730
000034  42b0              CMP      r0,r6                 ;730
000036  dc01              BGT      |L13.60|
000038  2002              MOVS     r0,#2                 ;731
00003a  e7ed              B        |L13.24|
                  |L13.60|
00003c  6820              LDR      r0,[r4,#0]            ;732
00003e  6a80              LDR      r0,[r0,#0x28]         ;732
000040  0931              LSRS     r1,r6,#4              ;732
000042  1840              ADDS     r0,r0,r1              ;732
000044  6120              STR      r0,[r4,#0x10]         ;732
000046  e021              B        |L13.140|
                  |L13.72|
000048  6820              LDR      r0,[r4,#0]            ;735
00004a  7880              LDRB     r0,[r0,#2]            ;735
00004c  0107              LSLS     r7,r0,#4              ;735
00004e  e013              B        |L13.120|
                  |L13.80|
000050  4629              MOV      r1,r5                 ;737
000052  6820              LDR      r0,[r4,#0]            ;737
000054  f7fffffe          BL       get_fat
000058  4605              MOV      r5,r0                 ;737
00005a  1c68              ADDS     r0,r5,#1              ;738
00005c  2800              CMP      r0,#0                 ;738
00005e  d101              BNE      |L13.100|
000060  2001              MOVS     r0,#1                 ;738
000062  e7d9              B        |L13.24|
                  |L13.100|
000064  2d02              CMP      r5,#2                 ;739
000066  d303              BCC      |L13.112|
000068  6820              LDR      r0,[r4,#0]            ;739
00006a  69c0              LDR      r0,[r0,#0x1c]         ;739
00006c  42a8              CMP      r0,r5                 ;739
00006e  d801              BHI      |L13.116|
                  |L13.112|
000070  2002              MOVS     r0,#2                 ;740
000072  e7d1              B        |L13.24|
                  |L13.116|
000074  1bf0              SUBS     r0,r6,r7              ;741
000076  b286              UXTH     r6,r0                 ;741
                  |L13.120|
000078  42be              CMP      r6,r7                 ;736
00007a  dae9              BGE      |L13.80|
00007c  60e5              STR      r5,[r4,#0xc]          ;743
00007e  4629              MOV      r1,r5                 ;744
000080  6820              LDR      r0,[r4,#0]            ;744
000082  f7fffffe          BL       clust2sect
000086  0931              LSRS     r1,r6,#4              ;744
000088  1840              ADDS     r0,r0,r1              ;744
00008a  6120              STR      r0,[r4,#0x10]         ;744
                  |L13.140|
00008c  6820              LDR      r0,[r4,#0]            ;747
00008e  3034              ADDS     r0,r0,#0x34           ;747
000090  0731              LSLS     r1,r6,#28             ;747
000092  0dc9              LSRS     r1,r1,#23             ;747
000094  1840              ADDS     r0,r0,r1              ;747
000096  6160              STR      r0,[r4,#0x14]         ;747
000098  2000              MOVS     r0,#0                 ;749
00009a  e7bd              B        |L13.24|
;;;751    
                          ENDP


                          AREA ||i.f_chdir||, CODE, READONLY, ALIGN=2

                  f_chdir PROC
;;;2329   
;;;2330   FRESULT f_chdir (
000000  b531              PUSH     {r0,r4,r5,lr}
;;;2331   	const TCHAR *path	/* Pointer to the directory path */
;;;2332   )
;;;2333   {
000002  b08c              SUB      sp,sp,#0x30
;;;2334   	FRESULT res;
;;;2335   	DIR dj;
;;;2336   	BYTE *dir;
;;;2337   	DEF_NAMEBUF;
;;;2338   
;;;2339   
;;;2340   	res = chk_mounted(&path, &dj.fs, 0);
000004  2200              MOVS     r2,#0
000006  a903              ADD      r1,sp,#0xc
000008  a80c              ADD      r0,sp,#0x30
00000a  f7fffffe          BL       chk_mounted
00000e  4605              MOV      r5,r0
;;;2341   	if (res == FR_OK) {
000010  2d00              CMP      r5,#0
000012  d127              BNE      |L14.100|
;;;2342   		INIT_BUF(dj);
000014  4668              MOV      r0,sp
000016  9009              STR      r0,[sp,#0x24]
000018  4814              LDR      r0,|L14.108|
00001a  900a              STR      r0,[sp,#0x28]
;;;2343   		res = follow_path(&dj, path);		/* Follow the path */
00001c  a803              ADD      r0,sp,#0xc
00001e  990c              LDR      r1,[sp,#0x30]
000020  f7fffffe          BL       follow_path
000024  4605              MOV      r5,r0
;;;2344   		FREE_BUF();
;;;2345   		if (res == FR_OK) {					/* Follow completed */
000026  2d00              CMP      r5,#0
000028  d119              BNE      |L14.94|
;;;2346   			dir = dj.dir;					/* Pointer to the entry */
00002a  9c08              LDR      r4,[sp,#0x20]
;;;2347   			if (!dir) {
00002c  2c00              CMP      r4,#0
00002e  d103              BNE      |L14.56|
;;;2348   				dj.fs->cdir = dj.sclust;	/* Start directory itself */
000030  9903              LDR      r1,[sp,#0xc]
000032  9805              LDR      r0,[sp,#0x14]
000034  6188              STR      r0,[r1,#0x18]
000036  e012              B        |L14.94|
                  |L14.56|
;;;2349   			} else {
;;;2350   				if (dir[DIR_Attr] & AM_DIR)	/* Reached to the directory */
000038  7ae0              LDRB     r0,[r4,#0xb]
00003a  2110              MOVS     r1,#0x10
00003c  4008              ANDS     r0,r0,r1
00003e  2800              CMP      r0,#0
000040  d00c              BEQ      |L14.92|
;;;2351   					dj.fs->cdir = ((DWORD)LD_WORD(dir+DIR_FstClusHI) << 16) | LD_WORD(dir+DIR_FstClusLO);
000042  7d60              LDRB     r0,[r4,#0x15]
000044  0200              LSLS     r0,r0,#8
000046  7d21              LDRB     r1,[r4,#0x14]
000048  4308              ORRS     r0,r0,r1
00004a  0400              LSLS     r0,r0,#16
00004c  7ee1              LDRB     r1,[r4,#0x1b]
00004e  0209              LSLS     r1,r1,#8
000050  7ea2              LDRB     r2,[r4,#0x1a]
000052  4311              ORRS     r1,r1,r2
000054  4308              ORRS     r0,r0,r1
000056  9903              LDR      r1,[sp,#0xc]
000058  6188              STR      r0,[r1,#0x18]
00005a  e000              B        |L14.94|
                  |L14.92|
;;;2352   				else
;;;2353   					res = FR_NO_PATH;		/* Reached but a file */
00005c  2505              MOVS     r5,#5
                  |L14.94|
;;;2354   			}
;;;2355   		}
;;;2356   		if (res == FR_NO_FILE) res = FR_NO_PATH;
00005e  2d04              CMP      r5,#4
000060  d100              BNE      |L14.100|
000062  2505              MOVS     r5,#5
                  |L14.100|
;;;2357   	}
;;;2358   
;;;2359   	LEAVE_FF(dj.fs, res);
000064  4628              MOV      r0,r5
;;;2360   }
000066  b00d              ADD      sp,sp,#0x34
000068  bd30              POP      {r4,r5,pc}
;;;2361   
                          ENDP

00006a  0000              DCW      0x0000
                  |L14.108|
                          DCD      LfnBuf

                          AREA ||i.f_chdrive||, CODE, READONLY, ALIGN=2

                  f_chdrive PROC
;;;2315   
;;;2316   FRESULT f_chdrive (
000000  4601              MOV      r1,r0
;;;2317   	BYTE drv		/* Drive number */
;;;2318   )
;;;2319   {
;;;2320   	if (drv >= _DRIVES) return FR_INVALID_DRIVE;
000002  2901              CMP      r1,#1
000004  db01              BLT      |L15.10|
000006  200b              MOVS     r0,#0xb
                  |L15.8|
;;;2321   
;;;2322   	Drive = drv;
;;;2323   
;;;2324   	return FR_OK;
;;;2325   }
000008  4770              BX       lr
                  |L15.10|
00000a  4802              LDR      r0,|L15.20|
00000c  7001              STRB     r1,[r0,#0]            ;2322
00000e  2000              MOVS     r0,#0                 ;2324
000010  e7fa              B        |L15.8|
;;;2326   
                          ENDP

000012  0000              DCW      0x0000
                  |L15.20|
                          DCD      Drive

                          AREA ||i.f_chmod||, CODE, READONLY, ALIGN=2

                  f_chmod PROC
;;;2908   
;;;2909   FRESULT f_chmod (
000000  b5f7              PUSH     {r0-r2,r4-r7,lr}
;;;2910   	const TCHAR *path,	/* Pointer to the file path */
;;;2911   	BYTE value,			/* Attribute bits */
;;;2912   	BYTE mask			/* Attribute mask to change */
;;;2913   )
;;;2914   {
000002  b08c              SUB      sp,sp,#0x30
000004  460f              MOV      r7,r1
000006  4614              MOV      r4,r2
;;;2915   	FRESULT res;
;;;2916   	DIR dj;
;;;2917   	BYTE *dir;
;;;2918   	DEF_NAMEBUF;
;;;2919   
;;;2920   
;;;2921   	res = chk_mounted(&path, &dj.fs, 1);
000008  2201              MOVS     r2,#1
00000a  a903              ADD      r1,sp,#0xc
00000c  a80c              ADD      r0,sp,#0x30
00000e  f7fffffe          BL       chk_mounted
000012  4605              MOV      r5,r0
;;;2922   	if (res == FR_OK) {
000014  2d00              CMP      r5,#0
000016  d127              BNE      |L16.104|
;;;2923   		INIT_BUF(dj);
000018  4668              MOV      r0,sp
00001a  9009              STR      r0,[sp,#0x24]
00001c  4814              LDR      r0,|L16.112|
00001e  900a              STR      r0,[sp,#0x28]
;;;2924   		res = follow_path(&dj, path);		/* Follow the file path */
000020  a803              ADD      r0,sp,#0xc
000022  990c              LDR      r1,[sp,#0x30]
000024  f7fffffe          BL       follow_path
000028  4605              MOV      r5,r0
;;;2925   		FREE_BUF();
;;;2926   		if (_FS_RPATH && res == FR_OK && (dj.fn[NS] & NS_DOT))
00002a  2d00              CMP      r5,#0
00002c  d106              BNE      |L16.60|
00002e  9809              LDR      r0,[sp,#0x24]
000030  7ac0              LDRB     r0,[r0,#0xb]
000032  2120              MOVS     r1,#0x20
000034  4008              ANDS     r0,r0,r1
000036  2800              CMP      r0,#0
000038  d000              BEQ      |L16.60|
;;;2927   			res = FR_INVALID_NAME;
00003a  2506              MOVS     r5,#6
                  |L16.60|
;;;2928   		if (res == FR_OK) {
00003c  2d00              CMP      r5,#0
00003e  d113              BNE      |L16.104|
;;;2929   			dir = dj.dir;
000040  9e08              LDR      r6,[sp,#0x20]
;;;2930   			if (!dir) {						/* Is it a root directory? */
000042  2e00              CMP      r6,#0
000044  d101              BNE      |L16.74|
;;;2931   				res = FR_INVALID_NAME;
000046  2506              MOVS     r5,#6
000048  e00e              B        |L16.104|
                  |L16.74|
;;;2932   			} else {						/* File or sub directory */
;;;2933   				mask &= AM_RDO|AM_HID|AM_SYS|AM_ARC;	/* Valid attribute mask */
00004a  2027              MOVS     r0,#0x27
00004c  4004              ANDS     r4,r4,r0
;;;2934   				dir[DIR_Attr] = (value & mask) | (dir[DIR_Attr] & (BYTE)~mask);	/* Apply attribute change */
00004e  4638              MOV      r0,r7
000050  4020              ANDS     r0,r0,r4
000052  7af1              LDRB     r1,[r6,#0xb]
000054  43a1              BICS     r1,r1,r4
000056  4308              ORRS     r0,r0,r1
000058  72f0              STRB     r0,[r6,#0xb]
;;;2935   				dj.fs->wflag = 1;
00005a  2001              MOVS     r0,#1
00005c  9903              LDR      r1,[sp,#0xc]
00005e  7108              STRB     r0,[r1,#4]
;;;2936   				res = sync(dj.fs);
000060  9803              LDR      r0,[sp,#0xc]
000062  f7fffffe          BL       sync
000066  4605              MOV      r5,r0
                  |L16.104|
;;;2937   			}
;;;2938   		}
;;;2939   	}
;;;2940   
;;;2941   	LEAVE_FF(dj.fs, res);
000068  4628              MOV      r0,r5
;;;2942   }
00006a  b00f              ADD      sp,sp,#0x3c
00006c  bdf0              POP      {r4-r7,pc}
;;;2943   
                          ENDP

00006e  0000              DCW      0x0000
                  |L16.112|
                          DCD      LfnBuf

                          AREA ||i.f_close||, CODE, READONLY, ALIGN=1

                  f_close PROC
;;;2274   
;;;2275   FRESULT f_close (
000000  b570              PUSH     {r4-r6,lr}
;;;2276   	FIL *fp		/* Pointer to the file object to be closed */
;;;2277   )
;;;2278   {
000002  4604              MOV      r4,r0
;;;2279   	FRESULT res;
;;;2280   
;;;2281   #if _FS_READONLY
;;;2282   	FATFS *fs = fp->fs;
;;;2283   	res = validate(fs, fp->id);
;;;2284   	if (res == FR_OK) fp->fs = 0;	/* Discard file object */
;;;2285   	LEAVE_FF(fs, res);
;;;2286   
;;;2287   #else
;;;2288   	res = f_sync(fp);		/* Flush cached data */
000004  4620              MOV      r0,r4
000006  f7fffffe          BL       f_sync
00000a  4605              MOV      r5,r0
;;;2289   #if _FS_SHARE
;;;2290   	if (res == FR_OK) {		/* Decrement open counter */
;;;2291   #if _FS_REENTRANT
;;;2292   		res = validate(fp->fs, fp->id);
;;;2293   		if (res == FR_OK) {
;;;2294   			res = dec_lock(fp->fs, fp->lockid);	
;;;2295   			unlock_fs(fp->fs, FR_OK);
;;;2296   		}
;;;2297   #else
;;;2298   		res = dec_lock(fp->fs, fp->lockid);
;;;2299   #endif
;;;2300   	}
;;;2301   #endif
;;;2302   	if (res == FR_OK) fp->fs = 0;	/* Discard file object */
00000c  2d00              CMP      r5,#0
00000e  d100              BNE      |L17.18|
000010  6020              STR      r0,[r4,#0]
                  |L17.18|
;;;2303   	return res;
000012  4628              MOV      r0,r5
;;;2304   #endif
;;;2305   }
000014  bd70              POP      {r4-r6,pc}
;;;2306   
                          ENDP


                          AREA ||i.f_getfree||, CODE, READONLY, ALIGN=1

                  f_getfree PROC
;;;2651   
;;;2652   FRESULT f_getfree (
000000  b5f7              PUSH     {r0-r2,r4-r7,lr}
;;;2653   	const TCHAR *path,	/* Pointer to the logical drive number (root dir) */
;;;2654   	DWORD *nclst,		/* Pointer to the variable to return number of free clusters */
;;;2655   	FATFS **fatfs		/* Pointer to pointer to corresponding file system object to return */
;;;2656   )
;;;2657   {
000002  b086              SUB      sp,sp,#0x18
000004  4614              MOV      r4,r2
;;;2658   	FRESULT res;
;;;2659   	DWORD n, clst, sect, stat;
;;;2660   	UINT i;
;;;2661   	BYTE fat, *p;
;;;2662   
;;;2663   
;;;2664   	/* Get drive number */
;;;2665   	res = chk_mounted(&path, fatfs, 0);
000006  2200              MOVS     r2,#0
000008  4621              MOV      r1,r4
00000a  a806              ADD      r0,sp,#0x18
00000c  f7fffffe          BL       chk_mounted
000010  9005              STR      r0,[sp,#0x14]
;;;2666   	if (res == FR_OK) {
000012  9805              LDR      r0,[sp,#0x14]
000014  2800              CMP      r0,#0
000016  d17e              BNE      |L18.278|
;;;2667   		/* If free_clust is valid, return it without full cluster scan */
;;;2668   		if ((*fatfs)->free_clust <= (*fatfs)->n_fatent - 2) {
000018  6820              LDR      r0,[r4,#0]
00001a  6901              LDR      r1,[r0,#0x10]
00001c  69c0              LDR      r0,[r0,#0x1c]
00001e  1e80              SUBS     r0,r0,#2
000020  4281              CMP      r1,r0
000022  d804              BHI      |L18.46|
;;;2669   			*nclst = (*fatfs)->free_clust;
000024  6820              LDR      r0,[r4,#0]
000026  6901              LDR      r1,[r0,#0x10]
000028  9807              LDR      r0,[sp,#0x1c]
00002a  6001              STR      r1,[r0,#0]
00002c  e073              B        |L18.278|
                  |L18.46|
;;;2670   		} else {
;;;2671   			/* Get number of free clusters */
;;;2672   			fat = (*fatfs)->fs_type;
00002e  6820              LDR      r0,[r4,#0]
000030  7800              LDRB     r0,[r0,#0]
000032  9001              STR      r0,[sp,#4]
;;;2673   			n = 0;
000034  2600              MOVS     r6,#0
;;;2674   			if (fat == FS_FAT12) {
000036  9801              LDR      r0,[sp,#4]
000038  2801              CMP      r0,#1
00003a  d11e              BNE      |L18.122|
;;;2675   				clst = 2;
00003c  2702              MOVS     r7,#2
;;;2676   				do {
00003e  bf00              NOP      
                  |L18.64|
;;;2677   					stat = get_fat(*fatfs, clst);
000040  4639              MOV      r1,r7
000042  6820              LDR      r0,[r4,#0]
000044  f7fffffe          BL       get_fat
000048  9003              STR      r0,[sp,#0xc]
;;;2678   					if (stat == 0xFFFFFFFF) { res = FR_DISK_ERR; break; }
00004a  9803              LDR      r0,[sp,#0xc]
00004c  1c40              ADDS     r0,r0,#1
00004e  2800              CMP      r0,#0
000050  d102              BNE      |L18.88|
000052  2001              MOVS     r0,#1
000054  9005              STR      r0,[sp,#0x14]
000056  e00f              B        |L18.120|
                  |L18.88|
;;;2679   					if (stat == 1) { res = FR_INT_ERR; break; }
000058  9803              LDR      r0,[sp,#0xc]
00005a  2801              CMP      r0,#1
00005c  d102              BNE      |L18.100|
00005e  2002              MOVS     r0,#2
000060  9005              STR      r0,[sp,#0x14]
000062  e009              B        |L18.120|
                  |L18.100|
;;;2680   					if (stat == 0) n++;
000064  9803              LDR      r0,[sp,#0xc]
000066  2800              CMP      r0,#0
000068  d100              BNE      |L18.108|
00006a  1c76              ADDS     r6,r6,#1
                  |L18.108|
;;;2681   				} while (++clst < (*fatfs)->n_fatent);
00006c  1c78              ADDS     r0,r7,#1
00006e  4607              MOV      r7,r0
000070  6821              LDR      r1,[r4,#0]
000072  69c9              LDR      r1,[r1,#0x1c]
000074  4288              CMP      r0,r1
000076  d3e3              BCC      |L18.64|
                  |L18.120|
000078  e043              B        |L18.258|
                  |L18.122|
;;;2682   			} else {
;;;2683   				clst = (*fatfs)->n_fatent;
00007a  6820              LDR      r0,[r4,#0]
00007c  69c7              LDR      r7,[r0,#0x1c]
;;;2684   				sect = (*fatfs)->fatbase;
00007e  6820              LDR      r0,[r4,#0]
000080  6a40              LDR      r0,[r0,#0x24]
000082  9004              STR      r0,[sp,#0x10]
;;;2685   				i = 0; p = 0;
000084  2000              MOVS     r0,#0
000086  9002              STR      r0,[sp,#8]
000088  2500              MOVS     r5,#0
;;;2686   				do {
00008a  bf00              NOP      
                  |L18.140|
;;;2687   					if (!i) {
00008c  9802              LDR      r0,[sp,#8]
00008e  2800              CMP      r0,#0
000090  d111              BNE      |L18.182|
;;;2688   						res = move_window(*fatfs, sect++);
000092  9a04              LDR      r2,[sp,#0x10]
000094  1c53              ADDS     r3,r2,#1
000096  4611              MOV      r1,r2
000098  9304              STR      r3,[sp,#0x10]
00009a  6820              LDR      r0,[r4,#0]
00009c  f7fffffe          BL       move_window
0000a0  9005              STR      r0,[sp,#0x14]
;;;2689   						if (res != FR_OK) break;
0000a2  9805              LDR      r0,[sp,#0x14]
0000a4  2800              CMP      r0,#0
0000a6  d000              BEQ      |L18.170|
0000a8  e02a              B        |L18.256|
                  |L18.170|
;;;2690   						p = (*fatfs)->win;
0000aa  6820              LDR      r0,[r4,#0]
0000ac  4605              MOV      r5,r0
0000ae  3534              ADDS     r5,r5,#0x34
;;;2691   						i = SS(*fatfs);
0000b0  2001              MOVS     r0,#1
0000b2  0240              LSLS     r0,r0,#9
0000b4  9002              STR      r0,[sp,#8]
                  |L18.182|
;;;2692   					}
;;;2693   					if (fat == FS_FAT16) {
0000b6  9801              LDR      r0,[sp,#4]
0000b8  2802              CMP      r0,#2
0000ba  d10b              BNE      |L18.212|
;;;2694   						if (LD_WORD(p) == 0) n++;
0000bc  7868              LDRB     r0,[r5,#1]
0000be  0200              LSLS     r0,r0,#8
0000c0  7829              LDRB     r1,[r5,#0]
0000c2  4308              ORRS     r0,r0,r1
0000c4  2800              CMP      r0,#0
0000c6  d100              BNE      |L18.202|
0000c8  1c76              ADDS     r6,r6,#1
                  |L18.202|
;;;2695   						p += 2; i -= 2;
0000ca  1cad              ADDS     r5,r5,#2
0000cc  9802              LDR      r0,[sp,#8]
0000ce  1e80              SUBS     r0,r0,#2
0000d0  9002              STR      r0,[sp,#8]
0000d2  e012              B        |L18.250|
                  |L18.212|
;;;2696   					} else {
;;;2697   						if ((LD_DWORD(p) & 0x0FFFFFFF) == 0) n++;
0000d4  78e8              LDRB     r0,[r5,#3]
0000d6  0600              LSLS     r0,r0,#24
0000d8  78a9              LDRB     r1,[r5,#2]
0000da  0409              LSLS     r1,r1,#16
0000dc  4308              ORRS     r0,r0,r1
0000de  7869              LDRB     r1,[r5,#1]
0000e0  0209              LSLS     r1,r1,#8
0000e2  4308              ORRS     r0,r0,r1
0000e4  7829              LDRB     r1,[r5,#0]
0000e6  4308              ORRS     r0,r0,r1
0000e8  0100              LSLS     r0,r0,#4
0000ea  0900              LSRS     r0,r0,#4
0000ec  2800              CMP      r0,#0
0000ee  d100              BNE      |L18.242|
0000f0  1c76              ADDS     r6,r6,#1
                  |L18.242|
;;;2698   						p += 4; i -= 4;
0000f2  1d2d              ADDS     r5,r5,#4
0000f4  9802              LDR      r0,[sp,#8]
0000f6  1f00              SUBS     r0,r0,#4
0000f8  9002              STR      r0,[sp,#8]
                  |L18.250|
;;;2699   					}
;;;2700   				} while (--clst);
0000fa  1e78              SUBS     r0,r7,#1
0000fc  1e07              SUBS     r7,r0,#0
0000fe  d1c5              BNE      |L18.140|
                  |L18.256|
000100  bf00              NOP                            ;2689
                  |L18.258|
;;;2701   			}
;;;2702   			(*fatfs)->free_clust = n;
000102  6820              LDR      r0,[r4,#0]
000104  6106              STR      r6,[r0,#0x10]
;;;2703   			if (fat == FS_FAT32) (*fatfs)->fsi_flag = 1;
000106  9801              LDR      r0,[sp,#4]
000108  2803              CMP      r0,#3
00010a  d102              BNE      |L18.274|
00010c  2001              MOVS     r0,#1
00010e  6821              LDR      r1,[r4,#0]
000110  7148              STRB     r0,[r1,#5]
                  |L18.274|
;;;2704   			*nclst = n;
000112  9807              LDR      r0,[sp,#0x1c]
000114  6006              STR      r6,[r0,#0]
                  |L18.278|
;;;2705   		}
;;;2706   	}
;;;2707   	LEAVE_FF(*fatfs, res);
000116  9805              LDR      r0,[sp,#0x14]
;;;2708   }
000118  b009              ADD      sp,sp,#0x24
00011a  bdf0              POP      {r4-r7,pc}
;;;2709   
                          ENDP


                          AREA ||i.f_lseek||, CODE, READONLY, ALIGN=1

                  f_lseek PROC
;;;2370   
;;;2371   FRESULT f_lseek (
000000  b5f0              PUSH     {r4-r7,lr}
;;;2372   	FIL *fp,		/* Pointer to the file object */
;;;2373   	DWORD ofs		/* File pointer from top of file */
;;;2374   )
;;;2375   {
000002  b085              SUB      sp,sp,#0x14
000004  4604              MOV      r4,r0
000006  460e              MOV      r6,r1
;;;2376   	FRESULT res;
;;;2377   
;;;2378   
;;;2379   	res = validate(fp->fs, fp->id);		/* Check validity of the object */
000008  88a1              LDRH     r1,[r4,#4]
00000a  6820              LDR      r0,[r4,#0]
00000c  f7fffffe          BL       validate
000010  9003              STR      r0,[sp,#0xc]
;;;2380   	if (res != FR_OK) LEAVE_FF(fp->fs, res);
000012  9803              LDR      r0,[sp,#0xc]
000014  2800              CMP      r0,#0
000016  d002              BEQ      |L19.30|
000018  9803              LDR      r0,[sp,#0xc]
                  |L19.26|
;;;2381   	if (fp->flag & FA__ERROR)			/* Check abort flag */
;;;2382   		LEAVE_FF(fp->fs, FR_INT_ERR);
;;;2383   
;;;2384   #if _USE_FASTSEEK
;;;2385   	if (fp->cltbl) {	/* Fast seek */
;;;2386   		DWORD cl, pcl, ncl, tcl, dsc, tlen, *tbl = fp->cltbl;
;;;2387   		BYTE csc;
;;;2388   
;;;2389   		tlen = *tbl++;
;;;2390   		if (ofs == CREATE_LINKMAP) {	/* Create link map table */
;;;2391   			cl = fp->org_clust;
;;;2392   			if (cl) {
;;;2393   				do {
;;;2394   					if (tlen < 4) {	/* Not enough table items */
;;;2395   						res = FR_NOT_ENOUGH_CORE; break;
;;;2396   					}
;;;2397   					tcl = cl; ncl = 0;
;;;2398   					do {		/* Get a fragment and store the top and length */
;;;2399   						pcl = cl; ncl++;
;;;2400   						cl = get_fat(fp->fs, cl);
;;;2401   						if (cl <= 1) ABORT(fp->fs, FR_INT_ERR);
;;;2402   						if (cl == 0xFFFFFFFF) ABORT(fp->fs, FR_DISK_ERR);
;;;2403   					} while (cl == pcl + 1);
;;;2404   					*tbl++ = ncl; *tbl++ = tcl;
;;;2405   					tlen -= 2;
;;;2406   				} while (cl < fp->fs->n_fatent);
;;;2407   			}
;;;2408   			*tbl = 0;	/* Terminate table */
;;;2409   
;;;2410   		} else {						/* Fast seek */
;;;2411   			if (ofs > fp->fsize)		/* Clip offset at the file size */
;;;2412   				ofs = fp->fsize;
;;;2413   			fp->fptr = ofs;				/* Set file pointer */
;;;2414   			if (ofs) {
;;;2415   				dsc = (ofs - 1) / SS(fp->fs);
;;;2416   				cl = dsc / fp->fs->csize;
;;;2417   				for (;;) {
;;;2418   					ncl = *tbl++;
;;;2419   					if (!ncl) ABORT(fp->fs, FR_INT_ERR);
;;;2420   					if (cl < ncl) break;
;;;2421   					cl -= ncl; tbl++;
;;;2422   				}
;;;2423   				fp->curr_clust = cl + *tbl;
;;;2424   				csc = (BYTE)(dsc & (fp->fs->csize - 1));
;;;2425   				dsc = clust2sect(fp->fs, fp->curr_clust);
;;;2426   				if (!dsc) ABORT(fp->fs, FR_INT_ERR);
;;;2427   				dsc += csc;
;;;2428   				if (fp->fptr % SS(fp->fs) && dsc != fp->dsect) {
;;;2429   #if !_FS_TINY
;;;2430   #if !_FS_READONLY
;;;2431   					if (fp->flag & FA__DIRTY) {		/* Flush dirty buffer if needed */
;;;2432   						if (disk_write(fp->fs->drv, fp->buf, fp->dsect, 1) != RES_OK)
;;;2433   							ABORT(fp->fs, FR_DISK_ERR);
;;;2434   						fp->flag &= ~FA__DIRTY;
;;;2435   					}
;;;2436   #endif
;;;2437   					if (disk_read(fp->fs->drv, fp->buf, dsc, 1) != RES_OK)
;;;2438   						ABORT(fp->fs, FR_DISK_ERR);
;;;2439   #endif
;;;2440   					fp->dsect = dsc;
;;;2441   				}
;;;2442   			}
;;;2443   		}
;;;2444   	} else
;;;2445   #endif
;;;2446   
;;;2447   	/* Normal Seek */
;;;2448   	{
;;;2449   		DWORD clst, bcs, nsect, ifptr;
;;;2450   
;;;2451   		if (ofs > fp->fsize					/* In read-only mode, clip offset with the file size */
;;;2452   #if !_FS_READONLY
;;;2453   			 && !(fp->flag & FA_WRITE)
;;;2454   #endif
;;;2455   			) ofs = fp->fsize;
;;;2456   
;;;2457   		ifptr = fp->fptr;
;;;2458   		fp->fptr = nsect = 0;
;;;2459   		if (ofs) {
;;;2460   			bcs = (DWORD)fp->fs->csize * SS(fp->fs);	/* Cluster size (byte) */
;;;2461   			if (ifptr > 0 &&
;;;2462   				(ofs - 1) / bcs >= (ifptr - 1) / bcs) {	/* When seek to same or following cluster, */
;;;2463   				fp->fptr = (ifptr - 1) & ~(bcs - 1);	/* start from the current cluster */
;;;2464   				ofs -= fp->fptr;
;;;2465   				clst = fp->curr_clust;
;;;2466   			} else {									/* When seek to back cluster, */
;;;2467   				clst = fp->org_clust;					/* start from the first cluster */
;;;2468   #if !_FS_READONLY
;;;2469   				if (clst == 0) {						/* If no cluster chain, create a new chain */
;;;2470   					clst = create_chain(fp->fs, 0);
;;;2471   					if (clst == 1) ABORT(fp->fs, FR_INT_ERR);
;;;2472   					if (clst == 0xFFFFFFFF) ABORT(fp->fs, FR_DISK_ERR);
;;;2473   					fp->org_clust = clst;
;;;2474   				}
;;;2475   #endif
;;;2476   				fp->curr_clust = clst;
;;;2477   			}
;;;2478   			if (clst != 0) {
;;;2479   				while (ofs > bcs) {						/* Cluster following loop */
;;;2480   #if !_FS_READONLY
;;;2481   					if (fp->flag & FA_WRITE) {			/* Check if in write mode or not */
;;;2482   						clst = create_chain(fp->fs, clst);	/* Force stretch if in write mode */
;;;2483   						if (clst == 0) {				/* When disk gets full, clip file size */
;;;2484   							ofs = bcs; break;
;;;2485   						}
;;;2486   					} else
;;;2487   #endif
;;;2488   						clst = get_fat(fp->fs, clst);	/* Follow cluster chain if not in write mode */
;;;2489   					if (clst == 0xFFFFFFFF) ABORT(fp->fs, FR_DISK_ERR);
;;;2490   					if (clst <= 1 || clst >= fp->fs->n_fatent) ABORT(fp->fs, FR_INT_ERR);
;;;2491   					fp->curr_clust = clst;
;;;2492   					fp->fptr += bcs;
;;;2493   					ofs -= bcs;
;;;2494   				}
;;;2495   				fp->fptr += ofs;
;;;2496   				if (ofs % SS(fp->fs)) {
;;;2497   					nsect = clust2sect(fp->fs, clst);	/* Current sector */
;;;2498   					if (!nsect) ABORT(fp->fs, FR_INT_ERR);
;;;2499   					nsect += ofs / SS(fp->fs);
;;;2500   				}
;;;2501   			}
;;;2502   		}
;;;2503   		if (fp->fptr % SS(fp->fs) && nsect != fp->dsect) {
;;;2504   #if !_FS_TINY
;;;2505   #if !_FS_READONLY
;;;2506   			if (fp->flag & FA__DIRTY) {			/* Flush dirty buffer if needed */
;;;2507   				if (disk_write(fp->fs->drv, fp->buf, fp->dsect, 1) != RES_OK)
;;;2508   					ABORT(fp->fs, FR_DISK_ERR);
;;;2509   				fp->flag &= ~FA__DIRTY;
;;;2510   			}
;;;2511   #endif
;;;2512   			if (disk_read(fp->fs->drv, fp->buf, nsect, 1) != RES_OK)
;;;2513   				ABORT(fp->fs, FR_DISK_ERR);
;;;2514   #endif
;;;2515   			fp->dsect = nsect;
;;;2516   		}
;;;2517   #if !_FS_READONLY
;;;2518   		if (fp->fptr > fp->fsize) {			/* Set changed flag if the file size is extended */
;;;2519   			fp->fsize = fp->fptr;
;;;2520   			fp->flag |= FA__WRITTEN;
;;;2521   		}
;;;2522   #endif
;;;2523   	}
;;;2524   
;;;2525   	LEAVE_FF(fp->fs, res);
;;;2526   }
00001a  b005              ADD      sp,sp,#0x14
00001c  bdf0              POP      {r4-r7,pc}
                  |L19.30|
00001e  79a0              LDRB     r0,[r4,#6]            ;2381
000020  2180              MOVS     r1,#0x80              ;2381
000022  4008              ANDS     r0,r0,r1              ;2381
000024  2800              CMP      r0,#0                 ;2381
000026  d001              BEQ      |L19.44|
000028  2002              MOVS     r0,#2                 ;2382
00002a  e7f6              B        |L19.26|
                  |L19.44|
00002c  68e0              LDR      r0,[r4,#0xc]          ;2451
00002e  42b0              CMP      r0,r6                 ;2451
000030  d205              BCS      |L19.62|
000032  79a0              LDRB     r0,[r4,#6]            ;2453
000034  2102              MOVS     r1,#2                 ;2453
000036  4008              ANDS     r0,r0,r1              ;2453
000038  2800              CMP      r0,#0                 ;2453
00003a  d100              BNE      |L19.62|
00003c  68e6              LDR      r6,[r4,#0xc]          ;2455
                  |L19.62|
00003e  68a0              LDR      r0,[r4,#8]            ;2457
000040  9000              STR      r0,[sp,#0]            ;2457
000042  2000              MOVS     r0,#0                 ;2458
000044  9001              STR      r0,[sp,#4]            ;2458
000046  60a0              STR      r0,[r4,#8]            ;2458
000048  2e00              CMP      r6,#0                 ;2459
00004a  d07d              BEQ      |L19.328|
00004c  6820              LDR      r0,[r4,#0]            ;2460
00004e  7880              LDRB     r0,[r0,#2]            ;2460
000050  0240              LSLS     r0,r0,#9              ;2460
000052  9002              STR      r0,[sp,#8]            ;2460
000054  9800              LDR      r0,[sp,#0]            ;2461
000056  2800              CMP      r0,#0                 ;2461
000058  d015              BEQ      |L19.134|
00005a  1e70              SUBS     r0,r6,#1              ;2462
00005c  9902              LDR      r1,[sp,#8]            ;2462
00005e  f7fffffe          BL       __aeabi_uidivmod
000062  4607              MOV      r7,r0                 ;2462
000064  9900              LDR      r1,[sp,#0]            ;2462
000066  1e48              SUBS     r0,r1,#1              ;2462
000068  9902              LDR      r1,[sp,#8]            ;2462
00006a  f7fffffe          BL       __aeabi_uidivmod
00006e  4287              CMP      r7,r0                 ;2462
000070  d309              BCC      |L19.134|
000072  9800              LDR      r0,[sp,#0]            ;2463
000074  1e40              SUBS     r0,r0,#1              ;2463
000076  9902              LDR      r1,[sp,#8]            ;2463
000078  1e49              SUBS     r1,r1,#1              ;2463
00007a  4388              BICS     r0,r0,r1              ;2463
00007c  60a0              STR      r0,[r4,#8]            ;2463
00007e  68a0              LDR      r0,[r4,#8]            ;2464
000080  1a36              SUBS     r6,r6,r0              ;2464
000082  6965              LDR      r5,[r4,#0x14]         ;2465
000084  e01a              B        |L19.188|
                  |L19.134|
000086  6925              LDR      r5,[r4,#0x10]         ;2467
000088  2d00              CMP      r5,#0                 ;2469
00008a  d116              BNE      |L19.186|
00008c  2100              MOVS     r1,#0                 ;2470
00008e  6820              LDR      r0,[r4,#0]            ;2470
000090  f7fffffe          BL       create_chain
000094  4605              MOV      r5,r0                 ;2470
000096  2d01              CMP      r5,#1                 ;2471
000098  d105              BNE      |L19.166|
00009a  79a0              LDRB     r0,[r4,#6]            ;2471
00009c  2180              MOVS     r1,#0x80              ;2471
00009e  4308              ORRS     r0,r0,r1              ;2471
0000a0  71a0              STRB     r0,[r4,#6]            ;2471
0000a2  2002              MOVS     r0,#2                 ;2471
0000a4  e7b9              B        |L19.26|
                  |L19.166|
0000a6  1c68              ADDS     r0,r5,#1              ;2472
0000a8  2800              CMP      r0,#0                 ;2472
0000aa  d105              BNE      |L19.184|
0000ac  79a0              LDRB     r0,[r4,#6]            ;2472
0000ae  2180              MOVS     r1,#0x80              ;2472
0000b0  4308              ORRS     r0,r0,r1              ;2472
0000b2  71a0              STRB     r0,[r4,#6]            ;2472
0000b4  2001              MOVS     r0,#1                 ;2472
0000b6  e7b0              B        |L19.26|
                  |L19.184|
0000b8  6125              STR      r5,[r4,#0x10]         ;2473
                  |L19.186|
0000ba  6165              STR      r5,[r4,#0x14]         ;2476
                  |L19.188|
0000bc  2d00              CMP      r5,#0                 ;2478
0000be  d04e              BEQ      |L19.350|
0000c0  e02e              B        |L19.288|
                  |L19.194|
0000c2  79a0              LDRB     r0,[r4,#6]            ;2481
0000c4  2102              MOVS     r1,#2                 ;2481
0000c6  4008              ANDS     r0,r0,r1              ;2481
0000c8  2800              CMP      r0,#0                 ;2481
0000ca  d008              BEQ      |L19.222|
0000cc  4629              MOV      r1,r5                 ;2482
0000ce  6820              LDR      r0,[r4,#0]            ;2482
0000d0  f7fffffe          BL       create_chain
0000d4  4605              MOV      r5,r0                 ;2482
0000d6  2d00              CMP      r5,#0                 ;2483
0000d8  d106              BNE      |L19.232|
0000da  9e02              LDR      r6,[sp,#8]            ;2484
0000dc  e023              B        |L19.294|
                  |L19.222|
0000de  4629              MOV      r1,r5                 ;2488
0000e0  6820              LDR      r0,[r4,#0]            ;2488
0000e2  f7fffffe          BL       get_fat
0000e6  4605              MOV      r5,r0                 ;2488
                  |L19.232|
0000e8  1c68              ADDS     r0,r5,#1              ;2489
0000ea  2800              CMP      r0,#0                 ;2489
0000ec  d105              BNE      |L19.250|
0000ee  79a0              LDRB     r0,[r4,#6]            ;2489
0000f0  2180              MOVS     r1,#0x80              ;2489
0000f2  4308              ORRS     r0,r0,r1              ;2489
0000f4  71a0              STRB     r0,[r4,#6]            ;2489
0000f6  2001              MOVS     r0,#1                 ;2489
0000f8  e78f              B        |L19.26|
                  |L19.250|
0000fa  2d01              CMP      r5,#1                 ;2490
0000fc  d903              BLS      |L19.262|
0000fe  6820              LDR      r0,[r4,#0]            ;2490
000100  69c0              LDR      r0,[r0,#0x1c]         ;2490
000102  42a8              CMP      r0,r5                 ;2490
000104  d805              BHI      |L19.274|
                  |L19.262|
000106  79a0              LDRB     r0,[r4,#6]            ;2490
000108  2180              MOVS     r1,#0x80              ;2490
00010a  4308              ORRS     r0,r0,r1              ;2490
00010c  71a0              STRB     r0,[r4,#6]            ;2490
00010e  2002              MOVS     r0,#2                 ;2490
000110  e783              B        |L19.26|
                  |L19.274|
000112  6165              STR      r5,[r4,#0x14]         ;2491
000114  68a1              LDR      r1,[r4,#8]            ;2492
000116  9802              LDR      r0,[sp,#8]            ;2492
000118  1808              ADDS     r0,r1,r0              ;2492
00011a  60a0              STR      r0,[r4,#8]            ;2492
00011c  9802              LDR      r0,[sp,#8]            ;2493
00011e  1a36              SUBS     r6,r6,r0              ;2493
                  |L19.288|
000120  9802              LDR      r0,[sp,#8]            ;2479
000122  4286              CMP      r6,r0                 ;2479
000124  d8cd              BHI      |L19.194|
                  |L19.294|
000126  bf00              NOP                            ;2484
000128  68a0              LDR      r0,[r4,#8]            ;2495
00012a  1980              ADDS     r0,r0,r6              ;2495
00012c  60a0              STR      r0,[r4,#8]            ;2495
00012e  05f0              LSLS     r0,r6,#23             ;2496
000130  0dc0              LSRS     r0,r0,#23             ;2496
000132  2800              CMP      r0,#0                 ;2496
000134  d013              BEQ      |L19.350|
000136  4629              MOV      r1,r5                 ;2497
000138  6820              LDR      r0,[r4,#0]            ;2497
00013a  f7fffffe          BL       clust2sect
00013e  9001              STR      r0,[sp,#4]            ;2497
000140  9801              LDR      r0,[sp,#4]            ;2498
000142  2800              CMP      r0,#0                 ;2498
000144  d107              BNE      |L19.342|
000146  e000              B        |L19.330|
                  |L19.328|
000148  e009              B        |L19.350|
                  |L19.330|
00014a  79a0              LDRB     r0,[r4,#6]            ;2498
00014c  2180              MOVS     r1,#0x80              ;2498
00014e  4308              ORRS     r0,r0,r1              ;2498
000150  71a0              STRB     r0,[r4,#6]            ;2498
000152  2002              MOVS     r0,#2                 ;2498
000154  e761              B        |L19.26|
                  |L19.342|
000156  0a71              LSRS     r1,r6,#9              ;2499
000158  9801              LDR      r0,[sp,#4]            ;2499
00015a  1808              ADDS     r0,r1,r0              ;2499
00015c  9001              STR      r0,[sp,#4]            ;2499
                  |L19.350|
00015e  8920              LDRH     r0,[r4,#8]            ;2503
000160  05c0              LSLS     r0,r0,#23             ;2503
000162  0dc0              LSRS     r0,r0,#23             ;2503
000164  2800              CMP      r0,#0                 ;2503
000166  d02e              BEQ      |L19.454|
000168  69a1              LDR      r1,[r4,#0x18]         ;2503
00016a  9801              LDR      r0,[sp,#4]            ;2503
00016c  4281              CMP      r1,r0                 ;2503
00016e  d02a              BEQ      |L19.454|
000170  79a0              LDRB     r0,[r4,#6]            ;2506
000172  2140              MOVS     r1,#0x40              ;2506
000174  4008              ANDS     r0,r0,r1              ;2506
000176  2800              CMP      r0,#0                 ;2506
000178  d013              BEQ      |L19.418|
00017a  6821              LDR      r1,[r4,#0]            ;2507
00017c  7848              LDRB     r0,[r1,#1]            ;2507
00017e  2301              MOVS     r3,#1                 ;2507
000180  4621              MOV      r1,r4                 ;2507
000182  3124              ADDS     r1,r1,#0x24           ;2507
000184  69a2              LDR      r2,[r4,#0x18]         ;2507
000186  f7fffffe          BL       disk_write
00018a  2800              CMP      r0,#0                 ;2507
00018c  d005              BEQ      |L19.410|
00018e  79a0              LDRB     r0,[r4,#6]            ;2508
000190  2180              MOVS     r1,#0x80              ;2508
000192  4308              ORRS     r0,r0,r1              ;2508
000194  71a0              STRB     r0,[r4,#6]            ;2508
000196  2001              MOVS     r0,#1                 ;2508
000198  e73f              B        |L19.26|
                  |L19.410|
00019a  79a0              LDRB     r0,[r4,#6]            ;2509
00019c  2140              MOVS     r1,#0x40              ;2509
00019e  4388              BICS     r0,r0,r1              ;2509
0001a0  71a0              STRB     r0,[r4,#6]            ;2509
                  |L19.418|
0001a2  6821              LDR      r1,[r4,#0]            ;2512
0001a4  7848              LDRB     r0,[r1,#1]            ;2512
0001a6  2301              MOVS     r3,#1                 ;2512
0001a8  4621              MOV      r1,r4                 ;2512
0001aa  3124              ADDS     r1,r1,#0x24           ;2512
0001ac  9a01              LDR      r2,[sp,#4]            ;2512
0001ae  f7fffffe          BL       disk_read
0001b2  2800              CMP      r0,#0                 ;2512
0001b4  d005              BEQ      |L19.450|
0001b6  79a0              LDRB     r0,[r4,#6]            ;2513
0001b8  2180              MOVS     r1,#0x80              ;2513
0001ba  4308              ORRS     r0,r0,r1              ;2513
0001bc  71a0              STRB     r0,[r4,#6]            ;2513
0001be  2001              MOVS     r0,#1                 ;2513
0001c0  e72b              B        |L19.26|
                  |L19.450|
0001c2  9801              LDR      r0,[sp,#4]            ;2515
0001c4  61a0              STR      r0,[r4,#0x18]         ;2515
                  |L19.454|
0001c6  68e1              LDR      r1,[r4,#0xc]          ;2518
0001c8  68a0              LDR      r0,[r4,#8]            ;2518
0001ca  4288              CMP      r0,r1                 ;2518
0001cc  d905              BLS      |L19.474|
0001ce  68a0              LDR      r0,[r4,#8]            ;2519
0001d0  60e0              STR      r0,[r4,#0xc]          ;2519
0001d2  79a0              LDRB     r0,[r4,#6]            ;2520
0001d4  2120              MOVS     r1,#0x20              ;2520
0001d6  4308              ORRS     r0,r0,r1              ;2520
0001d8  71a0              STRB     r0,[r4,#6]            ;2520
                  |L19.474|
0001da  9803              LDR      r0,[sp,#0xc]          ;2525
0001dc  e71d              B        |L19.26|
;;;2527   
                          ENDP


                          AREA ||i.f_mkdir||, CODE, READONLY, ALIGN=2

                  f_mkdir PROC
;;;2832   
;;;2833   FRESULT f_mkdir (
000000  b5f1              PUSH     {r0,r4-r7,lr}
;;;2834   	const TCHAR *path		/* Pointer to the directory path */
;;;2835   )
;;;2836   {
000002  b090              SUB      sp,sp,#0x40
;;;2837   	FRESULT res;
;;;2838   	DIR dj;
;;;2839   	BYTE *dir, n;
;;;2840   	DWORD dsc, dcl, pcl, tim = get_fattime();
000004  f7fffffe          BL       get_fattime
000008  4607              MOV      r7,r0
;;;2841   	DEF_NAMEBUF;
;;;2842   
;;;2843   
;;;2844   	res = chk_mounted(&path, &dj.fs, 1);
00000a  2201              MOVS     r2,#1
00000c  a907              ADD      r1,sp,#0x1c
00000e  a810              ADD      r0,sp,#0x40
000010  f7fffffe          BL       chk_mounted
000014  4606              MOV      r6,r0
;;;2845   	if (res == FR_OK) {
000016  2e00              CMP      r6,#0
                  |L20.24|
000018  d17e              BNE      |L20.280|
;;;2846   		INIT_BUF(dj);
00001a  a801              ADD      r0,sp,#4
00001c  900d              STR      r0,[sp,#0x34]
00001e  4867              LDR      r0,|L20.444|
000020  900e              STR      r0,[sp,#0x38]
;;;2847   		res = follow_path(&dj, path);			/* Follow the file path */
000022  a807              ADD      r0,sp,#0x1c
000024  9910              LDR      r1,[sp,#0x40]
000026  f7fffffe          BL       follow_path
00002a  4606              MOV      r6,r0
;;;2848   		if (res == FR_OK) res = FR_EXIST;		/* Any object with same name is already existing */
00002c  2e00              CMP      r6,#0
00002e  d100              BNE      |L20.50|
000030  2608              MOVS     r6,#8
                  |L20.50|
;;;2849   		if (_FS_RPATH && res == FR_NO_FILE && (dj.fn[NS] & NS_DOT))
000032  2e04              CMP      r6,#4
000034  d106              BNE      |L20.68|
000036  980d              LDR      r0,[sp,#0x34]
000038  7ac0              LDRB     r0,[r0,#0xb]
00003a  2120              MOVS     r1,#0x20
00003c  4008              ANDS     r0,r0,r1
00003e  2800              CMP      r0,#0
000040  d000              BEQ      |L20.68|
;;;2850   			res = FR_INVALID_NAME;
000042  2606              MOVS     r6,#6
                  |L20.68|
;;;2851   		if (res == FR_NO_FILE) {				/* Can create a new directory */
000044  2e04              CMP      r6,#4
000046  d1e7              BNE      |L20.24|
;;;2852   			dcl = create_chain(dj.fs, 0);		/* Allocate a cluster for the new directory table */
000048  2100              MOVS     r1,#0
00004a  9807              LDR      r0,[sp,#0x1c]
00004c  f7fffffe          BL       create_chain
000050  4605              MOV      r5,r0
;;;2853   			res = FR_OK;
000052  2600              MOVS     r6,#0
;;;2854   			if (dcl == 0) res = FR_DENIED;		/* No space to allocate a new cluster */
000054  2d00              CMP      r5,#0
000056  d100              BNE      |L20.90|
000058  2607              MOVS     r6,#7
                  |L20.90|
;;;2855   			if (dcl == 1) res = FR_INT_ERR;
00005a  2d01              CMP      r5,#1
00005c  d100              BNE      |L20.96|
00005e  2602              MOVS     r6,#2
                  |L20.96|
;;;2856   			if (dcl == 0xFFFFFFFF) res = FR_DISK_ERR;
000060  1c68              ADDS     r0,r5,#1
000062  2800              CMP      r0,#0
000064  d100              BNE      |L20.104|
000066  2601              MOVS     r6,#1
                  |L20.104|
;;;2857   			if (res == FR_OK)					/* Flush FAT */
000068  2e00              CMP      r6,#0
00006a  d104              BNE      |L20.118|
;;;2858   				res = move_window(dj.fs, 0);
00006c  2100              MOVS     r1,#0
00006e  9807              LDR      r0,[sp,#0x1c]
000070  f7fffffe          BL       move_window
000074  4606              MOV      r6,r0
                  |L20.118|
;;;2859   			if (res == FR_OK) {					/* Initialize the new directory table */
000076  2e00              CMP      r6,#0
000078  d174              BNE      |L20.356|
;;;2860   				dsc = clust2sect(dj.fs, dcl);
00007a  4629              MOV      r1,r5
00007c  9807              LDR      r0,[sp,#0x1c]
00007e  f7fffffe          BL       clust2sect
000082  9005              STR      r0,[sp,#0x14]
;;;2861   				dir = dj.fs->win;
000084  9807              LDR      r0,[sp,#0x1c]
000086  4604              MOV      r4,r0
000088  3434              ADDS     r4,r4,#0x34
;;;2862   				mem_set(dir, 0, SS(dj.fs));
00008a  2201              MOVS     r2,#1
00008c  0252              LSLS     r2,r2,#9
00008e  2100              MOVS     r1,#0
000090  4620              MOV      r0,r4
000092  f7fffffe          BL       mem_set
;;;2863   				mem_set(dir+DIR_Name, ' ', 8+3);	/* Create "." entry */
000096  220b              MOVS     r2,#0xb
000098  2120              MOVS     r1,#0x20
00009a  4620              MOV      r0,r4
00009c  f7fffffe          BL       mem_set
;;;2864   				dir[DIR_Name] = '.';
0000a0  202e              MOVS     r0,#0x2e
0000a2  7020              STRB     r0,[r4,#0]
;;;2865   				dir[DIR_Attr] = AM_DIR;
0000a4  2010              MOVS     r0,#0x10
0000a6  72e0              STRB     r0,[r4,#0xb]
;;;2866   				ST_DWORD(dir+DIR_WrtTime, tim);
0000a8  75a7              STRB     r7,[r4,#0x16]
0000aa  0438              LSLS     r0,r7,#16
0000ac  0e01              LSRS     r1,r0,#24
0000ae  75e1              STRB     r1,[r4,#0x17]
0000b0  0238              LSLS     r0,r7,#8
0000b2  0e01              LSRS     r1,r0,#24
0000b4  7621              STRB     r1,[r4,#0x18]
0000b6  0e39              LSRS     r1,r7,#24
0000b8  7661              STRB     r1,[r4,#0x19]
;;;2867   				ST_WORD(dir+DIR_FstClusLO, dcl);
0000ba  76a5              STRB     r5,[r4,#0x1a]
0000bc  0428              LSLS     r0,r5,#16
0000be  0e01              LSRS     r1,r0,#24
0000c0  76e1              STRB     r1,[r4,#0x1b]
;;;2868   				ST_WORD(dir+DIR_FstClusHI, dcl >> 16);
0000c2  0228              LSLS     r0,r5,#8
0000c4  0e00              LSRS     r0,r0,#24
0000c6  7520              STRB     r0,[r4,#0x14]
0000c8  0e29              LSRS     r1,r5,#24
0000ca  7561              STRB     r1,[r4,#0x15]
;;;2869   				mem_cpy(dir+32, dir, 32); 			/* Create ".." entry */
0000cc  2220              MOVS     r2,#0x20
0000ce  4621              MOV      r1,r4
0000d0  18a0              ADDS     r0,r4,r2
0000d2  f7fffffe          BL       mem_cpy
;;;2870   				dir[33] = '.'; pcl = dj.sclust;
0000d6  212e              MOVS     r1,#0x2e
0000d8  2021              MOVS     r0,#0x21
0000da  5501              STRB     r1,[r0,r4]
0000dc  9809              LDR      r0,[sp,#0x24]
0000de  9004              STR      r0,[sp,#0x10]
;;;2871   				if (dj.fs->fs_type == FS_FAT32 && pcl == dj.fs->dirbase)
0000e0  9807              LDR      r0,[sp,#0x1c]
0000e2  7800              LDRB     r0,[r0,#0]
0000e4  2803              CMP      r0,#3
0000e6  d106              BNE      |L20.246|
0000e8  9807              LDR      r0,[sp,#0x1c]
0000ea  6a81              LDR      r1,[r0,#0x28]
0000ec  9804              LDR      r0,[sp,#0x10]
0000ee  4281              CMP      r1,r0
0000f0  d101              BNE      |L20.246|
;;;2872   					pcl = 0;
0000f2  2000              MOVS     r0,#0
0000f4  9004              STR      r0,[sp,#0x10]
                  |L20.246|
;;;2873   				ST_WORD(dir+32+DIR_FstClusLO, pcl);
0000f6  9804              LDR      r0,[sp,#0x10]
0000f8  b2c1              UXTB     r1,r0
0000fa  203a              MOVS     r0,#0x3a
0000fc  5501              STRB     r1,[r0,r4]
0000fe  9804              LDR      r0,[sp,#0x10]
000100  0400              LSLS     r0,r0,#16
000102  0e01              LSRS     r1,r0,#24
000104  203b              MOVS     r0,#0x3b
000106  5501              STRB     r1,[r0,r4]
;;;2874   				ST_WORD(dir+32+DIR_FstClusHI, pcl >> 16);
000108  9804              LDR      r0,[sp,#0x10]
00010a  0200              LSLS     r0,r0,#8
00010c  0e01              LSRS     r1,r0,#24
00010e  2034              MOVS     r0,#0x34
000110  5501              STRB     r1,[r0,r4]
000112  9804              LDR      r0,[sp,#0x10]
000114  0e01              LSRS     r1,r0,#24
000116  e000              B        |L20.282|
                  |L20.280|
000118  e04d              B        |L20.438|
                  |L20.282|
00011a  2035              MOVS     r0,#0x35
00011c  5501              STRB     r1,[r0,r4]
;;;2875   				for (n = dj.fs->csize; n; n--) {	/* Write dot entries and clear following sectors */
00011e  9807              LDR      r0,[sp,#0x1c]
000120  7880              LDRB     r0,[r0,#2]
000122  9006              STR      r0,[sp,#0x18]
000124  e01a              B        |L20.348|
                  |L20.294|
;;;2876   					dj.fs->winsect = dsc++;
000126  9907              LDR      r1,[sp,#0x1c]
000128  9805              LDR      r0,[sp,#0x14]
00012a  6308              STR      r0,[r1,#0x30]
00012c  9805              LDR      r0,[sp,#0x14]
00012e  1c40              ADDS     r0,r0,#1
000130  9005              STR      r0,[sp,#0x14]
;;;2877   					dj.fs->wflag = 1;
000132  2001              MOVS     r0,#1
000134  9907              LDR      r1,[sp,#0x1c]
000136  7108              STRB     r0,[r1,#4]
;;;2878   					res = move_window(dj.fs, 0);
000138  2100              MOVS     r1,#0
00013a  9807              LDR      r0,[sp,#0x1c]
00013c  f7fffffe          BL       move_window
000140  4606              MOV      r6,r0
;;;2879   					if (res != FR_OK) break;
000142  2e00              CMP      r6,#0
000144  d000              BEQ      |L20.328|
000146  e00c              B        |L20.354|
                  |L20.328|
;;;2880   					mem_set(dir, 0, SS(dj.fs));
000148  2201              MOVS     r2,#1
00014a  0252              LSLS     r2,r2,#9
00014c  2100              MOVS     r1,#0
00014e  4620              MOV      r0,r4
000150  f7fffffe          BL       mem_set
000154  9806              LDR      r0,[sp,#0x18]         ;2875
000156  1e40              SUBS     r0,r0,#1              ;2875
000158  b2c0              UXTB     r0,r0                 ;2875
00015a  9006              STR      r0,[sp,#0x18]         ;2875
                  |L20.348|
00015c  9806              LDR      r0,[sp,#0x18]         ;2875
00015e  2800              CMP      r0,#0                 ;2875
000160  d1e1              BNE      |L20.294|
                  |L20.354|
000162  bf00              NOP                            ;2879
                  |L20.356|
;;;2881   				}
;;;2882   			}
;;;2883   			if (res == FR_OK) res = dir_register(&dj);	/* Register the object to the directoy */
000164  2e00              CMP      r6,#0
000166  d103              BNE      |L20.368|
000168  a807              ADD      r0,sp,#0x1c
00016a  f7fffffe          BL       dir_register
00016e  4606              MOV      r6,r0
                  |L20.368|
;;;2884   			if (res != FR_OK) {
000170  2e00              CMP      r6,#0
000172  d004              BEQ      |L20.382|
;;;2885   				remove_chain(dj.fs, dcl);				/* Could not register, remove cluster chain */
000174  4629              MOV      r1,r5
000176  9807              LDR      r0,[sp,#0x1c]
000178  f7fffffe          BL       remove_chain
00017c  e01b              B        |L20.438|
                  |L20.382|
;;;2886   			} else {
;;;2887   				dir = dj.dir;
00017e  9c0c              LDR      r4,[sp,#0x30]
;;;2888   				dir[DIR_Attr] = AM_DIR;					/* Attribute */
000180  2010              MOVS     r0,#0x10
000182  72e0              STRB     r0,[r4,#0xb]
;;;2889   				ST_DWORD(dir+DIR_WrtTime, tim);			/* Created time */
000184  75a7              STRB     r7,[r4,#0x16]
000186  0438              LSLS     r0,r7,#16
000188  0e01              LSRS     r1,r0,#24
00018a  75e1              STRB     r1,[r4,#0x17]
00018c  0238              LSLS     r0,r7,#8
00018e  0e01              LSRS     r1,r0,#24
000190  7621              STRB     r1,[r4,#0x18]
000192  0e39              LSRS     r1,r7,#24
000194  7661              STRB     r1,[r4,#0x19]
;;;2890   				ST_WORD(dir+DIR_FstClusLO, dcl);		/* Table start cluster */
000196  76a5              STRB     r5,[r4,#0x1a]
000198  0428              LSLS     r0,r5,#16
00019a  0e01              LSRS     r1,r0,#24
00019c  76e1              STRB     r1,[r4,#0x1b]
;;;2891   				ST_WORD(dir+DIR_FstClusHI, dcl >> 16);
00019e  0228              LSLS     r0,r5,#8
0001a0  0e00              LSRS     r0,r0,#24
0001a2  7520              STRB     r0,[r4,#0x14]
0001a4  0e29              LSRS     r1,r5,#24
0001a6  7561              STRB     r1,[r4,#0x15]
;;;2892   				dj.fs->wflag = 1;
0001a8  2001              MOVS     r0,#1
0001aa  9907              LDR      r1,[sp,#0x1c]
0001ac  7108              STRB     r0,[r1,#4]
;;;2893   				res = sync(dj.fs);
0001ae  9807              LDR      r0,[sp,#0x1c]
0001b0  f7fffffe          BL       sync
0001b4  4606              MOV      r6,r0
                  |L20.438|
;;;2894   			}
;;;2895   		}
;;;2896   		FREE_BUF();
;;;2897   	}
;;;2898   
;;;2899   	LEAVE_FF(dj.fs, res);
0001b6  4630              MOV      r0,r6
;;;2900   }
0001b8  b011              ADD      sp,sp,#0x44
0001ba  bdf0              POP      {r4-r7,pc}
;;;2901   
                          ENDP

                  |L20.444|
                          DCD      LfnBuf

                          AREA ||i.f_mkfs||, CODE, READONLY, ALIGN=2

                  f_mkfs PROC
;;;3134   
;;;3135   FRESULT f_mkfs (
000000  b5f7              PUSH     {r0-r2,r4-r7,lr}
;;;3136   	BYTE drv,		/* Logical drive number */
;;;3137   	BYTE sfd,		/* Partitioning rule 0:FDISK, 1:SFD */
;;;3138   	UINT au			/* Allocation unit size [bytes] */
;;;3139   )
;;;3140   {
000002  b090              SUB      sp,sp,#0x40
;;;3141   	static const WORD vst[] = { 1024,   512,  256,  128,   64,    32,   16,    8,    4,    2,   0};
;;;3142   	static const WORD cst[] = {32768, 16384, 8192, 4096, 2048, 16384, 8192, 4096, 2048, 1024, 512};
;;;3143   	BYTE fmt, md, *tbl;
;;;3144   	DWORD n_clst, vs, n;
;;;3145   	UINT as, i;
;;;3146   	DWORD b_vol, b_fat, b_dir, b_data;		/* Area offset (LBA) */
;;;3147   	DWORD n_vol, n_rsv, n_fat, n_dir;		/* Area size */
;;;3148   	FATFS *fs;
;;;3149   	DSTATUS stat;
;;;3150   
;;;3151   
;;;3152   	/* Check mounted drive and clear work area */
;;;3153   	if (drv >= _DRIVES) return FR_INVALID_DRIVE;
000004  9810              LDR      r0,[sp,#0x40]
000006  2801              CMP      r0,#1
000008  db02              BLT      |L21.16|
00000a  200b              MOVS     r0,#0xb
                  |L21.12|
;;;3154   	fs = FatFs[drv];
;;;3155   	if (!fs) return FR_NOT_ENABLED;
;;;3156   	fs->fs_type = 0;
;;;3157   	drv = LD2PD(drv);
;;;3158   
;;;3159   	/* Get disk statics */
;;;3160   	stat = disk_initialize(drv);
;;;3161   	if (stat & STA_NOINIT) return FR_NOT_READY;
;;;3162   	if (stat & STA_PROTECT) return FR_WRITE_PROTECTED;
;;;3163   #if _MAX_SS != 512					/* Get disk sector size */
;;;3164   	if (disk_ioctl(drv, GET_SECTOR_SIZE, &SS(fs)) != RES_OK || SS(fs) > _MAX_SS)
;;;3165   		return FR_DISK_ERR;
;;;3166   #endif
;;;3167   	if (disk_ioctl(drv, GET_SECTOR_COUNT, &n_vol) != RES_OK || n_vol < 128)
;;;3168   		return FR_DISK_ERR;
;;;3169   	b_vol = (sfd == 1) ? 0 : 63;	/* Volume start sector */
;;;3170   	n_vol -= b_vol;
;;;3171   	if (au & (au - 1)) au = 0;		/* Check validity of the allocation unit size */
;;;3172   	if (!au) {						/* AU auto selection */
;;;3173   		vs = n_vol / (2000 / (SS(fs) / 512));
;;;3174   		for (i = 0; vs < vst[i]; i++) ;
;;;3175   		au = cst[i];
;;;3176   	}
;;;3177   	if (_MAX_SS != 512 && au < SS(fs)) au = SS(fs);
;;;3178   	au /= SS(fs);		/* Number of sectors per cluster */
;;;3179   	if (au == 0) au = 1;
;;;3180   	if (au > 128) au = 128;
;;;3181   
;;;3182   	/* Pre-compute number of clusters and FAT syb-type */
;;;3183   	n_clst = n_vol / au;
;;;3184   	fmt = FS_FAT12;
;;;3185   	if (n_clst >= MIN_FAT16) fmt = FS_FAT16;
;;;3186   	if (n_clst >= MIN_FAT32) fmt = FS_FAT32;
;;;3187   
;;;3188   	/* Determine offset and size of FAT structure */
;;;3189   	if (fmt == FS_FAT32) {
;;;3190   		n_fat = ((n_clst * 4) + 8 + SS(fs) - 1) / SS(fs);
;;;3191   		n_rsv = 32;
;;;3192   		n_dir = 0;
;;;3193   	} else {
;;;3194   		n_fat = (fmt == FS_FAT12) ? (n_clst * 3 + 1) / 2 + 3 : (n_clst * 2) + 4;
;;;3195   		n_fat = (n_fat + SS(fs) - 1) / SS(fs);
;;;3196   		n_rsv = 1;
;;;3197   		n_dir = N_ROOTDIR * 32UL / SS(fs);
;;;3198   	}
;;;3199   	b_fat = b_vol + n_rsv;				/* FAT area start sector */
;;;3200   	b_dir = b_fat + n_fat * N_FATS;		/* Directory area start sector */
;;;3201   	b_data = b_dir + n_dir;				/* Data area start sector */
;;;3202   	if (n_vol < b_data + au) return FR_MKFS_ABORTED;	/* Too small volume */
;;;3203   
;;;3204   	/* Align data start sector to erase block boundary (for flash memory media) */
;;;3205   	if (disk_ioctl(drv, GET_BLOCK_SIZE, &n) != RES_OK) return FR_DISK_ERR;
;;;3206   	if (!n || n > 32768) return FR_MKFS_ABORTED;
;;;3207   	n = (b_data + n - 1) & ~(n - 1);	/* Next nearest boundary from current data start */
;;;3208   	n = (n - b_data) / N_FATS;
;;;3209   	if (fmt == FS_FAT32) {		/* FAT32: Move FAT start */
;;;3210   		n_rsv += n;
;;;3211   		b_fat += n;
;;;3212   	} else {					/* FAT12/16: Expand FAT size */
;;;3213   		n_fat += n;
;;;3214   	}
;;;3215   	/* b_dir and b_data are no longer used below */
;;;3216   
;;;3217   	/* Determine number of cluster and final check of validity of the FAT sub-type */
;;;3218   	n_clst = (n_vol - n_rsv - n_fat * N_FATS - n_dir) / au;
;;;3219   	if (   (fmt == FS_FAT16 && n_clst < MIN_FAT16)
;;;3220   		|| (fmt == FS_FAT32 && n_clst < MIN_FAT32))
;;;3221   		return FR_MKFS_ABORTED;
;;;3222   
;;;3223   	/* Create partition table if required */
;;;3224   	if (sfd == 1) {
;;;3225   		md = 0xF0;
;;;3226   	} else {
;;;3227   		DWORD n_disk = b_vol + n_vol;
;;;3228   
;;;3229   		mem_set(fs->win, 0, SS(fs));
;;;3230   		tbl = fs->win+MBR_Table;
;;;3231   		ST_DWORD(tbl, 0x00010180);		/* Partition start in CHS */
;;;3232   		if (n_disk < 63UL * 255 * 1024) {	/* Partition end in CHS */
;;;3233   			n_disk = n_disk / 63 / 255;
;;;3234   			tbl[7] = (BYTE)n_disk;
;;;3235   			tbl[6] = (BYTE)((n_disk >> 2) | 63);
;;;3236   		} else {
;;;3237   			ST_WORD(&tbl[6], 0xFFFF);
;;;3238   		}
;;;3239   		tbl[5] = 254;
;;;3240   		if (fmt != FS_FAT32)			/* System ID */
;;;3241   			tbl[4] = (n_vol < 0x10000) ? 0x04 : 0x06;
;;;3242   		else
;;;3243   			tbl[4] = 0x0c;
;;;3244   		ST_DWORD(tbl+8, 63);			/* Partition start in LBA */
;;;3245   		ST_DWORD(tbl+12, n_vol);		/* Partition size in LBA */
;;;3246   		ST_WORD(tbl+64, 0xAA55);		/* Signature */
;;;3247   		if (disk_write(drv, fs->win, 0, 1) != RES_OK)
;;;3248   			return FR_DISK_ERR;
;;;3249   		md = 0xF8;
;;;3250   	}
;;;3251   
;;;3252   	/* Create VBR */
;;;3253   	tbl = fs->win;								/* Clear buffer */
;;;3254   	mem_set(tbl, 0, SS(fs));
;;;3255   	ST_DWORD(tbl+BS_jmpBoot, 0x90FEEB);			/* Boot code (jmp $, nop) */
;;;3256   	as = SS(fs);								/* Sector size */
;;;3257   	ST_WORD(tbl+BPB_BytsPerSec, as);
;;;3258   	tbl[BPB_SecPerClus] = (BYTE)au;				/* Sectors per cluster */
;;;3259   	ST_WORD(tbl+BPB_RsvdSecCnt, n_rsv);			/* Reserved sectors */
;;;3260   	tbl[BPB_NumFATs] = N_FATS;					/* Number of FATs */
;;;3261   	as = (fmt == FS_FAT32) ? 0 : N_ROOTDIR;		/* Number of rootdir entries */
;;;3262   	ST_WORD(tbl+BPB_RootEntCnt, as);
;;;3263   	if (n_vol < 0x10000) {						/* Number of total sectors */
;;;3264   		ST_WORD(tbl+BPB_TotSec16, n_vol);
;;;3265   	} else {
;;;3266   		ST_DWORD(tbl+BPB_TotSec32, n_vol);
;;;3267   	}
;;;3268   	tbl[BPB_Media] = md;						/* Media descriptor */
;;;3269   	ST_WORD(tbl+BPB_SecPerTrk, 63);				/* Number of sectors per track */
;;;3270   	ST_WORD(tbl+BPB_NumHeads, 255);				/* Number of heads */
;;;3271   	ST_DWORD(tbl+BPB_HiddSec, b_vol);			/* Hidden sectors */
;;;3272   	n = get_fattime();							/* Use current time as VSN */
;;;3273   	if (fmt == FS_FAT32) {
;;;3274   		ST_DWORD(tbl+BS_VolID32, n);			/* VSN */
;;;3275   		ST_DWORD(tbl+BPB_FATSz32, n_fat);		/* Number of sectors per FAT */
;;;3276   		ST_DWORD(tbl+BPB_RootClus, 2);			/* Root directory start cluster (2) */
;;;3277   		ST_WORD(tbl+BPB_FSInfo, 1);				/* FSInfo record offset (VBR+1) */
;;;3278   		ST_WORD(tbl+BPB_BkBootSec, 6);			/* Backup boot record offset (VBR+6) */
;;;3279   		tbl[BS_DrvNum32] = 0x80;				/* Drive number */
;;;3280   		tbl[BS_BootSig32] = 0x29;				/* Extended boot signature */
;;;3281   		mem_cpy(tbl+BS_VolLab32, "NO NAME    FAT32   ", 19);	/* Volume label, FAT signature */
;;;3282   	} else {
;;;3283   		ST_DWORD(tbl+BS_VolID, n);				/* VSN */
;;;3284   		ST_WORD(tbl+BPB_FATSz16, n_fat);		/* Number of sectors per FAT */
;;;3285   		tbl[BS_DrvNum] = 0x80;					/* Drive number */
;;;3286   		tbl[BS_BootSig] = 0x29;					/* Extended boot signature */
;;;3287   		mem_cpy(tbl+BS_VolLab, "NO NAME    FAT     ", 19);	/* Volume label, FAT signature */
;;;3288   	}
;;;3289   	ST_WORD(tbl+BS_55AA, 0xAA55);				/* Signature (Offset is fixed here regardless of sector size) */
;;;3290   	if (disk_write(drv, tbl, b_vol, 1) != RES_OK)	/* Original (VBR) */
;;;3291   		return FR_DISK_ERR;
;;;3292   	if (fmt == FS_FAT32)						/* Backup (VBR+6) */
;;;3293   		disk_write(drv, tbl, b_vol + 6, 1);
;;;3294   
;;;3295   	/* Initialize FAT area */
;;;3296   	for (i = 0; i < N_FATS; i++) {
;;;3297   		mem_set(tbl, 0, SS(fs));			/* 1st sector of the FAT  */
;;;3298   		n = md;								/* Media descriptor byte */
;;;3299   		if (fmt != FS_FAT32) {
;;;3300   			n |= (fmt == FS_FAT12) ? 0x00FFFF00 : 0xFFFFFF00;
;;;3301   			ST_DWORD(tbl+0, n);				/* Reserve cluster #0-1 (FAT12/16) */
;;;3302   		} else {
;;;3303   			n |= 0x0FFFFF00;
;;;3304   			ST_DWORD(tbl+0, n);				/* Reserve cluster #0-1 (FAT32) */
;;;3305   			ST_DWORD(tbl+4, 0x0FFFFFFF);
;;;3306   			ST_DWORD(tbl+8, 0x0FFFFFFF);	/* Reserve cluster #2 for root dir */
;;;3307   		}
;;;3308   		if (disk_write(drv, tbl, b_fat++, 1) != RES_OK)
;;;3309   			return FR_DISK_ERR;
;;;3310   		mem_set(tbl, 0, SS(fs));		/* Fill following FAT entries with zero */
;;;3311   		for (n = 1; n < n_fat; n++) {	/* This loop may take a time on FAT32 volume due to many single sector write */
;;;3312   			if (disk_write(drv, tbl, b_fat++, 1) != RES_OK)
;;;3313   				return FR_DISK_ERR;
;;;3314   		}
;;;3315   	}
;;;3316   
;;;3317   	/* Initialize root directory */
;;;3318   	n = (fmt == FS_FAT32) ? as : n_dir;
;;;3319   	while (n--) {
;;;3320   		if (disk_write(drv, tbl, b_fat++, 1) != RES_OK)
;;;3321   			return FR_DISK_ERR;
;;;3322   	}
;;;3323   
;;;3324   	/* Create FSInfo record if needed */
;;;3325   	if (fmt == FS_FAT32) {
;;;3326   		ST_WORD(tbl+BS_55AA, 0xAA55);
;;;3327   		ST_DWORD(tbl+FSI_LeadSig, 0x41615252);
;;;3328   		ST_DWORD(tbl+FSI_StrucSig, 0x61417272);
;;;3329   		ST_DWORD(tbl+FSI_Free_Count, n_clst - 1);
;;;3330   		ST_DWORD(tbl+FSI_Nxt_Free, 0xFFFFFFFF);
;;;3331   		disk_write(drv, tbl, b_vol + 1, 1);	/* Original (VBR+1) */
;;;3332   		disk_write(drv, tbl, b_vol + 7, 1);	/* Backup  (VBR+7) */
;;;3333   	}
;;;3334   
;;;3335   	return (disk_ioctl(drv, CTRL_SYNC, (void*)0) == RES_OK) ? FR_OK : FR_DISK_ERR;
;;;3336   }
00000c  b013              ADD      sp,sp,#0x4c
00000e  bdf0              POP      {r4-r7,pc}
                  |L21.16|
000010  9810              LDR      r0,[sp,#0x40]         ;3154
000012  0080              LSLS     r0,r0,#2              ;3154
000014  49fe              LDR      r1,|L21.1040|
000016  5808              LDR      r0,[r1,r0]            ;3154
000018  9003              STR      r0,[sp,#0xc]          ;3154
00001a  9803              LDR      r0,[sp,#0xc]          ;3155
00001c  2800              CMP      r0,#0                 ;3155
00001e  d101              BNE      |L21.36|
000020  200c              MOVS     r0,#0xc               ;3155
000022  e7f3              B        |L21.12|
                  |L21.36|
000024  2100              MOVS     r1,#0                 ;3156
000026  9803              LDR      r0,[sp,#0xc]          ;3156
000028  7001              STRB     r1,[r0,#0]            ;3156
00002a  9810              LDR      r0,[sp,#0x40]         ;3157
00002c  9010              STR      r0,[sp,#0x40]         ;3157
00002e  9810              LDR      r0,[sp,#0x40]         ;3160
000030  f7fffffe          BL       disk_initialize
000034  9002              STR      r0,[sp,#8]            ;3160
000036  9802              LDR      r0,[sp,#8]            ;3161
000038  07c0              LSLS     r0,r0,#31             ;3161
00003a  0fc0              LSRS     r0,r0,#31             ;3161
00003c  2800              CMP      r0,#0                 ;3161
00003e  d001              BEQ      |L21.68|
000040  2003              MOVS     r0,#3                 ;3161
000042  e7e3              B        |L21.12|
                  |L21.68|
000044  2104              MOVS     r1,#4                 ;3162
000046  9802              LDR      r0,[sp,#8]            ;3162
000048  4008              ANDS     r0,r0,r1              ;3162
00004a  2800              CMP      r0,#0                 ;3162
00004c  d001              BEQ      |L21.82|
00004e  200a              MOVS     r0,#0xa               ;3162
000050  e7dc              B        |L21.12|
                  |L21.82|
000052  aa06              ADD      r2,sp,#0x18           ;3167
000054  2101              MOVS     r1,#1                 ;3167
000056  9810              LDR      r0,[sp,#0x40]         ;3167
000058  f7fffffe          BL       disk_ioctl
00005c  2800              CMP      r0,#0                 ;3167
00005e  d102              BNE      |L21.102|
000060  9806              LDR      r0,[sp,#0x18]         ;3167
000062  2880              CMP      r0,#0x80              ;3167
000064  d201              BCS      |L21.106|
                  |L21.102|
000066  2001              MOVS     r0,#1                 ;3168
000068  e7d0              B        |L21.12|
                  |L21.106|
00006a  9811              LDR      r0,[sp,#0x44]         ;3169
00006c  2801              CMP      r0,#1                 ;3169
00006e  d101              BNE      |L21.116|
000070  2000              MOVS     r0,#0                 ;3169
000072  e000              B        |L21.118|
                  |L21.116|
000074  203f              MOVS     r0,#0x3f              ;3169
                  |L21.118|
000076  900a              STR      r0,[sp,#0x28]         ;3169
000078  9906              LDR      r1,[sp,#0x18]         ;3170
00007a  980a              LDR      r0,[sp,#0x28]         ;3170
00007c  1a08              SUBS     r0,r1,r0              ;3170
00007e  9006              STR      r0,[sp,#0x18]         ;3170
000080  9812              LDR      r0,[sp,#0x48]         ;3171
000082  1e40              SUBS     r0,r0,#1              ;3171
000084  9912              LDR      r1,[sp,#0x48]         ;3171
000086  4008              ANDS     r0,r0,r1              ;3171
000088  2800              CMP      r0,#0                 ;3171
00008a  d001              BEQ      |L21.144|
00008c  2000              MOVS     r0,#0                 ;3171
00008e  9012              STR      r0,[sp,#0x48]         ;3171
                  |L21.144|
000090  9812              LDR      r0,[sp,#0x48]         ;3172
000092  2800              CMP      r0,#0                 ;3172
000094  d117              BNE      |L21.198|
000096  217d              MOVS     r1,#0x7d              ;3173
000098  0109              LSLS     r1,r1,#4              ;3173
00009a  9806              LDR      r0,[sp,#0x18]         ;3173
00009c  f7fffffe          BL       __aeabi_uidivmod
0000a0  900e              STR      r0,[sp,#0x38]         ;3173
0000a2  2000              MOVS     r0,#0                 ;3174
0000a4  900b              STR      r0,[sp,#0x2c]         ;3174
0000a6  e002              B        |L21.174|
                  |L21.168|
0000a8  980b              LDR      r0,[sp,#0x2c]         ;3174
0000aa  1c40              ADDS     r0,r0,#1              ;3174
0000ac  900b              STR      r0,[sp,#0x2c]         ;3174
                  |L21.174|
0000ae  980b              LDR      r0,[sp,#0x2c]         ;3174
0000b0  0040              LSLS     r0,r0,#1              ;3174
0000b2  49d8              LDR      r1,|L21.1044|
0000b4  5a09              LDRH     r1,[r1,r0]            ;3174
0000b6  980e              LDR      r0,[sp,#0x38]         ;3174
0000b8  4281              CMP      r1,r0                 ;3174
0000ba  d8f5              BHI      |L21.168|
0000bc  980b              LDR      r0,[sp,#0x2c]         ;3175
0000be  0040              LSLS     r0,r0,#1              ;3175
0000c0  49d5              LDR      r1,|L21.1048|
0000c2  5a08              LDRH     r0,[r1,r0]            ;3175
0000c4  9012              STR      r0,[sp,#0x48]         ;3175
                  |L21.198|
0000c6  bf00              NOP                            ;3177
0000c8  9812              LDR      r0,[sp,#0x48]         ;3178
0000ca  0a40              LSRS     r0,r0,#9              ;3178
0000cc  9012              STR      r0,[sp,#0x48]         ;3178
0000ce  9812              LDR      r0,[sp,#0x48]         ;3179
0000d0  2800              CMP      r0,#0                 ;3179
0000d2  d101              BNE      |L21.216|
0000d4  2001              MOVS     r0,#1                 ;3179
0000d6  9012              STR      r0,[sp,#0x48]         ;3179
                  |L21.216|
0000d8  9812              LDR      r0,[sp,#0x48]         ;3180
0000da  2880              CMP      r0,#0x80              ;3180
0000dc  d901              BLS      |L21.226|
0000de  2080              MOVS     r0,#0x80              ;3180
0000e0  9012              STR      r0,[sp,#0x48]         ;3180
                  |L21.226|
0000e2  9912              LDR      r1,[sp,#0x48]         ;3183
0000e4  9806              LDR      r0,[sp,#0x18]         ;3183
0000e6  f7fffffe          BL       __aeabi_uidivmod
0000ea  4607              MOV      r7,r0                 ;3183
0000ec  2501              MOVS     r5,#1                 ;3184
0000ee  49cb              LDR      r1,|L21.1052|
0000f0  428f              CMP      r7,r1                 ;3185
0000f2  d300              BCC      |L21.246|
0000f4  2502              MOVS     r5,#2                 ;3185
                  |L21.246|
0000f6  48ca              LDR      r0,|L21.1056|
0000f8  4287              CMP      r7,r0                 ;3186
0000fa  d300              BCC      |L21.254|
0000fc  2503              MOVS     r5,#3                 ;3186
                  |L21.254|
0000fe  2d03              CMP      r5,#3                 ;3189
000100  d10a              BNE      |L21.280|
000102  00b8              LSLS     r0,r7,#2              ;3190
000104  3008              ADDS     r0,r0,#8              ;3190
000106  30ff              ADDS     r0,r0,#0xff           ;3190
000108  30ff              ADDS     r0,r0,#0xff           ;3190
00010a  3001              ADDS     r0,#1                 ;3190
00010c  0a46              LSRS     r6,r0,#9              ;3190
00010e  2020              MOVS     r0,#0x20              ;3191
000110  9005              STR      r0,[sp,#0x14]         ;3191
000112  2000              MOVS     r0,#0                 ;3192
000114  9004              STR      r0,[sp,#0x10]         ;3192
000116  e012              B        |L21.318|
                  |L21.280|
000118  2d01              CMP      r5,#1                 ;3194
00011a  d105              BNE      |L21.296|
00011c  0078              LSLS     r0,r7,#1              ;3194
00011e  1838              ADDS     r0,r7,r0              ;3194
000120  1c40              ADDS     r0,r0,#1              ;3194
000122  0840              LSRS     r0,r0,#1              ;3194
000124  1cc0              ADDS     r0,r0,#3              ;3194
000126  e001              B        |L21.300|
                  |L21.296|
000128  0078              LSLS     r0,r7,#1              ;3194
00012a  1d00              ADDS     r0,r0,#4              ;3194
                  |L21.300|
00012c  4606              MOV      r6,r0                 ;3194
00012e  1df0              ADDS     r0,r6,#7              ;3195
000130  30ff              ADDS     r0,r0,#0xff           ;3195
000132  30f9              ADDS     r0,r0,#0xf9           ;3195
000134  0a46              LSRS     r6,r0,#9              ;3195
000136  2001              MOVS     r0,#1                 ;3196
000138  9005              STR      r0,[sp,#0x14]         ;3196
00013a  2020              MOVS     r0,#0x20              ;3197
00013c  9004              STR      r0,[sp,#0x10]         ;3197
                  |L21.318|
00013e  9905              LDR      r1,[sp,#0x14]         ;3199
000140  980a              LDR      r0,[sp,#0x28]         ;3199
000142  1840              ADDS     r0,r0,r1              ;3199
000144  9009              STR      r0,[sp,#0x24]         ;3199
000146  9809              LDR      r0,[sp,#0x24]         ;3200
000148  1830              ADDS     r0,r6,r0              ;3200
00014a  9008              STR      r0,[sp,#0x20]         ;3200
00014c  9904              LDR      r1,[sp,#0x10]         ;3201
00014e  9808              LDR      r0,[sp,#0x20]         ;3201
000150  1840              ADDS     r0,r0,r1              ;3201
000152  9007              STR      r0,[sp,#0x1c]         ;3201
000154  9912              LDR      r1,[sp,#0x48]         ;3202
000156  9807              LDR      r0,[sp,#0x1c]         ;3202
000158  1840              ADDS     r0,r0,r1              ;3202
00015a  9906              LDR      r1,[sp,#0x18]         ;3202
00015c  4288              CMP      r0,r1                 ;3202
00015e  d901              BLS      |L21.356|
000160  200e              MOVS     r0,#0xe               ;3202
000162  e753              B        |L21.12|
                  |L21.356|
000164  aa0d              ADD      r2,sp,#0x34           ;3205
000166  2103              MOVS     r1,#3                 ;3205
000168  9810              LDR      r0,[sp,#0x40]         ;3205
00016a  f7fffffe          BL       disk_ioctl
00016e  2800              CMP      r0,#0                 ;3205
000170  d001              BEQ      |L21.374|
000172  2001              MOVS     r0,#1                 ;3205
000174  e74a              B        |L21.12|
                  |L21.374|
000176  980d              LDR      r0,[sp,#0x34]         ;3206
000178  2800              CMP      r0,#0                 ;3206
00017a  d004              BEQ      |L21.390|
00017c  2101              MOVS     r1,#1                 ;3206
00017e  03c9              LSLS     r1,r1,#15             ;3206
000180  980d              LDR      r0,[sp,#0x34]         ;3206
000182  4288              CMP      r0,r1                 ;3206
000184  d901              BLS      |L21.394|
                  |L21.390|
000186  200e              MOVS     r0,#0xe               ;3206
000188  e740              B        |L21.12|
                  |L21.394|
00018a  990d              LDR      r1,[sp,#0x34]         ;3207
00018c  9807              LDR      r0,[sp,#0x1c]         ;3207
00018e  1840              ADDS     r0,r0,r1              ;3207
000190  1e40              SUBS     r0,r0,#1              ;3207
000192  1e49              SUBS     r1,r1,#1              ;3207
000194  4388              BICS     r0,r0,r1              ;3207
000196  900d              STR      r0,[sp,#0x34]         ;3207
000198  990d              LDR      r1,[sp,#0x34]         ;3208
00019a  9807              LDR      r0,[sp,#0x1c]         ;3208
00019c  1a08              SUBS     r0,r1,r0              ;3208
00019e  900d              STR      r0,[sp,#0x34]         ;3208
0001a0  2d03              CMP      r5,#3                 ;3209
0001a2  d108              BNE      |L21.438|
0001a4  990d              LDR      r1,[sp,#0x34]         ;3210
0001a6  9805              LDR      r0,[sp,#0x14]         ;3210
0001a8  1840              ADDS     r0,r0,r1              ;3210
0001aa  9005              STR      r0,[sp,#0x14]         ;3210
0001ac  990d              LDR      r1,[sp,#0x34]         ;3211
0001ae  9809              LDR      r0,[sp,#0x24]         ;3211
0001b0  1840              ADDS     r0,r0,r1              ;3211
0001b2  9009              STR      r0,[sp,#0x24]         ;3211
0001b4  e001              B        |L21.442|
                  |L21.438|
0001b6  980d              LDR      r0,[sp,#0x34]         ;3213
0001b8  1836              ADDS     r6,r6,r0              ;3213
                  |L21.442|
0001ba  9a06              LDR      r2,[sp,#0x18]         ;3218
0001bc  9905              LDR      r1,[sp,#0x14]         ;3218
0001be  1a51              SUBS     r1,r2,r1              ;3218
0001c0  1b8a              SUBS     r2,r1,r6              ;3218
0001c2  9904              LDR      r1,[sp,#0x10]         ;3218
0001c4  1a50              SUBS     r0,r2,r1              ;3218
0001c6  9912              LDR      r1,[sp,#0x48]         ;3218
0001c8  f7fffffe          BL       __aeabi_uidivmod
0001cc  4607              MOV      r7,r0                 ;3218
0001ce  2d02              CMP      r5,#2                 ;3219
0001d0  d102              BNE      |L21.472|
0001d2  4892              LDR      r0,|L21.1052|
0001d4  4287              CMP      r7,r0                 ;3219
0001d6  d304              BCC      |L21.482|
                  |L21.472|
0001d8  2d03              CMP      r5,#3                 ;3220
0001da  d104              BNE      |L21.486|
0001dc  4890              LDR      r0,|L21.1056|
0001de  4287              CMP      r7,r0                 ;3220
0001e0  d201              BCS      |L21.486|
                  |L21.482|
0001e2  200e              MOVS     r0,#0xe               ;3221
0001e4  e712              B        |L21.12|
                  |L21.486|
0001e6  9811              LDR      r0,[sp,#0x44]         ;3224
0001e8  2801              CMP      r0,#1                 ;3224
0001ea  d102              BNE      |L21.498|
0001ec  20f0              MOVS     r0,#0xf0              ;3225
0001ee  900f              STR      r0,[sp,#0x3c]         ;3225
0001f0  e065              B        |L21.702|
                  |L21.498|
0001f2  9906              LDR      r1,[sp,#0x18]         ;3227
0001f4  980a              LDR      r0,[sp,#0x28]         ;3227
0001f6  1840              ADDS     r0,r0,r1              ;3227
0001f8  9001              STR      r0,[sp,#4]            ;3227
0001fa  2201              MOVS     r2,#1                 ;3229
0001fc  0252              LSLS     r2,r2,#9              ;3229
0001fe  2100              MOVS     r1,#0                 ;3229
000200  9803              LDR      r0,[sp,#0xc]          ;3229
000202  3034              ADDS     r0,r0,#0x34           ;3229
000204  f7fffffe          BL       mem_set
000208  9803              LDR      r0,[sp,#0xc]          ;3230
00020a  4604              MOV      r4,r0                 ;3230
00020c  34ff              ADDS     r4,r4,#0xff           ;3230
00020e  34f3              ADDS     r4,r4,#0xf3           ;3230
000210  2080              MOVS     r0,#0x80              ;3231
000212  7020              STRB     r0,[r4,#0]            ;3231
000214  2001              MOVS     r0,#1                 ;3231
000216  7060              STRB     r0,[r4,#1]            ;3231
000218  70a0              STRB     r0,[r4,#2]            ;3231
00021a  2000              MOVS     r0,#0                 ;3231
00021c  70e0              STRB     r0,[r4,#3]            ;3231
00021e  4981              LDR      r1,|L21.1060|
000220  9801              LDR      r0,[sp,#4]            ;3232
000222  4288              CMP      r0,r1                 ;3232
000224  d210              BCS      |L21.584|
000226  213f              MOVS     r1,#0x3f              ;3233
000228  9801              LDR      r0,[sp,#4]            ;3233
00022a  f7fffffe          BL       __aeabi_uidivmod
00022e  21ff              MOVS     r1,#0xff              ;3233
000230  9000              STR      r0,[sp,#0]            ;3233
000232  f7fffffe          BL       __aeabi_uidivmod
000236  9001              STR      r0,[sp,#4]            ;3233
000238  9801              LDR      r0,[sp,#4]            ;3234
00023a  71e0              STRB     r0,[r4,#7]            ;3234
00023c  9801              LDR      r0,[sp,#4]            ;3235
00023e  0880              LSRS     r0,r0,#2              ;3235
000240  213f              MOVS     r1,#0x3f              ;3235
000242  4308              ORRS     r0,r0,r1              ;3235
000244  71a0              STRB     r0,[r4,#6]            ;3235
000246  e003              B        |L21.592|
                  |L21.584|
000248  20ff              MOVS     r0,#0xff              ;3237
00024a  71a0              STRB     r0,[r4,#6]            ;3237
00024c  21ff              MOVS     r1,#0xff              ;3237
00024e  71e1              STRB     r1,[r4,#7]            ;3237
                  |L21.592|
000250  20fe              MOVS     r0,#0xfe              ;3239
000252  7160              STRB     r0,[r4,#5]            ;3239
000254  2d03              CMP      r5,#3                 ;3240
000256  d009              BEQ      |L21.620|
000258  2101              MOVS     r1,#1                 ;3241
00025a  0409              LSLS     r1,r1,#16             ;3241
00025c  9806              LDR      r0,[sp,#0x18]         ;3241
00025e  4288              CMP      r0,r1                 ;3241
000260  d201              BCS      |L21.614|
000262  2004              MOVS     r0,#4                 ;3241
000264  e000              B        |L21.616|
                  |L21.614|
000266  2006              MOVS     r0,#6                 ;3241
                  |L21.616|
000268  7120              STRB     r0,[r4,#4]            ;3241
00026a  e001              B        |L21.624|
                  |L21.620|
00026c  200c              MOVS     r0,#0xc               ;3243
00026e  7120              STRB     r0,[r4,#4]            ;3243
                  |L21.624|
000270  203f              MOVS     r0,#0x3f              ;3244
000272  7220              STRB     r0,[r4,#8]            ;3244
000274  2100              MOVS     r1,#0                 ;3244
000276  7261              STRB     r1,[r4,#9]            ;3244
000278  72a1              STRB     r1,[r4,#0xa]          ;3244
00027a  72e1              STRB     r1,[r4,#0xb]          ;3244
00027c  9806              LDR      r0,[sp,#0x18]         ;3245
00027e  7320              STRB     r0,[r4,#0xc]          ;3245
000280  9806              LDR      r0,[sp,#0x18]         ;3245
000282  0400              LSLS     r0,r0,#16             ;3245
000284  0e01              LSRS     r1,r0,#24             ;3245
000286  7361              STRB     r1,[r4,#0xd]          ;3245
000288  9806              LDR      r0,[sp,#0x18]         ;3245
00028a  0200              LSLS     r0,r0,#8              ;3245
00028c  0e01              LSRS     r1,r0,#24             ;3245
00028e  73a1              STRB     r1,[r4,#0xe]          ;3245
000290  9806              LDR      r0,[sp,#0x18]         ;3245
000292  0e01              LSRS     r1,r0,#24             ;3245
000294  73e1              STRB     r1,[r4,#0xf]          ;3245
000296  2155              MOVS     r1,#0x55              ;3246
000298  2040              MOVS     r0,#0x40              ;3246
00029a  5501              STRB     r1,[r0,r4]            ;3246
00029c  21aa              MOVS     r1,#0xaa              ;3246
00029e  2041              MOVS     r0,#0x41              ;3246
0002a0  5501              STRB     r1,[r0,r4]            ;3246
0002a2  2301              MOVS     r3,#1                 ;3247
0002a4  2200              MOVS     r2,#0                 ;3247
0002a6  9903              LDR      r1,[sp,#0xc]          ;3247
0002a8  3134              ADDS     r1,r1,#0x34           ;3247
0002aa  9810              LDR      r0,[sp,#0x40]         ;3247
0002ac  f7fffffe          BL       disk_write
0002b0  2800              CMP      r0,#0                 ;3247
0002b2  d001              BEQ      |L21.696|
0002b4  2001              MOVS     r0,#1                 ;3248
0002b6  e6a9              B        |L21.12|
                  |L21.696|
0002b8  20f8              MOVS     r0,#0xf8              ;3249
0002ba  900f              STR      r0,[sp,#0x3c]         ;3249
0002bc  bf00              NOP                            ;3250
                  |L21.702|
0002be  9803              LDR      r0,[sp,#0xc]          ;3253
0002c0  4604              MOV      r4,r0                 ;3253
0002c2  3434              ADDS     r4,r4,#0x34           ;3253
0002c4  2201              MOVS     r2,#1                 ;3254
0002c6  0252              LSLS     r2,r2,#9              ;3254
0002c8  2100              MOVS     r1,#0                 ;3254
0002ca  4620              MOV      r0,r4                 ;3254
0002cc  f7fffffe          BL       mem_set
0002d0  20eb              MOVS     r0,#0xeb              ;3255
0002d2  7020              STRB     r0,[r4,#0]            ;3255
0002d4  20fe              MOVS     r0,#0xfe              ;3255
0002d6  7060              STRB     r0,[r4,#1]            ;3255
0002d8  2090              MOVS     r0,#0x90              ;3255
0002da  70a0              STRB     r0,[r4,#2]            ;3255
0002dc  2000              MOVS     r0,#0                 ;3255
0002de  70e0              STRB     r0,[r4,#3]            ;3255
0002e0  2001              MOVS     r0,#1                 ;3256
0002e2  0240              LSLS     r0,r0,#9              ;3256
0002e4  900c              STR      r0,[sp,#0x30]         ;3256
0002e6  980c              LDR      r0,[sp,#0x30]         ;3257
0002e8  72e0              STRB     r0,[r4,#0xb]          ;3257
0002ea  980c              LDR      r0,[sp,#0x30]         ;3257
0002ec  1201              ASRS     r1,r0,#8              ;3257
0002ee  7321              STRB     r1,[r4,#0xc]          ;3257
0002f0  9812              LDR      r0,[sp,#0x48]         ;3258
0002f2  7360              STRB     r0,[r4,#0xd]          ;3258
0002f4  9805              LDR      r0,[sp,#0x14]         ;3259
0002f6  73a0              STRB     r0,[r4,#0xe]          ;3259
0002f8  9805              LDR      r0,[sp,#0x14]         ;3259
0002fa  0400              LSLS     r0,r0,#16             ;3259
0002fc  0e01              LSRS     r1,r0,#24             ;3259
0002fe  73e1              STRB     r1,[r4,#0xf]          ;3259
000300  2001              MOVS     r0,#1                 ;3260
000302  7420              STRB     r0,[r4,#0x10]         ;3260
000304  2d03              CMP      r5,#3                 ;3261
000306  d101              BNE      |L21.780|
000308  2000              MOVS     r0,#0                 ;3261
00030a  e001              B        |L21.784|
                  |L21.780|
00030c  2001              MOVS     r0,#1                 ;3261
00030e  0240              LSLS     r0,r0,#9              ;3261
                  |L21.784|
000310  900c              STR      r0,[sp,#0x30]         ;3261
000312  980c              LDR      r0,[sp,#0x30]         ;3262
000314  7460              STRB     r0,[r4,#0x11]         ;3262
000316  980c              LDR      r0,[sp,#0x30]         ;3262
000318  0400              LSLS     r0,r0,#16             ;3262
00031a  0e01              LSRS     r1,r0,#24             ;3262
00031c  74a1              STRB     r1,[r4,#0x12]         ;3262
00031e  2101              MOVS     r1,#1                 ;3263
000320  0409              LSLS     r1,r1,#16             ;3263
000322  9806              LDR      r0,[sp,#0x18]         ;3263
000324  4288              CMP      r0,r1                 ;3263
000326  d206              BCS      |L21.822|
000328  9806              LDR      r0,[sp,#0x18]         ;3264
00032a  74e0              STRB     r0,[r4,#0x13]         ;3264
00032c  9806              LDR      r0,[sp,#0x18]         ;3264
00032e  0400              LSLS     r0,r0,#16             ;3264
000330  0e01              LSRS     r1,r0,#24             ;3264
000332  7521              STRB     r1,[r4,#0x14]         ;3264
000334  e011              B        |L21.858|
                  |L21.822|
000336  9806              LDR      r0,[sp,#0x18]         ;3266
000338  b2c1              UXTB     r1,r0                 ;3266
00033a  2020              MOVS     r0,#0x20              ;3266
00033c  5501              STRB     r1,[r0,r4]            ;3266
00033e  9806              LDR      r0,[sp,#0x18]         ;3266
000340  0400              LSLS     r0,r0,#16             ;3266
000342  0e01              LSRS     r1,r0,#24             ;3266
000344  2021              MOVS     r0,#0x21              ;3266
000346  5501              STRB     r1,[r0,r4]            ;3266
000348  9806              LDR      r0,[sp,#0x18]         ;3266
00034a  0200              LSLS     r0,r0,#8              ;3266
00034c  0e01              LSRS     r1,r0,#24             ;3266
00034e  2022              MOVS     r0,#0x22              ;3266
000350  5501              STRB     r1,[r0,r4]            ;3266
000352  9806              LDR      r0,[sp,#0x18]         ;3266
000354  0e01              LSRS     r1,r0,#24             ;3266
000356  2023              MOVS     r0,#0x23              ;3266
000358  5501              STRB     r1,[r0,r4]            ;3266
                  |L21.858|
00035a  980f              LDR      r0,[sp,#0x3c]         ;3268
00035c  7560              STRB     r0,[r4,#0x15]         ;3268
00035e  203f              MOVS     r0,#0x3f              ;3269
000360  7620              STRB     r0,[r4,#0x18]         ;3269
000362  2100              MOVS     r1,#0                 ;3269
000364  7661              STRB     r1,[r4,#0x19]         ;3269
000366  20ff              MOVS     r0,#0xff              ;3270
000368  76a0              STRB     r0,[r4,#0x1a]         ;3270
00036a  76e1              STRB     r1,[r4,#0x1b]         ;3270
00036c  980a              LDR      r0,[sp,#0x28]         ;3271
00036e  7720              STRB     r0,[r4,#0x1c]         ;3271
000370  980a              LDR      r0,[sp,#0x28]         ;3271
000372  0400              LSLS     r0,r0,#16             ;3271
000374  0e01              LSRS     r1,r0,#24             ;3271
000376  7761              STRB     r1,[r4,#0x1d]         ;3271
000378  980a              LDR      r0,[sp,#0x28]         ;3271
00037a  0200              LSLS     r0,r0,#8              ;3271
00037c  0e01              LSRS     r1,r0,#24             ;3271
00037e  77a1              STRB     r1,[r4,#0x1e]         ;3271
000380  980a              LDR      r0,[sp,#0x28]         ;3271
000382  0e01              LSRS     r1,r0,#24             ;3271
000384  77e1              STRB     r1,[r4,#0x1f]         ;3271
000386  f7fffffe          BL       get_fattime
00038a  900d              STR      r0,[sp,#0x34]         ;3272
00038c  2d03              CMP      r5,#3                 ;3273
00038e  d158              BNE      |L21.1090|
000390  980d              LDR      r0,[sp,#0x34]         ;3274
000392  b2c1              UXTB     r1,r0                 ;3274
000394  2043              MOVS     r0,#0x43              ;3274
000396  5501              STRB     r1,[r0,r4]            ;3274
000398  980d              LDR      r0,[sp,#0x34]         ;3274
00039a  0400              LSLS     r0,r0,#16             ;3274
00039c  0e01              LSRS     r1,r0,#24             ;3274
00039e  2044              MOVS     r0,#0x44              ;3274
0003a0  5501              STRB     r1,[r0,r4]            ;3274
0003a2  980d              LDR      r0,[sp,#0x34]         ;3274
0003a4  0200              LSLS     r0,r0,#8              ;3274
0003a6  0e01              LSRS     r1,r0,#24             ;3274
0003a8  2045              MOVS     r0,#0x45              ;3274
0003aa  5501              STRB     r1,[r0,r4]            ;3274
0003ac  980d              LDR      r0,[sp,#0x34]         ;3274
0003ae  0e01              LSRS     r1,r0,#24             ;3274
0003b0  2046              MOVS     r0,#0x46              ;3274
0003b2  5501              STRB     r1,[r0,r4]            ;3274
0003b4  2024              MOVS     r0,#0x24              ;3275
0003b6  5506              STRB     r6,[r0,r4]            ;3275
0003b8  0430              LSLS     r0,r6,#16             ;3275
0003ba  0e01              LSRS     r1,r0,#24             ;3275
0003bc  2025              MOVS     r0,#0x25              ;3275
0003be  5501              STRB     r1,[r0,r4]            ;3275
0003c0  0230              LSLS     r0,r6,#8              ;3275
0003c2  0e01              LSRS     r1,r0,#24             ;3275
0003c4  2026              MOVS     r0,#0x26              ;3275
0003c6  5501              STRB     r1,[r0,r4]            ;3275
0003c8  0e31              LSRS     r1,r6,#24             ;3275
0003ca  2027              MOVS     r0,#0x27              ;3275
0003cc  5501              STRB     r1,[r0,r4]            ;3275
0003ce  2102              MOVS     r1,#2                 ;3276
0003d0  202c              MOVS     r0,#0x2c              ;3276
0003d2  5501              STRB     r1,[r0,r4]            ;3276
0003d4  2100              MOVS     r1,#0                 ;3276
0003d6  202d              MOVS     r0,#0x2d              ;3276
0003d8  5501              STRB     r1,[r0,r4]            ;3276
0003da  202e              MOVS     r0,#0x2e              ;3276
0003dc  5501              STRB     r1,[r0,r4]            ;3276
0003de  202f              MOVS     r0,#0x2f              ;3276
0003e0  5501              STRB     r1,[r0,r4]            ;3276
0003e2  2101              MOVS     r1,#1                 ;3277
0003e4  2030              MOVS     r0,#0x30              ;3277
0003e6  5501              STRB     r1,[r0,r4]            ;3277
0003e8  2100              MOVS     r1,#0                 ;3277
0003ea  2031              MOVS     r0,#0x31              ;3277
0003ec  5501              STRB     r1,[r0,r4]            ;3277
0003ee  2106              MOVS     r1,#6                 ;3278
0003f0  2032              MOVS     r0,#0x32              ;3278
0003f2  5501              STRB     r1,[r0,r4]            ;3278
0003f4  2100              MOVS     r1,#0                 ;3278
0003f6  2033              MOVS     r0,#0x33              ;3278
0003f8  5501              STRB     r1,[r0,r4]            ;3278
0003fa  2180              MOVS     r1,#0x80              ;3279
0003fc  2040              MOVS     r0,#0x40              ;3279
0003fe  5501              STRB     r1,[r0,r4]            ;3279
000400  2129              MOVS     r1,#0x29              ;3280
000402  2042              MOVS     r0,#0x42              ;3280
000404  5501              STRB     r1,[r0,r4]            ;3280
000406  2213              MOVS     r2,#0x13              ;3281
000408  a107              ADR      r1,|L21.1064|
00040a  4620              MOV      r0,r4                 ;3281
00040c  3047              ADDS     r0,r0,#0x47           ;3281
00040e  e015              B        |L21.1084|
                  |L21.1040|
                          DCD      FatFs
                  |L21.1044|
                          DCD      vst
                  |L21.1048|
                          DCD      ||cst||
                  |L21.1052|
                          DCD      0x00000ff6
                  |L21.1056|
                          DCD      0x0000fff6
                  |L21.1060|
                          DCD      0x00fb0400
                  |L21.1064|
000428  4e4f204e          DCB      "NO NAME    FAT32   ",0
00042c  414d4520
000430  20202046
000434  41543332
000438  20202000
                  |L21.1084|
00043c  f7fffffe          BL       mem_cpy
000440  e021              B        |L21.1158|
                  |L21.1090|
000442  980d              LDR      r0,[sp,#0x34]         ;3283
000444  b2c1              UXTB     r1,r0                 ;3283
000446  2027              MOVS     r0,#0x27              ;3283
000448  5501              STRB     r1,[r0,r4]            ;3283
00044a  980d              LDR      r0,[sp,#0x34]         ;3283
00044c  0400              LSLS     r0,r0,#16             ;3283
00044e  0e01              LSRS     r1,r0,#24             ;3283
000450  2028              MOVS     r0,#0x28              ;3283
000452  5501              STRB     r1,[r0,r4]            ;3283
000454  980d              LDR      r0,[sp,#0x34]         ;3283
000456  0200              LSLS     r0,r0,#8              ;3283
000458  0e01              LSRS     r1,r0,#24             ;3283
00045a  2029              MOVS     r0,#0x29              ;3283
00045c  5501              STRB     r1,[r0,r4]            ;3283
00045e  980d              LDR      r0,[sp,#0x34]         ;3283
000460  0e01              LSRS     r1,r0,#24             ;3283
000462  202a              MOVS     r0,#0x2a              ;3283
000464  5501              STRB     r1,[r0,r4]            ;3283
000466  75a6              STRB     r6,[r4,#0x16]         ;3284
000468  0430              LSLS     r0,r6,#16             ;3284
00046a  0e01              LSRS     r1,r0,#24             ;3284
00046c  75e1              STRB     r1,[r4,#0x17]         ;3284
00046e  2180              MOVS     r1,#0x80              ;3285
000470  2024              MOVS     r0,#0x24              ;3285
000472  5501              STRB     r1,[r0,r4]            ;3285
000474  2129              MOVS     r1,#0x29              ;3286
000476  2026              MOVS     r0,#0x26              ;3286
000478  5501              STRB     r1,[r0,r4]            ;3286
00047a  2213              MOVS     r2,#0x13              ;3287
00047c  a17e              ADR      r1,|L21.1656|
00047e  4620              MOV      r0,r4                 ;3287
000480  302b              ADDS     r0,r0,#0x2b           ;3287
000482  f7fffffe          BL       mem_cpy
                  |L21.1158|
000486  2155              MOVS     r1,#0x55              ;3289
000488  20ff              MOVS     r0,#0xff              ;3289
00048a  30ff              ADDS     r0,r0,#0xff           ;3289
00048c  5501              STRB     r1,[r0,r4]            ;3289
00048e  21aa              MOVS     r1,#0xaa              ;3289
000490  1c40              ADDS     r0,r0,#1              ;3289
000492  5501              STRB     r1,[r0,r4]            ;3289
000494  2301              MOVS     r3,#1                 ;3290
000496  4621              MOV      r1,r4                 ;3290
000498  9a0a              LDR      r2,[sp,#0x28]         ;3290
00049a  9810              LDR      r0,[sp,#0x40]         ;3290
00049c  f7fffffe          BL       disk_write
0004a0  2800              CMP      r0,#0                 ;3290
0004a2  d001              BEQ      |L21.1192|
0004a4  2001              MOVS     r0,#1                 ;3291
0004a6  e5b1              B        |L21.12|
                  |L21.1192|
0004a8  2d03              CMP      r5,#3                 ;3292
0004aa  d106              BNE      |L21.1210|
0004ac  2301              MOVS     r3,#1                 ;3293
0004ae  9a0a              LDR      r2,[sp,#0x28]         ;3293
0004b0  1d92              ADDS     r2,r2,#6              ;3293
0004b2  4621              MOV      r1,r4                 ;3293
0004b4  9810              LDR      r0,[sp,#0x40]         ;3293
0004b6  f7fffffe          BL       disk_write
                  |L21.1210|
0004ba  2000              MOVS     r0,#0                 ;3296
0004bc  900b              STR      r0,[sp,#0x2c]         ;3296
0004be  e06a              B        |L21.1430|
                  |L21.1216|
0004c0  2201              MOVS     r2,#1                 ;3297
0004c2  0252              LSLS     r2,r2,#9              ;3297
0004c4  2100              MOVS     r1,#0                 ;3297
0004c6  4620              MOV      r0,r4                 ;3297
0004c8  f7fffffe          BL       mem_set
0004cc  980f              LDR      r0,[sp,#0x3c]         ;3298
0004ce  900d              STR      r0,[sp,#0x34]         ;3298
0004d0  2d03              CMP      r5,#3                 ;3299
0004d2  d016              BEQ      |L21.1282|
0004d4  2d01              CMP      r5,#1                 ;3300
0004d6  d101              BNE      |L21.1244|
0004d8  486c              LDR      r0,|L21.1676|
0004da  e001              B        |L21.1248|
                  |L21.1244|
0004dc  20ff              MOVS     r0,#0xff              ;3300
0004de  43c0              MVNS     r0,r0                 ;3300
                  |L21.1248|
0004e0  990d              LDR      r1,[sp,#0x34]         ;3300
0004e2  4308              ORRS     r0,r0,r1              ;3300
0004e4  900d              STR      r0,[sp,#0x34]         ;3300
0004e6  980d              LDR      r0,[sp,#0x34]         ;3301
0004e8  7020              STRB     r0,[r4,#0]            ;3301
0004ea  980d              LDR      r0,[sp,#0x34]         ;3301
0004ec  0400              LSLS     r0,r0,#16             ;3301
0004ee  0e00              LSRS     r0,r0,#24             ;3301
0004f0  7060              STRB     r0,[r4,#1]            ;3301
0004f2  980d              LDR      r0,[sp,#0x34]         ;3301
0004f4  0200              LSLS     r0,r0,#8              ;3301
0004f6  0e00              LSRS     r0,r0,#24             ;3301
0004f8  70a0              STRB     r0,[r4,#2]            ;3301
0004fa  980d              LDR      r0,[sp,#0x34]         ;3301
0004fc  0e00              LSRS     r0,r0,#24             ;3301
0004fe  70e0              STRB     r0,[r4,#3]            ;3301
000500  e01d              B        |L21.1342|
                  |L21.1282|
000502  4963              LDR      r1,|L21.1680|
000504  980d              LDR      r0,[sp,#0x34]         ;3303
000506  4308              ORRS     r0,r0,r1              ;3303
000508  900d              STR      r0,[sp,#0x34]         ;3303
00050a  980d              LDR      r0,[sp,#0x34]         ;3304
00050c  7020              STRB     r0,[r4,#0]            ;3304
00050e  980d              LDR      r0,[sp,#0x34]         ;3304
000510  0400              LSLS     r0,r0,#16             ;3304
000512  0e00              LSRS     r0,r0,#24             ;3304
000514  7060              STRB     r0,[r4,#1]            ;3304
000516  980d              LDR      r0,[sp,#0x34]         ;3304
000518  0200              LSLS     r0,r0,#8              ;3304
00051a  0e00              LSRS     r0,r0,#24             ;3304
00051c  70a0              STRB     r0,[r4,#2]            ;3304
00051e  980d              LDR      r0,[sp,#0x34]         ;3304
000520  0e00              LSRS     r0,r0,#24             ;3304
000522  70e0              STRB     r0,[r4,#3]            ;3304
000524  20ff              MOVS     r0,#0xff              ;3305
000526  7120              STRB     r0,[r4,#4]            ;3305
000528  21ff              MOVS     r1,#0xff              ;3305
00052a  7161              STRB     r1,[r4,#5]            ;3305
00052c  71a1              STRB     r1,[r4,#6]            ;3305
00052e  210f              MOVS     r1,#0xf               ;3305
000530  71e1              STRB     r1,[r4,#7]            ;3305
000532  7220              STRB     r0,[r4,#8]            ;3306
000534  21ff              MOVS     r1,#0xff              ;3306
000536  7261              STRB     r1,[r4,#9]            ;3306
000538  72a1              STRB     r1,[r4,#0xa]          ;3306
00053a  210f              MOVS     r1,#0xf               ;3306
00053c  72e1              STRB     r1,[r4,#0xb]          ;3306
                  |L21.1342|
00053e  9809              LDR      r0,[sp,#0x24]         ;3308
000540  1c41              ADDS     r1,r0,#1              ;3308
000542  4602              MOV      r2,r0                 ;3308
000544  2301              MOVS     r3,#1                 ;3308
000546  9109              STR      r1,[sp,#0x24]         ;3308
000548  4621              MOV      r1,r4                 ;3308
00054a  9810              LDR      r0,[sp,#0x40]         ;3308
00054c  f7fffffe          BL       disk_write
000550  2800              CMP      r0,#0                 ;3308
000552  d001              BEQ      |L21.1368|
000554  2001              MOVS     r0,#1                 ;3309
000556  e559              B        |L21.12|
                  |L21.1368|
000558  2201              MOVS     r2,#1                 ;3310
00055a  0252              LSLS     r2,r2,#9              ;3310
00055c  2100              MOVS     r1,#0                 ;3310
00055e  4620              MOV      r0,r4                 ;3310
000560  f7fffffe          BL       mem_set
000564  2001              MOVS     r0,#1                 ;3311
000566  900d              STR      r0,[sp,#0x34]         ;3311
000568  e00f              B        |L21.1418|
                  |L21.1386|
00056a  9809              LDR      r0,[sp,#0x24]         ;3312
00056c  1c41              ADDS     r1,r0,#1              ;3312
00056e  4602              MOV      r2,r0                 ;3312
000570  2301              MOVS     r3,#1                 ;3312
000572  9109              STR      r1,[sp,#0x24]         ;3312
000574  4621              MOV      r1,r4                 ;3312
000576  9810              LDR      r0,[sp,#0x40]         ;3312
000578  f7fffffe          BL       disk_write
00057c  2800              CMP      r0,#0                 ;3312
00057e  d001              BEQ      |L21.1412|
000580  2001              MOVS     r0,#1                 ;3313
000582  e543              B        |L21.12|
                  |L21.1412|
000584  980d              LDR      r0,[sp,#0x34]         ;3311
000586  1c40              ADDS     r0,r0,#1              ;3311
000588  900d              STR      r0,[sp,#0x34]         ;3311
                  |L21.1418|
00058a  980d              LDR      r0,[sp,#0x34]         ;3311
00058c  42b0              CMP      r0,r6                 ;3311
00058e  d3ec              BCC      |L21.1386|
000590  980b              LDR      r0,[sp,#0x2c]         ;3296
000592  1c40              ADDS     r0,r0,#1              ;3296
000594  900b              STR      r0,[sp,#0x2c]         ;3296
                  |L21.1430|
000596  980b              LDR      r0,[sp,#0x2c]         ;3296
000598  2800              CMP      r0,#0                 ;3296
00059a  d091              BEQ      |L21.1216|
00059c  2d03              CMP      r5,#3                 ;3318
00059e  d101              BNE      |L21.1444|
0005a0  980c              LDR      r0,[sp,#0x30]         ;3318
0005a2  e000              B        |L21.1446|
                  |L21.1444|
0005a4  9804              LDR      r0,[sp,#0x10]         ;3318
                  |L21.1446|
0005a6  900d              STR      r0,[sp,#0x34]         ;3318
0005a8  e00c              B        |L21.1476|
                  |L21.1450|
0005aa  9809              LDR      r0,[sp,#0x24]         ;3320
0005ac  1c41              ADDS     r1,r0,#1              ;3320
0005ae  4602              MOV      r2,r0                 ;3320
0005b0  2301              MOVS     r3,#1                 ;3320
0005b2  9109              STR      r1,[sp,#0x24]         ;3320
0005b4  4621              MOV      r1,r4                 ;3320
0005b6  9810              LDR      r0,[sp,#0x40]         ;3320
0005b8  f7fffffe          BL       disk_write
0005bc  2800              CMP      r0,#0                 ;3320
0005be  d001              BEQ      |L21.1476|
0005c0  2001              MOVS     r0,#1                 ;3321
0005c2  e523              B        |L21.12|
                  |L21.1476|
0005c4  990d              LDR      r1,[sp,#0x34]         ;3319
0005c6  1e48              SUBS     r0,r1,#1              ;3319
0005c8  900d              STR      r0,[sp,#0x34]         ;3319
0005ca  2900              CMP      r1,#0                 ;3319
0005cc  d1ed              BNE      |L21.1450|
0005ce  2d03              CMP      r5,#3                 ;3325
0005d0  d146              BNE      |L21.1632|
0005d2  2155              MOVS     r1,#0x55              ;3326
0005d4  20ff              MOVS     r0,#0xff              ;3326
0005d6  30ff              ADDS     r0,r0,#0xff           ;3326
0005d8  5501              STRB     r1,[r0,r4]            ;3326
0005da  21aa              MOVS     r1,#0xaa              ;3326
0005dc  1c40              ADDS     r0,r0,#1              ;3326
0005de  5501              STRB     r1,[r0,r4]            ;3326
0005e0  2052              MOVS     r0,#0x52              ;3327
0005e2  7020              STRB     r0,[r4,#0]            ;3327
0005e4  7060              STRB     r0,[r4,#1]            ;3327
0005e6  2061              MOVS     r0,#0x61              ;3327
0005e8  70a0              STRB     r0,[r4,#2]            ;3327
0005ea  2041              MOVS     r0,#0x41              ;3327
0005ec  70e0              STRB     r0,[r4,#3]            ;3327
0005ee  2172              MOVS     r1,#0x72              ;3328
0005f0  20ff              MOVS     r0,#0xff              ;3328
0005f2  30e5              ADDS     r0,r0,#0xe5           ;3328
0005f4  5501              STRB     r1,[r0,r4]            ;3328
0005f6  1c40              ADDS     r0,r0,#1              ;3328
0005f8  5501              STRB     r1,[r0,r4]            ;3328
0005fa  2141              MOVS     r1,#0x41              ;3328
0005fc  1c40              ADDS     r0,r0,#1              ;3328
0005fe  5501              STRB     r1,[r0,r4]            ;3328
000600  2161              MOVS     r1,#0x61              ;3328
000602  1c40              ADDS     r0,r0,#1              ;3328
000604  5501              STRB     r1,[r0,r4]            ;3328
000606  1e78              SUBS     r0,r7,#1              ;3329
000608  b2c1              UXTB     r1,r0                 ;3329
00060a  20ff              MOVS     r0,#0xff              ;3329
00060c  30e9              ADDS     r0,r0,#0xe9           ;3329
00060e  5501              STRB     r1,[r0,r4]            ;3329
000610  1e78              SUBS     r0,r7,#1              ;3329
000612  0400              LSLS     r0,r0,#16             ;3329
000614  0e01              LSRS     r1,r0,#24             ;3329
000616  20ff              MOVS     r0,#0xff              ;3329
000618  30ea              ADDS     r0,r0,#0xea           ;3329
00061a  5501              STRB     r1,[r0,r4]            ;3329
00061c  1e78              SUBS     r0,r7,#1              ;3329
00061e  0200              LSLS     r0,r0,#8              ;3329
000620  0e01              LSRS     r1,r0,#24             ;3329
000622  20ff              MOVS     r0,#0xff              ;3329
000624  30eb              ADDS     r0,r0,#0xeb           ;3329
000626  5501              STRB     r1,[r0,r4]            ;3329
000628  1e78              SUBS     r0,r7,#1              ;3329
00062a  0e01              LSRS     r1,r0,#24             ;3329
00062c  20ff              MOVS     r0,#0xff              ;3329
00062e  30ec              ADDS     r0,r0,#0xec           ;3329
000630  5501              STRB     r1,[r0,r4]            ;3329
000632  21ff              MOVS     r1,#0xff              ;3330
000634  1c40              ADDS     r0,r0,#1              ;3330
000636  5501              STRB     r1,[r0,r4]            ;3330
000638  1c40              ADDS     r0,r0,#1              ;3330
00063a  5501              STRB     r1,[r0,r4]            ;3330
00063c  1c40              ADDS     r0,r0,#1              ;3330
00063e  5501              STRB     r1,[r0,r4]            ;3330
000640  1c40              ADDS     r0,r0,#1              ;3330
000642  5501              STRB     r1,[r0,r4]            ;3330
000644  2301              MOVS     r3,#1                 ;3331
000646  9a0a              LDR      r2,[sp,#0x28]         ;3331
000648  1c52              ADDS     r2,r2,#1              ;3331
00064a  4621              MOV      r1,r4                 ;3331
00064c  9810              LDR      r0,[sp,#0x40]         ;3331
00064e  f7fffffe          BL       disk_write
000652  2301              MOVS     r3,#1                 ;3332
000654  9a0a              LDR      r2,[sp,#0x28]         ;3332
000656  1dd2              ADDS     r2,r2,#7              ;3332
000658  4621              MOV      r1,r4                 ;3332
00065a  9810              LDR      r0,[sp,#0x40]         ;3332
00065c  f7fffffe          BL       disk_write
                  |L21.1632|
000660  2200              MOVS     r2,#0                 ;3335
000662  4611              MOV      r1,r2                 ;3335
000664  9810              LDR      r0,[sp,#0x40]         ;3335
000666  f7fffffe          BL       disk_ioctl
00066a  2800              CMP      r0,#0                 ;3335
00066c  d001              BEQ      |L21.1650|
00066e  2001              MOVS     r0,#1                 ;3335
000670  e4cc              B        |L21.12|
                  |L21.1650|
000672  2000              MOVS     r0,#0                 ;3335
000674  e4ca              B        |L21.12|
;;;3337   
                          ENDP

000676  0000              DCW      0x0000
                  |L21.1656|
000678  4e4f204e          DCB      "NO NAME    FAT     ",0
00067c  414d4520
000680  20202046
000684  41542020
000688  20202000
                  |L21.1676|
                          DCD      0x00ffff00
                  |L21.1680|
                          DCD      0x0fffff00

                          AREA ||i.f_mount||, CODE, READONLY, ALIGN=2

                  f_mount PROC
;;;1850   
;;;1851   FRESULT f_mount (
000000  b510              PUSH     {r4,lr}
;;;1852   	BYTE vol,		/* Logical drive number to be mounted/unmounted */
;;;1853   	FATFS *fs		/* Pointer to new file system object (NULL for unmount)*/
;;;1854   )
;;;1855   {
000002  4602              MOV      r2,r0
;;;1856   	FATFS *rfs;
;;;1857   
;;;1858   
;;;1859   	if (vol >= _DRIVES)				/* Check if the drive number is valid */
000004  2a01              CMP      r2,#1
000006  db01              BLT      |L22.12|
;;;1860   		return FR_INVALID_DRIVE;
000008  200b              MOVS     r0,#0xb
                  |L22.10|
;;;1861   	rfs = FatFs[vol];				/* Get current fs object */
;;;1862   
;;;1863   	if (rfs) {
;;;1864   #if _FS_REENTRANT					/* Discard sync object of the current volume */
;;;1865   		if (!ff_del_syncobj(rfs->sobj)) return FR_INT_ERR;
;;;1866   #endif
;;;1867   		rfs->fs_type = 0;			/* Clear old fs object */
;;;1868   	}
;;;1869   
;;;1870   	if (fs) {
;;;1871   		fs->fs_type = 0;			/* Clear new fs object */
;;;1872   #if _FS_REENTRANT					/* Create sync object for the new volume */
;;;1873   		if (!ff_cre_syncobj(vol, &fs->sobj)) return FR_INT_ERR;
;;;1874   #endif
;;;1875   	}
;;;1876   	FatFs[vol] = fs;				/* Register new fs object */
;;;1877   
;;;1878   	return FR_OK;
;;;1879   }
00000a  bd10              POP      {r4,pc}
                  |L22.12|
00000c  0090              LSLS     r0,r2,#2              ;1861
00000e  4c07              LDR      r4,|L22.44|
000010  5823              LDR      r3,[r4,r0]            ;1861
000012  2b00              CMP      r3,#0                 ;1863
000014  d001              BEQ      |L22.26|
000016  2000              MOVS     r0,#0                 ;1867
000018  7018              STRB     r0,[r3,#0]            ;1867
                  |L22.26|
00001a  2900              CMP      r1,#0                 ;1870
00001c  d001              BEQ      |L22.34|
00001e  2000              MOVS     r0,#0                 ;1871
000020  7008              STRB     r0,[r1,#0]            ;1871
                  |L22.34|
000022  0090              LSLS     r0,r2,#2              ;1876
000024  4c01              LDR      r4,|L22.44|
000026  5021              STR      r1,[r4,r0]            ;1876
000028  2000              MOVS     r0,#0                 ;1878
00002a  e7ee              B        |L22.10|
;;;1880   
                          ENDP

                  |L22.44|
                          DCD      FatFs

                          AREA ||i.f_open||, CODE, READONLY, ALIGN=2

                  f_open PROC
;;;1887   
;;;1888   FRESULT f_open (
000000  b5f7              PUSH     {r0-r2,r4-r7,lr}
;;;1889   	FIL *fp,			/* Pointer to the blank file object */
;;;1890   	const TCHAR *path,	/* Pointer to the file name */
;;;1891   	BYTE mode			/* Access mode and file open mode flags */
;;;1892   )
;;;1893   {
000002  b08e              SUB      sp,sp,#0x38
000004  4605              MOV      r5,r0
000006  4616              MOV      r6,r2
;;;1894   	FRESULT res;
;;;1895   	DIR dj;
;;;1896   	BYTE *dir;
;;;1897   	DEF_NAMEBUF;
;;;1898   
;;;1899   
;;;1900   	fp->fs = 0;			/* Clear file object */
000008  2000              MOVS     r0,#0
00000a  6028              STR      r0,[r5,#0]
;;;1901   
;;;1902   #if !_FS_READONLY
;;;1903   	mode &= FA_READ | FA_WRITE | FA_CREATE_ALWAYS | FA_OPEN_ALWAYS | FA_CREATE_NEW;
00000c  06f6              LSLS     r6,r6,#27
00000e  0ef6              LSRS     r6,r6,#27
;;;1904   	res = chk_mounted(&path, &dj.fs, (BYTE)(mode & ~FA_READ));
000010  0872              LSRS     r2,r6,#1
000012  0052              LSLS     r2,r2,#1
000014  a905              ADD      r1,sp,#0x14
000016  a80f              ADD      r0,sp,#0x3c
000018  f7fffffe          BL       chk_mounted
00001c  4607              MOV      r7,r0
;;;1905   #else
;;;1906   	mode &= FA_READ;
;;;1907   	res = chk_mounted(&path, &dj.fs, 0);
;;;1908   #endif
;;;1909   	INIT_BUF(dj);
00001e  a802              ADD      r0,sp,#8
000020  900b              STR      r0,[sp,#0x2c]
000022  485b              LDR      r0,|L23.400|
000024  900c              STR      r0,[sp,#0x30]
;;;1910   	if (res == FR_OK)
000026  2f00              CMP      r7,#0
000028  d104              BNE      |L23.52|
;;;1911   		res = follow_path(&dj, path);	/* Follow the file path */
00002a  a805              ADD      r0,sp,#0x14
00002c  990f              LDR      r1,[sp,#0x3c]
00002e  f7fffffe          BL       follow_path
000032  4607              MOV      r7,r0
                  |L23.52|
;;;1912   	dir = dj.dir;
000034  9c0a              LDR      r4,[sp,#0x28]
;;;1913   
;;;1914   #if !_FS_READONLY	/* R/W configuration */
;;;1915   	if (res == FR_OK) {
000036  2f00              CMP      r7,#0
000038  d102              BNE      |L23.64|
;;;1916   		if (!dir)	/* Current dir itself */
00003a  2c00              CMP      r4,#0
00003c  d100              BNE      |L23.64|
;;;1917   			res = FR_INVALID_NAME;
00003e  2706              MOVS     r7,#6
                  |L23.64|
;;;1918   #if _FS_SHARE
;;;1919   		else
;;;1920   			res = chk_lock(&dj, (mode & ~FA_READ) ? 1 : 0);
;;;1921   #endif
;;;1922   	}
;;;1923   	/* Create or Open a file */
;;;1924   	if (mode & (FA_CREATE_ALWAYS | FA_OPEN_ALWAYS | FA_CREATE_NEW)) {
000040  201c              MOVS     r0,#0x1c
000042  4030              ANDS     r0,r0,r6
000044  2800              CMP      r0,#0
000046  d05f              BEQ      |L23.264|
;;;1925   		DWORD dw, cl;
;;;1926   
;;;1927   		if (res != FR_OK) {				/* No file, create new */
000048  2f00              CMP      r7,#0
00004a  d009              BEQ      |L23.96|
;;;1928   			if (res == FR_NO_FILE)		/* There is no file to open, create a new entry */
00004c  2f04              CMP      r7,#4
00004e  d103              BNE      |L23.88|
;;;1929   #if _FS_SHARE
;;;1930   				res = enq_lock(dj.fs) ? dir_register(&dj) : FR_TOO_MANY_OPEN_FILES;
;;;1931   #else
;;;1932   				res = dir_register(&dj);
000050  a805              ADD      r0,sp,#0x14
000052  f7fffffe          BL       dir_register
000056  4607              MOV      r7,r0
                  |L23.88|
;;;1933   #endif
;;;1934   			mode |= FA_CREATE_ALWAYS;
000058  2008              MOVS     r0,#8
00005a  4306              ORRS     r6,r6,r0
;;;1935   			dir = dj.dir;				/* New entry */
00005c  9c0a              LDR      r4,[sp,#0x28]
00005e  e00b              B        |L23.120|
                  |L23.96|
;;;1936   		}
;;;1937   		else {							/* Any object is already existing */
;;;1938   			if (mode & FA_CREATE_NEW) {			/* Cannot create new */
000060  2004              MOVS     r0,#4
000062  4030              ANDS     r0,r0,r6
000064  2800              CMP      r0,#0
000066  d001              BEQ      |L23.108|
;;;1939   				res = FR_EXIST;
000068  2708              MOVS     r7,#8
00006a  e005              B        |L23.120|
                  |L23.108|
;;;1940   			} else {
;;;1941   				if (dir[DIR_Attr] & (AM_RDO | AM_DIR))	/* Cannot overwrite it (R/O or DIR) */
00006c  7ae0              LDRB     r0,[r4,#0xb]
00006e  2111              MOVS     r1,#0x11
000070  4008              ANDS     r0,r0,r1
000072  2800              CMP      r0,#0
000074  d000              BEQ      |L23.120|
;;;1942   					res = FR_DENIED;
000076  2707              MOVS     r7,#7
                  |L23.120|
;;;1943   			}
;;;1944   		}
;;;1945   		if (res == FR_OK && (mode & FA_CREATE_ALWAYS)) {	/* Truncate it if overwrite mode */
000078  2f00              CMP      r7,#0
00007a  d144              BNE      |L23.262|
00007c  2008              MOVS     r0,#8
00007e  4030              ANDS     r0,r0,r6
000080  2800              CMP      r0,#0
000082  d040              BEQ      |L23.262|
;;;1946   			dw = get_fattime();						/* Created time */
000084  f7fffffe          BL       get_fattime
000088  9001              STR      r0,[sp,#4]
;;;1947   			ST_DWORD(dir+DIR_CrtTime, dw);
00008a  9801              LDR      r0,[sp,#4]
00008c  73a0              STRB     r0,[r4,#0xe]
00008e  9801              LDR      r0,[sp,#4]
000090  0400              LSLS     r0,r0,#16
000092  0e01              LSRS     r1,r0,#24
000094  73e1              STRB     r1,[r4,#0xf]
000096  9801              LDR      r0,[sp,#4]
000098  0200              LSLS     r0,r0,#8
00009a  0e01              LSRS     r1,r0,#24
00009c  7421              STRB     r1,[r4,#0x10]
00009e  9801              LDR      r0,[sp,#4]
0000a0  0e01              LSRS     r1,r0,#24
0000a2  7461              STRB     r1,[r4,#0x11]
;;;1948   			dir[DIR_Attr] = 0;					/* Reset attribute */
0000a4  2000              MOVS     r0,#0
0000a6  72e0              STRB     r0,[r4,#0xb]
;;;1949   			ST_DWORD(dir+DIR_FileSize, 0);		/* size = 0 */
0000a8  7720              STRB     r0,[r4,#0x1c]
0000aa  2100              MOVS     r1,#0
0000ac  7761              STRB     r1,[r4,#0x1d]
0000ae  77a1              STRB     r1,[r4,#0x1e]
0000b0  77e1              STRB     r1,[r4,#0x1f]
;;;1950   			cl = ((DWORD)LD_WORD(dir+DIR_FstClusHI) << 16) | LD_WORD(dir+DIR_FstClusLO);	/* Get start cluster */
0000b2  7d60              LDRB     r0,[r4,#0x15]
0000b4  0200              LSLS     r0,r0,#8
0000b6  7d21              LDRB     r1,[r4,#0x14]
0000b8  4308              ORRS     r0,r0,r1
0000ba  0400              LSLS     r0,r0,#16
0000bc  7ee1              LDRB     r1,[r4,#0x1b]
0000be  0209              LSLS     r1,r1,#8
0000c0  7ea2              LDRB     r2,[r4,#0x1a]
0000c2  4311              ORRS     r1,r1,r2
0000c4  4308              ORRS     r0,r0,r1
0000c6  9000              STR      r0,[sp,#0]
;;;1951   			ST_WORD(dir+DIR_FstClusHI, 0);		/* cluster = 0 */
0000c8  2000              MOVS     r0,#0
0000ca  7520              STRB     r0,[r4,#0x14]
0000cc  2100              MOVS     r1,#0
0000ce  7561              STRB     r1,[r4,#0x15]
;;;1952   			ST_WORD(dir+DIR_FstClusLO, 0);
0000d0  76a0              STRB     r0,[r4,#0x1a]
0000d2  76e1              STRB     r1,[r4,#0x1b]
;;;1953   			dj.fs->wflag = 1;
0000d4  2001              MOVS     r0,#1
0000d6  9905              LDR      r1,[sp,#0x14]
0000d8  7108              STRB     r0,[r1,#4]
;;;1954   			if (cl) {							/* Remove the cluster chain if exist */
0000da  9800              LDR      r0,[sp,#0]
0000dc  2800              CMP      r0,#0
0000de  d012              BEQ      |L23.262|
;;;1955   				dw = dj.fs->winsect;
0000e0  9805              LDR      r0,[sp,#0x14]
0000e2  6b00              LDR      r0,[r0,#0x30]
0000e4  9001              STR      r0,[sp,#4]
;;;1956   				res = remove_chain(dj.fs, cl);
0000e6  9900              LDR      r1,[sp,#0]
0000e8  9805              LDR      r0,[sp,#0x14]
0000ea  f7fffffe          BL       remove_chain
0000ee  4607              MOV      r7,r0
;;;1957   				if (res == FR_OK) {
0000f0  2f00              CMP      r7,#0
0000f2  d108              BNE      |L23.262|
;;;1958   					dj.fs->last_clust = cl - 1;	/* Reuse the cluster hole */
0000f4  9800              LDR      r0,[sp,#0]
0000f6  1e40              SUBS     r0,r0,#1
0000f8  9905              LDR      r1,[sp,#0x14]
0000fa  60c8              STR      r0,[r1,#0xc]
;;;1959   					res = move_window(dj.fs, dw);
0000fc  9901              LDR      r1,[sp,#4]
0000fe  9805              LDR      r0,[sp,#0x14]
000100  f7fffffe          BL       move_window
000104  4607              MOV      r7,r0
                  |L23.262|
;;;1960   				}
;;;1961   			}
;;;1962   		}
;;;1963   	}
000106  e012              B        |L23.302|
                  |L23.264|
;;;1964   	else {	/* Open an existing file */
;;;1965   		if (res == FR_OK) {						/* Follow succeeded */
000108  2f00              CMP      r7,#0
00010a  d110              BNE      |L23.302|
;;;1966   			if (dir[DIR_Attr] & AM_DIR) {		/* It is a directory */
00010c  7ae0              LDRB     r0,[r4,#0xb]
00010e  2110              MOVS     r1,#0x10
000110  4008              ANDS     r0,r0,r1
000112  2800              CMP      r0,#0
000114  d001              BEQ      |L23.282|
;;;1967   				res = FR_NO_FILE;
000116  2704              MOVS     r7,#4
000118  e009              B        |L23.302|
                  |L23.282|
;;;1968   			} else {
;;;1969   				if ((mode & FA_WRITE) && (dir[DIR_Attr] & AM_RDO)) /* R/O violation */
00011a  2002              MOVS     r0,#2
00011c  4030              ANDS     r0,r0,r6
00011e  2800              CMP      r0,#0
000120  d005              BEQ      |L23.302|
000122  7ae0              LDRB     r0,[r4,#0xb]
000124  07c0              LSLS     r0,r0,#31
000126  0fc0              LSRS     r0,r0,#31
000128  2800              CMP      r0,#0
00012a  d000              BEQ      |L23.302|
;;;1970   					res = FR_DENIED;
00012c  2707              MOVS     r7,#7
                  |L23.302|
;;;1971   			}
;;;1972   		}
;;;1973   	}
;;;1974   	if (res == FR_OK) {
00012e  2f00              CMP      r7,#0
000130  d109              BNE      |L23.326|
;;;1975   		if (mode & (FA_WRITE | FA_CREATE_ALWAYS | FA_OPEN_ALWAYS | FA_CREATE_NEW))
000132  201e              MOVS     r0,#0x1e
000134  4030              ANDS     r0,r0,r6
000136  2800              CMP      r0,#0
000138  d001              BEQ      |L23.318|
;;;1976   			mode |= FA__WRITTEN;				/* Set file changed flag */
00013a  2020              MOVS     r0,#0x20
00013c  4306              ORRS     r6,r6,r0
                  |L23.318|
;;;1977   		fp->dir_sect = dj.fs->winsect;			/* Pointer to the directory entry */
00013e  9805              LDR      r0,[sp,#0x14]
000140  6b00              LDR      r0,[r0,#0x30]
000142  61e8              STR      r0,[r5,#0x1c]
;;;1978   		fp->dir_ptr = dir;
000144  622c              STR      r4,[r5,#0x20]
                  |L23.326|
;;;1979   #if _FS_SHARE
;;;1980   		fp->lockid = inc_lock(&dj, (mode & ~FA_READ) ? 1 : 0);
;;;1981   		if (!fp->lockid) res = FR_INT_ERR;
;;;1982   #endif
;;;1983   	}
;;;1984   
;;;1985   #else				/* R/O configuration */
;;;1986   	if (res == FR_OK) {					/* Follow succeeded */
;;;1987   		if (!dir) {						/* Current dir itself */
;;;1988   			res = FR_INVALID_NAME;
;;;1989   		} else {
;;;1990   			if (dir[DIR_Attr] & AM_DIR)	/* It is a directory */
;;;1991   				res = FR_NO_FILE;
;;;1992   		}
;;;1993   	}
;;;1994   #endif
;;;1995   	FREE_BUF();
;;;1996   
;;;1997   	if (res == FR_OK) {
000146  2f00              CMP      r7,#0
000148  d11e              BNE      |L23.392|
;;;1998   		fp->flag = mode;					/* File access mode */
00014a  71ae              STRB     r6,[r5,#6]
;;;1999   		fp->org_clust =						/* File start cluster */
00014c  7d60              LDRB     r0,[r4,#0x15]
00014e  0200              LSLS     r0,r0,#8
000150  7d21              LDRB     r1,[r4,#0x14]
000152  4308              ORRS     r0,r0,r1
000154  0400              LSLS     r0,r0,#16
000156  7ee1              LDRB     r1,[r4,#0x1b]
000158  0209              LSLS     r1,r1,#8
00015a  7ea2              LDRB     r2,[r4,#0x1a]
00015c  4311              ORRS     r1,r1,r2
00015e  4308              ORRS     r0,r0,r1
000160  6128              STR      r0,[r5,#0x10]
;;;2000   			((DWORD)LD_WORD(dir+DIR_FstClusHI) << 16) | LD_WORD(dir+DIR_FstClusLO);
;;;2001   		fp->fsize = LD_DWORD(dir+DIR_FileSize);	/* File size */
000162  7fe0              LDRB     r0,[r4,#0x1f]
000164  0600              LSLS     r0,r0,#24
000166  7fa1              LDRB     r1,[r4,#0x1e]
000168  0409              LSLS     r1,r1,#16
00016a  4308              ORRS     r0,r0,r1
00016c  7f61              LDRB     r1,[r4,#0x1d]
00016e  0209              LSLS     r1,r1,#8
000170  4308              ORRS     r0,r0,r1
000172  7f21              LDRB     r1,[r4,#0x1c]
000174  4308              ORRS     r0,r0,r1
000176  60e8              STR      r0,[r5,#0xc]
;;;2002   		fp->fptr = 0;						/* File pointer */
000178  2000              MOVS     r0,#0
00017a  60a8              STR      r0,[r5,#8]
;;;2003   		fp->dsect = 0;
00017c  61a8              STR      r0,[r5,#0x18]
;;;2004   #if _USE_FASTSEEK
;;;2005   		fp->cltbl = 0;						/* No cluster link map table */
;;;2006   #endif
;;;2007   		fp->fs = dj.fs; fp->id = dj.fs->id;	/* Validate file object */
00017e  9805              LDR      r0,[sp,#0x14]
000180  6028              STR      r0,[r5,#0]
000182  9805              LDR      r0,[sp,#0x14]
000184  88c0              LDRH     r0,[r0,#6]
000186  80a8              STRH     r0,[r5,#4]
                  |L23.392|
;;;2008   	}
;;;2009   
;;;2010   	LEAVE_FF(dj.fs, res);
000188  4638              MOV      r0,r7
;;;2011   }
00018a  b011              ADD      sp,sp,#0x44
00018c  bdf0              POP      {r4-r7,pc}
;;;2012   
                          ENDP

00018e  0000              DCW      0x0000
                  |L23.400|
                          DCD      LfnBuf

                          AREA ||i.f_opendir||, CODE, READONLY, ALIGN=2

                  f_opendir PROC
;;;2534   
;;;2535   FRESULT f_opendir (
000000  b573              PUSH     {r0,r1,r4-r6,lr}
;;;2536   	DIR *dj,			/* Pointer to directory object to create */
;;;2537   	const TCHAR *path	/* Pointer to the directory path */
;;;2538   )
;;;2539   {
000002  b084              SUB      sp,sp,#0x10
000004  4604              MOV      r4,r0
;;;2540   	FRESULT res;
;;;2541   	BYTE *dir;
;;;2542   	DEF_NAMEBUF;
;;;2543   
;;;2544   
;;;2545   	res = chk_mounted(&path, &dj->fs, 0);
000006  2200              MOVS     r2,#0
000008  4621              MOV      r1,r4
00000a  a805              ADD      r0,sp,#0x14
00000c  f7fffffe          BL       chk_mounted
000010  4606              MOV      r6,r0
;;;2546   	if (res == FR_OK) {
000012  2e00              CMP      r6,#0
000014  d12c              BNE      |L24.112|
;;;2547   		INIT_BUF(*dj);
000016  a801              ADD      r0,sp,#4
000018  61a0              STR      r0,[r4,#0x18]
00001a  4817              LDR      r0,|L24.120|
00001c  61e0              STR      r0,[r4,#0x1c]
;;;2548   		res = follow_path(dj, path);			/* Follow the path to the directory */
00001e  4620              MOV      r0,r4
000020  9905              LDR      r1,[sp,#0x14]
000022  f7fffffe          BL       follow_path
000026  4606              MOV      r6,r0
;;;2549   		FREE_BUF();
;;;2550   		if (res == FR_OK) {						/* Follow completed */
000028  2e00              CMP      r6,#0
00002a  d11e              BNE      |L24.106|
;;;2551   			dir = dj->dir;
00002c  6965              LDR      r5,[r4,#0x14]
;;;2552   			if (dir) {							/* It is not the current dir */
00002e  2d00              CMP      r5,#0
000030  d011              BEQ      |L24.86|
;;;2553   				if (dir[DIR_Attr] & AM_DIR) {	/* The object is a directory */
000032  7ae8              LDRB     r0,[r5,#0xb]
000034  2110              MOVS     r1,#0x10
000036  4008              ANDS     r0,r0,r1
000038  2800              CMP      r0,#0
00003a  d00b              BEQ      |L24.84|
;;;2554   					dj->sclust = ((DWORD)LD_WORD(dir+DIR_FstClusHI) << 16) | LD_WORD(dir+DIR_FstClusLO);
00003c  7d68              LDRB     r0,[r5,#0x15]
00003e  0200              LSLS     r0,r0,#8
000040  7d29              LDRB     r1,[r5,#0x14]
000042  4308              ORRS     r0,r0,r1
000044  0400              LSLS     r0,r0,#16
000046  7ee9              LDRB     r1,[r5,#0x1b]
000048  0209              LSLS     r1,r1,#8
00004a  7eaa              LDRB     r2,[r5,#0x1a]
00004c  4311              ORRS     r1,r1,r2
00004e  4308              ORRS     r0,r0,r1
000050  60a0              STR      r0,[r4,#8]
000052  e000              B        |L24.86|
                  |L24.84|
;;;2555   				} else {						/* The object is not a directory */
;;;2556   					res = FR_NO_PATH;
000054  2605              MOVS     r6,#5
                  |L24.86|
;;;2557   				}
;;;2558   			}
;;;2559   			if (res == FR_OK) {
000056  2e00              CMP      r6,#0
000058  d107              BNE      |L24.106|
;;;2560   				dj->id = dj->fs->id;
00005a  6820              LDR      r0,[r4,#0]
00005c  88c0              LDRH     r0,[r0,#6]
00005e  80a0              STRH     r0,[r4,#4]
;;;2561   				res = dir_sdi(dj, 0);			/* Rewind dir */
000060  2100              MOVS     r1,#0
000062  4620              MOV      r0,r4
000064  f7fffffe          BL       dir_sdi
000068  4606              MOV      r6,r0
                  |L24.106|
;;;2562   			}
;;;2563   		}
;;;2564   		if (res == FR_NO_FILE) res = FR_NO_PATH;
00006a  2e04              CMP      r6,#4
00006c  d100              BNE      |L24.112|
00006e  2605              MOVS     r6,#5
                  |L24.112|
;;;2565   	}
;;;2566   
;;;2567   	LEAVE_FF(dj->fs, res);
000070  4630              MOV      r0,r6
;;;2568   }
000072  b006              ADD      sp,sp,#0x18
000074  bd70              POP      {r4-r6,pc}
;;;2569   
                          ENDP

000076  0000              DCW      0x0000
                  |L24.120|
                          DCD      LfnBuf

                          AREA ||i.f_read||, CODE, READONLY, ALIGN=1

                  f_read PROC
;;;2019   
;;;2020   FRESULT f_read (
000000  b5ff              PUSH     {r0-r7,lr}
;;;2021   	FIL *fp, 		/* Pointer to the file object */
;;;2022   	void *buff,		/* Pointer to data buffer */
;;;2023   	UINT btr,		/* Number of bytes to read */
;;;2024   	UINT *br		/* Pointer to number of bytes read */
;;;2025   )
;;;2026   {
000002  b087              SUB      sp,sp,#0x1c
000004  4604              MOV      r4,r0
000006  4615              MOV      r5,r2
;;;2027   	FRESULT res;
;;;2028   	DWORD clst, sect, remain;
;;;2029   	UINT rcnt, cc;
;;;2030   	BYTE csect, *rbuff = buff;
000008  9808              LDR      r0,[sp,#0x20]
00000a  9001              STR      r0,[sp,#4]
;;;2031   
;;;2032   
;;;2033   	*br = 0;	/* Initialize byte counter */
00000c  2100              MOVS     r1,#0
00000e  980a              LDR      r0,[sp,#0x28]
000010  6001              STR      r1,[r0,#0]
;;;2034   
;;;2035   	res = validate(fp->fs, fp->id);					/* Check validity of the object */
000012  88a1              LDRH     r1,[r4,#4]
000014  6820              LDR      r0,[r4,#0]
000016  f7fffffe          BL       validate
00001a  9006              STR      r0,[sp,#0x18]
;;;2036   	if (res != FR_OK) LEAVE_FF(fp->fs, res);
00001c  9806              LDR      r0,[sp,#0x18]
00001e  2800              CMP      r0,#0
000020  d002              BEQ      |L25.40|
000022  9806              LDR      r0,[sp,#0x18]
                  |L25.36|
;;;2037   	if (fp->flag & FA__ERROR)						/* Check abort flag */
;;;2038   		LEAVE_FF(fp->fs, FR_INT_ERR);
;;;2039   	if (!(fp->flag & FA_READ)) 						/* Check access mode */
;;;2040   		LEAVE_FF(fp->fs, FR_DENIED);
;;;2041   	remain = fp->fsize - fp->fptr;
;;;2042   	if (btr > remain) btr = (UINT)remain;			/* Truncate btr by remaining bytes */
;;;2043   
;;;2044   	for ( ;  btr;									/* Repeat until all data transferred */
;;;2045   		rbuff += rcnt, fp->fptr += rcnt, *br += rcnt, btr -= rcnt) {
;;;2046   		if ((fp->fptr % SS(fp->fs)) == 0) {			/* On the sector boundary? */
;;;2047   			csect = (BYTE)(fp->fptr / SS(fp->fs) & (fp->fs->csize - 1));	/* Sector offset in the cluster */
;;;2048   			if (!csect) {							/* On the cluster boundary? */
;;;2049   				clst = (fp->fptr == 0) ?			/* On the top of the file? */
;;;2050   					fp->org_clust : get_fat(fp->fs, fp->curr_clust);
;;;2051   				if (clst <= 1) ABORT(fp->fs, FR_INT_ERR);
;;;2052   				if (clst == 0xFFFFFFFF) ABORT(fp->fs, FR_DISK_ERR);
;;;2053   				fp->curr_clust = clst;				/* Update current cluster */
;;;2054   			}
;;;2055   			sect = clust2sect(fp->fs, fp->curr_clust);	/* Get current sector */
;;;2056   			if (!sect) ABORT(fp->fs, FR_INT_ERR);
;;;2057   			sect += csect;
;;;2058   			cc = btr / SS(fp->fs);					/* When remaining bytes >= sector size, */
;;;2059   			if (cc) {								/* Read maximum contiguous sectors directly */
;;;2060   				if (csect + cc > fp->fs->csize)		/* Clip at cluster boundary */
;;;2061   					cc = fp->fs->csize - csect;
;;;2062   				if (disk_read(fp->fs->drv, rbuff, sect, (BYTE)cc) != RES_OK)
;;;2063   					ABORT(fp->fs, FR_DISK_ERR);
;;;2064   #if !_FS_READONLY && _FS_MINIMIZE <= 2				/* Replace one of the read sectors with cached data if it contains a dirty sector */
;;;2065   #if _FS_TINY
;;;2066   				if (fp->fs->wflag && fp->fs->winsect - sect < cc)
;;;2067   					mem_cpy(rbuff + ((fp->fs->winsect - sect) * SS(fp->fs)), fp->fs->win, SS(fp->fs));
;;;2068   #else
;;;2069   				if ((fp->flag & FA__DIRTY) && fp->dsect - sect < cc)
;;;2070   					mem_cpy(rbuff + ((fp->dsect - sect) * SS(fp->fs)), fp->buf, SS(fp->fs));
;;;2071   #endif
;;;2072   #endif
;;;2073   				rcnt = SS(fp->fs) * cc;				/* Number of bytes transferred */
;;;2074   				continue;
;;;2075   			}
;;;2076   #if !_FS_TINY
;;;2077   #if !_FS_READONLY
;;;2078   			if (fp->flag & FA__DIRTY) {			/* Write sector I/O buffer if needed */
;;;2079   				if (disk_write(fp->fs->drv, fp->buf, fp->dsect, 1) != RES_OK)
;;;2080   					ABORT(fp->fs, FR_DISK_ERR);
;;;2081   				fp->flag &= ~FA__DIRTY;
;;;2082   			}
;;;2083   #endif
;;;2084   			if (fp->dsect != sect) {			/* Fill sector buffer with file data */
;;;2085   				if (disk_read(fp->fs->drv, fp->buf, sect, 1) != RES_OK)
;;;2086   					ABORT(fp->fs, FR_DISK_ERR);
;;;2087   			}
;;;2088   #endif
;;;2089   			fp->dsect = sect;
;;;2090   		}
;;;2091   		rcnt = SS(fp->fs) - (fp->fptr % SS(fp->fs));	/* Get partial sector data from sector buffer */
;;;2092   		if (rcnt > btr) rcnt = btr;
;;;2093   #if _FS_TINY
;;;2094   		if (move_window(fp->fs, fp->dsect))			/* Move sector window */
;;;2095   			ABORT(fp->fs, FR_DISK_ERR);
;;;2096   		mem_cpy(rbuff, &fp->fs->win[fp->fptr % SS(fp->fs)], rcnt);	/* Pick partial sector */
;;;2097   #else
;;;2098   		mem_cpy(rbuff, &fp->buf[fp->fptr % SS(fp->fs)], rcnt);	/* Pick partial sector */
;;;2099   #endif
;;;2100   	}
;;;2101   
;;;2102   	LEAVE_FF(fp->fs, FR_OK);
;;;2103   }
000024  b00b              ADD      sp,sp,#0x2c
000026  bdf0              POP      {r4-r7,pc}
                  |L25.40|
000028  79a0              LDRB     r0,[r4,#6]            ;2037
00002a  2180              MOVS     r1,#0x80              ;2037
00002c  4008              ANDS     r0,r0,r1              ;2037
00002e  2800              CMP      r0,#0                 ;2037
000030  d001              BEQ      |L25.54|
000032  2002              MOVS     r0,#2                 ;2038
000034  e7f6              B        |L25.36|
                  |L25.54|
000036  79a0              LDRB     r0,[r4,#6]            ;2039
000038  07c0              LSLS     r0,r0,#31             ;2039
00003a  0fc0              LSRS     r0,r0,#31             ;2039
00003c  2800              CMP      r0,#0                 ;2039
00003e  d101              BNE      |L25.68|
000040  2007              MOVS     r0,#7                 ;2040
000042  e7ef              B        |L25.36|
                  |L25.68|
000044  68a1              LDR      r1,[r4,#8]            ;2041
000046  68e0              LDR      r0,[r4,#0xc]          ;2041
000048  1a40              SUBS     r0,r0,r1              ;2041
00004a  9004              STR      r0,[sp,#0x10]         ;2041
00004c  9804              LDR      r0,[sp,#0x10]         ;2042
00004e  4285              CMP      r5,r0                 ;2042
000050  d900              BLS      |L25.84|
000052  9d04              LDR      r5,[sp,#0x10]         ;2042
                  |L25.84|
000054  e0c7              B        |L25.486|
                  |L25.86|
000056  8920              LDRH     r0,[r4,#8]            ;2046
000058  05c0              LSLS     r0,r0,#23             ;2046
00005a  0dc0              LSRS     r0,r0,#23             ;2046
00005c  2800              CMP      r0,#0                 ;2046
00005e  d172              BNE      |L25.326|
000060  68a0              LDR      r0,[r4,#8]            ;2047
000062  0a40              LSRS     r0,r0,#9              ;2047
000064  6821              LDR      r1,[r4,#0]            ;2047
000066  7889              LDRB     r1,[r1,#2]            ;2047
000068  1e49              SUBS     r1,r1,#1              ;2047
00006a  4008              ANDS     r0,r0,r1              ;2047
00006c  b2c0              UXTB     r0,r0                 ;2047
00006e  9002              STR      r0,[sp,#8]            ;2047
000070  9802              LDR      r0,[sp,#8]            ;2048
000072  2800              CMP      r0,#0                 ;2048
000074  d11e              BNE      |L25.180|
000076  68a0              LDR      r0,[r4,#8]            ;2049
000078  2800              CMP      r0,#0                 ;2049
00007a  d101              BNE      |L25.128|
00007c  6920              LDR      r0,[r4,#0x10]         ;2050
00007e  e003              B        |L25.136|
                  |L25.128|
000080  6961              LDR      r1,[r4,#0x14]         ;2050
000082  6820              LDR      r0,[r4,#0]            ;2050
000084  f7fffffe          BL       get_fat
                  |L25.136|
000088  9005              STR      r0,[sp,#0x14]         ;2050
00008a  9805              LDR      r0,[sp,#0x14]         ;2051
00008c  2801              CMP      r0,#1                 ;2051
00008e  d805              BHI      |L25.156|
000090  79a0              LDRB     r0,[r4,#6]            ;2051
000092  2180              MOVS     r1,#0x80              ;2051
000094  4308              ORRS     r0,r0,r1              ;2051
000096  71a0              STRB     r0,[r4,#6]            ;2051
000098  2002              MOVS     r0,#2                 ;2051
00009a  e7c3              B        |L25.36|
                  |L25.156|
00009c  9805              LDR      r0,[sp,#0x14]         ;2052
00009e  1c40              ADDS     r0,r0,#1              ;2052
0000a0  2800              CMP      r0,#0                 ;2052
0000a2  d105              BNE      |L25.176|
0000a4  79a0              LDRB     r0,[r4,#6]            ;2052
0000a6  2180              MOVS     r1,#0x80              ;2052
0000a8  4308              ORRS     r0,r0,r1              ;2052
0000aa  71a0              STRB     r0,[r4,#6]            ;2052
0000ac  2001              MOVS     r0,#1                 ;2052
0000ae  e7b9              B        |L25.36|
                  |L25.176|
0000b0  9805              LDR      r0,[sp,#0x14]         ;2053
0000b2  6160              STR      r0,[r4,#0x14]         ;2053
                  |L25.180|
0000b4  6961              LDR      r1,[r4,#0x14]         ;2055
0000b6  6820              LDR      r0,[r4,#0]            ;2055
0000b8  f7fffffe          BL       clust2sect
0000bc  4606              MOV      r6,r0                 ;2055
0000be  2e00              CMP      r6,#0                 ;2056
0000c0  d105              BNE      |L25.206|
0000c2  79a0              LDRB     r0,[r4,#6]            ;2056
0000c4  2180              MOVS     r1,#0x80              ;2056
0000c6  4308              ORRS     r0,r0,r1              ;2056
0000c8  71a0              STRB     r0,[r4,#6]            ;2056
0000ca  2002              MOVS     r0,#2                 ;2056
0000cc  e7aa              B        |L25.36|
                  |L25.206|
0000ce  9802              LDR      r0,[sp,#8]            ;2057
0000d0  1836              ADDS     r6,r6,r0              ;2057
0000d2  0a68              LSRS     r0,r5,#9              ;2058
0000d4  9003              STR      r0,[sp,#0xc]          ;2058
0000d6  9803              LDR      r0,[sp,#0xc]          ;2059
0000d8  2800              CMP      r0,#0                 ;2059
0000da  d035              BEQ      |L25.328|
0000dc  9903              LDR      r1,[sp,#0xc]          ;2060
0000de  9802              LDR      r0,[sp,#8]            ;2060
0000e0  1840              ADDS     r0,r0,r1              ;2060
0000e2  6821              LDR      r1,[r4,#0]            ;2060
0000e4  7889              LDRB     r1,[r1,#2]            ;2060
0000e6  4288              CMP      r0,r1                 ;2060
0000e8  d904              BLS      |L25.244|
0000ea  6820              LDR      r0,[r4,#0]            ;2061
0000ec  7881              LDRB     r1,[r0,#2]            ;2061
0000ee  9802              LDR      r0,[sp,#8]            ;2061
0000f0  1a08              SUBS     r0,r1,r0              ;2061
0000f2  9003              STR      r0,[sp,#0xc]          ;2061
                  |L25.244|
0000f4  9803              LDR      r0,[sp,#0xc]          ;2062
0000f6  b2c3              UXTB     r3,r0                 ;2062
0000f8  6820              LDR      r0,[r4,#0]            ;2062
0000fa  7840              LDRB     r0,[r0,#1]            ;2062
0000fc  4632              MOV      r2,r6                 ;2062
0000fe  9000              STR      r0,[sp,#0]            ;2062
000100  9901              LDR      r1,[sp,#4]            ;2062
000102  f7fffffe          BL       disk_read
000106  2800              CMP      r0,#0                 ;2062
000108  d005              BEQ      |L25.278|
00010a  79a0              LDRB     r0,[r4,#6]            ;2063
00010c  2180              MOVS     r1,#0x80              ;2063
00010e  4308              ORRS     r0,r0,r1              ;2063
000110  71a0              STRB     r0,[r4,#6]            ;2063
000112  2001              MOVS     r0,#1                 ;2063
000114  e786              B        |L25.36|
                  |L25.278|
000116  79a0              LDRB     r0,[r4,#6]            ;2069
000118  2140              MOVS     r1,#0x40              ;2069
00011a  4008              ANDS     r0,r0,r1              ;2069
00011c  2800              CMP      r0,#0                 ;2069
00011e  d00f              BEQ      |L25.320|
000120  69a0              LDR      r0,[r4,#0x18]         ;2069
000122  1b81              SUBS     r1,r0,r6              ;2069
000124  9803              LDR      r0,[sp,#0xc]          ;2069
000126  4281              CMP      r1,r0                 ;2069
000128  d20a              BCS      |L25.320|
00012a  69a1              LDR      r1,[r4,#0x18]         ;2070
00012c  1b89              SUBS     r1,r1,r6              ;2070
00012e  024a              LSLS     r2,r1,#9              ;2070
000130  9901              LDR      r1,[sp,#4]            ;2070
000132  1850              ADDS     r0,r2,r1              ;2070
000134  2201              MOVS     r2,#1                 ;2070
000136  0252              LSLS     r2,r2,#9              ;2070
000138  4621              MOV      r1,r4                 ;2070
00013a  3124              ADDS     r1,r1,#0x24           ;2070
00013c  f7fffffe          BL       mem_cpy
                  |L25.320|
000140  9803              LDR      r0,[sp,#0xc]          ;2073
000142  0247              LSLS     r7,r0,#9              ;2073
000144  e043              B        |L25.462|
                  |L25.326|
000146  e02e              B        |L25.422|
                  |L25.328|
000148  79a0              LDRB     r0,[r4,#6]            ;2078
00014a  2140              MOVS     r1,#0x40              ;2078
00014c  4008              ANDS     r0,r0,r1              ;2078
00014e  2800              CMP      r0,#0                 ;2078
000150  d014              BEQ      |L25.380|
000152  6820              LDR      r0,[r4,#0]            ;2079
000154  7840              LDRB     r0,[r0,#1]            ;2079
000156  69a2              LDR      r2,[r4,#0x18]         ;2079
000158  2301              MOVS     r3,#1                 ;2079
00015a  4621              MOV      r1,r4                 ;2079
00015c  3124              ADDS     r1,r1,#0x24           ;2079
00015e  9000              STR      r0,[sp,#0]            ;2079
000160  f7fffffe          BL       disk_write
000164  2800              CMP      r0,#0                 ;2079
000166  d005              BEQ      |L25.372|
000168  79a0              LDRB     r0,[r4,#6]            ;2080
00016a  2180              MOVS     r1,#0x80              ;2080
00016c  4308              ORRS     r0,r0,r1              ;2080
00016e  71a0              STRB     r0,[r4,#6]            ;2080
000170  2001              MOVS     r0,#1                 ;2080
000172  e757              B        |L25.36|
                  |L25.372|
000174  79a0              LDRB     r0,[r4,#6]            ;2081
000176  2140              MOVS     r1,#0x40              ;2081
000178  4388              BICS     r0,r0,r1              ;2081
00017a  71a0              STRB     r0,[r4,#6]            ;2081
                  |L25.380|
00017c  69a0              LDR      r0,[r4,#0x18]         ;2084
00017e  42b0              CMP      r0,r6                 ;2084
000180  d010              BEQ      |L25.420|
000182  6820              LDR      r0,[r4,#0]            ;2085
000184  7840              LDRB     r0,[r0,#1]            ;2085
000186  2301              MOVS     r3,#1                 ;2085
000188  4632              MOV      r2,r6                 ;2085
00018a  4621              MOV      r1,r4                 ;2085
00018c  3124              ADDS     r1,r1,#0x24           ;2085
00018e  9000              STR      r0,[sp,#0]            ;2085
000190  f7fffffe          BL       disk_read
000194  2800              CMP      r0,#0                 ;2085
000196  d005              BEQ      |L25.420|
000198  79a0              LDRB     r0,[r4,#6]            ;2086
00019a  2180              MOVS     r1,#0x80              ;2086
00019c  4308              ORRS     r0,r0,r1              ;2086
00019e  71a0              STRB     r0,[r4,#6]            ;2086
0001a0  2001              MOVS     r0,#1                 ;2086
0001a2  e73f              B        |L25.36|
                  |L25.420|
0001a4  61a6              STR      r6,[r4,#0x18]         ;2089
                  |L25.422|
0001a6  8920              LDRH     r0,[r4,#8]            ;2091
0001a8  05c0              LSLS     r0,r0,#23             ;2091
0001aa  0dc0              LSRS     r0,r0,#23             ;2091
0001ac  2101              MOVS     r1,#1                 ;2091
0001ae  0249              LSLS     r1,r1,#9              ;2091
0001b0  1a0f              SUBS     r7,r1,r0              ;2091
0001b2  42af              CMP      r7,r5                 ;2092
0001b4  d900              BLS      |L25.440|
0001b6  462f              MOV      r7,r5                 ;2092
                  |L25.440|
0001b8  8920              LDRH     r0,[r4,#8]            ;2098
0001ba  05c2              LSLS     r2,r0,#23             ;2098
0001bc  0dd2              LSRS     r2,r2,#23             ;2098
0001be  4620              MOV      r0,r4                 ;2098
0001c0  3024              ADDS     r0,r0,#0x24           ;2098
0001c2  1811              ADDS     r1,r2,r0              ;2098
0001c4  463a              MOV      r2,r7                 ;2098
0001c6  9801              LDR      r0,[sp,#4]            ;2098
0001c8  f7fffffe          BL       mem_cpy
0001cc  bf00              NOP                            ;2074
                  |L25.462|
0001ce  9801              LDR      r0,[sp,#4]            ;2045
0001d0  19c0              ADDS     r0,r0,r7              ;2045
0001d2  9001              STR      r0,[sp,#4]            ;2045
0001d4  68a0              LDR      r0,[r4,#8]            ;2045
0001d6  19c0              ADDS     r0,r0,r7              ;2045
0001d8  60a0              STR      r0,[r4,#8]            ;2045
0001da  980a              LDR      r0,[sp,#0x28]         ;2045
0001dc  6800              LDR      r0,[r0,#0]            ;2045
0001de  19c1              ADDS     r1,r0,r7              ;2045
0001e0  980a              LDR      r0,[sp,#0x28]         ;2045
0001e2  6001              STR      r1,[r0,#0]            ;2045
0001e4  1bed              SUBS     r5,r5,r7              ;2045
                  |L25.486|
0001e6  2d00              CMP      r5,#0                 ;2044
0001e8  d000              BEQ      |L25.492|
0001ea  e734              B        |L25.86|
                  |L25.492|
0001ec  2000              MOVS     r0,#0                 ;2102
0001ee  e719              B        |L25.36|
;;;2104   
                          ENDP


                          AREA ||i.f_readdir||, CODE, READONLY, ALIGN=2

                  f_readdir PROC
;;;2576   
;;;2577   FRESULT f_readdir (
000000  b5fe              PUSH     {r1-r7,lr}
;;;2578   	DIR *dj,			/* Pointer to the open directory object */
;;;2579   	FILINFO *fno		/* Pointer to file information to return */
;;;2580   )
;;;2581   {
000002  4604              MOV      r4,r0
000004  460e              MOV      r6,r1
;;;2582   	FRESULT res;
;;;2583   	DEF_NAMEBUF;
;;;2584   
;;;2585   
;;;2586   	res = validate(dj->fs, dj->id);			/* Check validity of the object */
000006  88a1              LDRH     r1,[r4,#4]
000008  6820              LDR      r0,[r4,#0]
00000a  f7fffffe          BL       validate
00000e  4605              MOV      r5,r0
;;;2587   	if (res == FR_OK) {
000010  2d00              CMP      r5,#0
000012  d124              BNE      |L26.94|
;;;2588   		if (!fno) {
000014  2e00              CMP      r6,#0
000016  d105              BNE      |L26.36|
;;;2589   			res = dir_sdi(dj, 0);
000018  2100              MOVS     r1,#0
00001a  4620              MOV      r0,r4
00001c  f7fffffe          BL       dir_sdi
000020  4605              MOV      r5,r0
000022  e01c              B        |L26.94|
                  |L26.36|
;;;2590   		} else {
;;;2591   			INIT_BUF(*dj);
000024  4668              MOV      r0,sp
000026  61a0              STR      r0,[r4,#0x18]
000028  480e              LDR      r0,|L26.100|
00002a  61e0              STR      r0,[r4,#0x1c]
;;;2592   			res = dir_read(dj);
00002c  4620              MOV      r0,r4
00002e  f7fffffe          BL       dir_read
000032  4605              MOV      r5,r0
;;;2593   			if (res == FR_NO_FILE) {
000034  2d04              CMP      r5,#4
000036  d102              BNE      |L26.62|
;;;2594   				dj->sect = 0;
000038  2000              MOVS     r0,#0
00003a  6120              STR      r0,[r4,#0x10]
;;;2595   				res = FR_OK;
00003c  2500              MOVS     r5,#0
                  |L26.62|
;;;2596   			}
;;;2597   			if (res == FR_OK) {				/* A valid entry is found */
00003e  2d00              CMP      r5,#0
000040  d10d              BNE      |L26.94|
;;;2598   				get_fileinfo(dj, fno);		/* Get the object information */
000042  4631              MOV      r1,r6
000044  4620              MOV      r0,r4
000046  f7fffffe          BL       get_fileinfo
;;;2599   				res = dir_next(dj, 0);		/* Increment index for next */
00004a  2100              MOVS     r1,#0
00004c  4620              MOV      r0,r4
00004e  f7fffffe          BL       dir_next
000052  4605              MOV      r5,r0
;;;2600   				if (res == FR_NO_FILE) {
000054  2d04              CMP      r5,#4
000056  d102              BNE      |L26.94|
;;;2601   					dj->sect = 0;
000058  2000              MOVS     r0,#0
00005a  6120              STR      r0,[r4,#0x10]
;;;2602   					res = FR_OK;
00005c  2500              MOVS     r5,#0
                  |L26.94|
;;;2603   				}
;;;2604   			}
;;;2605   			FREE_BUF();
;;;2606   		}
;;;2607   	}
;;;2608   
;;;2609   	LEAVE_FF(dj->fs, res);
00005e  4628              MOV      r0,r5
;;;2610   }
000060  bdfe              POP      {r1-r7,pc}
;;;2611   
                          ENDP

000062  0000              DCW      0x0000
                  |L26.100|
                          DCD      LfnBuf

                          AREA ||i.f_rename||, CODE, READONLY, ALIGN=2

                  f_rename PROC
;;;2991   
;;;2992   FRESULT f_rename (
000000  b5f3              PUSH     {r0,r1,r4-r7,lr}
;;;2993   	const TCHAR *path_old,	/* Pointer to the old name */
;;;2994   	const TCHAR *path_new	/* Pointer to the new name */
;;;2995   )
;;;2996   {
000002  b09b              SUB      sp,sp,#0x6c
;;;2997   	FRESULT res;
;;;2998   	DIR djo, djn;
;;;2999   	BYTE buf[21], *dir;
;;;3000   	DWORD dw;
;;;3001   	DEF_NAMEBUF;
;;;3002   
;;;3003   
;;;3004   	res = chk_mounted(&path_old, &djo.fs, 1);
000004  2201              MOVS     r2,#1
000006  a912              ADD      r1,sp,#0x48
000008  a81b              ADD      r0,sp,#0x6c
00000a  f7fffffe          BL       chk_mounted
00000e  4605              MOV      r5,r0
;;;3005   	if (res == FR_OK) {
000010  2d00              CMP      r5,#0
000012  d119              BNE      |L27.72|
;;;3006   		djn.fs = djo.fs;
000014  9812              LDR      r0,[sp,#0x48]
000016  9009              STR      r0,[sp,#0x24]
;;;3007   		INIT_BUF(djo);
000018  4668              MOV      r0,sp
00001a  9018              STR      r0,[sp,#0x60]
00001c  4849              LDR      r0,|L27.324|
00001e  9019              STR      r0,[sp,#0x64]
;;;3008   		res = follow_path(&djo, path_old);		/* Check old object */
000020  a812              ADD      r0,sp,#0x48
000022  991b              LDR      r1,[sp,#0x6c]
000024  f7fffffe          BL       follow_path
000028  4605              MOV      r5,r0
;;;3009   		if (_FS_RPATH && res == FR_OK && (djo.fn[NS] & NS_DOT))
00002a  2d00              CMP      r5,#0
00002c  d106              BNE      |L27.60|
00002e  9818              LDR      r0,[sp,#0x60]
000030  7ac0              LDRB     r0,[r0,#0xb]
000032  2120              MOVS     r1,#0x20
000034  4008              ANDS     r0,r0,r1
000036  2800              CMP      r0,#0
000038  d000              BEQ      |L27.60|
;;;3010   			res = FR_INVALID_NAME;
00003a  2506              MOVS     r5,#6
                  |L27.60|
;;;3011   #if _FS_SHARE
;;;3012   		if (res == FR_OK) res = chk_lock(&djo, 2);
;;;3013   #endif
;;;3014   		if (res == FR_OK) {						/* Old object is found */
00003c  2d00              CMP      r5,#0
00003e  d17d              BNE      |L27.316|
;;;3015   			if (!djo.dir) {						/* Is root dir? */
000040  9817              LDR      r0,[sp,#0x5c]
000042  2800              CMP      r0,#0
000044  d101              BNE      |L27.74|
;;;3016   				res = FR_NO_FILE;
000046  2504              MOVS     r5,#4
                  |L27.72|
000048  e078              B        |L27.316|
                  |L27.74|
;;;3017   			} else {
;;;3018   				mem_cpy(buf, djo.dir+DIR_Attr, 21);		/* Save the object information except for name */
00004a  9817              LDR      r0,[sp,#0x5c]
00004c  4601              MOV      r1,r0
00004e  310b              ADDS     r1,r1,#0xb
000050  2215              MOVS     r2,#0x15
000052  a803              ADD      r0,sp,#0xc
000054  f7fffffe          BL       mem_cpy
;;;3019   				mem_cpy(&djn, &djo, sizeof(DIR));		/* Check new object */
000058  2224              MOVS     r2,#0x24
00005a  a912              ADD      r1,sp,#0x48
00005c  a809              ADD      r0,sp,#0x24
00005e  f7fffffe          BL       mem_cpy
;;;3020   				res = follow_path(&djn, path_new);
000062  a809              ADD      r0,sp,#0x24
000064  991c              LDR      r1,[sp,#0x70]
000066  f7fffffe          BL       follow_path
00006a  4605              MOV      r5,r0
;;;3021   				if (res == FR_OK) res = FR_EXIST;			/* The new object name is already existing */
00006c  2d00              CMP      r5,#0
00006e  d100              BNE      |L27.114|
000070  2508              MOVS     r5,#8
                  |L27.114|
;;;3022   				if (res == FR_NO_FILE) { 					/* Is it a valid path and no name collision? */
000072  2d04              CMP      r5,#4
000074  d162              BNE      |L27.316|
;;;3023   /* Start critical section that any interruption or error can cause cross-link */
;;;3024   					res = dir_register(&djn);			/* Register the new entry */
000076  a809              ADD      r0,sp,#0x24
000078  f7fffffe          BL       dir_register
00007c  4605              MOV      r5,r0
;;;3025   					if (res == FR_OK) {
00007e  2d00              CMP      r5,#0
000080  d15c              BNE      |L27.316|
;;;3026   						dir = djn.dir;					/* Copy object information except for name */
000082  9c0e              LDR      r4,[sp,#0x38]
;;;3027   						mem_cpy(dir+13, buf+2, 19);
000084  2213              MOVS     r2,#0x13
000086  a903              ADD      r1,sp,#0xc
000088  3102              ADDS     r1,#2
00008a  4620              MOV      r0,r4
00008c  300d              ADDS     r0,r0,#0xd
00008e  f7fffffe          BL       mem_cpy
;;;3028   						dir[DIR_Attr] = buf[0] | AM_ARC;
000092  4668              MOV      r0,sp
000094  7b00              LDRB     r0,[r0,#0xc]
000096  2120              MOVS     r1,#0x20
000098  4308              ORRS     r0,r0,r1
00009a  72e0              STRB     r0,[r4,#0xb]
;;;3029   						djo.fs->wflag = 1;
00009c  2001              MOVS     r0,#1
00009e  9912              LDR      r1,[sp,#0x48]
0000a0  7108              STRB     r0,[r1,#4]
;;;3030   						if (djo.sclust != djn.sclust && (dir[DIR_Attr] & AM_DIR)) {		/* Update .. entry in the directory if needed */
0000a2  990b              LDR      r1,[sp,#0x2c]
0000a4  9814              LDR      r0,[sp,#0x50]
0000a6  4288              CMP      r0,r1
0000a8  d03c              BEQ      |L27.292|
0000aa  7ae0              LDRB     r0,[r4,#0xb]
0000ac  2110              MOVS     r1,#0x10
0000ae  4008              ANDS     r0,r0,r1
0000b0  2800              CMP      r0,#0
0000b2  d037              BEQ      |L27.292|
;;;3031   							dw = clust2sect(djn.fs, (DWORD)LD_WORD(dir+DIR_FstClusHI) | LD_WORD(dir+DIR_FstClusLO));
0000b4  7d62              LDRB     r2,[r4,#0x15]
0000b6  0212              LSLS     r2,r2,#8
0000b8  7d23              LDRB     r3,[r4,#0x14]
0000ba  431a              ORRS     r2,r2,r3
0000bc  7ee3              LDRB     r3,[r4,#0x1b]
0000be  021b              LSLS     r3,r3,#8
0000c0  7ea7              LDRB     r7,[r4,#0x1a]
0000c2  433b              ORRS     r3,r3,r7
0000c4  431a              ORRS     r2,r2,r3
0000c6  4611              MOV      r1,r2
0000c8  9809              LDR      r0,[sp,#0x24]
0000ca  f7fffffe          BL       clust2sect
0000ce  4606              MOV      r6,r0
;;;3032   							if (!dw) {
0000d0  2e00              CMP      r6,#0
0000d2  d101              BNE      |L27.216|
;;;3033   								res = FR_INT_ERR;
0000d4  2502              MOVS     r5,#2
0000d6  e025              B        |L27.292|
                  |L27.216|
;;;3034   							} else {
;;;3035   								res = move_window(djn.fs, dw);
0000d8  4631              MOV      r1,r6
0000da  9809              LDR      r0,[sp,#0x24]
0000dc  f7fffffe          BL       move_window
0000e0  4605              MOV      r5,r0
;;;3036   								dir = djn.fs->win+32;	/* .. entry */
0000e2  9809              LDR      r0,[sp,#0x24]
0000e4  4604              MOV      r4,r0
0000e6  3454              ADDS     r4,r4,#0x54
;;;3037   								if (res == FR_OK && dir[1] == '.') {
0000e8  2d00              CMP      r5,#0
0000ea  d11b              BNE      |L27.292|
0000ec  7860              LDRB     r0,[r4,#1]
0000ee  282e              CMP      r0,#0x2e
0000f0  d118              BNE      |L27.292|
;;;3038   									dw = (djn.fs->fs_type == FS_FAT32 && djn.sclust == djn.fs->dirbase) ? 0 : djn.sclust;
0000f2  9809              LDR      r0,[sp,#0x24]
0000f4  7800              LDRB     r0,[r0,#0]
0000f6  2803              CMP      r0,#3
0000f8  d106              BNE      |L27.264|
0000fa  9909              LDR      r1,[sp,#0x24]
0000fc  980b              LDR      r0,[sp,#0x2c]
0000fe  6a89              LDR      r1,[r1,#0x28]
000100  4288              CMP      r0,r1
000102  d101              BNE      |L27.264|
000104  2000              MOVS     r0,#0
000106  e000              B        |L27.266|
                  |L27.264|
000108  980b              LDR      r0,[sp,#0x2c]
                  |L27.266|
00010a  4606              MOV      r6,r0
;;;3039   									ST_WORD(dir+DIR_FstClusLO, dw);
00010c  76a6              STRB     r6,[r4,#0x1a]
00010e  0430              LSLS     r0,r6,#16
000110  0e01              LSRS     r1,r0,#24
000112  76e1              STRB     r1,[r4,#0x1b]
;;;3040   									ST_WORD(dir+DIR_FstClusHI, dw >> 16);
000114  0230              LSLS     r0,r6,#8
000116  0e00              LSRS     r0,r0,#24
000118  7520              STRB     r0,[r4,#0x14]
00011a  0e31              LSRS     r1,r6,#24
00011c  7561              STRB     r1,[r4,#0x15]
;;;3041   									djn.fs->wflag = 1;
00011e  2001              MOVS     r0,#1
000120  9909              LDR      r1,[sp,#0x24]
000122  7108              STRB     r0,[r1,#4]
                  |L27.292|
;;;3042   								}
;;;3043   							}
;;;3044   						}
;;;3045   						if (res == FR_OK) {
000124  2d00              CMP      r5,#0
000126  d109              BNE      |L27.316|
;;;3046   							res = dir_remove(&djo);		/* Remove old entry */
000128  a812              ADD      r0,sp,#0x48
00012a  f7fffffe          BL       dir_remove
00012e  4605              MOV      r5,r0
;;;3047   							if (res == FR_OK)
000130  2d00              CMP      r5,#0
000132  d103              BNE      |L27.316|
;;;3048   								res = sync(djo.fs);
000134  9812              LDR      r0,[sp,#0x48]
000136  f7fffffe          BL       sync
00013a  4605              MOV      r5,r0
                  |L27.316|
;;;3049   						}
;;;3050   					}
;;;3051   /* End critical section */
;;;3052   				}
;;;3053   			}
;;;3054   		}
;;;3055   		FREE_BUF();
;;;3056   	}
;;;3057   	LEAVE_FF(djo.fs, res);
00013c  4628              MOV      r0,r5
;;;3058   }
00013e  b01d              ADD      sp,sp,#0x74
000140  bdf0              POP      {r4-r7,pc}
;;;3059   
                          ENDP

000142  0000              DCW      0x0000
                  |L27.324|
                          DCD      LfnBuf

                          AREA ||i.f_stat||, CODE, READONLY, ALIGN=2

                  f_stat PROC
;;;2618   
;;;2619   FRESULT f_stat (
000000  b533              PUSH     {r0,r1,r4,r5,lr}
;;;2620   	const TCHAR *path,	/* Pointer to the file path */
;;;2621   	FILINFO *fno		/* Pointer to file information to return */
;;;2622   )
;;;2623   {
000002  b08d              SUB      sp,sp,#0x34
000004  460d              MOV      r5,r1
;;;2624   	FRESULT res;
;;;2625   	DIR dj;
;;;2626   	DEF_NAMEBUF;
;;;2627   
;;;2628   
;;;2629   	res = chk_mounted(&path, &dj.fs, 0);
000006  2200              MOVS     r2,#0
000008  a904              ADD      r1,sp,#0x10
00000a  a80d              ADD      r0,sp,#0x34
00000c  f7fffffe          BL       chk_mounted
000010  4604              MOV      r4,r0
;;;2630   	if (res == FR_OK) {
000012  2c00              CMP      r4,#0
000014  d113              BNE      |L28.62|
;;;2631   		INIT_BUF(dj);
000016  a801              ADD      r0,sp,#4
000018  900a              STR      r0,[sp,#0x28]
00001a  480a              LDR      r0,|L28.68|
00001c  900b              STR      r0,[sp,#0x2c]
;;;2632   		res = follow_path(&dj, path);	/* Follow the file path */
00001e  a804              ADD      r0,sp,#0x10
000020  990d              LDR      r1,[sp,#0x34]
000022  f7fffffe          BL       follow_path
000026  4604              MOV      r4,r0
;;;2633   		if (res == FR_OK) {				/* Follow completed */
000028  2c00              CMP      r4,#0
00002a  d108              BNE      |L28.62|
;;;2634   			if (dj.dir)		/* Found an object */
00002c  9809              LDR      r0,[sp,#0x24]
00002e  2800              CMP      r0,#0
000030  d004              BEQ      |L28.60|
;;;2635   				get_fileinfo(&dj, fno);
000032  4629              MOV      r1,r5
000034  a804              ADD      r0,sp,#0x10
000036  f7fffffe          BL       get_fileinfo
00003a  e000              B        |L28.62|
                  |L28.60|
;;;2636   			else			/* It is root dir */
;;;2637   				res = FR_INVALID_NAME;
00003c  2406              MOVS     r4,#6
                  |L28.62|
;;;2638   		}
;;;2639   		FREE_BUF();
;;;2640   	}
;;;2641   
;;;2642   	LEAVE_FF(dj.fs, res);
00003e  4620              MOV      r0,r4
;;;2643   }
000040  b00f              ADD      sp,sp,#0x3c
000042  bd30              POP      {r4,r5,pc}
;;;2644   
                          ENDP

                  |L28.68|
                          DCD      LfnBuf

                          AREA ||i.f_sync||, CODE, READONLY, ALIGN=1

                  f_sync PROC
;;;2226   
;;;2227   FRESULT f_sync (
000000  b5f8              PUSH     {r3-r7,lr}
;;;2228   	FIL *fp		/* Pointer to the file object */
;;;2229   )
;;;2230   {
000002  4604              MOV      r4,r0
;;;2231   	FRESULT res;
;;;2232   	DWORD tim;
;;;2233   	BYTE *dir;
;;;2234   
;;;2235   
;;;2236   	res = validate(fp->fs, fp->id);		/* Check validity of the object */
000004  88a1              LDRH     r1,[r4,#4]
000006  6820              LDR      r0,[r4,#0]
000008  f7fffffe          BL       validate
00000c  4607              MOV      r7,r0
;;;2237   	if (res == FR_OK) {
00000e  2f00              CMP      r7,#0
000010  d156              BNE      |L29.192|
;;;2238   		if (fp->flag & FA__WRITTEN) {	/* Has the file been written? */
000012  79a0              LDRB     r0,[r4,#6]
000014  2120              MOVS     r1,#0x20
000016  4008              ANDS     r0,r0,r1
000018  2800              CMP      r0,#0
00001a  d051              BEQ      |L29.192|
;;;2239   #if !_FS_TINY	/* Write-back dirty buffer */
;;;2240   			if (fp->flag & FA__DIRTY) {
00001c  79a0              LDRB     r0,[r4,#6]
00001e  2140              MOVS     r1,#0x40
000020  4008              ANDS     r0,r0,r1
000022  2800              CMP      r0,#0
000024  d00f              BEQ      |L29.70|
;;;2241   				if (disk_write(fp->fs->drv, fp->buf, fp->dsect, 1) != RES_OK)
000026  6821              LDR      r1,[r4,#0]
000028  7848              LDRB     r0,[r1,#1]
00002a  2301              MOVS     r3,#1
00002c  4621              MOV      r1,r4
00002e  3124              ADDS     r1,r1,#0x24
000030  69a2              LDR      r2,[r4,#0x18]
000032  f7fffffe          BL       disk_write
000036  2800              CMP      r0,#0
000038  d001              BEQ      |L29.62|
;;;2242   					LEAVE_FF(fp->fs, FR_DISK_ERR);
00003a  2001              MOVS     r0,#1
                  |L29.60|
;;;2243   				fp->flag &= ~FA__DIRTY;
;;;2244   			}
;;;2245   #endif
;;;2246   			/* Update the directory entry */
;;;2247   			res = move_window(fp->fs, fp->dir_sect);
;;;2248   			if (res == FR_OK) {
;;;2249   				dir = fp->dir_ptr;
;;;2250   				dir[DIR_Attr] |= AM_ARC;					/* Set archive bit */
;;;2251   				ST_DWORD(dir+DIR_FileSize, fp->fsize);		/* Update file size */
;;;2252   				ST_WORD(dir+DIR_FstClusLO, fp->org_clust);	/* Update start cluster */
;;;2253   				ST_WORD(dir+DIR_FstClusHI, fp->org_clust >> 16);
;;;2254   				tim = get_fattime();						/* Update updated time */
;;;2255   				ST_DWORD(dir+DIR_WrtTime, tim);
;;;2256   				fp->flag &= ~FA__WRITTEN;
;;;2257   				fp->fs->wflag = 1;
;;;2258   				res = sync(fp->fs);
;;;2259   			}
;;;2260   		}
;;;2261   	}
;;;2262   
;;;2263   	LEAVE_FF(fp->fs, res);
;;;2264   }
00003c  bdf8              POP      {r3-r7,pc}
                  |L29.62|
00003e  79a0              LDRB     r0,[r4,#6]            ;2243
000040  2140              MOVS     r1,#0x40              ;2243
000042  4388              BICS     r0,r0,r1              ;2243
000044  71a0              STRB     r0,[r4,#6]            ;2243
                  |L29.70|
000046  69e1              LDR      r1,[r4,#0x1c]         ;2247
000048  6820              LDR      r0,[r4,#0]            ;2247
00004a  f7fffffe          BL       move_window
00004e  4607              MOV      r7,r0                 ;2247
000050  2f00              CMP      r7,#0                 ;2248
000052  d135              BNE      |L29.192|
000054  6a25              LDR      r5,[r4,#0x20]         ;2249
000056  7ae8              LDRB     r0,[r5,#0xb]          ;2250
000058  2120              MOVS     r1,#0x20              ;2250
00005a  4308              ORRS     r0,r0,r1              ;2250
00005c  72e8              STRB     r0,[r5,#0xb]          ;2250
00005e  7b20              LDRB     r0,[r4,#0xc]          ;2251
000060  7728              STRB     r0,[r5,#0x1c]         ;2251
000062  89a0              LDRH     r0,[r4,#0xc]          ;2251
000064  0400              LSLS     r0,r0,#16             ;2251
000066  0e01              LSRS     r1,r0,#24             ;2251
000068  7769              STRB     r1,[r5,#0x1d]         ;2251
00006a  68e0              LDR      r0,[r4,#0xc]          ;2251
00006c  0200              LSLS     r0,r0,#8              ;2251
00006e  0e01              LSRS     r1,r0,#24             ;2251
000070  77a9              STRB     r1,[r5,#0x1e]         ;2251
000072  68e0              LDR      r0,[r4,#0xc]          ;2251
000074  0e01              LSRS     r1,r0,#24             ;2251
000076  77e9              STRB     r1,[r5,#0x1f]         ;2251
000078  7c20              LDRB     r0,[r4,#0x10]         ;2252
00007a  76a8              STRB     r0,[r5,#0x1a]         ;2252
00007c  8a20              LDRH     r0,[r4,#0x10]         ;2252
00007e  0400              LSLS     r0,r0,#16             ;2252
000080  0e01              LSRS     r1,r0,#24             ;2252
000082  76e9              STRB     r1,[r5,#0x1b]         ;2252
000084  6920              LDR      r0,[r4,#0x10]         ;2253
000086  0200              LSLS     r0,r0,#8              ;2253
000088  0e00              LSRS     r0,r0,#24             ;2253
00008a  7528              STRB     r0,[r5,#0x14]         ;2253
00008c  6920              LDR      r0,[r4,#0x10]         ;2253
00008e  0e01              LSRS     r1,r0,#24             ;2253
000090  7569              STRB     r1,[r5,#0x15]         ;2253
000092  f7fffffe          BL       get_fattime
000096  4606              MOV      r6,r0                 ;2254
000098  75ae              STRB     r6,[r5,#0x16]         ;2255
00009a  0430              LSLS     r0,r6,#16             ;2255
00009c  0e01              LSRS     r1,r0,#24             ;2255
00009e  75e9              STRB     r1,[r5,#0x17]         ;2255
0000a0  0230              LSLS     r0,r6,#8              ;2255
0000a2  0e01              LSRS     r1,r0,#24             ;2255
0000a4  7629              STRB     r1,[r5,#0x18]         ;2255
0000a6  0e31              LSRS     r1,r6,#24             ;2255
0000a8  7669              STRB     r1,[r5,#0x19]         ;2255
0000aa  79a0              LDRB     r0,[r4,#6]            ;2256
0000ac  2120              MOVS     r1,#0x20              ;2256
0000ae  4388              BICS     r0,r0,r1              ;2256
0000b0  71a0              STRB     r0,[r4,#6]            ;2256
0000b2  2001              MOVS     r0,#1                 ;2257
0000b4  6821              LDR      r1,[r4,#0]            ;2257
0000b6  7108              STRB     r0,[r1,#4]            ;2257
0000b8  6820              LDR      r0,[r4,#0]            ;2258
0000ba  f7fffffe          BL       sync
0000be  4607              MOV      r7,r0                 ;2258
                  |L29.192|
0000c0  4638              MOV      r0,r7                 ;2263
0000c2  e7bb              B        |L29.60|
;;;2265   
                          ENDP


                          AREA ||i.f_truncate||, CODE, READONLY, ALIGN=2

                  f_truncate PROC
;;;2716   
;;;2717   FRESULT f_truncate (
000000  b570              PUSH     {r4-r6,lr}
;;;2718   	FIL *fp		/* Pointer to the file object */
;;;2719   )
;;;2720   {
000002  4604              MOV      r4,r0
;;;2721   	FRESULT res;
;;;2722   	DWORD ncl;
;;;2723   
;;;2724   
;;;2725   	res = validate(fp->fs, fp->id);		/* Check validity of the object */
000004  88a1              LDRH     r1,[r4,#4]
000006  6820              LDR      r0,[r4,#0]
000008  f7fffffe          BL       validate
00000c  4605              MOV      r5,r0
;;;2726   	if (res == FR_OK) {
00000e  2d00              CMP      r5,#0
000010  d10c              BNE      |L30.44|
;;;2727   		if (fp->flag & FA__ERROR) {			/* Check abort flag */
000012  79a0              LDRB     r0,[r4,#6]
000014  2180              MOVS     r1,#0x80
000016  4008              ANDS     r0,r0,r1
000018  2800              CMP      r0,#0
00001a  d001              BEQ      |L30.32|
;;;2728   			res = FR_INT_ERR;
00001c  2502              MOVS     r5,#2
00001e  e005              B        |L30.44|
                  |L30.32|
;;;2729   		} else {
;;;2730   			if (!(fp->flag & FA_WRITE))		/* Check access mode */
000020  79a0              LDRB     r0,[r4,#6]
000022  2102              MOVS     r1,#2
000024  4008              ANDS     r0,r0,r1
000026  2800              CMP      r0,#0
000028  d100              BNE      |L30.44|
;;;2731   				res = FR_DENIED;
00002a  2507              MOVS     r5,#7
                  |L30.44|
;;;2732   		}
;;;2733   	}
;;;2734   	if (res == FR_OK) {
00002c  2d00              CMP      r5,#0
00002e  d13a              BNE      |L30.166|
;;;2735   		if (fp->fsize > fp->fptr) {
000030  68a1              LDR      r1,[r4,#8]
000032  68e0              LDR      r0,[r4,#0xc]
000034  4288              CMP      r0,r1
000036  d930              BLS      |L30.154|
;;;2736   			fp->fsize = fp->fptr;	/* Set file size to current R/W point */
000038  68a0              LDR      r0,[r4,#8]
00003a  60e0              STR      r0,[r4,#0xc]
;;;2737   			fp->flag |= FA__WRITTEN;
00003c  79a0              LDRB     r0,[r4,#6]
00003e  2120              MOVS     r1,#0x20
000040  4308              ORRS     r0,r0,r1
000042  71a0              STRB     r0,[r4,#6]
;;;2738   			if (fp->fptr == 0) {	/* When set file size to zero, remove entire cluster chain */
000044  68a0              LDR      r0,[r4,#8]
000046  2800              CMP      r0,#0
000048  d107              BNE      |L30.90|
;;;2739   				res = remove_chain(fp->fs, fp->org_clust);
00004a  6921              LDR      r1,[r4,#0x10]
00004c  6820              LDR      r0,[r4,#0]
00004e  f7fffffe          BL       remove_chain
000052  4605              MOV      r5,r0
;;;2740   				fp->org_clust = 0;
000054  2000              MOVS     r0,#0
000056  6120              STR      r0,[r4,#0x10]
000058  e01f              B        |L30.154|
                  |L30.90|
;;;2741   			} else {				/* When truncate a part of the file, remove remaining clusters */
;;;2742   				ncl = get_fat(fp->fs, fp->curr_clust);
00005a  6961              LDR      r1,[r4,#0x14]
00005c  6820              LDR      r0,[r4,#0]
00005e  f7fffffe          BL       get_fat
000062  4606              MOV      r6,r0
;;;2743   				res = FR_OK;
000064  2500              MOVS     r5,#0
;;;2744   				if (ncl == 0xFFFFFFFF) res = FR_DISK_ERR;
000066  1c70              ADDS     r0,r6,#1
000068  2800              CMP      r0,#0
00006a  d100              BNE      |L30.110|
00006c  2501              MOVS     r5,#1
                  |L30.110|
;;;2745   				if (ncl == 1) res = FR_INT_ERR;
00006e  2e01              CMP      r6,#1
000070  d100              BNE      |L30.116|
000072  2502              MOVS     r5,#2
                  |L30.116|
;;;2746   				if (res == FR_OK && ncl < fp->fs->n_fatent) {
000074  2d00              CMP      r5,#0
000076  d110              BNE      |L30.154|
000078  6820              LDR      r0,[r4,#0]
00007a  69c0              LDR      r0,[r0,#0x1c]
00007c  42b0              CMP      r0,r6
00007e  d90c              BLS      |L30.154|
;;;2747   					res = put_fat(fp->fs, fp->curr_clust, 0x0FFFFFFF);
000080  4a0a              LDR      r2,|L30.172|
000082  6961              LDR      r1,[r4,#0x14]
000084  6820              LDR      r0,[r4,#0]
000086  f7fffffe          BL       put_fat
00008a  4605              MOV      r5,r0
;;;2748   					if (res == FR_OK) res = remove_chain(fp->fs, ncl);
00008c  2d00              CMP      r5,#0
00008e  d104              BNE      |L30.154|
000090  4631              MOV      r1,r6
000092  6820              LDR      r0,[r4,#0]
000094  f7fffffe          BL       remove_chain
000098  4605              MOV      r5,r0
                  |L30.154|
;;;2749   				}
;;;2750   			}
;;;2751   		}
;;;2752   		if (res != FR_OK) fp->flag |= FA__ERROR;
00009a  2d00              CMP      r5,#0
00009c  d003              BEQ      |L30.166|
00009e  79a0              LDRB     r0,[r4,#6]
0000a0  2180              MOVS     r1,#0x80
0000a2  4308              ORRS     r0,r0,r1
0000a4  71a0              STRB     r0,[r4,#6]
                  |L30.166|
;;;2753   	}
;;;2754   
;;;2755   	LEAVE_FF(fp->fs, res);
0000a6  4628              MOV      r0,r5
;;;2756   }
0000a8  bd70              POP      {r4-r6,pc}
;;;2757   
                          ENDP

0000aa  0000              DCW      0x0000
                  |L30.172|
                          DCD      0x0fffffff

                          AREA ||i.f_unlink||, CODE, READONLY, ALIGN=2

                  f_unlink PROC
;;;2764   
;;;2765   FRESULT f_unlink (
000000  b571              PUSH     {r0,r4-r6,lr}
;;;2766   	const TCHAR *path		/* Pointer to the file or directory path */
;;;2767   )
;;;2768   {
000002  b095              SUB      sp,sp,#0x54
;;;2769   	FRESULT res;
;;;2770   	DIR dj, sdj;
;;;2771   	BYTE *dir;
;;;2772   	DWORD dclst;
;;;2773   	DEF_NAMEBUF;
;;;2774   
;;;2775   
;;;2776   	res = chk_mounted(&path, &dj.fs, 1);
000004  2201              MOVS     r2,#1
000006  a90c              ADD      r1,sp,#0x30
000008  a815              ADD      r0,sp,#0x54
00000a  f7fffffe          BL       chk_mounted
00000e  4604              MOV      r4,r0
;;;2777   	if (res == FR_OK) {
000010  2c00              CMP      r4,#0
000012  d163              BNE      |L31.220|
;;;2778   		INIT_BUF(dj);
000014  4668              MOV      r0,sp
000016  9012              STR      r0,[sp,#0x48]
000018  4832              LDR      r0,|L31.228|
00001a  9013              STR      r0,[sp,#0x4c]
;;;2779   		res = follow_path(&dj, path);		/* Follow the file path */
00001c  a80c              ADD      r0,sp,#0x30
00001e  9915              LDR      r1,[sp,#0x54]
000020  f7fffffe          BL       follow_path
000024  4604              MOV      r4,r0
;;;2780   		if (_FS_RPATH && res == FR_OK && (dj.fn[NS] & NS_DOT))
000026  2c00              CMP      r4,#0
000028  d106              BNE      |L31.56|
00002a  9812              LDR      r0,[sp,#0x48]
00002c  7ac0              LDRB     r0,[r0,#0xb]
00002e  2120              MOVS     r1,#0x20
000030  4008              ANDS     r0,r0,r1
000032  2800              CMP      r0,#0
000034  d000              BEQ      |L31.56|
;;;2781   			res = FR_INVALID_NAME;			/* Cannot remove dot entry */
000036  2406              MOVS     r4,#6
                  |L31.56|
;;;2782   #if _FS_SHARE
;;;2783   		if (res == FR_OK) res = chk_lock(&dj, 2);	/* Cannot remove open file */
;;;2784   #endif
;;;2785   		if (res == FR_OK) {					/* The object is accessible */
000038  2c00              CMP      r4,#0
00003a  d14f              BNE      |L31.220|
;;;2786   			dir = dj.dir;
00003c  9d11              LDR      r5,[sp,#0x44]
;;;2787   			if (!dir) {
00003e  2d00              CMP      r5,#0
000040  d101              BNE      |L31.70|
;;;2788   				res = FR_INVALID_NAME;		/* Cannot remove the start directory */
000042  2406              MOVS     r4,#6
000044  e005              B        |L31.82|
                  |L31.70|
;;;2789   			} else {
;;;2790   				if (dir[DIR_Attr] & AM_RDO)
000046  7ae8              LDRB     r0,[r5,#0xb]
000048  07c0              LSLS     r0,r0,#31
00004a  0fc0              LSRS     r0,r0,#31
00004c  2800              CMP      r0,#0
00004e  d000              BEQ      |L31.82|
;;;2791   					res = FR_DENIED;		/* Cannot remove R/O object */
000050  2407              MOVS     r4,#7
                  |L31.82|
;;;2792   			}
;;;2793   			dclst = ((DWORD)LD_WORD(dir+DIR_FstClusHI) << 16) | LD_WORD(dir+DIR_FstClusLO);
000052  7d68              LDRB     r0,[r5,#0x15]
000054  0200              LSLS     r0,r0,#8
000056  7d29              LDRB     r1,[r5,#0x14]
000058  4308              ORRS     r0,r0,r1
00005a  0406              LSLS     r6,r0,#16
00005c  7ee9              LDRB     r1,[r5,#0x1b]
00005e  0209              LSLS     r1,r1,#8
000060  7eaa              LDRB     r2,[r5,#0x1a]
000062  4311              ORRS     r1,r1,r2
000064  430e              ORRS     r6,r6,r1
;;;2794   			if (res == FR_OK && (dir[DIR_Attr] & AM_DIR)) {	/* Is it a sub-dir? */
000066  2c00              CMP      r4,#0
000068  d123              BNE      |L31.178|
00006a  7ae8              LDRB     r0,[r5,#0xb]
00006c  2110              MOVS     r1,#0x10
00006e  4008              ANDS     r0,r0,r1
000070  2800              CMP      r0,#0
000072  d01e              BEQ      |L31.178|
;;;2795   				if (dclst < 2) {
000074  2e02              CMP      r6,#2
000076  d201              BCS      |L31.124|
;;;2796   					res = FR_INT_ERR;
000078  2402              MOVS     r4,#2
00007a  e01a              B        |L31.178|
                  |L31.124|
;;;2797   				} else {
;;;2798   					mem_cpy(&sdj, &dj, sizeof(DIR));	/* Check if the sub-dir is empty or not */
00007c  2224              MOVS     r2,#0x24
00007e  a90c              ADD      r1,sp,#0x30
000080  a803              ADD      r0,sp,#0xc
000082  f7fffffe          BL       mem_cpy
;;;2799   					sdj.sclust = dclst;
000086  9605              STR      r6,[sp,#0x14]
;;;2800   					res = dir_sdi(&sdj, 2);		/* Exclude dot entries */
000088  2102              MOVS     r1,#2
00008a  a803              ADD      r0,sp,#0xc
00008c  f7fffffe          BL       dir_sdi
000090  4604              MOV      r4,r0
;;;2801   					if (res == FR_OK) {
000092  2c00              CMP      r4,#0
000094  d10d              BNE      |L31.178|
;;;2802   						res = dir_read(&sdj);
000096  a803              ADD      r0,sp,#0xc
000098  f7fffffe          BL       dir_read
00009c  4604              MOV      r4,r0
;;;2803   						if (res == FR_OK			/* Not empty dir */
00009e  2c00              CMP      r4,#0
0000a0  d003              BEQ      |L31.170|
;;;2804   #if _FS_RPATH
;;;2805   						|| dclst == sdj.fs->cdir	/* Current dir */
0000a2  9803              LDR      r0,[sp,#0xc]
0000a4  6980              LDR      r0,[r0,#0x18]
0000a6  42b0              CMP      r0,r6
0000a8  d100              BNE      |L31.172|
                  |L31.170|
;;;2806   #endif
;;;2807   						) res = FR_DENIED;
0000aa  2407              MOVS     r4,#7
                  |L31.172|
;;;2808   						if (res == FR_NO_FILE) res = FR_OK;	/* Empty */
0000ac  2c04              CMP      r4,#4
0000ae  d100              BNE      |L31.178|
0000b0  2400              MOVS     r4,#0
                  |L31.178|
;;;2809   					}
;;;2810   				}
;;;2811   			}
;;;2812   			if (res == FR_OK) {
0000b2  2c00              CMP      r4,#0
0000b4  d112              BNE      |L31.220|
;;;2813   				res = dir_remove(&dj);		/* Remove the directory entry */
0000b6  a80c              ADD      r0,sp,#0x30
0000b8  f7fffffe          BL       dir_remove
0000bc  4604              MOV      r4,r0
;;;2814   				if (res == FR_OK) {
0000be  2c00              CMP      r4,#0
0000c0  d10c              BNE      |L31.220|
;;;2815   					if (dclst)				/* Remove the cluster chain if exist */
0000c2  2e00              CMP      r6,#0
0000c4  d004              BEQ      |L31.208|
;;;2816   						res = remove_chain(dj.fs, dclst);
0000c6  4631              MOV      r1,r6
0000c8  980c              LDR      r0,[sp,#0x30]
0000ca  f7fffffe          BL       remove_chain
0000ce  4604              MOV      r4,r0
                  |L31.208|
;;;2817   					if (res == FR_OK) res = sync(dj.fs);
0000d0  2c00              CMP      r4,#0
0000d2  d103              BNE      |L31.220|
0000d4  980c              LDR      r0,[sp,#0x30]
0000d6  f7fffffe          BL       sync
0000da  4604              MOV      r4,r0
                  |L31.220|
;;;2818   				}
;;;2819   			}
;;;2820   		}
;;;2821   		FREE_BUF();
;;;2822   	}
;;;2823   	LEAVE_FF(dj.fs, res);
0000dc  4620              MOV      r0,r4
;;;2824   }
0000de  b016              ADD      sp,sp,#0x58
0000e0  bd70              POP      {r4-r6,pc}
;;;2825   
                          ENDP

0000e2  0000              DCW      0x0000
                  |L31.228|
                          DCD      LfnBuf

                          AREA ||i.f_utime||, CODE, READONLY, ALIGN=2

                  f_utime PROC
;;;2950   
;;;2951   FRESULT f_utime (
000000  b573              PUSH     {r0,r1,r4-r6,lr}
;;;2952   	const TCHAR *path,	/* Pointer to the file/directory name */
;;;2953   	const FILINFO *fno	/* Pointer to the time stamp to be set */
;;;2954   )
;;;2955   {
000002  b08c              SUB      sp,sp,#0x30
000004  460d              MOV      r5,r1
;;;2956   	FRESULT res;
;;;2957   	DIR dj;
;;;2958   	BYTE *dir;
;;;2959   	DEF_NAMEBUF;
;;;2960   
;;;2961   
;;;2962   	res = chk_mounted(&path, &dj.fs, 1);
000006  2201              MOVS     r2,#1
000008  a903              ADD      r1,sp,#0xc
00000a  a80c              ADD      r0,sp,#0x30
00000c  f7fffffe          BL       chk_mounted
000010  4606              MOV      r6,r0
;;;2963   	if (res == FR_OK) {
000012  2e00              CMP      r6,#0
000014  d129              BNE      |L32.106|
;;;2964   		INIT_BUF(dj);
000016  4668              MOV      r0,sp
000018  9009              STR      r0,[sp,#0x24]
00001a  4815              LDR      r0,|L32.112|
00001c  900a              STR      r0,[sp,#0x28]
;;;2965   		res = follow_path(&dj, path);	/* Follow the file path */
00001e  a803              ADD      r0,sp,#0xc
000020  990c              LDR      r1,[sp,#0x30]
000022  f7fffffe          BL       follow_path
000026  4606              MOV      r6,r0
;;;2966   		FREE_BUF();
;;;2967   		if (_FS_RPATH && res == FR_OK && (dj.fn[NS] & NS_DOT))
000028  2e00              CMP      r6,#0
00002a  d106              BNE      |L32.58|
00002c  9809              LDR      r0,[sp,#0x24]
00002e  7ac0              LDRB     r0,[r0,#0xb]
000030  2120              MOVS     r1,#0x20
000032  4008              ANDS     r0,r0,r1
000034  2800              CMP      r0,#0
000036  d000              BEQ      |L32.58|
;;;2968   			res = FR_INVALID_NAME;
000038  2606              MOVS     r6,#6
                  |L32.58|
;;;2969   		if (res == FR_OK) {
00003a  2e00              CMP      r6,#0
00003c  d115              BNE      |L32.106|
;;;2970   			dir = dj.dir;
00003e  9c08              LDR      r4,[sp,#0x20]
;;;2971   			if (!dir) {					/* Root directory */
000040  2c00              CMP      r4,#0
000042  d101              BNE      |L32.72|
;;;2972   				res = FR_INVALID_NAME;
000044  2606              MOVS     r6,#6
000046  e010              B        |L32.106|
                  |L32.72|
;;;2973   			} else {					/* File or sub-directory */
;;;2974   				ST_WORD(dir+DIR_WrtTime, fno->ftime);
000048  79a8              LDRB     r0,[r5,#6]
00004a  75a0              STRB     r0,[r4,#0x16]
00004c  88e8              LDRH     r0,[r5,#6]
00004e  1201              ASRS     r1,r0,#8
000050  75e1              STRB     r1,[r4,#0x17]
;;;2975   				ST_WORD(dir+DIR_WrtDate, fno->fdate);
000052  7928              LDRB     r0,[r5,#4]
000054  7620              STRB     r0,[r4,#0x18]
000056  88a8              LDRH     r0,[r5,#4]
000058  1201              ASRS     r1,r0,#8
00005a  7661              STRB     r1,[r4,#0x19]
;;;2976   				dj.fs->wflag = 1;
00005c  2001              MOVS     r0,#1
00005e  9903              LDR      r1,[sp,#0xc]
000060  7108              STRB     r0,[r1,#4]
;;;2977   				res = sync(dj.fs);
000062  9803              LDR      r0,[sp,#0xc]
000064  f7fffffe          BL       sync
000068  4606              MOV      r6,r0
                  |L32.106|
;;;2978   			}
;;;2979   		}
;;;2980   	}
;;;2981   
;;;2982   	LEAVE_FF(dj.fs, res);
00006a  4630              MOV      r0,r6
;;;2983   }
00006c  b00e              ADD      sp,sp,#0x38
00006e  bd70              POP      {r4-r6,pc}
;;;2984   
                          ENDP

                  |L32.112|
                          DCD      LfnBuf

                          AREA ||i.f_write||, CODE, READONLY, ALIGN=1

                  f_write PROC
;;;2112   
;;;2113   FRESULT f_write (
000000  b5ff              PUSH     {r0-r7,lr}
;;;2114   	FIL *fp,			/* Pointer to the file object */
;;;2115   	const void *buff,	/* Pointer to the data to be written */
;;;2116   	UINT btw,			/* Number of bytes to write */
;;;2117   	UINT *bw			/* Pointer to number of bytes written */
;;;2118   )
;;;2119   {
000002  b087              SUB      sp,sp,#0x1c
000004  4604              MOV      r4,r0
000006  4615              MOV      r5,r2
;;;2120   	FRESULT res;
;;;2121   	DWORD clst, sect;
;;;2122   	UINT wcnt, cc;
;;;2123   	const BYTE *wbuff = buff;
000008  9808              LDR      r0,[sp,#0x20]
00000a  9003              STR      r0,[sp,#0xc]
;;;2124   	BYTE csect;
;;;2125   
;;;2126   
;;;2127   	*bw = 0;	/* Initialize byte counter */
00000c  2100              MOVS     r1,#0
00000e  980a              LDR      r0,[sp,#0x28]
000010  6001              STR      r1,[r0,#0]
;;;2128   
;;;2129   	res = validate(fp->fs, fp->id);					/* Check validity of the object */
000012  88a1              LDRH     r1,[r4,#4]
000014  6820              LDR      r0,[r4,#0]
000016  f7fffffe          BL       validate
00001a  9006              STR      r0,[sp,#0x18]
;;;2130   	if (res != FR_OK) LEAVE_FF(fp->fs, res);
00001c  9806              LDR      r0,[sp,#0x18]
00001e  2800              CMP      r0,#0
000020  d002              BEQ      |L33.40|
000022  9806              LDR      r0,[sp,#0x18]
                  |L33.36|
;;;2131   	if (fp->flag & FA__ERROR)						/* Check abort flag */
;;;2132   		LEAVE_FF(fp->fs, FR_INT_ERR);
;;;2133   	if (!(fp->flag & FA_WRITE))						/* Check access mode */
;;;2134   		LEAVE_FF(fp->fs, FR_DENIED);
;;;2135   	if (fp->fsize + btw < fp->fsize) btw = 0;		/* File size cannot reach 4GB */
;;;2136   
;;;2137   	for ( ;  btw;									/* Repeat until all data transferred */
;;;2138   		wbuff += wcnt, fp->fptr += wcnt, *bw += wcnt, btw -= wcnt) {
;;;2139   		if ((fp->fptr % SS(fp->fs)) == 0) {			/* On the sector boundary? */
;;;2140   			csect = (BYTE)(fp->fptr / SS(fp->fs) & (fp->fs->csize - 1));	/* Sector offset in the cluster */
;;;2141   			if (!csect) {							/* On the cluster boundary? */
;;;2142   				if (fp->fptr == 0) {				/* On the top of the file? */
;;;2143   					clst = fp->org_clust;			/* Follow from the origin */
;;;2144   					if (clst == 0)					/* When there is no cluster chain, */
;;;2145   						fp->org_clust = clst = create_chain(fp->fs, 0);	/* Create a new cluster chain */
;;;2146   				} else {							/* Middle or end of the file */
;;;2147   					clst = create_chain(fp->fs, fp->curr_clust);			/* Follow or stretch cluster chain */
;;;2148   				}
;;;2149   				if (clst == 0) break;				/* Could not allocate a new cluster (disk full) */
;;;2150   				if (clst == 1) ABORT(fp->fs, FR_INT_ERR);
;;;2151   				if (clst == 0xFFFFFFFF) ABORT(fp->fs, FR_DISK_ERR);
;;;2152   				fp->curr_clust = clst;				/* Update current cluster */
;;;2153   			}
;;;2154   #if _FS_TINY
;;;2155   			if (fp->fs->winsect == fp->dsect && move_window(fp->fs, 0))	/* Write back data buffer prior to following direct transfer */
;;;2156   				ABORT(fp->fs, FR_DISK_ERR);
;;;2157   #else
;;;2158   			if (fp->flag & FA__DIRTY) {		/* Write back data buffer prior to following direct transfer */
;;;2159   				if (disk_write(fp->fs->drv, fp->buf, fp->dsect, 1) != RES_OK)
;;;2160   					ABORT(fp->fs, FR_DISK_ERR);
;;;2161   				fp->flag &= ~FA__DIRTY;
;;;2162   			}
;;;2163   #endif
;;;2164   			sect = clust2sect(fp->fs, fp->curr_clust);	/* Get current sector */
;;;2165   			if (!sect) ABORT(fp->fs, FR_INT_ERR);
;;;2166   			sect += csect;
;;;2167   			cc = btw / SS(fp->fs);					/* When remaining bytes >= sector size, */
;;;2168   			if (cc) {								/* Write maximum contiguous sectors directly */
;;;2169   				if (csect + cc > fp->fs->csize)		/* Clip at cluster boundary */
;;;2170   					cc = fp->fs->csize - csect;
;;;2171   				if (disk_write(fp->fs->drv, wbuff, sect, (BYTE)cc) != RES_OK)
;;;2172   					ABORT(fp->fs, FR_DISK_ERR);
;;;2173   #if _FS_TINY
;;;2174   				if (fp->fs->winsect - sect < cc) {	/* Refill sector cache if it gets dirty by the direct write */
;;;2175   					mem_cpy(fp->fs->win, wbuff + ((fp->fs->winsect - sect) * SS(fp->fs)), SS(fp->fs));
;;;2176   					fp->fs->wflag = 0;
;;;2177   				}
;;;2178   #else
;;;2179   				if (fp->dsect - sect < cc) {		/* Refill sector cache if it gets dirty by the direct write */
;;;2180   					mem_cpy(fp->buf, wbuff + ((fp->dsect - sect) * SS(fp->fs)), SS(fp->fs));
;;;2181   					fp->flag &= ~FA__DIRTY;
;;;2182   				}
;;;2183   #endif
;;;2184   				wcnt = SS(fp->fs) * cc;				/* Number of bytes transferred */
;;;2185   				continue;
;;;2186   			}
;;;2187   #if _FS_TINY
;;;2188   			if (fp->fptr >= fp->fsize) {			/* Avoid silly buffer filling at growing edge */
;;;2189   				if (move_window(fp->fs, 0)) ABORT(fp->fs, FR_DISK_ERR);
;;;2190   				fp->fs->winsect = sect;
;;;2191   			}
;;;2192   #else
;;;2193   			if (fp->dsect != sect) {				/* Fill sector buffer with file data */
;;;2194   				if (fp->fptr < fp->fsize &&
;;;2195   					disk_read(fp->fs->drv, fp->buf, sect, 1) != RES_OK)
;;;2196   						ABORT(fp->fs, FR_DISK_ERR);
;;;2197   			}
;;;2198   #endif
;;;2199   			fp->dsect = sect;
;;;2200   		}
;;;2201   		wcnt = SS(fp->fs) - (fp->fptr % SS(fp->fs));	/* Put partial sector into file I/O buffer */
;;;2202   		if (wcnt > btw) wcnt = btw;
;;;2203   #if _FS_TINY
;;;2204   		if (move_window(fp->fs, fp->dsect))			/* Move sector window */
;;;2205   			ABORT(fp->fs, FR_DISK_ERR);
;;;2206   		mem_cpy(&fp->fs->win[fp->fptr % SS(fp->fs)], wbuff, wcnt);	/* Fit partial sector */
;;;2207   		fp->fs->wflag = 1;
;;;2208   #else
;;;2209   		mem_cpy(&fp->buf[fp->fptr % SS(fp->fs)], wbuff, wcnt);	/* Fit partial sector */
;;;2210   		fp->flag |= FA__DIRTY;
;;;2211   #endif
;;;2212   	}
;;;2213   
;;;2214   	if (fp->fptr > fp->fsize) fp->fsize = fp->fptr;	/* Update file size if needed */
;;;2215   	fp->flag |= FA__WRITTEN;						/* Set file changed flag */
;;;2216   
;;;2217   	LEAVE_FF(fp->fs, FR_OK);
;;;2218   }
000024  b00b              ADD      sp,sp,#0x2c
000026  bdf0              POP      {r4-r7,pc}
                  |L33.40|
000028  79a0              LDRB     r0,[r4,#6]            ;2131
00002a  2180              MOVS     r1,#0x80              ;2131
00002c  4008              ANDS     r0,r0,r1              ;2131
00002e  2800              CMP      r0,#0                 ;2131
000030  d001              BEQ      |L33.54|
000032  2002              MOVS     r0,#2                 ;2132
000034  e7f6              B        |L33.36|
                  |L33.54|
000036  79a0              LDRB     r0,[r4,#6]            ;2133
000038  2102              MOVS     r1,#2                 ;2133
00003a  4008              ANDS     r0,r0,r1              ;2133
00003c  2800              CMP      r0,#0                 ;2133
00003e  d101              BNE      |L33.68|
000040  2007              MOVS     r0,#7                 ;2134
000042  e7ef              B        |L33.36|
                  |L33.68|
000044  68e0              LDR      r0,[r4,#0xc]          ;2135
000046  1940              ADDS     r0,r0,r5              ;2135
000048  68e1              LDR      r1,[r4,#0xc]          ;2135
00004a  4288              CMP      r0,r1                 ;2135
00004c  d200              BCS      |L33.80|
00004e  2500              MOVS     r5,#0                 ;2135
                  |L33.80|
000050  e0dd              B        |L33.526|
                  |L33.82|
000052  8920              LDRH     r0,[r4,#8]            ;2139
000054  05c0              LSLS     r0,r0,#23             ;2139
000056  0dc0              LSRS     r0,r0,#23             ;2139
000058  2800              CMP      r0,#0                 ;2139
00005a  d17d              BNE      |L33.344|
00005c  68a0              LDR      r0,[r4,#8]            ;2140
00005e  0a40              LSRS     r0,r0,#9              ;2140
000060  6821              LDR      r1,[r4,#0]            ;2140
000062  7889              LDRB     r1,[r1,#2]            ;2140
000064  1e49              SUBS     r1,r1,#1              ;2140
000066  4008              ANDS     r0,r0,r1              ;2140
000068  b2c0              UXTB     r0,r0                 ;2140
00006a  9002              STR      r0,[sp,#8]            ;2140
00006c  9802              LDR      r0,[sp,#8]            ;2141
00006e  2800              CMP      r0,#0                 ;2141
000070  d12c              BNE      |L33.204|
000072  68a0              LDR      r0,[r4,#8]            ;2142
000074  2800              CMP      r0,#0                 ;2142
000076  d10b              BNE      |L33.144|
000078  6920              LDR      r0,[r4,#0x10]         ;2143
00007a  9005              STR      r0,[sp,#0x14]         ;2143
00007c  9805              LDR      r0,[sp,#0x14]         ;2144
00007e  2800              CMP      r0,#0                 ;2144
000080  d10b              BNE      |L33.154|
000082  2100              MOVS     r1,#0                 ;2145
000084  6820              LDR      r0,[r4,#0]            ;2145
000086  f7fffffe          BL       create_chain
00008a  9005              STR      r0,[sp,#0x14]         ;2145
00008c  6120              STR      r0,[r4,#0x10]         ;2145
00008e  e004              B        |L33.154|
                  |L33.144|
000090  6961              LDR      r1,[r4,#0x14]         ;2147
000092  6820              LDR      r0,[r4,#0]            ;2147
000094  f7fffffe          BL       create_chain
000098  9005              STR      r0,[sp,#0x14]         ;2147
                  |L33.154|
00009a  9805              LDR      r0,[sp,#0x14]         ;2149
00009c  2800              CMP      r0,#0                 ;2149
00009e  d100              BNE      |L33.162|
0000a0  e0b8              B        |L33.532|
                  |L33.162|
0000a2  9805              LDR      r0,[sp,#0x14]         ;2150
0000a4  2801              CMP      r0,#1                 ;2150
0000a6  d105              BNE      |L33.180|
0000a8  79a0              LDRB     r0,[r4,#6]            ;2150
0000aa  2180              MOVS     r1,#0x80              ;2150
0000ac  4308              ORRS     r0,r0,r1              ;2150
0000ae  71a0              STRB     r0,[r4,#6]            ;2150
0000b0  2002              MOVS     r0,#2                 ;2150
0000b2  e7b7              B        |L33.36|
                  |L33.180|
0000b4  9805              LDR      r0,[sp,#0x14]         ;2151
0000b6  1c40              ADDS     r0,r0,#1              ;2151
0000b8  2800              CMP      r0,#0                 ;2151
0000ba  d105              BNE      |L33.200|
0000bc  79a0              LDRB     r0,[r4,#6]            ;2151
0000be  2180              MOVS     r1,#0x80              ;2151
0000c0  4308              ORRS     r0,r0,r1              ;2151
0000c2  71a0              STRB     r0,[r4,#6]            ;2151
0000c4  2001              MOVS     r0,#1                 ;2151
0000c6  e7ad              B        |L33.36|
                  |L33.200|
0000c8  9805              LDR      r0,[sp,#0x14]         ;2152
0000ca  6160              STR      r0,[r4,#0x14]         ;2152
                  |L33.204|
0000cc  79a0              LDRB     r0,[r4,#6]            ;2158
0000ce  2140              MOVS     r1,#0x40              ;2158
0000d0  4008              ANDS     r0,r0,r1              ;2158
0000d2  2800              CMP      r0,#0                 ;2158
0000d4  d014              BEQ      |L33.256|
0000d6  6820              LDR      r0,[r4,#0]            ;2159
0000d8  7840              LDRB     r0,[r0,#1]            ;2159
0000da  69a2              LDR      r2,[r4,#0x18]         ;2159
0000dc  2301              MOVS     r3,#1                 ;2159
0000de  4621              MOV      r1,r4                 ;2159
0000e0  3124              ADDS     r1,r1,#0x24           ;2159
0000e2  9001              STR      r0,[sp,#4]            ;2159
0000e4  f7fffffe          BL       disk_write
0000e8  2800              CMP      r0,#0                 ;2159
0000ea  d005              BEQ      |L33.248|
0000ec  79a0              LDRB     r0,[r4,#6]            ;2160
0000ee  2180              MOVS     r1,#0x80              ;2160
0000f0  4308              ORRS     r0,r0,r1              ;2160
0000f2  71a0              STRB     r0,[r4,#6]            ;2160
0000f4  2001              MOVS     r0,#1                 ;2160
0000f6  e795              B        |L33.36|
                  |L33.248|
0000f8  79a0              LDRB     r0,[r4,#6]            ;2161
0000fa  2140              MOVS     r1,#0x40              ;2161
0000fc  4388              BICS     r0,r0,r1              ;2161
0000fe  71a0              STRB     r0,[r4,#6]            ;2161
                  |L33.256|
000100  6961              LDR      r1,[r4,#0x14]         ;2164
000102  6820              LDR      r0,[r4,#0]            ;2164
000104  f7fffffe          BL       clust2sect
000108  4606              MOV      r6,r0                 ;2164
00010a  2e00              CMP      r6,#0                 ;2165
00010c  d105              BNE      |L33.282|
00010e  79a0              LDRB     r0,[r4,#6]            ;2165
000110  2180              MOVS     r1,#0x80              ;2165
000112  4308              ORRS     r0,r0,r1              ;2165
000114  71a0              STRB     r0,[r4,#6]            ;2165
000116  2002              MOVS     r0,#2                 ;2165
000118  e784              B        |L33.36|
                  |L33.282|
00011a  9802              LDR      r0,[sp,#8]            ;2166
00011c  1836              ADDS     r6,r6,r0              ;2166
00011e  0a68              LSRS     r0,r5,#9              ;2167
000120  9004              STR      r0,[sp,#0x10]         ;2167
000122  9804              LDR      r0,[sp,#0x10]         ;2168
000124  2800              CMP      r0,#0                 ;2168
000126  d035              BEQ      |L33.404|
000128  9904              LDR      r1,[sp,#0x10]         ;2169
00012a  9802              LDR      r0,[sp,#8]            ;2169
00012c  1840              ADDS     r0,r0,r1              ;2169
00012e  6821              LDR      r1,[r4,#0]            ;2169
000130  7889              LDRB     r1,[r1,#2]            ;2169
000132  4288              CMP      r0,r1                 ;2169
000134  d904              BLS      |L33.320|
000136  6820              LDR      r0,[r4,#0]            ;2170
000138  7881              LDRB     r1,[r0,#2]            ;2170
00013a  9802              LDR      r0,[sp,#8]            ;2170
00013c  1a08              SUBS     r0,r1,r0              ;2170
00013e  9004              STR      r0,[sp,#0x10]         ;2170
                  |L33.320|
000140  9804              LDR      r0,[sp,#0x10]         ;2171
000142  b2c3              UXTB     r3,r0                 ;2171
000144  6820              LDR      r0,[r4,#0]            ;2171
000146  7840              LDRB     r0,[r0,#1]            ;2171
000148  4632              MOV      r2,r6                 ;2171
00014a  9001              STR      r0,[sp,#4]            ;2171
00014c  9903              LDR      r1,[sp,#0xc]          ;2171
00014e  f7fffffe          BL       disk_write
000152  2800              CMP      r0,#0                 ;2171
000154  d007              BEQ      |L33.358|
000156  e000              B        |L33.346|
                  |L33.344|
000158  e035              B        |L33.454|
                  |L33.346|
00015a  79a0              LDRB     r0,[r4,#6]            ;2172
00015c  2180              MOVS     r1,#0x80              ;2172
00015e  4308              ORRS     r0,r0,r1              ;2172
000160  71a0              STRB     r0,[r4,#6]            ;2172
000162  2001              MOVS     r0,#1                 ;2172
000164  e75e              B        |L33.36|
                  |L33.358|
000166  69a0              LDR      r0,[r4,#0x18]         ;2179
000168  1b81              SUBS     r1,r0,r6              ;2179
00016a  9804              LDR      r0,[sp,#0x10]         ;2179
00016c  4281              CMP      r1,r0                 ;2179
00016e  d20e              BCS      |L33.398|
000170  69a0              LDR      r0,[r4,#0x18]         ;2180
000172  1b80              SUBS     r0,r0,r6              ;2180
000174  0242              LSLS     r2,r0,#9              ;2180
000176  9803              LDR      r0,[sp,#0xc]          ;2180
000178  1811              ADDS     r1,r2,r0              ;2180
00017a  2201              MOVS     r2,#1                 ;2180
00017c  0252              LSLS     r2,r2,#9              ;2180
00017e  4620              MOV      r0,r4                 ;2180
000180  3024              ADDS     r0,r0,#0x24           ;2180
000182  f7fffffe          BL       mem_cpy
000186  79a0              LDRB     r0,[r4,#6]            ;2181
000188  2140              MOVS     r1,#0x40              ;2181
00018a  4388              BICS     r0,r0,r1              ;2181
00018c  71a0              STRB     r0,[r4,#6]            ;2181
                  |L33.398|
00018e  9804              LDR      r0,[sp,#0x10]         ;2184
000190  0247              LSLS     r7,r0,#9              ;2184
000192  e030              B        |L33.502|
                  |L33.404|
000194  69a0              LDR      r0,[r4,#0x18]         ;2193
000196  42b0              CMP      r0,r6                 ;2193
000198  d014              BEQ      |L33.452|
00019a  68e1              LDR      r1,[r4,#0xc]          ;2194
00019c  68a0              LDR      r0,[r4,#8]            ;2194
00019e  4288              CMP      r0,r1                 ;2194
0001a0  d210              BCS      |L33.452|
0001a2  6820              LDR      r0,[r4,#0]            ;2195
0001a4  7840              LDRB     r0,[r0,#1]            ;2195
0001a6  2301              MOVS     r3,#1                 ;2195
0001a8  4632              MOV      r2,r6                 ;2195
0001aa  4621              MOV      r1,r4                 ;2195
0001ac  3124              ADDS     r1,r1,#0x24           ;2195
0001ae  9001              STR      r0,[sp,#4]            ;2195
0001b0  f7fffffe          BL       disk_read
0001b4  2800              CMP      r0,#0                 ;2195
0001b6  d005              BEQ      |L33.452|
0001b8  79a0              LDRB     r0,[r4,#6]            ;2196
0001ba  2180              MOVS     r1,#0x80              ;2196
0001bc  4308              ORRS     r0,r0,r1              ;2196
0001be  71a0              STRB     r0,[r4,#6]            ;2196
0001c0  2001              MOVS     r0,#1                 ;2196
0001c2  e72f              B        |L33.36|
                  |L33.452|
0001c4  61a6              STR      r6,[r4,#0x18]         ;2199
                  |L33.454|
0001c6  8920              LDRH     r0,[r4,#8]            ;2201
0001c8  05c0              LSLS     r0,r0,#23             ;2201
0001ca  0dc0              LSRS     r0,r0,#23             ;2201
0001cc  2101              MOVS     r1,#1                 ;2201
0001ce  0249              LSLS     r1,r1,#9              ;2201
0001d0  1a0f              SUBS     r7,r1,r0              ;2201
0001d2  42af              CMP      r7,r5                 ;2202
0001d4  d900              BLS      |L33.472|
0001d6  462f              MOV      r7,r5                 ;2202
                  |L33.472|
0001d8  8921              LDRH     r1,[r4,#8]            ;2209
0001da  05ca              LSLS     r2,r1,#23             ;2209
0001dc  0dd2              LSRS     r2,r2,#23             ;2209
0001de  4621              MOV      r1,r4                 ;2209
0001e0  3124              ADDS     r1,r1,#0x24           ;2209
0001e2  1850              ADDS     r0,r2,r1              ;2209
0001e4  463a              MOV      r2,r7                 ;2209
0001e6  9903              LDR      r1,[sp,#0xc]          ;2209
0001e8  f7fffffe          BL       mem_cpy
0001ec  79a0              LDRB     r0,[r4,#6]            ;2210
0001ee  2140              MOVS     r1,#0x40              ;2210
0001f0  4308              ORRS     r0,r0,r1              ;2210
0001f2  71a0              STRB     r0,[r4,#6]            ;2210
0001f4  bf00              NOP                            ;2185
                  |L33.502|
0001f6  9803              LDR      r0,[sp,#0xc]          ;2138
0001f8  19c0              ADDS     r0,r0,r7              ;2138
0001fa  9003              STR      r0,[sp,#0xc]          ;2138
0001fc  68a0              LDR      r0,[r4,#8]            ;2138
0001fe  19c0              ADDS     r0,r0,r7              ;2138
000200  60a0              STR      r0,[r4,#8]            ;2138
000202  980a              LDR      r0,[sp,#0x28]         ;2138
000204  6800              LDR      r0,[r0,#0]            ;2138
000206  19c1              ADDS     r1,r0,r7              ;2138
000208  980a              LDR      r0,[sp,#0x28]         ;2138
00020a  6001              STR      r1,[r0,#0]            ;2138
00020c  1bed              SUBS     r5,r5,r7              ;2138
                  |L33.526|
00020e  2d00              CMP      r5,#0                 ;2137
000210  d000              BEQ      |L33.532|
000212  e71e              B        |L33.82|
                  |L33.532|
000214  bf00              NOP                            ;2149
000216  68e1              LDR      r1,[r4,#0xc]          ;2214
000218  68a0              LDR      r0,[r4,#8]            ;2214
00021a  4288              CMP      r0,r1                 ;2214
00021c  d901              BLS      |L33.546|
00021e  68a0              LDR      r0,[r4,#8]            ;2214
000220  60e0              STR      r0,[r4,#0xc]          ;2214
                  |L33.546|
000222  79a0              LDRB     r0,[r4,#6]            ;2215
000224  2120              MOVS     r1,#0x20              ;2215
000226  4308              ORRS     r0,r0,r1              ;2215
000228  71a0              STRB     r0,[r4,#6]            ;2215
00022a  2000              MOVS     r0,#0                 ;2217
00022c  e6fa              B        |L33.36|
;;;2219   
                          ENDP


                          AREA ||i.fit_lfn||, CODE, READONLY, ALIGN=2

                  fit_lfn PROC
;;;894    static
;;;895    void fit_lfn (
000000  b5ff              PUSH     {r0-r7,lr}
;;;896    	const WCHAR *lfnbuf,	/* Pointer to the LFN buffer */
;;;897    	BYTE *dir,				/* Pointer to the directory entry */
;;;898    	BYTE ord,				/* LFN order (1-20) */
;;;899    	BYTE sum				/* SFN sum */
;;;900    )
;;;901    {
000002  4604              MOV      r4,r0
;;;902    	int i, s;
;;;903    	WCHAR wc;
;;;904    
;;;905    
;;;906    	dir[LDIR_Chksum] = sum;			/* Set check sum */
000004  9e03              LDR      r6,[sp,#0xc]
000006  734e              STRB     r6,[r1,#0xd]
;;;907    	dir[LDIR_Attr] = AM_LFN;		/* Set attribute. LFN entry */
000008  260f              MOVS     r6,#0xf
00000a  72ce              STRB     r6,[r1,#0xb]
;;;908    	dir[LDIR_Type] = 0;
00000c  2600              MOVS     r6,#0
00000e  730e              STRB     r6,[r1,#0xc]
;;;909    	ST_WORD(dir+LDIR_FstClusLO, 0);
000010  768e              STRB     r6,[r1,#0x1a]
000012  76ce              STRB     r6,[r1,#0x1b]
;;;910    
;;;911    	i = (ord - 1) * 13;				/* Get offset in the LFN buffer */
000014  1e56              SUBS     r6,r2,#1
000016  270d              MOVS     r7,#0xd
000018  437e              MULS     r6,r7,r6
00001a  4635              MOV      r5,r6
;;;912    	s = wc = 0;
00001c  2600              MOVS     r6,#0
00001e  4630              MOV      r0,r6
000020  4633              MOV      r3,r6
;;;913    	do {
000022  bf00              NOP      
                  |L34.36|
;;;914    		if (wc != 0xFFFF) wc = lfnbuf[i++];	/* Get an effective char */
000024  4e10              LDR      r6,|L34.104|
000026  42b0              CMP      r0,r6
000028  d003              BEQ      |L34.50|
00002a  462e              MOV      r6,r5
00002c  1c6d              ADDS     r5,r5,#1
00002e  0076              LSLS     r6,r6,#1
000030  5ba0              LDRH     r0,[r4,r6]
                  |L34.50|
;;;915    		ST_WORD(dir+LfnOfs[s], wc);	/* Put it */
000032  4f0e              LDR      r7,|L34.108|
000034  5cff              LDRB     r7,[r7,r3]
000036  55c8              STRB     r0,[r1,r7]
000038  1206              ASRS     r6,r0,#8
00003a  4f0c              LDR      r7,|L34.108|
00003c  5cff              LDRB     r7,[r7,r3]
00003e  187f              ADDS     r7,r7,r1
000040  707e              STRB     r6,[r7,#1]
;;;916    		if (!wc) wc = 0xFFFF;		/* Padding chars following last char */
000042  2800              CMP      r0,#0
000044  d100              BNE      |L34.72|
000046  4808              LDR      r0,|L34.104|
                  |L34.72|
;;;917    	} while (++s < 13);
000048  1c5e              ADDS     r6,r3,#1
00004a  4633              MOV      r3,r6
00004c  2e0d              CMP      r6,#0xd
00004e  dbe9              BLT      |L34.36|
;;;918    	if (wc == 0xFFFF || !lfnbuf[i]) ord |= 0x40;	/* Bottom LFN part is the start of LFN sequence */
000050  4e05              LDR      r6,|L34.104|
000052  42b0              CMP      r0,r6
000054  d003              BEQ      |L34.94|
000056  006e              LSLS     r6,r5,#1
000058  5ba6              LDRH     r6,[r4,r6]
00005a  2e00              CMP      r6,#0
00005c  d101              BNE      |L34.98|
                  |L34.94|
00005e  2640              MOVS     r6,#0x40
000060  4332              ORRS     r2,r2,r6
                  |L34.98|
;;;919    	dir[LDIR_Ord] = ord;			/* Set the LFN order */
000062  700a              STRB     r2,[r1,#0]
;;;920    }
000064  bdff              POP      {r0-r7,pc}
;;;921    
                          ENDP

000066  0000              DCW      0x0000
                  |L34.104|
                          DCD      0x0000ffff
                  |L34.108|
                          DCD      LfnOfs

                          AREA ||i.follow_path||, CODE, READONLY, ALIGN=1

                  follow_path PROC
;;;1565   static
;;;1566   FRESULT follow_path (	/* FR_OK(0): successful, !=0: error code */
000000  b5f3              PUSH     {r0,r1,r4-r7,lr}
;;;1567   	DIR *dj,			/* Directory object to return last directory and found object */
;;;1568   	const TCHAR *path	/* Full-path string to find a file or directory */
;;;1569   )
;;;1570   {
000002  b081              SUB      sp,sp,#4
000004  4604              MOV      r4,r0
;;;1571   	FRESULT res;
;;;1572   	BYTE *dir, ns;
;;;1573   
;;;1574   
;;;1575   #if _FS_RPATH
;;;1576   	if (*path == '/' || *path == '\\') { /* There is a heading separator */
000006  9802              LDR      r0,[sp,#8]
000008  7800              LDRB     r0,[r0,#0]
00000a  282f              CMP      r0,#0x2f
00000c  d003              BEQ      |L35.22|
00000e  9802              LDR      r0,[sp,#8]
000010  7800              LDRB     r0,[r0,#0]
000012  285c              CMP      r0,#0x5c
000014  d105              BNE      |L35.34|
                  |L35.22|
;;;1577   		path++;	dj->sclust = 0;		/* Strip it and start from the root dir */
000016  9802              LDR      r0,[sp,#8]
000018  1c40              ADDS     r0,r0,#1
00001a  9002              STR      r0,[sp,#8]
00001c  2000              MOVS     r0,#0
00001e  60a0              STR      r0,[r4,#8]
000020  e002              B        |L35.40|
                  |L35.34|
;;;1578   	} else {							/* No heading separator */
;;;1579   		dj->sclust = dj->fs->cdir;	/* Start from the current dir */
000022  6820              LDR      r0,[r4,#0]
000024  6980              LDR      r0,[r0,#0x18]
000026  60a0              STR      r0,[r4,#8]
                  |L35.40|
;;;1580   	}
;;;1581   #else
;;;1582   	if (*path == '/' || *path == '\\')	/* Strip heading separator if exist */
;;;1583   		path++;
;;;1584   	dj->sclust = 0;						/* Start from the root dir */
;;;1585   #endif
;;;1586   
;;;1587   	if ((UINT)*path < ' ') {			/* Nul path means the start directory itself */
000028  9802              LDR      r0,[sp,#8]
00002a  7800              LDRB     r0,[r0,#0]
00002c  2820              CMP      r0,#0x20
00002e  d207              BCS      |L35.64|
;;;1588   		res = dir_sdi(dj, 0);
000030  2100              MOVS     r1,#0
000032  4620              MOV      r0,r4
000034  f7fffffe          BL       dir_sdi
000038  4606              MOV      r6,r0
;;;1589   		dj->dir = 0;
00003a  2000              MOVS     r0,#0
00003c  6160              STR      r0,[r4,#0x14]
00003e  e040              B        |L35.194|
                  |L35.64|
;;;1590   
;;;1591   	} else {							/* Follow path */
;;;1592   		for (;;) {
000040  bf00              NOP      
                  |L35.66|
;;;1593   			res = create_name(dj, &path);	/* Get a segment */
000042  a902              ADD      r1,sp,#8
000044  4620              MOV      r0,r4
000046  f7fffffe          BL       create_name
00004a  4606              MOV      r6,r0
;;;1594   			if (res != FR_OK) break;
00004c  2e00              CMP      r6,#0
00004e  d000              BEQ      |L35.82|
000050  e036              B        |L35.192|
                  |L35.82|
;;;1595   			res = dir_find(dj);				/* Find it */
000052  4620              MOV      r0,r4
000054  f7fffffe          BL       dir_find
000058  4606              MOV      r6,r0
;;;1596   			ns = *(dj->fn+NS);
00005a  69a0              LDR      r0,[r4,#0x18]
00005c  7ac7              LDRB     r7,[r0,#0xb]
;;;1597   			if (res != FR_OK) {				/* Failed to find the object */
00005e  2e00              CMP      r6,#0
000060  d015              BEQ      |L35.142|
;;;1598   				if (res != FR_NO_FILE) break;	/* Abort if any hard error occured */
000062  2e04              CMP      r6,#4
000064  d000              BEQ      |L35.104|
000066  e02b              B        |L35.192|
                  |L35.104|
;;;1599   				/* Object not found */
;;;1600   				if (_FS_RPATH && (ns & NS_DOT)) {	/* If dot entry is not exit */
000068  2020              MOVS     r0,#0x20
00006a  4038              ANDS     r0,r0,r7
00006c  2800              CMP      r0,#0
00006e  d008              BEQ      |L35.130|
;;;1601   					dj->sclust = 0; dj->dir = 0;	/* It is the root dir */
000070  2000              MOVS     r0,#0
000072  60a0              STR      r0,[r4,#8]
000074  6160              STR      r0,[r4,#0x14]
;;;1602   					res = FR_OK;
000076  2600              MOVS     r6,#0
;;;1603   					if (!(ns & NS_LAST)) continue;
000078  2004              MOVS     r0,#4
00007a  4038              ANDS     r0,r0,r7
00007c  2800              CMP      r0,#0
00007e  d105              BNE      |L35.140|
000080  e7df              B        |L35.66|
                  |L35.130|
;;;1604   				} else {							/* Could not find the object */
;;;1605   					if (!(ns & NS_LAST)) res = FR_NO_PATH;
000082  2004              MOVS     r0,#4
000084  4038              ANDS     r0,r0,r7
000086  2800              CMP      r0,#0
000088  d100              BNE      |L35.140|
00008a  2605              MOVS     r6,#5
                  |L35.140|
;;;1606   				}
;;;1607   				break;
00008c  e018              B        |L35.192|
                  |L35.142|
;;;1608   			}
;;;1609   			if (ns & NS_LAST) break;			/* Last segment match. Function completed. */
00008e  2004              MOVS     r0,#4
000090  4038              ANDS     r0,r0,r7
000092  2800              CMP      r0,#0
000094  d000              BEQ      |L35.152|
000096  e013              B        |L35.192|
                  |L35.152|
;;;1610   			dir = dj->dir;						/* There is next segment. Follow the sub directory */
000098  6965              LDR      r5,[r4,#0x14]
;;;1611   			if (!(dir[DIR_Attr] & AM_DIR)) {	/* Cannot follow because it is a file */
00009a  7ae8              LDRB     r0,[r5,#0xb]
00009c  2110              MOVS     r1,#0x10
00009e  4008              ANDS     r0,r0,r1
0000a0  2800              CMP      r0,#0
0000a2  d101              BNE      |L35.168|
;;;1612   				res = FR_NO_PATH; break;
0000a4  2605              MOVS     r6,#5
0000a6  e00b              B        |L35.192|
                  |L35.168|
;;;1613   			}
;;;1614   			dj->sclust = ((DWORD)LD_WORD(dir+DIR_FstClusHI) << 16) | LD_WORD(dir+DIR_FstClusLO);
0000a8  7d68              LDRB     r0,[r5,#0x15]
0000aa  0200              LSLS     r0,r0,#8
0000ac  7d29              LDRB     r1,[r5,#0x14]
0000ae  4308              ORRS     r0,r0,r1
0000b0  0400              LSLS     r0,r0,#16
0000b2  7ee9              LDRB     r1,[r5,#0x1b]
0000b4  0209              LSLS     r1,r1,#8
0000b6  7eaa              LDRB     r2,[r5,#0x1a]
0000b8  4311              ORRS     r1,r1,r2
0000ba  4308              ORRS     r0,r0,r1
0000bc  60a0              STR      r0,[r4,#8]
0000be  e7c0              B        |L35.66|
                  |L35.192|
0000c0  bf00              NOP                            ;1594
                  |L35.194|
;;;1615   		}
;;;1616   	}
;;;1617   
;;;1618   	return res;
0000c2  4630              MOV      r0,r6
;;;1619   }
0000c4  bdfe              POP      {r1-r7,pc}
;;;1620   
                          ENDP


                          AREA ||i.gen_numname||, CODE, READONLY, ALIGN=1

                  gen_numname PROC
;;;930    #if _USE_LFN
;;;931    void gen_numname (
000000  b5ff              PUSH     {r0-r7,lr}
;;;932    	BYTE *dst,			/* Pointer to generated SFN */
;;;933    	const BYTE *src,	/* Pointer to source SFN to be modified */
;;;934    	const WCHAR *lfn,	/* Pointer to LFN */
;;;935    	WORD seq			/* Sequence number */
;;;936    )
;;;937    {
000002  b083              SUB      sp,sp,#0xc
000004  4617              MOV      r7,r2
000006  461c              MOV      r4,r3
;;;938    	BYTE ns[8], c;
;;;939    	int i, j;
;;;940    
;;;941    
;;;942    	mem_cpy(dst, src, 11);
000008  220b              MOVS     r2,#0xb
00000a  9904              LDR      r1,[sp,#0x10]
00000c  9803              LDR      r0,[sp,#0xc]
00000e  f7fffffe          BL       mem_cpy
;;;943    
;;;944    	if (seq > 5) {	/* On many collisions, generate a hash number instead of sequential number */
000012  2c05              CMP      r4,#5
000014  dd0a              BLE      |L36.44|
;;;945    		do seq = (seq >> 1) + (seq << 15) + (WORD)*lfn++; while (*lfn);
000016  bf00              NOP      
                  |L36.24|
000018  1060              ASRS     r0,r4,#1
00001a  03e1              LSLS     r1,r4,#15
00001c  1841              ADDS     r1,r0,r1
00001e  883a              LDRH     r2,[r7,#0]
000020  1cbf              ADDS     r7,r7,#2
000022  1888              ADDS     r0,r1,r2
000024  b284              UXTH     r4,r0
000026  8838              LDRH     r0,[r7,#0]
000028  2800              CMP      r0,#0
00002a  d1f5              BNE      |L36.24|
                  |L36.44|
;;;946    	}
;;;947    
;;;948    	/* itoa */
;;;949    	i = 7;
00002c  2507              MOVS     r5,#7
;;;950    	do {
00002e  bf00              NOP      
                  |L36.48|
;;;951    		c = (seq % 16) + '0';
000030  4620              MOV      r0,r4
000032  17e1              ASRS     r1,r4,#31
000034  0f09              LSRS     r1,r1,#28
000036  1809              ADDS     r1,r1,r0
000038  1109              ASRS     r1,r1,#4
00003a  0109              LSLS     r1,r1,#4
00003c  1a61              SUBS     r1,r4,r1
00003e  3130              ADDS     r1,r1,#0x30
000040  b2c9              UXTB     r1,r1
000042  9100              STR      r1,[sp,#0]
;;;952    		if (c > '9') c += 7;
000044  9800              LDR      r0,[sp,#0]
000046  2839              CMP      r0,#0x39
000048  dd03              BLE      |L36.82|
00004a  9800              LDR      r0,[sp,#0]
00004c  1dc0              ADDS     r0,r0,#7
00004e  b2c0              UXTB     r0,r0
000050  9000              STR      r0,[sp,#0]
                  |L36.82|
;;;953    		ns[i--] = c;
000052  4629              MOV      r1,r5
000054  1e6d              SUBS     r5,r5,#1
000056  aa01              ADD      r2,sp,#4
000058  9800              LDR      r0,[sp,#0]
00005a  5450              STRB     r0,[r2,r1]
;;;954    		seq /= 16;
00005c  4620              MOV      r0,r4
00005e  17e1              ASRS     r1,r4,#31
000060  0f09              LSRS     r1,r1,#28
000062  1809              ADDS     r1,r1,r0
000064  0309              LSLS     r1,r1,#12
000066  0c0c              LSRS     r4,r1,#16
;;;955    	} while (seq);
000068  2c00              CMP      r4,#0
00006a  d1e1              BNE      |L36.48|
;;;956    	ns[i] = '~';
00006c  207e              MOVS     r0,#0x7e
00006e  a901              ADD      r1,sp,#4
000070  5548              STRB     r0,[r1,r5]
;;;957    
;;;958    	/* Append the number */
;;;959    	for (j = 0; j < i && dst[j] != ' '; j++) {
000072  2600              MOVS     r6,#0
000074  e000              B        |L36.120|
                  |L36.118|
000076  1c76              ADDS     r6,r6,#1
                  |L36.120|
000078  42ae              CMP      r6,r5
00007a  da03              BGE      |L36.132|
00007c  9803              LDR      r0,[sp,#0xc]
00007e  5d80              LDRB     r0,[r0,r6]
000080  2820              CMP      r0,#0x20
000082  d1f8              BNE      |L36.118|
                  |L36.132|
;;;960    		if (IsDBCS1(dst[j])) {
;;;961    			if (j == i - 1) break;
;;;962    			j++;
;;;963    		}
;;;964    	}
;;;965    	do {
000084  bf00              NOP      
                  |L36.134|
;;;966    		dst[j++] = (i < 8) ? ns[i++] : ' ';
000086  2d08              CMP      r5,#8
000088  da04              BGE      |L36.148|
00008a  4628              MOV      r0,r5
00008c  1c6d              ADDS     r5,r5,#1
00008e  a901              ADD      r1,sp,#4
000090  5c08              LDRB     r0,[r1,r0]
000092  e000              B        |L36.150|
                  |L36.148|
000094  2020              MOVS     r0,#0x20
                  |L36.150|
000096  4631              MOV      r1,r6
000098  1c76              ADDS     r6,r6,#1
00009a  9a03              LDR      r2,[sp,#0xc]
00009c  5450              STRB     r0,[r2,r1]
;;;967    	} while (j < 8);
00009e  2e08              CMP      r6,#8
0000a0  dbf1              BLT      |L36.134|
;;;968    }
0000a2  b007              ADD      sp,sp,#0x1c
0000a4  bdf0              POP      {r4-r7,pc}
;;;969    #endif
                          ENDP


                          AREA ||i.get_fat||, CODE, READONLY, ALIGN=1

                  get_fat PROC
;;;488    
;;;489    DWORD get_fat (	/* 0xFFFFFFFF:Disk error, 1:Internal error, Else:Cluster status */
000000  b5f8              PUSH     {r3-r7,lr}
;;;490    	FATFS *fs,	/* File system object */
;;;491    	DWORD clst	/* Cluster# to get the link information */
;;;492    )
;;;493    {
000002  4604              MOV      r4,r0
000004  460d              MOV      r5,r1
;;;494    	UINT wc, bc;
;;;495    	BYTE *p;
;;;496    
;;;497    
;;;498    	if (clst < 2 || clst >= fs->n_fatent)	/* Chack range */
000006  2d02              CMP      r5,#2
000008  d302              BCC      |L37.16|
00000a  69e0              LDR      r0,[r4,#0x1c]
00000c  42a8              CMP      r0,r5
00000e  d801              BHI      |L37.20|
                  |L37.16|
;;;499    		return 1;
000010  2001              MOVS     r0,#1
                  |L37.18|
;;;500    
;;;501    	switch (fs->fs_type) {
;;;502    	case FS_FAT12 :
;;;503    		bc = (UINT)clst; bc += bc / 2;
;;;504    		if (move_window(fs, fs->fatbase + (bc / SS(fs)))) break;
;;;505    		wc = fs->win[bc % SS(fs)]; bc++;
;;;506    		if (move_window(fs, fs->fatbase + (bc / SS(fs)))) break;
;;;507    		wc |= fs->win[bc % SS(fs)] << 8;
;;;508    		return (clst & 1) ? (wc >> 4) : (wc & 0xFFF);
;;;509    
;;;510    	case FS_FAT16 :
;;;511    		if (move_window(fs, fs->fatbase + (clst / (SS(fs) / 2)))) break;
;;;512    		p = &fs->win[clst * 2 % SS(fs)];
;;;513    		return LD_WORD(p);
;;;514    
;;;515    	case FS_FAT32 :
;;;516    		if (move_window(fs, fs->fatbase + (clst / (SS(fs) / 4)))) break;
;;;517    		p = &fs->win[clst * 4 % SS(fs)];
;;;518    		return LD_DWORD(p) & 0x0FFFFFFF;
;;;519    	}
;;;520    
;;;521    	return 0xFFFFFFFF;	/* An error occurred at the disk I/O layer */
;;;522    }
000012  bdf8              POP      {r3-r7,pc}
                  |L37.20|
000014  7820              LDRB     r0,[r4,#0]            ;501
000016  2801              CMP      r0,#1                 ;501
000018  d004              BEQ      |L37.36|
00001a  2802              CMP      r0,#2                 ;501
00001c  d032              BEQ      |L37.132|
00001e  2803              CMP      r0,#3                 ;501
000020  d15e              BNE      |L37.224|
000022  e042              B        |L37.170|
                  |L37.36|
000024  462f              MOV      r7,r5                 ;503
000026  0878              LSRS     r0,r7,#1              ;503
000028  19c7              ADDS     r7,r0,r7              ;503
00002a  0a7a              LSRS     r2,r7,#9              ;504
00002c  6a60              LDR      r0,[r4,#0x24]         ;504
00002e  1881              ADDS     r1,r0,r2              ;504
000030  4620              MOV      r0,r4                 ;504
000032  f7fffffe          BL       move_window
000036  2800              CMP      r0,#0                 ;504
000038  d000              BEQ      |L37.60|
00003a  e051              B        |L37.224|
                  |L37.60|
00003c  05f9              LSLS     r1,r7,#23             ;505
00003e  0dc9              LSRS     r1,r1,#23             ;505
000040  4620              MOV      r0,r4                 ;505
000042  3034              ADDS     r0,r0,#0x34           ;505
000044  5c40              LDRB     r0,[r0,r1]            ;505
000046  9000              STR      r0,[sp,#0]            ;505
000048  1c7f              ADDS     r7,r7,#1              ;505
00004a  0a7a              LSRS     r2,r7,#9              ;506
00004c  6a60              LDR      r0,[r4,#0x24]         ;506
00004e  1881              ADDS     r1,r0,r2              ;506
000050  4620              MOV      r0,r4                 ;506
000052  f7fffffe          BL       move_window
000056  2800              CMP      r0,#0                 ;506
000058  d000              BEQ      |L37.92|
00005a  e041              B        |L37.224|
                  |L37.92|
00005c  05f9              LSLS     r1,r7,#23             ;507
00005e  0dc9              LSRS     r1,r1,#23             ;507
000060  4620              MOV      r0,r4                 ;507
000062  3034              ADDS     r0,r0,#0x34           ;507
000064  5c40              LDRB     r0,[r0,r1]            ;507
000066  0200              LSLS     r0,r0,#8              ;507
000068  9900              LDR      r1,[sp,#0]            ;507
00006a  4308              ORRS     r0,r0,r1              ;507
00006c  9000              STR      r0,[sp,#0]            ;507
00006e  07e8              LSLS     r0,r5,#31             ;508
000070  0fc0              LSRS     r0,r0,#31             ;508
000072  2800              CMP      r0,#0                 ;508
000074  d002              BEQ      |L37.124|
000076  9800              LDR      r0,[sp,#0]            ;508
000078  0900              LSRS     r0,r0,#4              ;508
00007a  e7ca              B        |L37.18|
                  |L37.124|
00007c  9800              LDR      r0,[sp,#0]            ;508
00007e  0500              LSLS     r0,r0,#20             ;508
000080  0d00              LSRS     r0,r0,#20             ;508
000082  e7c6              B        |L37.18|
                  |L37.132|
000084  0a2a              LSRS     r2,r5,#8              ;511
000086  6a60              LDR      r0,[r4,#0x24]         ;511
000088  1881              ADDS     r1,r0,r2              ;511
00008a  4620              MOV      r0,r4                 ;511
00008c  f7fffffe          BL       move_window
000090  2800              CMP      r0,#0                 ;511
000092  d000              BEQ      |L37.150|
000094  e024              B        |L37.224|
                  |L37.150|
000096  0628              LSLS     r0,r5,#24             ;512
000098  0dc1              LSRS     r1,r0,#23             ;512
00009a  4620              MOV      r0,r4                 ;512
00009c  3034              ADDS     r0,r0,#0x34           ;512
00009e  180e              ADDS     r6,r1,r0              ;512
0000a0  7870              LDRB     r0,[r6,#1]            ;513
0000a2  0200              LSLS     r0,r0,#8              ;513
0000a4  7831              LDRB     r1,[r6,#0]            ;513
0000a6  4308              ORRS     r0,r0,r1              ;513
0000a8  e7b3              B        |L37.18|
                  |L37.170|
0000aa  09ea              LSRS     r2,r5,#7              ;516
0000ac  6a60              LDR      r0,[r4,#0x24]         ;516
0000ae  1881              ADDS     r1,r0,r2              ;516
0000b0  4620              MOV      r0,r4                 ;516
0000b2  f7fffffe          BL       move_window
0000b6  2800              CMP      r0,#0                 ;516
0000b8  d000              BEQ      |L37.188|
0000ba  e011              B        |L37.224|
                  |L37.188|
0000bc  0668              LSLS     r0,r5,#25             ;517
0000be  0dc1              LSRS     r1,r0,#23             ;517
0000c0  4620              MOV      r0,r4                 ;517
0000c2  3034              ADDS     r0,r0,#0x34           ;517
0000c4  180e              ADDS     r6,r1,r0              ;517
0000c6  78f0              LDRB     r0,[r6,#3]            ;518
0000c8  0600              LSLS     r0,r0,#24             ;518
0000ca  78b1              LDRB     r1,[r6,#2]            ;518
0000cc  0409              LSLS     r1,r1,#16             ;518
0000ce  4308              ORRS     r0,r0,r1              ;518
0000d0  7871              LDRB     r1,[r6,#1]            ;518
0000d2  0209              LSLS     r1,r1,#8              ;518
0000d4  4308              ORRS     r0,r0,r1              ;518
0000d6  7831              LDRB     r1,[r6,#0]            ;518
0000d8  4308              ORRS     r0,r0,r1              ;518
0000da  0100              LSLS     r0,r0,#4              ;518
0000dc  0900              LSRS     r0,r0,#4              ;518
0000de  e798              B        |L37.18|
                  |L37.224|
0000e0  bf00              NOP                            ;504
0000e2  2000              MOVS     r0,#0                 ;521
0000e4  43c0              MVNS     r0,r0                 ;521
0000e6  e794              B        |L37.18|
;;;523    
                          ENDP


                          AREA ||i.get_fileinfo||, CODE, READONLY, ALIGN=2

                  get_fileinfo PROC
;;;1483   static
;;;1484   void get_fileinfo (		/* No return code */
000000  b5f3              PUSH     {r0,r1,r4-r7,lr}
;;;1485   	DIR *dj,			/* Pointer to the directory object */
;;;1486   	FILINFO *fno	 	/* Pointer to the file information to be filled */
;;;1487   )
;;;1488   {
000002  b085              SUB      sp,sp,#0x14
000004  460f              MOV      r7,r1
;;;1489   	int i;
;;;1490   	BYTE nt, *dir;
;;;1491   	TCHAR *p, c;
;;;1492   
;;;1493   
;;;1494   	p = fno->fname;
000006  4638              MOV      r0,r7
000008  3009              ADDS     r0,r0,#9
00000a  9003              STR      r0,[sp,#0xc]
;;;1495   	if (dj->sect) {
00000c  9805              LDR      r0,[sp,#0x14]
00000e  6900              LDR      r0,[r0,#0x10]
000010  2800              CMP      r0,#0
000012  d05c              BEQ      |L38.206|
;;;1496   		dir = dj->dir;
000014  9805              LDR      r0,[sp,#0x14]
000016  6944              LDR      r4,[r0,#0x14]
;;;1497   		nt = dir[DIR_NTres];		/* NT flag */
000018  7b20              LDRB     r0,[r4,#0xc]
00001a  9004              STR      r0,[sp,#0x10]
;;;1498   		for (i = 0; i < 8; i++) {	/* Copy name body */
00001c  2600              MOVS     r6,#0
00001e  e018              B        |L38.82|
                  |L38.32|
;;;1499   			c = dir[i];
000020  5da5              LDRB     r5,[r4,r6]
;;;1500   			if (c == ' ') break;
000022  2d20              CMP      r5,#0x20
000024  d100              BNE      |L38.40|
000026  e016              B        |L38.86|
                  |L38.40|
;;;1501   			if (c == 0x05) c = (TCHAR)0xE5;
000028  2d05              CMP      r5,#5
00002a  d100              BNE      |L38.46|
00002c  25e5              MOVS     r5,#0xe5
                  |L38.46|
;;;1502   			if (_USE_LFN && (nt & NS_BODY) && IsUpper(c)) c += 0x20;
00002e  2108              MOVS     r1,#8
000030  9804              LDR      r0,[sp,#0x10]
000032  4008              ANDS     r0,r0,r1
000034  2800              CMP      r0,#0
000036  d006              BEQ      |L38.70|
000038  2d41              CMP      r5,#0x41
00003a  db04              BLT      |L38.70|
00003c  2d5a              CMP      r5,#0x5a
00003e  dc02              BGT      |L38.70|
000040  4628              MOV      r0,r5
000042  3020              ADDS     r0,r0,#0x20
000044  b2c5              UXTB     r5,r0
                  |L38.70|
;;;1503   #if _LFN_UNICODE
;;;1504   			if (IsDBCS1(c) && i < 7 && IsDBCS2(dir[i + 1]))
;;;1505   				c = (c << 8) | dir[++i];
;;;1506   			c = ff_convert(c, 1);
;;;1507   			if (!c) c = '?';
;;;1508   #endif
;;;1509   			*p++ = c;
000046  9803              LDR      r0,[sp,#0xc]
000048  7005              STRB     r5,[r0,#0]
00004a  9803              LDR      r0,[sp,#0xc]
00004c  1c40              ADDS     r0,r0,#1
00004e  9003              STR      r0,[sp,#0xc]
000050  1c76              ADDS     r6,r6,#1              ;1498
                  |L38.82|
000052  2e08              CMP      r6,#8                 ;1498
000054  dbe4              BLT      |L38.32|
                  |L38.86|
000056  bf00              NOP                            ;1500
;;;1510   		}
;;;1511   		if (dir[8] != ' ') {		/* Copy name extension */
000058  7a20              LDRB     r0,[r4,#8]
00005a  2820              CMP      r0,#0x20
00005c  d020              BEQ      |L38.160|
;;;1512   			*p++ = '.';
00005e  212e              MOVS     r1,#0x2e
000060  9803              LDR      r0,[sp,#0xc]
000062  7001              STRB     r1,[r0,#0]
000064  9803              LDR      r0,[sp,#0xc]
000066  1c40              ADDS     r0,r0,#1
000068  9003              STR      r0,[sp,#0xc]
;;;1513   			for (i = 8; i < 11; i++) {
00006a  2608              MOVS     r6,#8
00006c  e015              B        |L38.154|
                  |L38.110|
;;;1514   				c = dir[i];
00006e  5da5              LDRB     r5,[r4,r6]
;;;1515   				if (c == ' ') break;
000070  2d20              CMP      r5,#0x20
000072  d100              BNE      |L38.118|
000074  e013              B        |L38.158|
                  |L38.118|
;;;1516   				if (_USE_LFN && (nt & NS_EXT) && IsUpper(c)) c += 0x20;
000076  2110              MOVS     r1,#0x10
000078  9804              LDR      r0,[sp,#0x10]
00007a  4008              ANDS     r0,r0,r1
00007c  2800              CMP      r0,#0
00007e  d006              BEQ      |L38.142|
000080  2d41              CMP      r5,#0x41
000082  db04              BLT      |L38.142|
000084  2d5a              CMP      r5,#0x5a
000086  dc02              BGT      |L38.142|
000088  4628              MOV      r0,r5
00008a  3020              ADDS     r0,r0,#0x20
00008c  b2c5              UXTB     r5,r0
                  |L38.142|
;;;1517   #if _LFN_UNICODE
;;;1518   				if (IsDBCS1(c) && i < 10 && IsDBCS2(dir[i + 1]))
;;;1519   					c = (c << 8) | dir[++i];
;;;1520   				c = ff_convert(c, 1);
;;;1521   				if (!c) c = '?';
;;;1522   #endif
;;;1523   				*p++ = c;
00008e  9803              LDR      r0,[sp,#0xc]
000090  7005              STRB     r5,[r0,#0]
000092  9803              LDR      r0,[sp,#0xc]
000094  1c40              ADDS     r0,r0,#1
000096  9003              STR      r0,[sp,#0xc]
000098  1c76              ADDS     r6,r6,#1              ;1513
                  |L38.154|
00009a  2e0b              CMP      r6,#0xb               ;1513
00009c  dbe7              BLT      |L38.110|
                  |L38.158|
00009e  bf00              NOP                            ;1515
                  |L38.160|
;;;1524   			}
;;;1525   		}
;;;1526   		fno->fattrib = dir[DIR_Attr];				/* Attribute */
0000a0  7ae0              LDRB     r0,[r4,#0xb]
0000a2  7238              STRB     r0,[r7,#8]
;;;1527   		fno->fsize = LD_DWORD(dir+DIR_FileSize);	/* Size */
0000a4  7fe0              LDRB     r0,[r4,#0x1f]
0000a6  0600              LSLS     r0,r0,#24
0000a8  7fa1              LDRB     r1,[r4,#0x1e]
0000aa  0409              LSLS     r1,r1,#16
0000ac  4308              ORRS     r0,r0,r1
0000ae  7f61              LDRB     r1,[r4,#0x1d]
0000b0  0209              LSLS     r1,r1,#8
0000b2  4308              ORRS     r0,r0,r1
0000b4  7f21              LDRB     r1,[r4,#0x1c]
0000b6  4308              ORRS     r0,r0,r1
0000b8  6038              STR      r0,[r7,#0]
;;;1528   		fno->fdate = LD_WORD(dir+DIR_WrtDate);		/* Date */
0000ba  7e60              LDRB     r0,[r4,#0x19]
0000bc  0200              LSLS     r0,r0,#8
0000be  7e21              LDRB     r1,[r4,#0x18]
0000c0  4308              ORRS     r0,r0,r1
0000c2  80b8              STRH     r0,[r7,#4]
;;;1529   		fno->ftime = LD_WORD(dir+DIR_WrtTime);		/* Time */
0000c4  7de0              LDRB     r0,[r4,#0x17]
0000c6  0200              LSLS     r0,r0,#8
0000c8  7da1              LDRB     r1,[r4,#0x16]
0000ca  4308              ORRS     r0,r0,r1
0000cc  80f8              STRH     r0,[r7,#6]
                  |L38.206|
;;;1530   	}
;;;1531   	*p = 0;
0000ce  2100              MOVS     r1,#0
0000d0  9803              LDR      r0,[sp,#0xc]
0000d2  7001              STRB     r1,[r0,#0]
;;;1532   
;;;1533   #if _USE_LFN
;;;1534   	if (fno->lfname) {
0000d4  69b8              LDR      r0,[r7,#0x18]
0000d6  2800              CMP      r0,#0
0000d8  d032              BEQ      |L38.320|
;;;1535   		TCHAR *tp = fno->lfname;
0000da  69b8              LDR      r0,[r7,#0x18]
0000dc  9002              STR      r0,[sp,#8]
;;;1536   		WCHAR w, *lfn;
;;;1537   
;;;1538   		i = 0;
0000de  2600              MOVS     r6,#0
;;;1539   		if (dj->sect && dj->lfn_idx != 0xFFFF) {/* Get LFN if available */
0000e0  9805              LDR      r0,[sp,#0x14]
0000e2  6900              LDR      r0,[r0,#0x10]
0000e4  2800              CMP      r0,#0
0000e6  d027              BEQ      |L38.312|
0000e8  9805              LDR      r0,[sp,#0x14]
0000ea  8c00              LDRH     r0,[r0,#0x20]
0000ec  4915              LDR      r1,|L38.324|
0000ee  4288              CMP      r0,r1
0000f0  d022              BEQ      |L38.312|
;;;1540   			lfn = dj->lfn;
0000f2  9805              LDR      r0,[sp,#0x14]
0000f4  69c0              LDR      r0,[r0,#0x1c]
0000f6  9000              STR      r0,[sp,#0]
;;;1541   			while ((w = *lfn++) != 0) {			/* Get an LFN char */
0000f8  e016              B        |L38.296|
                  |L38.250|
;;;1542   #if !_LFN_UNICODE
;;;1543   				w = ff_convert(w, 0);			/* Unicode -> OEM conversion */
0000fa  2100              MOVS     r1,#0
0000fc  9801              LDR      r0,[sp,#4]
0000fe  f7fffffe          BL       ff_convert
000102  9001              STR      r0,[sp,#4]
;;;1544   				if (!w) { i = 0; break; }		/* Could not convert, no LFN */
000104  9801              LDR      r0,[sp,#4]
000106  2800              CMP      r0,#0
000108  d101              BNE      |L38.270|
00010a  2600              MOVS     r6,#0
00010c  e013              B        |L38.310|
                  |L38.270|
;;;1545   				if (_DF1S && w >= 0x100)		/* Put 1st byte if it is a DBC */
00010e  bf00              NOP      
;;;1546   					tp[i++] = (TCHAR)(w >> 8);
;;;1547   #endif
;;;1548   				if (i >= fno->lfsize - 1) { i = 0; break; }	/* Buffer overrun, no LFN */
000110  69f8              LDR      r0,[r7,#0x1c]
000112  1e40              SUBS     r0,r0,#1
000114  42b0              CMP      r0,r6
000116  dc01              BGT      |L38.284|
000118  2600              MOVS     r6,#0
00011a  e00c              B        |L38.310|
                  |L38.284|
;;;1549   				tp[i++] = (TCHAR)w;
00011c  9801              LDR      r0,[sp,#4]
00011e  b2c2              UXTB     r2,r0
000120  4630              MOV      r0,r6
000122  1c76              ADDS     r6,r6,#1
000124  9902              LDR      r1,[sp,#8]
000126  540a              STRB     r2,[r1,r0]
                  |L38.296|
000128  9800              LDR      r0,[sp,#0]            ;1541
00012a  8801              LDRH     r1,[r0,#0]            ;1541
00012c  1c80              ADDS     r0,r0,#2              ;1541
00012e  9101              STR      r1,[sp,#4]            ;1541
000130  9000              STR      r0,[sp,#0]            ;1541
000132  2900              CMP      r1,#0                 ;1541
000134  d1e1              BNE      |L38.250|
                  |L38.310|
000136  bf00              NOP                            ;1544
                  |L38.312|
;;;1550   			}
;;;1551   		}
;;;1552   		tp[i] = 0;	/* Terminator */
000138  2100              MOVS     r1,#0
00013a  9802              LDR      r0,[sp,#8]
00013c  5581              STRB     r1,[r0,r6]
;;;1553   	}
00013e  bf00              NOP      
                  |L38.320|
;;;1554   #endif
;;;1555   }
000140  b007              ADD      sp,sp,#0x1c
000142  bdf0              POP      {r4-r7,pc}
;;;1556   #endif /* _FS_MINIMIZE <= 1 */
                          ENDP

                  |L38.324|
                          DCD      0x0000ffff

                          AREA ||i.mem_cmp||, CODE, READONLY, ALIGN=1

                  mem_cmp PROC
;;;257    static
;;;258    int mem_cmp (const void* dst, const void* src, int cnt) {
000000  b5f8              PUSH     {r3-r7,lr}
000002  4603              MOV      r3,r0
;;;259    	const BYTE *d = (const BYTE *)dst, *s = (const BYTE *)src;
000004  461c              MOV      r4,r3
000006  460d              MOV      r5,r1
;;;260    	int r = 0;
000008  2000              MOVS     r0,#0
00000a  9000              STR      r0,[sp,#0]
;;;261    
;;;262    	while (cnt-- && (r = *d++ - *s++) == 0) ;
00000c  bf00              NOP      
                  |L39.14|
00000e  4610              MOV      r0,r2
000010  1e52              SUBS     r2,r2,#1
000012  2800              CMP      r0,#0
000014  d007              BEQ      |L39.38|
000016  7820              LDRB     r0,[r4,#0]
000018  1c64              ADDS     r4,r4,#1
00001a  782e              LDRB     r6,[r5,#0]
00001c  1c6d              ADDS     r5,r5,#1
00001e  1b80              SUBS     r0,r0,r6
000020  9000              STR      r0,[sp,#0]
000022  2800              CMP      r0,#0
000024  d0f3              BEQ      |L39.14|
                  |L39.38|
;;;263    	return r;
000026  9800              LDR      r0,[sp,#0]
;;;264    }
000028  bdf8              POP      {r3-r7,pc}
;;;265    
                          ENDP


                          AREA ||i.mem_cpy||, CODE, READONLY, ALIGN=1

                  mem_cpy PROC
;;;231    static
;;;232    void mem_cpy (void* dst, const void* src, int cnt) {
000000  b570              PUSH     {r4-r6,lr}
;;;233    	BYTE *d = (BYTE*)dst;
000002  4603              MOV      r3,r0
;;;234    	const BYTE *s = (const BYTE*)src;
000004  460c              MOV      r4,r1
;;;235    
;;;236    #if _WORD_ACCESS == 1
;;;237    	while (cnt >= sizeof(int)) {
;;;238    		*(int*)d = *(int*)s;
;;;239    		d += sizeof(int); s += sizeof(int);
;;;240    		cnt -= sizeof(int);
;;;241    	}
;;;242    #endif
;;;243    	while (cnt--)
000006  e003              B        |L40.16|
                  |L40.8|
;;;244    		*d++ = *s++;
000008  7825              LDRB     r5,[r4,#0]
00000a  701d              STRB     r5,[r3,#0]
00000c  1c64              ADDS     r4,r4,#1
00000e  1c5b              ADDS     r3,r3,#1
                  |L40.16|
000010  4615              MOV      r5,r2                 ;243
000012  1e52              SUBS     r2,r2,#1              ;243
000014  2d00              CMP      r5,#0                 ;243
000016  d1f7              BNE      |L40.8|
;;;245    }
000018  bd70              POP      {r4-r6,pc}
;;;246    
                          ENDP


                          AREA ||i.mem_set||, CODE, READONLY, ALIGN=1

                  mem_set PROC
;;;248    static
;;;249    void mem_set (void* dst, int val, int cnt) {
000000  b530              PUSH     {r4,r5,lr}
;;;250    	BYTE *d = (BYTE*)dst;
000002  4603              MOV      r3,r0
;;;251    
;;;252    	while (cnt--)
000004  e001              B        |L41.10|
                  |L41.6|
;;;253    		*d++ = (BYTE)val;
000006  7019              STRB     r1,[r3,#0]
000008  1c5b              ADDS     r3,r3,#1
                  |L41.10|
00000a  4614              MOV      r4,r2                 ;252
00000c  1e52              SUBS     r2,r2,#1              ;252
00000e  2c00              CMP      r4,#0                 ;252
000010  d1f9              BNE      |L41.6|
;;;254    }
000012  bd30              POP      {r4,r5,pc}
;;;255    
                          ENDP


                          AREA ||i.move_window||, CODE, READONLY, ALIGN=1

                  move_window PROC
;;;408    static
;;;409    FRESULT move_window (
000000  b5f8              PUSH     {r3-r7,lr}
;;;410    	FATFS *fs,		/* File system object */
;;;411    	DWORD sector	/* Sector number to make appearance in the fs->win[] */
;;;412    )					/* Move to zero only writes back dirty window */
;;;413    {
000002  4604              MOV      r4,r0
000004  460d              MOV      r5,r1
;;;414    	DWORD wsect;
;;;415    
;;;416    
;;;417    	wsect = fs->winsect;
000006  6b26              LDR      r6,[r4,#0x30]
;;;418    	if (wsect != sector) {	/* Changed current window */
000008  42ae              CMP      r6,r5
00000a  d032              BEQ      |L42.114|
;;;419    #if !_FS_READONLY
;;;420    		if (fs->wflag) {	/* Write back dirty window if needed */
00000c  7920              LDRB     r0,[r4,#4]
00000e  2800              CMP      r0,#0
000010  d021              BEQ      |L42.86|
;;;421    			if (disk_write(fs->drv, fs->win, wsect, 1) != RES_OK)
000012  7860              LDRB     r0,[r4,#1]
000014  2301              MOVS     r3,#1
000016  4632              MOV      r2,r6
000018  4621              MOV      r1,r4
00001a  3134              ADDS     r1,r1,#0x34
00001c  f7fffffe          BL       disk_write
000020  2800              CMP      r0,#0
000022  d001              BEQ      |L42.40|
;;;422    				return FR_DISK_ERR;
000024  2001              MOVS     r0,#1
                  |L42.38|
;;;423    			fs->wflag = 0;
;;;424    			if (wsect < (fs->fatbase + fs->fsize)) {	/* In FAT area */
;;;425    				BYTE nf;
;;;426    				for (nf = fs->n_fats; nf > 1; nf--) {	/* Reflect the change to all FAT copies */
;;;427    					wsect += fs->fsize;
;;;428    					disk_write(fs->drv, fs->win, wsect, 1);
;;;429    				}
;;;430    			}
;;;431    		}
;;;432    #endif
;;;433    		if (sector) {
;;;434    			if (disk_read(fs->drv, fs->win, sector, 1) != RES_OK)
;;;435    				return FR_DISK_ERR;
;;;436    			fs->winsect = sector;
;;;437    		}
;;;438    	}
;;;439    
;;;440    	return FR_OK;
;;;441    }
000026  bdf8              POP      {r3-r7,pc}
                  |L42.40|
000028  2000              MOVS     r0,#0                 ;423
00002a  7120              STRB     r0,[r4,#4]            ;423
00002c  6a21              LDR      r1,[r4,#0x20]         ;424
00002e  6a60              LDR      r0,[r4,#0x24]         ;424
000030  1840              ADDS     r0,r0,r1              ;424
000032  42b0              CMP      r0,r6                 ;424
000034  d90f              BLS      |L42.86|
000036  78e7              LDRB     r7,[r4,#3]            ;426
000038  e00a              B        |L42.80|
                  |L42.58|
00003a  6a20              LDR      r0,[r4,#0x20]         ;427
00003c  1986              ADDS     r6,r0,r6              ;427
00003e  7860              LDRB     r0,[r4,#1]            ;428
000040  2301              MOVS     r3,#1                 ;428
000042  4632              MOV      r2,r6                 ;428
000044  4621              MOV      r1,r4                 ;428
000046  3134              ADDS     r1,r1,#0x34           ;428
000048  f7fffffe          BL       disk_write
00004c  1e78              SUBS     r0,r7,#1              ;426
00004e  b2c7              UXTB     r7,r0                 ;426
                  |L42.80|
000050  2f01              CMP      r7,#1                 ;426
000052  dcf2              BGT      |L42.58|
000054  bf00              NOP                            ;430
                  |L42.86|
000056  2d00              CMP      r5,#0                 ;433
000058  d00b              BEQ      |L42.114|
00005a  7860              LDRB     r0,[r4,#1]            ;434
00005c  2301              MOVS     r3,#1                 ;434
00005e  462a              MOV      r2,r5                 ;434
000060  4621              MOV      r1,r4                 ;434
000062  3134              ADDS     r1,r1,#0x34           ;434
000064  f7fffffe          BL       disk_read
000068  2800              CMP      r0,#0                 ;434
00006a  d001              BEQ      |L42.112|
00006c  2001              MOVS     r0,#1                 ;435
00006e  e7da              B        |L42.38|
                  |L42.112|
000070  6325              STR      r5,[r4,#0x30]         ;436
                  |L42.114|
000072  2000              MOVS     r0,#0                 ;440
000074  e7d7              B        |L42.38|
;;;442    
                          ENDP


                          AREA ||i.pick_lfn||, CODE, READONLY, ALIGN=2

                  pick_lfn PROC
;;;861    static
;;;862    int pick_lfn (			/* 1:Succeeded, 0:Buffer overflow */
000000  b5f0              PUSH     {r4-r7,lr}
;;;863    	WCHAR *lfnbuf,		/* Pointer to the Unicode-LFN buffer */
;;;864    	BYTE *dir			/* Pointer to the directory entry */
;;;865    )
;;;866    {
000002  4603              MOV      r3,r0
;;;867    	int i, s;
;;;868    	WCHAR wc, uc;
;;;869    
;;;870    
;;;871    	i = ((dir[LDIR_Ord] & 0x3F) - 1) * 13;	/* Offset in the LFN buffer */
000004  7808              LDRB     r0,[r1,#0]
000006  0680              LSLS     r0,r0,#26
000008  0e80              LSRS     r0,r0,#26
00000a  1e40              SUBS     r0,r0,#1
00000c  270d              MOVS     r7,#0xd
00000e  4378              MULS     r0,r7,r0
000010  4602              MOV      r2,r0
;;;872    
;;;873    	s = 0; wc = 1;
000012  2400              MOVS     r4,#0
000014  2601              MOVS     r6,#1
;;;874    	do {
000016  bf00              NOP      
                  |L43.24|
;;;875    		uc = LD_WORD(dir+LfnOfs[s]);		/* Pick an LFN character from the entry */
000018  4815              LDR      r0,|L43.112|
00001a  5d00              LDRB     r0,[r0,r4]
00001c  1840              ADDS     r0,r0,r1
00001e  7840              LDRB     r0,[r0,#1]
000020  0205              LSLS     r5,r0,#8
000022  4f13              LDR      r7,|L43.112|
000024  5d3f              LDRB     r7,[r7,r4]
000026  5dcf              LDRB     r7,[r1,r7]
000028  433d              ORRS     r5,r5,r7
;;;876    		if (wc) {	/* Last char has not been processed */
00002a  2e00              CMP      r6,#0
00002c  d009              BEQ      |L43.66|
;;;877    			if (i >= _MAX_LFN) return 0;	/* Buffer overflow? */
00002e  2a7f              CMP      r2,#0x7f
000030  db01              BLT      |L43.54|
000032  2000              MOVS     r0,#0
                  |L43.52|
;;;878    			lfnbuf[i++] = wc = uc;			/* Store it */
;;;879    		} else {
;;;880    			if (uc != 0xFFFF) return 0;		/* Check filler */
;;;881    		}
;;;882    	} while (++s < 13);						/* Read all character in the entry */
;;;883    
;;;884    	if (dir[LDIR_Ord] & 0x40) {				/* Put terminator if it is the last LFN part */
;;;885    		if (i >= _MAX_LFN) return 0;		/* Buffer overflow? */
;;;886    		lfnbuf[i] = 0;
;;;887    	}
;;;888    
;;;889    	return 1;
;;;890    }
000034  bdf0              POP      {r4-r7,pc}
                  |L43.54|
000036  462e              MOV      r6,r5                 ;878
000038  4610              MOV      r0,r2                 ;878
00003a  1c52              ADDS     r2,r2,#1              ;878
00003c  0040              LSLS     r0,r0,#1              ;878
00003e  521d              STRH     r5,[r3,r0]            ;878
000040  e004              B        |L43.76|
                  |L43.66|
000042  480c              LDR      r0,|L43.116|
000044  4285              CMP      r5,r0                 ;880
000046  d001              BEQ      |L43.76|
000048  2000              MOVS     r0,#0                 ;880
00004a  e7f3              B        |L43.52|
                  |L43.76|
00004c  1c60              ADDS     r0,r4,#1              ;882
00004e  4604              MOV      r4,r0                 ;882
000050  280d              CMP      r0,#0xd               ;882
000052  dbe1              BLT      |L43.24|
000054  7808              LDRB     r0,[r1,#0]            ;884
000056  2740              MOVS     r7,#0x40              ;884
000058  4038              ANDS     r0,r0,r7              ;884
00005a  2800              CMP      r0,#0                 ;884
00005c  d006              BEQ      |L43.108|
00005e  2a7f              CMP      r2,#0x7f              ;885
000060  db01              BLT      |L43.102|
000062  2000              MOVS     r0,#0                 ;885
000064  e7e6              B        |L43.52|
                  |L43.102|
000066  2000              MOVS     r0,#0                 ;886
000068  0057              LSLS     r7,r2,#1              ;886
00006a  53d8              STRH     r0,[r3,r7]            ;886
                  |L43.108|
00006c  2001              MOVS     r0,#1                 ;889
00006e  e7e1              B        |L43.52|
;;;891    
                          ENDP

                  |L43.112|
                          DCD      LfnOfs
                  |L43.116|
                          DCD      0x0000ffff

                          AREA ||i.put_fat||, CODE, READONLY, ALIGN=1

                  put_fat PROC
;;;531    
;;;532    FRESULT put_fat (
000000  b5fe              PUSH     {r1-r7,lr}
;;;533    	FATFS *fs,	/* File system object */
;;;534    	DWORD clst,	/* Cluster# to be changed in range of 2 to fs->n_fatent - 1 */
;;;535    	DWORD val	/* New value to mark the cluster */
;;;536    )
;;;537    {
000002  4605              MOV      r5,r0
000004  460e              MOV      r6,r1
000006  4617              MOV      r7,r2
;;;538    	UINT bc;
;;;539    	BYTE *p;
;;;540    	FRESULT res;
;;;541    
;;;542    
;;;543    	if (clst < 2 || clst >= fs->n_fatent) {	/* Check range */
000008  2e02              CMP      r6,#2
00000a  d302              BCC      |L44.18|
00000c  69e8              LDR      r0,[r5,#0x1c]
00000e  42b0              CMP      r0,r6
000010  d802              BHI      |L44.24|
                  |L44.18|
;;;544    		res = FR_INT_ERR;
000012  2002              MOVS     r0,#2
000014  9000              STR      r0,[sp,#0]
000016  e094              B        |L44.322|
                  |L44.24|
;;;545    
;;;546    	} else {
;;;547    		switch (fs->fs_type) {
000018  7828              LDRB     r0,[r5,#0]
00001a  2801              CMP      r0,#1
00001c  d004              BEQ      |L44.40|
00001e  2802              CMP      r0,#2
000020  d04b              BEQ      |L44.186|
000022  2803              CMP      r0,#3
000024  d17e              BNE      |L44.292|
000026  e05d              B        |L44.228|
                  |L44.40|
;;;548    		case FS_FAT12 :
;;;549    			bc = clst; bc += bc / 2;
000028  9601              STR      r6,[sp,#4]
00002a  9e01              LDR      r6,[sp,#4]
00002c  0870              LSRS     r0,r6,#1
00002e  1980              ADDS     r0,r0,r6
000030  9001              STR      r0,[sp,#4]
;;;550    			res = move_window(fs, fs->fatbase + (bc / SS(fs)));
000032  6a6a              LDR      r2,[r5,#0x24]
000034  9801              LDR      r0,[sp,#4]
000036  0a40              LSRS     r0,r0,#9
000038  1811              ADDS     r1,r2,r0
00003a  4628              MOV      r0,r5
00003c  f7fffffe          BL       move_window
000040  9000              STR      r0,[sp,#0]
;;;551    			if (res != FR_OK) break;
000042  9800              LDR      r0,[sp,#0]
000044  2800              CMP      r0,#0
000046  d000              BEQ      |L44.74|
000048  e078              B        |L44.316|
                  |L44.74|
;;;552    			p = &fs->win[bc % SS(fs)];
00004a  9801              LDR      r0,[sp,#4]
00004c  05c1              LSLS     r1,r0,#23
00004e  0dc9              LSRS     r1,r1,#23
000050  4628              MOV      r0,r5
000052  3034              ADDS     r0,r0,#0x34
000054  180c              ADDS     r4,r1,r0
;;;553    			*p = (clst & 1) ? ((*p & 0x0F) | ((BYTE)val << 4)) : (BYTE)val;
000056  07f0              LSLS     r0,r6,#31
000058  0fc0              LSRS     r0,r0,#31
00005a  2800              CMP      r0,#0
00005c  d005              BEQ      |L44.106|
00005e  7820              LDRB     r0,[r4,#0]
000060  0700              LSLS     r0,r0,#28
000062  0f00              LSRS     r0,r0,#28
000064  0139              LSLS     r1,r7,#4
000066  4308              ORRS     r0,r0,r1
000068  e000              B        |L44.108|
                  |L44.106|
00006a  4638              MOV      r0,r7
                  |L44.108|
00006c  7020              STRB     r0,[r4,#0]
;;;554    			bc++;
00006e  9801              LDR      r0,[sp,#4]
000070  1c40              ADDS     r0,r0,#1
000072  9001              STR      r0,[sp,#4]
;;;555    			fs->wflag = 1;
000074  2001              MOVS     r0,#1
000076  7128              STRB     r0,[r5,#4]
;;;556    			res = move_window(fs, fs->fatbase + (bc / SS(fs)));
000078  6a6a              LDR      r2,[r5,#0x24]
00007a  9801              LDR      r0,[sp,#4]
00007c  0a40              LSRS     r0,r0,#9
00007e  1811              ADDS     r1,r2,r0
000080  4628              MOV      r0,r5
000082  f7fffffe          BL       move_window
000086  9000              STR      r0,[sp,#0]
;;;557    			if (res != FR_OK) break;
000088  9800              LDR      r0,[sp,#0]
00008a  2800              CMP      r0,#0
00008c  d000              BEQ      |L44.144|
00008e  e055              B        |L44.316|
                  |L44.144|
;;;558    			p = &fs->win[bc % SS(fs)];
000090  9801              LDR      r0,[sp,#4]
000092  05c1              LSLS     r1,r0,#23
000094  0dc9              LSRS     r1,r1,#23
000096  4628              MOV      r0,r5
000098  3034              ADDS     r0,r0,#0x34
00009a  180c              ADDS     r4,r1,r0
;;;559    			*p = (clst & 1) ? (BYTE)(val >> 4) : ((*p & 0xF0) | ((BYTE)(val >> 8) & 0x0F));
00009c  07f0              LSLS     r0,r6,#31
00009e  0fc0              LSRS     r0,r0,#31
0000a0  2800              CMP      r0,#0
0000a2  d002              BEQ      |L44.170|
0000a4  0538              LSLS     r0,r7,#20
0000a6  0e00              LSRS     r0,r0,#24
0000a8  e005              B        |L44.182|
                  |L44.170|
0000aa  7820              LDRB     r0,[r4,#0]
0000ac  21f0              MOVS     r1,#0xf0
0000ae  4008              ANDS     r0,r0,r1
0000b0  0539              LSLS     r1,r7,#20
0000b2  0f09              LSRS     r1,r1,#28
0000b4  4308              ORRS     r0,r0,r1
                  |L44.182|
0000b6  7020              STRB     r0,[r4,#0]
;;;560    			break;
0000b8  e040              B        |L44.316|
                  |L44.186|
;;;561    
;;;562    		case FS_FAT16 :
;;;563    			res = move_window(fs, fs->fatbase + (clst / (SS(fs) / 2)));
0000ba  0a32              LSRS     r2,r6,#8
0000bc  6a68              LDR      r0,[r5,#0x24]
0000be  1881              ADDS     r1,r0,r2
0000c0  4628              MOV      r0,r5
0000c2  f7fffffe          BL       move_window
0000c6  9000              STR      r0,[sp,#0]
;;;564    			if (res != FR_OK) break;
0000c8  9800              LDR      r0,[sp,#0]
0000ca  2800              CMP      r0,#0
0000cc  d000              BEQ      |L44.208|
0000ce  e035              B        |L44.316|
                  |L44.208|
;;;565    			p = &fs->win[clst * 2 % SS(fs)];
0000d0  0630              LSLS     r0,r6,#24
0000d2  0dc1              LSRS     r1,r0,#23
0000d4  4628              MOV      r0,r5
0000d6  3034              ADDS     r0,r0,#0x34
0000d8  180c              ADDS     r4,r1,r0
;;;566    			ST_WORD(p, (WORD)val);
0000da  7027              STRB     r7,[r4,#0]
0000dc  0438              LSLS     r0,r7,#16
0000de  0e00              LSRS     r0,r0,#24
0000e0  7060              STRB     r0,[r4,#1]
;;;567    			break;
0000e2  e02b              B        |L44.316|
                  |L44.228|
;;;568    
;;;569    		case FS_FAT32 :
;;;570    			res = move_window(fs, fs->fatbase + (clst / (SS(fs) / 4)));
0000e4  09f2              LSRS     r2,r6,#7
0000e6  6a68              LDR      r0,[r5,#0x24]
0000e8  1881              ADDS     r1,r0,r2
0000ea  4628              MOV      r0,r5
0000ec  f7fffffe          BL       move_window
0000f0  9000              STR      r0,[sp,#0]
;;;571    			if (res != FR_OK) break;
0000f2  9800              LDR      r0,[sp,#0]
0000f4  2800              CMP      r0,#0
0000f6  d000              BEQ      |L44.250|
0000f8  e020              B        |L44.316|
                  |L44.250|
;;;572    			p = &fs->win[clst * 4 % SS(fs)];
0000fa  0670              LSLS     r0,r6,#25
0000fc  0dc1              LSRS     r1,r0,#23
0000fe  4628              MOV      r0,r5
000100  3034              ADDS     r0,r0,#0x34
000102  180c              ADDS     r4,r1,r0
;;;573    			val |= LD_DWORD(p) & 0xF0000000;
000104  78e0              LDRB     r0,[r4,#3]
000106  0600              LSLS     r0,r0,#24
000108  78a1              LDRB     r1,[r4,#2]
00010a  0409              LSLS     r1,r1,#16
00010c  4308              ORRS     r0,r0,r1
00010e  7861              LDRB     r1,[r4,#1]
000110  0209              LSLS     r1,r1,#8
000112  4308              ORRS     r0,r0,r1
000114  7821              LDRB     r1,[r4,#0]
000116  4308              ORRS     r0,r0,r1
000118  0f00              LSRS     r0,r0,#28
00011a  0700              LSLS     r0,r0,#28
00011c  4307              ORRS     r7,r7,r0
;;;574    			ST_DWORD(p, val);
00011e  7027              STRB     r7,[r4,#0]
000120  0438              LSLS     r0,r7,#16
000122  e000              B        |L44.294|
                  |L44.292|
000124  e007              B        |L44.310|
                  |L44.294|
000126  0e00              LSRS     r0,r0,#24
000128  7060              STRB     r0,[r4,#1]
00012a  0238              LSLS     r0,r7,#8
00012c  0e00              LSRS     r0,r0,#24
00012e  70a0              STRB     r0,[r4,#2]
000130  0e38              LSRS     r0,r7,#24
000132  70e0              STRB     r0,[r4,#3]
;;;575    			break;
000134  e002              B        |L44.316|
                  |L44.310|
;;;576    
;;;577    		default :
;;;578    			res = FR_INT_ERR;
000136  2002              MOVS     r0,#2
000138  9000              STR      r0,[sp,#0]
00013a  bf00              NOP                            ;547
                  |L44.316|
00013c  bf00              NOP                            ;551
;;;579    		}
;;;580    		fs->wflag = 1;
00013e  2001              MOVS     r0,#1
000140  7128              STRB     r0,[r5,#4]
                  |L44.322|
;;;581    	}
;;;582    
;;;583    	return res;
000142  9800              LDR      r0,[sp,#0]
;;;584    }
000144  bdfe              POP      {r1-r7,pc}
;;;585    #endif /* !_FS_READONLY */
                          ENDP


                          AREA ||i.remove_chain||, CODE, READONLY, ALIGN=1

                  remove_chain PROC
;;;594    static
;;;595    FRESULT remove_chain (
000000  b5f8              PUSH     {r3-r7,lr}
;;;596    	FATFS *fs,			/* File system object */
;;;597    	DWORD clst			/* Cluster# to remove a chain from */
;;;598    )
;;;599    {
000002  4604              MOV      r4,r0
000004  460e              MOV      r6,r1
;;;600    	FRESULT res;
;;;601    	DWORD nxt;
;;;602    
;;;603    
;;;604    	if (clst < 2 || clst >= fs->n_fatent) {	/* Check range */
000006  2e02              CMP      r6,#2
000008  d302              BCC      |L45.16|
00000a  69e0              LDR      r0,[r4,#0x1c]
00000c  42b0              CMP      r0,r6
00000e  d801              BHI      |L45.20|
                  |L45.16|
;;;605    		res = FR_INT_ERR;
000010  2702              MOVS     r7,#2
000012  e029              B        |L45.104|
                  |L45.20|
;;;606    
;;;607    	} else {
;;;608    		res = FR_OK;
000014  2700              MOVS     r7,#0
;;;609    		while (clst < fs->n_fatent) {			/* Not a last link? */
000016  e023              B        |L45.96|
                  |L45.24|
;;;610    			nxt = get_fat(fs, clst);			/* Get cluster status */
000018  4631              MOV      r1,r6
00001a  4620              MOV      r0,r4
00001c  f7fffffe          BL       get_fat
000020  4605              MOV      r5,r0
;;;611    			if (nxt == 0) break;				/* Empty cluster? */
000022  2d00              CMP      r5,#0
000024  d100              BNE      |L45.40|
000026  e01e              B        |L45.102|
                  |L45.40|
;;;612    			if (nxt == 1) { res = FR_INT_ERR; break; }	/* Internal error? */
000028  2d01              CMP      r5,#1
00002a  d101              BNE      |L45.48|
00002c  2702              MOVS     r7,#2
00002e  e01a              B        |L45.102|
                  |L45.48|
;;;613    			if (nxt == 0xFFFFFFFF) { res = FR_DISK_ERR; break; }	/* Disk error? */
000030  1c68              ADDS     r0,r5,#1
000032  2800              CMP      r0,#0
000034  d101              BNE      |L45.58|
000036  2701              MOVS     r7,#1
000038  e015              B        |L45.102|
                  |L45.58|
;;;614    			res = put_fat(fs, clst, 0);			/* Mark the cluster "empty" */
00003a  2200              MOVS     r2,#0
00003c  4631              MOV      r1,r6
00003e  4620              MOV      r0,r4
000040  f7fffffe          BL       put_fat
000044  4607              MOV      r7,r0
;;;615    			if (res != FR_OK) break;
000046  2f00              CMP      r7,#0
000048  d000              BEQ      |L45.76|
00004a  e00c              B        |L45.102|
                  |L45.76|
;;;616    			if (fs->free_clust != 0xFFFFFFFF) {	/* Update FSInfo */
00004c  6920              LDR      r0,[r4,#0x10]
00004e  1c40              ADDS     r0,r0,#1
000050  2800              CMP      r0,#0
000052  d004              BEQ      |L45.94|
;;;617    				fs->free_clust++;
000054  6920              LDR      r0,[r4,#0x10]
000056  1c40              ADDS     r0,r0,#1
000058  6120              STR      r0,[r4,#0x10]
;;;618    				fs->fsi_flag = 1;
00005a  2001              MOVS     r0,#1
00005c  7160              STRB     r0,[r4,#5]
                  |L45.94|
;;;619    			}
;;;620    			clst = nxt;	/* Next cluster */
00005e  462e              MOV      r6,r5
                  |L45.96|
000060  69e0              LDR      r0,[r4,#0x1c]         ;609
000062  42b0              CMP      r0,r6                 ;609
000064  d8d8              BHI      |L45.24|
                  |L45.102|
000066  bf00              NOP                            ;611
                  |L45.104|
;;;621    		}
;;;622    	}
;;;623    
;;;624    	return res;
000068  4638              MOV      r0,r7
;;;625    }
00006a  bdf8              POP      {r3-r7,pc}
;;;626    #endif
                          ENDP


                          AREA ||i.sum_sfn||, CODE, READONLY, ALIGN=1

                  sum_sfn PROC
;;;978    static
;;;979    BYTE sum_sfn (
000000  b530              PUSH     {r4,r5,lr}
;;;980    	const BYTE *dir		/* Ptr to directory entry */
;;;981    )
;;;982    {
000002  4601              MOV      r1,r0
;;;983    	BYTE sum = 0;
000004  2000              MOVS     r0,#0
;;;984    	int n = 11;
000006  220b              MOVS     r2,#0xb
;;;985    
;;;986    	do sum = (sum >> 1) + (sum << 7) + *dir++; while (--n);
000008  bf00              NOP      
                  |L46.10|
00000a  1043              ASRS     r3,r0,#1
00000c  01c4              LSLS     r4,r0,#7
00000e  191c              ADDS     r4,r3,r4
000010  780d              LDRB     r5,[r1,#0]
000012  1c49              ADDS     r1,r1,#1
000014  1963              ADDS     r3,r4,r5
000016  b2d8              UXTB     r0,r3
000018  1e53              SUBS     r3,r2,#1
00001a  1e1a              SUBS     r2,r3,#0
00001c  d1f5              BNE      |L46.10|
;;;987    	return sum;
;;;988    }
00001e  bd30              POP      {r4,r5,pc}
;;;989    #endif
                          ENDP


                          AREA ||i.sync||, CODE, READONLY, ALIGN=1

                  sync PROC
;;;450    static
;;;451    FRESULT sync (	/* FR_OK: successful, FR_DISK_ERR: failed */
000000  b570              PUSH     {r4-r6,lr}
;;;452    	FATFS *fs	/* File system object */
;;;453    )
;;;454    {
000002  4604              MOV      r4,r0
;;;455    	FRESULT res;
;;;456    
;;;457    
;;;458    	res = move_window(fs, 0);
000004  2100              MOVS     r1,#0
000006  4620              MOV      r0,r4
000008  f7fffffe          BL       move_window
00000c  4605              MOV      r5,r0
;;;459    	if (res == FR_OK) {
00000e  2d00              CMP      r5,#0
000010  d17e              BNE      |L47.272|
;;;460    		/* Update FSInfo sector if needed */
;;;461    		if (fs->fs_type == FS_FAT32 && fs->fsi_flag) {
000012  7820              LDRB     r0,[r4,#0]
000014  2803              CMP      r0,#3
000016  d17f              BNE      |L47.280|
000018  7960              LDRB     r0,[r4,#5]
00001a  2800              CMP      r0,#0
00001c  d07c              BEQ      |L47.280|
;;;462    			fs->winsect = 0;
00001e  2000              MOVS     r0,#0
000020  6320              STR      r0,[r4,#0x30]
;;;463    			mem_set(fs->win, 0, 512);
000022  2201              MOVS     r2,#1
000024  0252              LSLS     r2,r2,#9
000026  2100              MOVS     r1,#0
000028  4620              MOV      r0,r4
00002a  3034              ADDS     r0,r0,#0x34
00002c  f7fffffe          BL       mem_set
;;;464    			ST_WORD(fs->win+BS_55AA, 0xAA55);
000030  2155              MOVS     r1,#0x55
000032  4620              MOV      r0,r4
000034  3034              ADDS     r0,r0,#0x34
000036  30ff              ADDS     r0,r0,#0xff
000038  30e1              ADDS     r0,r0,#0xe1
00003a  7781              STRB     r1,[r0,#0x1e]
00003c  21aa              MOVS     r1,#0xaa
00003e  4620              MOV      r0,r4
000040  3034              ADDS     r0,r0,#0x34
000042  30ff              ADDS     r0,r0,#0xff
000044  30ff              ADDS     r0,r0,#0xff
000046  7041              STRB     r1,[r0,#1]
;;;465    			ST_DWORD(fs->win+FSI_LeadSig, 0x41615252);
000048  2152              MOVS     r1,#0x52
00004a  2034              MOVS     r0,#0x34
00004c  5501              STRB     r1,[r0,r4]
00004e  2035              MOVS     r0,#0x35
000050  5501              STRB     r1,[r0,r4]
000052  2161              MOVS     r1,#0x61
000054  2036              MOVS     r0,#0x36
000056  5501              STRB     r1,[r0,r4]
000058  2141              MOVS     r1,#0x41
00005a  2037              MOVS     r0,#0x37
00005c  5501              STRB     r1,[r0,r4]
;;;466    			ST_DWORD(fs->win+FSI_StrucSig, 0x61417272);
00005e  2172              MOVS     r1,#0x72
000060  4620              MOV      r0,r4
000062  3034              ADDS     r0,r0,#0x34
000064  30ff              ADDS     r0,r0,#0xff
000066  30e1              ADDS     r0,r0,#0xe1
000068  7101              STRB     r1,[r0,#4]
00006a  4620              MOV      r0,r4
00006c  3034              ADDS     r0,r0,#0x34
00006e  30ff              ADDS     r0,r0,#0xff
000070  30e5              ADDS     r0,r0,#0xe5
000072  7041              STRB     r1,[r0,#1]
000074  2141              MOVS     r1,#0x41
000076  4620              MOV      r0,r4
000078  3034              ADDS     r0,r0,#0x34
00007a  30ff              ADDS     r0,r0,#0xff
00007c  30e5              ADDS     r0,r0,#0xe5
00007e  7081              STRB     r1,[r0,#2]
000080  2161              MOVS     r1,#0x61
000082  4620              MOV      r0,r4
000084  3034              ADDS     r0,r0,#0x34
000086  30ff              ADDS     r0,r0,#0xff
000088  30e5              ADDS     r0,r0,#0xe5
00008a  70c1              STRB     r1,[r0,#3]
;;;467    			ST_DWORD(fs->win+FSI_Free_Count, fs->free_clust);
00008c  7c21              LDRB     r1,[r4,#0x10]
00008e  4620              MOV      r0,r4
000090  3034              ADDS     r0,r0,#0x34
000092  30ff              ADDS     r0,r0,#0xff
000094  30e1              ADDS     r0,r0,#0xe1
000096  7201              STRB     r1,[r0,#8]
000098  8a20              LDRH     r0,[r4,#0x10]
00009a  0400              LSLS     r0,r0,#16
00009c  0e01              LSRS     r1,r0,#24
00009e  4620              MOV      r0,r4
0000a0  3034              ADDS     r0,r0,#0x34
0000a2  30ff              ADDS     r0,r0,#0xff
0000a4  30e9              ADDS     r0,r0,#0xe9
0000a6  7041              STRB     r1,[r0,#1]
0000a8  6920              LDR      r0,[r4,#0x10]
0000aa  0200              LSLS     r0,r0,#8
0000ac  0e01              LSRS     r1,r0,#24
0000ae  4620              MOV      r0,r4
0000b0  3034              ADDS     r0,r0,#0x34
0000b2  30ff              ADDS     r0,r0,#0xff
0000b4  30e9              ADDS     r0,r0,#0xe9
0000b6  7081              STRB     r1,[r0,#2]
0000b8  6920              LDR      r0,[r4,#0x10]
0000ba  0e01              LSRS     r1,r0,#24
0000bc  4620              MOV      r0,r4
0000be  3034              ADDS     r0,r0,#0x34
0000c0  30ff              ADDS     r0,r0,#0xff
0000c2  30e9              ADDS     r0,r0,#0xe9
0000c4  70c1              STRB     r1,[r0,#3]
;;;468    			ST_DWORD(fs->win+FSI_Nxt_Free, fs->last_clust);
0000c6  7b21              LDRB     r1,[r4,#0xc]
0000c8  4620              MOV      r0,r4
0000ca  3034              ADDS     r0,r0,#0x34
0000cc  30ff              ADDS     r0,r0,#0xff
0000ce  30e1              ADDS     r0,r0,#0xe1
0000d0  7301              STRB     r1,[r0,#0xc]
0000d2  89a0              LDRH     r0,[r4,#0xc]
0000d4  0400              LSLS     r0,r0,#16
0000d6  0e01              LSRS     r1,r0,#24
0000d8  4620              MOV      r0,r4
0000da  3034              ADDS     r0,r0,#0x34
0000dc  30ff              ADDS     r0,r0,#0xff
0000de  30ed              ADDS     r0,r0,#0xed
0000e0  7041              STRB     r1,[r0,#1]
0000e2  68e0              LDR      r0,[r4,#0xc]
0000e4  0200              LSLS     r0,r0,#8
0000e6  0e01              LSRS     r1,r0,#24
0000e8  4620              MOV      r0,r4
0000ea  3034              ADDS     r0,r0,#0x34
0000ec  30ff              ADDS     r0,r0,#0xff
0000ee  30ed              ADDS     r0,r0,#0xed
0000f0  7081              STRB     r1,[r0,#2]
0000f2  68e0              LDR      r0,[r4,#0xc]
0000f4  0e01              LSRS     r1,r0,#24
0000f6  4620              MOV      r0,r4
0000f8  3034              ADDS     r0,r0,#0x34
0000fa  30ff              ADDS     r0,r0,#0xff
0000fc  30ed              ADDS     r0,r0,#0xed
0000fe  70c1              STRB     r1,[r0,#3]
;;;469    			disk_write(fs->drv, fs->win, fs->fsi_sector, 1);
000100  7860              LDRB     r0,[r4,#1]
000102  2301              MOVS     r3,#1
000104  4621              MOV      r1,r4
000106  3134              ADDS     r1,r1,#0x34
000108  6962              LDR      r2,[r4,#0x14]
00010a  f7fffffe          BL       disk_write
;;;470    			fs->fsi_flag = 0;
00010e  e001              B        |L47.276|
                  |L47.272|
000110  e00a              B        |L47.296|
000112  e001              B        |L47.280|
                  |L47.276|
000114  2000              MOVS     r0,#0
000116  7160              STRB     r0,[r4,#5]
                  |L47.280|
;;;471    		}
;;;472    		/* Make sure that no pending write process in the physical drive */
;;;473    		if (disk_ioctl(fs->drv, CTRL_SYNC, (void*)0) != RES_OK)
000118  7860              LDRB     r0,[r4,#1]
00011a  2200              MOVS     r2,#0
00011c  4611              MOV      r1,r2
00011e  f7fffffe          BL       disk_ioctl
000122  2800              CMP      r0,#0
000124  d000              BEQ      |L47.296|
;;;474    			res = FR_DISK_ERR;
000126  2501              MOVS     r5,#1
                  |L47.296|
;;;475    	}
;;;476    
;;;477    	return res;
000128  4628              MOV      r0,r5
;;;478    }
00012a  bd70              POP      {r4-r6,pc}
;;;479    #endif
                          ENDP


                          AREA ||i.validate||, CODE, READONLY, ALIGN=1

                  validate PROC
;;;1819   static
;;;1820   FRESULT validate (	/* FR_OK(0): The object is valid, !=0: Invalid */
000000  b570              PUSH     {r4-r6,lr}
;;;1821   	FATFS *fs,		/* Pointer to the file system object */
;;;1822   	WORD id			/* Member id of the target object to be checked */
;;;1823   )
;;;1824   {
000002  4604              MOV      r4,r0
000004  460d              MOV      r5,r1
;;;1825   	if (!fs || !fs->fs_type || fs->id != id)
000006  2c00              CMP      r4,#0
000008  d005              BEQ      |L48.22|
00000a  7820              LDRB     r0,[r4,#0]
00000c  2800              CMP      r0,#0
00000e  d002              BEQ      |L48.22|
000010  88e0              LDRH     r0,[r4,#6]
000012  42a8              CMP      r0,r5
000014  d001              BEQ      |L48.26|
                  |L48.22|
;;;1826   		return FR_INVALID_OBJECT;
000016  2009              MOVS     r0,#9
                  |L48.24|
;;;1827   
;;;1828   	ENTER_FF(fs);		/* Lock file system */
;;;1829   
;;;1830   	if (disk_status(fs->drv) & STA_NOINIT)
;;;1831   		return FR_NOT_READY;
;;;1832   
;;;1833   	return FR_OK;
;;;1834   }
000018  bd70              POP      {r4-r6,pc}
                  |L48.26|
00001a  7860              LDRB     r0,[r4,#1]            ;1830
00001c  f7fffffe          BL       disk_status
000020  07c0              LSLS     r0,r0,#31             ;1830
000022  0fc0              LSRS     r0,r0,#31             ;1830
000024  2800              CMP      r0,#0                 ;1830
000026  d001              BEQ      |L48.44|
000028  2003              MOVS     r0,#3                 ;1831
00002a  e7f5              B        |L48.24|
                  |L48.44|
00002c  2000              MOVS     r0,#0                 ;1833
00002e  e7f3              B        |L48.24|
;;;1835   
                          ENDP


                          AREA ||.bss||, DATA, NOINIT, ALIGN=1

                  LfnBuf
                          %        256

                          AREA ||.constdata||, DATA, READONLY, ALIGN=1

                  LfnOfs
000000  01030507          DCB      0x01,0x03,0x05,0x07
000004  090e1012          DCB      0x09,0x0e,0x10,0x12
000008  1416181c          DCB      0x14,0x16,0x18,0x1c
00000c  1e                DCB      0x1e
                  excvt
00000d  809a90            DCB      0x80,0x9a,0x90
000010  b68eb78f          DCB      0xb6,0x8e,0xb7,0x8f
000014  80d2d3d4          DCB      0x80,0xd2,0xd3,0xd4
000018  d8d7de8e          DCB      0xd8,0xd7,0xde,0x8e
00001c  8f909292          DCB      0x8f,0x90,0x92,0x92
000020  e299e3ea          DCB      0xe2,0x99,0xe3,0xea
000024  eb59999a          DCB      0xeb,0x59,0x99,0x9a
000028  9d9c9d9e          DCB      0x9d,0x9c,0x9d,0x9e
00002c  9fb5d6e0          DCB      0x9f,0xb5,0xd6,0xe0
000030  e9a5a5a6          DCB      0xe9,0xa5,0xa5,0xa6
000034  a7a8a9aa          DCB      0xa7,0xa8,0xa9,0xaa
000038  abac21ae          DCB      0xab,0xac,0x21,0xae
00003c  afb0b1b2          DCB      0xaf,0xb0,0xb1,0xb2
000040  b3b4b5b6          DCB      0xb3,0xb4,0xb5,0xb6
000044  b7b8b9ba          DCB      0xb7,0xb8,0xb9,0xba
000048  bbbcbdbe          DCB      0xbb,0xbc,0xbd,0xbe
00004c  bfc0c1c2          DCB      0xbf,0xc0,0xc1,0xc2
000050  c3c4c5c7          DCB      0xc3,0xc4,0xc5,0xc7
000054  c7c8c9ca          DCB      0xc7,0xc8,0xc9,0xca
000058  cbcccdce          DCB      0xcb,0xcc,0xcd,0xce
00005c  cfd0d1d2          DCB      0xcf,0xd0,0xd1,0xd2
000060  d3d4d5d6          DCB      0xd3,0xd4,0xd5,0xd6
000064  d7d8d9da          DCB      0xd7,0xd8,0xd9,0xda
000068  dbdcddde          DCB      0xdb,0xdc,0xdd,0xde
00006c  dfe0e1e2          DCB      0xdf,0xe0,0xe1,0xe2
000070  e3e5e5e6          DCB      0xe3,0xe5,0xe5,0xe6
000074  e7e7e9ea          DCB      0xe7,0xe7,0xe9,0xea
000078  ebededee          DCB      0xeb,0xed,0xed,0xee
00007c  eff0f1f2          DCB      0xef,0xf0,0xf1,0xf2
000080  f3f4f5f6          DCB      0xf3,0xf4,0xf5,0xf6
000084  f7f8f9fa          DCB      0xf7,0xf8,0xf9,0xfa
000088  fbfcfdfe          DCB      0xfb,0xfc,0xfd,0xfe
00008c  ff00              DCB      0xff,0x00
                  vst
00008e  0400              DCW      0x0400
000090  02000100          DCW      0x0200,0x0100
000094  00800040          DCW      0x0080,0x0040
000098  00200010          DCW      0x0020,0x0010
00009c  00080004          DCW      0x0008,0x0004
0000a0  00020000          DCW      0x0002,0x0000
                  ||cst||
0000a4  80004000          DCW      0x8000,0x4000
0000a8  20001000          DCW      0x2000,0x1000
0000ac  08004000          DCW      0x0800,0x4000
0000b0  20001000          DCW      0x2000,0x1000
0000b4  08000400          DCW      0x0800,0x0400
0000b8  0200              DCW      0x0200

                          AREA ||.data||, DATA, ALIGN=2

                  Fsid
000000  00000000          DCB      0x00,0x00,0x00,0x00
                  FatFs
                          DCD      0x00000000
                  Drive
000008  00                DCB      0x00
